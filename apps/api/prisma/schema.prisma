generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ItemStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  RETIRED
}

enum TransactionAction {
  BORROW
  RETURN
  ADJUST
}

enum UserRole {
  ADMIN
  MANAGER
  VIEWER
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Employee {
  id           String         @id @default(uuid())
  employeeCode String         @unique
  displayName  String
  nfcTagUid    String?        @unique
  department   String?
  contact      String?
  status       EmployeeStatus @default(ACTIVE)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  loans        Loan[]
  transactions Transaction[]  @relation("EmployeeActor")
}

model Item {
  id              String     @id @default(uuid())
  itemCode        String     @unique
  name            String
  description     String?
  nfcTagUid       String?    @unique
  category        String?
  storageLocation String?
  status          ItemStatus @default(AVAILABLE)
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  loans           Loan[]
}

model ClientDevice {
  id           String        @id @default(uuid())
  name         String
  location     String?
  apiKey       String        @unique
  lastSeenAt   DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  loans        Loan[]
  transactions Transaction[]
}

model User {
  id           String        @id @default(uuid())
  username     String        @unique
  passwordHash String
  role         UserRole      @default(VIEWER)
  status       UserStatus    @default(ACTIVE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
}

model Loan {
  id           String        @id @default(uuid())
  itemId       String?
  employeeId   String?
  clientId     String?
  borrowedAt   DateTime      @default(now())
  dueAt        DateTime?
  returnedAt   DateTime?
  notes        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  item         Item?         @relation(fields: [itemId], references: [id], onDelete: SetNull)
  employee     Employee?     @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  client       ClientDevice? @relation(fields: [clientId], references: [id])
  transactions Transaction[]

  @@index([itemId])
  @@index([employeeId])
  @@index([clientId])
  @@index([returnedAt])
}

model Transaction {
  id                String            @id @default(uuid())
  loanId            String?
  action            TransactionAction
  actorEmployeeId   String?
  performedByUserId String?
  clientId          String?
  details           Json?
  createdAt         DateTime          @default(now())
  loan              Loan?             @relation(fields: [loanId], references: [id])
  actorEmployee     Employee?         @relation("EmployeeActor", fields: [actorEmployeeId], references: [id])
  performedByUser   User?             @relation(fields: [performedByUserId], references: [id])
  client            ClientDevice?     @relation(fields: [clientId], references: [id])

  @@index([loanId])
  @@index([actorEmployeeId])
  @@index([performedByUserId])
  @@index([clientId])
}

model ImportJob {
  id          String        @id @default(uuid())
  type        String
  status      ImportStatus  @default(PENDING)
  summary     Json?
  createdAt   DateTime      @default(now())
  completedAt DateTime?
}
