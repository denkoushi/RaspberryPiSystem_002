generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ItemStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  RETIRED
}

enum MeasuringInstrumentStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  RETIRED
}

enum RiggingStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  RETIRED
}

enum TransactionAction {
  BORROW
  RETURN
  ADJUST
  CANCEL
}

enum UserRole {
  ADMIN
  MANAGER
  VIEWER
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SignageContentType {
  TOOLS
  PDF
  SPLIT
}

enum SignageDisplayMode {
  SLIDESHOW
  SINGLE
}

model Employee {
  id                       String                    @id @default(uuid())
  employeeCode             String                    @unique
  displayName              String
  lastName                 String? // 苗字（CSVインポート用）
  firstName                String? // 名前（CSVインポート用）
  nfcTagUid                String?                   @unique
  department               String?
  contact                  String?
  status                   EmployeeStatus            @default(ACTIVE)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  loans                    Loan[]
  inspectionRecords        InspectionRecord[]
  riggingInspectionRecords RiggingInspectionRecord[]
  transactions             Transaction[]             @relation("EmployeeActor")
}

model Item {
  id              String     @id @default(uuid())
  itemCode        String     @unique
  name            String
  description     String?
  nfcTagUid       String?    @unique
  category        String?
  storageLocation String?
  status          ItemStatus @default(AVAILABLE)
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  loans           Loan[]
}

model MeasuringInstrument {
  id                    String                    @id @default(uuid())
  name                  String
  managementNumber      String                    @unique
  storageLocation       String?
  department            String? // 管理部署（CSVインポート用）
  measurementRange      String?
  calibrationExpiryDate DateTime?
  status                MeasuringInstrumentStatus @default(AVAILABLE)
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  inspectionItems       InspectionItem[]
  inspectionRecords     InspectionRecord[]
  tags                  MeasuringInstrumentTag[]
  loans                 Loan[]
}

model InspectionItem {
  id                    String              @id @default(uuid())
  measuringInstrumentId String
  name                  String
  content               String
  criteria              String
  method                String
  order                 Int
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  measuringInstrument   MeasuringInstrument @relation(fields: [measuringInstrumentId], references: [id], onDelete: Cascade)
  inspectionRecords     InspectionRecord[]

  @@unique([measuringInstrumentId, name])
  @@index([measuringInstrumentId])
  @@index([order])
}

enum InspectionResult {
  PASS
  FAIL
}

model InspectionRecord {
  id                    String              @id @default(uuid())
  measuringInstrumentId String
  loanId                String?
  employeeId            String
  inspectionItemId      String
  result                InspectionResult
  inspectedAt           DateTime
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  measuringInstrument   MeasuringInstrument @relation(fields: [measuringInstrumentId], references: [id], onDelete: Cascade)
  loan                  Loan?               @relation(fields: [loanId], references: [id], onDelete: SetNull)
  employee              Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  inspectionItem        InspectionItem      @relation(fields: [inspectionItemId], references: [id], onDelete: Cascade)

  @@index([measuringInstrumentId])
  @@index([loanId])
  @@index([employeeId])
  @@index([inspectionItemId])
  @@index([inspectedAt])
}

model MeasuringInstrumentTag {
  id                    String              @id @default(uuid())
  measuringInstrumentId String
  rfidTagUid            String              @unique
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  measuringInstrument   MeasuringInstrument @relation(fields: [measuringInstrumentId], references: [id], onDelete: Cascade)

  @@index([measuringInstrumentId])
}

model RiggingGear {
  id                String                    @id @default(uuid())
  name              String
  managementNumber  String                    @unique
  storageLocation   String?
  department        String?
  maxLoadTon        Float?
  lengthMm          Int?
  widthMm           Int?
  thicknessMm       Int?
  startedAt         DateTime?
  usableYears       Int? // 使用可能年数（CSVインポート用）
  status            RiggingStatus             @default(AVAILABLE)
  notes             String?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  tags              RiggingGearTag[]
  inspectionRecords RiggingInspectionRecord[]
  loans             Loan[]
}

model RiggingGearTag {
  id            String      @id @default(uuid())
  riggingGearId String
  rfidTagUid    String      @unique
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  riggingGear   RiggingGear @relation(fields: [riggingGearId], references: [id], onDelete: Cascade)

  @@index([riggingGearId])
}

model RiggingInspectionRecord {
  id            String           @id @default(uuid())
  riggingGearId String
  loanId        String?
  employeeId    String
  result        InspectionResult
  inspectedAt   DateTime
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  riggingGear   RiggingGear      @relation(fields: [riggingGearId], references: [id], onDelete: Cascade)
  loan          Loan?            @relation(fields: [loanId], references: [id], onDelete: SetNull)
  employee      Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([riggingGearId])
  @@index([loanId])
  @@index([employeeId])
  @@index([inspectedAt])
}

model ClientDevice {
  id             String        @id @default(uuid())
  name           String
  location       String?
  apiKey         String        @unique
  statusClientId String? // ClientStatus.clientId への紐づけ（x-client-key → statusClientId）
  defaultMode    String?       @default("TAG") // 'PHOTO' | 'TAG'（デフォルト: 'TAG'）
  lastSeenAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  loans          Loan[]
  transactions   Transaction[]

  @@index([statusClientId])
}

model ClientStatus {
  id            String    @id @default(uuid())
  clientId      String    @unique
  hostname      String
  ipAddress     String
  cpuUsage      Float
  memoryUsage   Float
  diskUsage     Float
  temperature   Float?
  uptimeSeconds Int?
  lastBoot      DateTime?
  lastSeen      DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([lastSeen])
}

model ClientLog {
  id        String   @id @default(uuid())
  clientId  String
  level     String
  message   String
  context   Json?
  createdAt DateTime @default(now())

  @@index([clientId, createdAt])
  @@index([createdAt])
}

model User {
  id              String         @id @default(uuid())
  username        String         @unique
  passwordHash    String
  role            UserRole       @default(VIEWER)
  status          UserStatus     @default(ACTIVE)
  mfaEnabled      Boolean        @default(false)
  totpSecret      String?
  mfaBackupCodes  String[]       @default([])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  transactions    Transaction[]
  auditLogsActor  RoleAuditLog[] @relation("RoleAuditActor")
  auditLogsTarget RoleAuditLog[] @relation("RoleAuditTarget")
}

model RoleAuditLog {
  id           String   @id @default(uuid())
  actorUserId  String
  targetUserId String
  fromRole     UserRole
  toRole       UserRole
  createdAt    DateTime @default(now())

  actorUser  User @relation("RoleAuditActor", fields: [actorUserId], references: [id], onDelete: Cascade)
  targetUser User @relation("RoleAuditTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([actorUserId])
  @@index([targetUserId])
}

model Loan {
  id                      String                    @id @default(uuid())
  itemId                  String?
  measuringInstrumentId   String?
  riggingGearId           String?
  employeeId              String?
  clientId                String?
  borrowedAt              DateTime                  @default(now())
  dueAt                   DateTime?
  returnedAt              DateTime?
  cancelledAt             DateTime? // 取消日時（誤スキャン時の取消に使用、ダッシュボードで除外可能）
  notes                   String?
  photoUrl                String? // 写真のURL（例: /api/storage/photos/2025/11/20251127_123456_employee-uuid.jpg）
  photoTakenAt            DateTime? // 撮影日時
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  item                    Item?                     @relation(fields: [itemId], references: [id], onDelete: SetNull)
  measuringInstrument     MeasuringInstrument?      @relation(fields: [measuringInstrumentId], references: [id], onDelete: SetNull)
  riggingGear             RiggingGear?              @relation(fields: [riggingGearId], references: [id], onDelete: SetNull)
  employee                Employee?                 @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  client                  ClientDevice?             @relation(fields: [clientId], references: [id])
  transactions            Transaction[]
  InspectionRecord        InspectionRecord[]
  RiggingInspectionRecord RiggingInspectionRecord[]

  @@index([itemId])
  @@index([measuringInstrumentId])
  @@index([riggingGearId])
  @@index([employeeId])
  @@index([clientId])
  @@index([returnedAt])
  @@index([cancelledAt])
  @@index([photoTakenAt])
}

model Transaction {
  id                String            @id @default(uuid())
  loanId            String?
  action            TransactionAction
  actorEmployeeId   String?
  performedByUserId String?
  clientId          String?
  details           Json?
  createdAt         DateTime          @default(now())
  loan              Loan?             @relation(fields: [loanId], references: [id])
  actorEmployee     Employee?         @relation("EmployeeActor", fields: [actorEmployeeId], references: [id])
  performedByUser   User?             @relation(fields: [performedByUserId], references: [id])
  client            ClientDevice?     @relation(fields: [clientId], references: [id])

  @@index([loanId])
  @@index([actorEmployeeId])
  @@index([performedByUserId])
  @@index([clientId])
}

model ImportJob {
  id          String       @id @default(uuid())
  type        String
  status      ImportStatus @default(PENDING)
  summary     Json?
  createdAt   DateTime     @default(now())
  completedAt DateTime?
}

model CsvImportHistory {
  id            String       @id @default(uuid())
  scheduleId    String // スケジュールID（backup.jsonのcsvImports[].id）
  scheduleName  String? // スケジュール名（表示用）
  status        ImportStatus @default(PENDING)
  employeesPath String? // Dropbox上の従業員CSVパス
  itemsPath     String? // Dropbox上のアイテムCSVパス
  summary       Json? // インポート結果サマリー（{ employees: { processed, created, updated }, items: { processed, created, updated } }）
  errorMessage  String? // エラーメッセージ（失敗時）
  startedAt     DateTime     @default(now())
  completedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([scheduleId])
  @@index([status])
  @@index([startedAt])
  @@index([completedAt])
}

enum BackupOperationType {
  BACKUP
  RESTORE
}

enum BackupStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum BackupFileStatus {
  EXISTS // ファイルが存在する
  DELETED // ファイルが削除済み（保持期間超過または最大件数超過）
}

model BackupHistory {
  id              String              @id @default(uuid())
  operationType   BackupOperationType // バックアップまたはリストア
  targetKind      String // バックアップ対象の種類（database, csv, file, directory, image）
  targetSource    String // バックアップ対象のソース
  backupPath      String? // バックアップファイルのパス（Dropboxまたはローカル）
  storageProvider String              @default("local") // ストレージプロバイダー（local, dropbox）
  status          BackupStatus        @default(PENDING)
  fileStatus      BackupFileStatus    @default(EXISTS) // バックアップファイルの存在状態
  sizeBytes       Int? // バックアップファイルサイズ（バイト）
  hash            String? // バックアップファイルのハッシュ値（SHA256）
  summary         Json? // バックアップ・リストア結果サマリー
  errorMessage    String? // エラーメッセージ（失敗時）
  startedAt       DateTime            @default(now())
  completedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([operationType])
  @@index([targetKind])
  @@index([status])
  @@index([fileStatus])
  @@index([startedAt])
  @@index([completedAt])
}

model SignageSchedule {
  id           String             @id @default(uuid())
  name         String
  contentType  SignageContentType
  pdfId        String?
  pdf          SignagePdf?        @relation("SchedulePdf", fields: [pdfId], references: [id], onDelete: SetNull)
  layoutConfig Json? // レイアウト設定（FULL/SPLIT + slots定義）。nullの場合は旧contentType/pdfIdから合成
  dayOfWeek    Int[]
  startTime    String
  endTime      String
  priority     Int
  enabled      Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([enabled])
  @@index([priority])
}

model SignagePdf {
  id            String             @id @default(uuid())
  name          String
  filename      String
  filePath      String
  displayMode   SignageDisplayMode
  slideInterval Int?
  enabled       Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  schedules     SignageSchedule[]  @relation("SchedulePdf")
  emergencies   SignageEmergency[] @relation("EmergencyPdf")

  @@index([enabled])
}

model SignageEmergency {
  id           String              @id @default(uuid())
  message      String?
  contentType  SignageContentType?
  pdfId        String?
  pdf          SignagePdf?         @relation("EmergencyPdf", fields: [pdfId], references: [id], onDelete: SetNull)
  layoutConfig Json? // レイアウト設定（FULL/SPLIT + slots定義）。nullの場合は旧contentType/pdfIdから合成
  enabled      Boolean             @default(false)
  expiresAt    DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([enabled])
  @@index([expiresAt])
}

enum CsvDashboardIngestMode {
  APPEND // 追加（重複無視）
  DEDUP // 重複除去
}

enum CsvDashboardTemplateType {
  TABLE // テーブル形式
  CARD_GRID // カードグリッド形式
}

enum CsvDashboardConfigType {
  DASHBOARD
  MASTER
}

enum CsvImportStrategy {
  UPSERT
  REPLACE
}

enum AlertSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum AlertChannel {
  SLACK
  EMAIL
  HTTP
}

enum AlertDeliveryStatus {
  PENDING
  SENT
  FAILED
  SUPPRESSED
}

model CsvDashboard {
  id                String                   @id @default(uuid())
  name              String // ダッシュボード名
  description       String? // 説明
  configType        CsvDashboardConfigType   @default(DASHBOARD) // 設定種別（ダッシュボード/マスター設定）
  importType        String                   @default("csvDashboards") // インポートタイプ（employees/items/.../csvDashboards）
  allowedManualImport Boolean                @default(true) // 手動取り込みを許可
  allowedScheduledImport Boolean             @default(true) // 自動取り込みを許可
  importStrategy    CsvImportStrategy        @default(UPSERT) // 取り込み戦略（主にマスターデータ用）
  columnDefinitions Json // 列定義（列名マッピング、順序、型、表示名など）
  dateColumnName    String? // 日付列の内部名（表示期間フィルタ用）
  displayPeriodDays Int                      @default(1) // 表示期間（日数、デフォルトは当日のみ）
  emptyMessage      String? // 0件時のメッセージ
  ingestMode        CsvDashboardIngestMode   @default(APPEND) // 取り込み方式
  dedupKeyColumns   String[]                 @default([]) // 重複除去キー列（内部名の配列、dedup時のみ使用）
  gmailScheduleId   String? // Gmail取得スケジュールID（オプション、将来の拡張用）
  gmailSubjectPattern String? // Gmail件名パターン（CSV取得用）
  templateType      CsvDashboardTemplateType @default(TABLE) // 可視化テンプレート種別
  templateConfig    Json // テンプレート設定（行数、フォントサイズ、表示列など）
  csvFilePath       String? // 最新のCSVファイルパス（原本保存先）
  enabled           Boolean                  @default(true)
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  ingestRuns        CsvDashboardIngestRun[]
  rows              CsvDashboardRow[]

  @@index([enabled])
  @@index([gmailScheduleId])
  @@index([gmailSubjectPattern])
  @@index([configType, importType])
}

model CsvDashboardIngestRun {
  id             String       @id @default(uuid())
  csvDashboardId String
  csvDashboard   CsvDashboard @relation(fields: [csvDashboardId], references: [id], onDelete: Cascade)
  status         ImportStatus @default(PENDING)
  messageId      String? // GmailメッセージID
  messageSubject String? // Gmail件名
  csvFilePath    String? // 取り込んだCSVファイルパス
  rowsProcessed  Int          @default(0) // 処理行数
  rowsAdded      Int          @default(0) // 追加行数（dedup時は重複除外後の数）
  rowsSkipped    Int          @default(0) // スキップ行数（重複など）
  errorMessage   String? // エラーメッセージ
  startedAt      DateTime     @default(now())
  completedAt    DateTime?

  @@index([csvDashboardId])
  @@index([status])
  @@index([startedAt])
}

model CsvDashboardRow {
  id             String       @id @default(uuid())
  csvDashboardId String
  csvDashboard   CsvDashboard @relation(fields: [csvDashboardId], references: [id], onDelete: Cascade)
  occurredAt     DateTime // 日付列から抽出した日時（表示期間フィルタ用、Asia/Tokyo）
  dataHash       String? // データのハッシュ（重複除去用、dedup時のみ使用）
  rowData        Json // 正規化された行データ（列マッピング適用後）
  createdAt      DateTime     @default(now())

  @@index([csvDashboardId])
  @@index([csvDashboardId, occurredAt]) // 表示期間フィルタ用の複合インデックス
  @@index([csvDashboardId, dataHash]) // 重複除去用の複合インデックス（dedup時のみ使用）
}

model MeasuringInstrumentLoanEvent {
  id                  String   @id @default(uuid())
  managementNumber    String
  eventAt             DateTime // CSVのday列（UTC）のイベント時刻
  action              String // 持ち出し / 返却
  raw                 Json // CSV行の原本
  sourceMessageId     String? // GmailメッセージID
  sourceMessageSubject String? // Gmail件名
  sourceCsvDashboardId String? // CSVダッシュボードID
  createdAt           DateTime @default(now())

  @@unique([managementNumber, eventAt, action])
  @@index([eventAt])
  @@index([managementNumber])
  @@index([action])
}

// CSVインポート件名パターン（マスターデータ用）
model CsvImportSubjectPattern {
  id          String   @id @default(uuid())
  importType  String   // インポートタイプ（employees, items, measuringInstruments, riggingGears, csvDashboards）
  dashboardId String?  // CSVダッシュボードID（csvDashboards用、任意）
  pattern     String   // Gmail件名パターン
  priority    Int      @default(0) // 優先順位（数値が小さいほど優先）
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([importType, pattern])
  @@index([importType])
  @@index([importType, enabled])
  @@index([priority])
  @@index([dashboardId])
}

model Alert {
  id            String            @id // ファイルのidをそのまま使用（例: "20260118-103750"）
  type          String? // アラートタイプ（例: "ansible-update-failed"）
  severity      AlertSeverity? // 重要度
  message       String? // メッセージ
  details       Json? // 詳細情報（JSON形式推奨）
  source        Json? // 発生源情報（service/host/location等）
  context       Json? // コンテキスト情報（branch/inventory/requestId/hosts等）
  fingerprint   String? // dedupe用（type+message+host等から計算）
  timestamp     DateTime // 発生時刻
  acknowledged  Boolean           @default(false) // 確認済みフラグ（既存仕様互換）
  acknowledgedAt DateTime? // 確認済み日時
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deliveries    AlertDelivery[]

  @@index([timestamp])
  @@index([acknowledged])
  @@index([type])
}

model AlertDelivery {
  id            String              @id @default(uuid())
  alertId       String // Alert.id（ファイルのid）
  alert         Alert                @relation(fields: [alertId], references: [id], onDelete: Cascade)
  channel       AlertChannel         @default(SLACK) // 配送チャンネル（slack/email/http等）
  routeKey      String // ルートキー（deploy/ops/support/security等）
  status        AlertDeliveryStatus  @default(PENDING) // 配送状態
  attemptCount  Int                  @default(0) // 試行回数
  nextAttemptAt DateTime? // 次回試行時刻（バックオフ）
  lastAttemptAt DateTime? // 最終試行時刻
  sentAt        DateTime? // 送信成功時刻
  lastError     String? // 最終エラーメッセージ
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@unique([alertId, channel, routeKey]) // 同一アラート・チャンネル・ルートの重複を防止
  @@index([alertId])
  @@index([status])
  @@index([nextAttemptAt])
  @@index([channel, routeKey, status])
}
