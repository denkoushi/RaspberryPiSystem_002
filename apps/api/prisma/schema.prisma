generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ItemStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  RETIRED
}

enum TransactionAction {
  BORROW
  RETURN
  ADJUST
  CANCEL
}

enum UserRole {
  ADMIN
  MANAGER
  VIEWER
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SignageContentType {
  TOOLS
  PDF
  SPLIT
}

enum SignageDisplayMode {
  SLIDESHOW
  SINGLE
}

model Employee {
  id           String         @id @default(uuid())
  employeeCode String         @unique
  displayName  String
  nfcTagUid    String?        @unique
  department   String?
  contact      String?
  status       EmployeeStatus @default(ACTIVE)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  loans        Loan[]
  transactions Transaction[]  @relation("EmployeeActor")
}

model Item {
  id              String     @id @default(uuid())
  itemCode        String     @unique
  name            String
  description     String?
  nfcTagUid       String?    @unique
  category        String?
  storageLocation String?
  status          ItemStatus @default(AVAILABLE)
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  loans           Loan[]
}

model ClientDevice {
  id           String        @id @default(uuid())
  name         String
  location     String?
  apiKey       String        @unique
  defaultMode  String?       @default("TAG") // 'PHOTO' | 'TAG'（デフォルト: 'TAG'）
  lastSeenAt   DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  loans        Loan[]
  transactions Transaction[]
}

model User {
  id           String        @id @default(uuid())
  username     String        @unique
  passwordHash String
  role         UserRole      @default(VIEWER)
  status       UserStatus    @default(ACTIVE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
}

model Loan {
  id           String        @id @default(uuid())
  itemId       String?
  employeeId   String?
  clientId     String?
  borrowedAt   DateTime      @default(now())
  dueAt        DateTime?
  returnedAt   DateTime?
  cancelledAt  DateTime? // 取消日時（誤スキャン時の取消に使用、ダッシュボードで除外可能）
  notes        String?
  photoUrl     String? // 写真のURL（例: /api/storage/photos/2025/11/20251127_123456_employee-uuid.jpg）
  photoTakenAt DateTime? // 撮影日時
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  item         Item?         @relation(fields: [itemId], references: [id], onDelete: SetNull)
  employee     Employee?     @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  client       ClientDevice? @relation(fields: [clientId], references: [id])
  transactions Transaction[]

  @@index([itemId])
  @@index([employeeId])
  @@index([clientId])
  @@index([returnedAt])
  @@index([cancelledAt])
  @@index([photoTakenAt])
}

model Transaction {
  id                String            @id @default(uuid())
  loanId            String?
  action            TransactionAction
  actorEmployeeId   String?
  performedByUserId String?
  clientId          String?
  details           Json?
  createdAt         DateTime          @default(now())
  loan              Loan?             @relation(fields: [loanId], references: [id])
  actorEmployee     Employee?         @relation("EmployeeActor", fields: [actorEmployeeId], references: [id])
  performedByUser   User?             @relation(fields: [performedByUserId], references: [id])
  client            ClientDevice?     @relation(fields: [clientId], references: [id])

  @@index([loanId])
  @@index([actorEmployeeId])
  @@index([performedByUserId])
  @@index([clientId])
}

model ImportJob {
  id          String       @id @default(uuid())
  type        String
  status      ImportStatus @default(PENDING)
  summary     Json?
  createdAt   DateTime     @default(now())
  completedAt DateTime?
}

model SignageSchedule {
  id          String             @id @default(uuid())
  name        String
  contentType SignageContentType
  pdfId       String?
  pdf         SignagePdf?        @relation("SchedulePdf", fields: [pdfId], references: [id], onDelete: SetNull)
  dayOfWeek   Int[]
  startTime   String
  endTime     String
  priority    Int
  enabled     Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([enabled])
  @@index([priority])
}

model SignagePdf {
  id            String             @id @default(uuid())
  name          String
  filename      String
  filePath      String
  displayMode   SignageDisplayMode
  slideInterval Int?
  enabled       Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  schedules     SignageSchedule[]  @relation("SchedulePdf")
  emergencies   SignageEmergency[] @relation("EmergencyPdf")

  @@index([enabled])
}

model SignageEmergency {
  id          String              @id @default(uuid())
  message     String?
  contentType SignageContentType?
  pdfId       String?
  pdf         SignagePdf?         @relation("EmergencyPdf", fields: [pdfId], references: [id], onDelete: SetNull)
  enabled     Boolean             @default(false)
  expiresAt   DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([enabled])
  @@index([expiresAt])
}
