# syntax=docker/dockerfile:1
FROM node:20-alpine AS build
WORKDIR /app
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json tsconfig.base.json ./
COPY apps/web/package.json apps/web/
COPY packages ./packages
RUN corepack enable && pnpm install --frozen-lockfile
WORKDIR /app/packages/shared-types
RUN pnpm build
WORKDIR /app
COPY apps/web ./apps/web
# apps/webをコピーした後、workspace解決を確実にするためpnpm installを再実行
RUN pnpm install --frozen-lockfile
# NFCエージェントのWebSocket URLをビルド時に設定可能にする
ARG VITE_AGENT_WS_URL=ws://localhost:7071/stream
ENV VITE_AGENT_WS_URL=${VITE_AGENT_WS_URL}
# ラズパイ5のAPIサーバーのURLをビルド時に設定可能にする
ARG VITE_API_BASE_URL=/api
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
# apps/webのビルド前にshared-typesのdistが存在することを確認
RUN test -d packages/shared-types/dist || (echo "ERROR: shared-types/dist not found before web build" && exit 1)
RUN cd apps/web && pnpm run build

FROM caddy:2-alpine
WORKDIR /srv
# envsubstをインストール（gettextパッケージに含まれる）
RUN apk add --no-cache gettext
COPY --from=build /app/apps/web/dist ./site
COPY infrastructure/docker/Caddyfile ./Caddyfile
COPY infrastructure/docker/Caddyfile.production ./Caddyfile.production
COPY infrastructure/docker/Caddyfile.local.template ./Caddyfile.local.template
# Caddyfileの選択ロジック:
# 1. USE_LOCAL_CERTS環境変数が設定されている場合 → Caddyfile.local（自己署名証明書）
# 2. DOMAIN環境変数が設定されている場合 → Caddyfile.production（Let's Encrypt）
# 3. それ以外 → Caddyfile（HTTPのみ、開発用）
CMD ["sh", "-c", "if [ -n \"$USE_LOCAL_CERTS\" ]; then export NFC_AGENT_HOST=${NFC_AGENT_HOST:-192.168.10.223} && envsubst < /srv/Caddyfile.local.template > /srv/Caddyfile.local && caddy run --config /srv/Caddyfile.local; elif [ -n \"$DOMAIN\" ]; then caddy run --config /srv/Caddyfile.production; else caddy run --config /srv/Caddyfile; fi"]
