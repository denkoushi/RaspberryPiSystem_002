# 開発環境用Caddyfile（HTTPのみ）
# 本番環境では Caddyfile.production を使用

{
  auto_https off
}
:80 {
  root * /srv/site

  @api {
    path /api/*
    path /ws/*
  }
  reverse_proxy @api api:8080

  # サムネイルの静的ファイル配信（認証不要）
  handle_path /storage/thumbnails/* {
    root * /srv/storage/thumbnails
    file_server
    header Cache-Control "public, max-age=86400" # 1日キャッシュ
  }

  @spa {
    not path /api/*
    not path /ws/*
    not path /storage/*
    not file
  }
  rewrite @spa /index.html
  
  # JavaScript/CSSファイルのキャッシュ制御（開発環境ではキャッシュを無効化）
  @static {
    path *.js
    path *.css
  }
  header @static Cache-Control "no-cache, no-store, must-revalidate"
  
  file_server

  log {
    output file /var/log/caddy/access.log {
      roll_size 5MiB
      roll_keep 5
      roll_keep_for 168h
    }
  }
}
