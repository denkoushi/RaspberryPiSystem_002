services:
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    env_file:
      - .env
    environment:
      POSTGRES_DB: borrow_return
      POSTGRES_USER: postgres
      # セキュリティ強化: 環境変数からパスワードを取得（デフォルト値は開発環境用）
      # 本番環境では強力なパスワードを環境変数で設定すること
      # infrastructure/docker/.envファイルにPOSTGRES_PASSWORDを設定
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - db-data:/var/lib/postgresql/data
    # セキュリティ強化: ポートマッピングを削除（Docker内部ネットワークでのみアクセス可能）
    # APIコンテナからは `db:5432` でアクセス可能
    # ports:
    #   - "5432:5432"

  api:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.api
    restart: always
    depends_on:
      - db
    env_file:
      - ../../apps/api/.env.example
      - .env
    environment:
      # セキュリティ強化: 環境変数からデータベースURLを構築（パスワードは環境変数から取得）
      # 本番環境では強力なパスワードを環境変数で設定すること
      # infrastructure/docker/.envファイルにPOSTGRES_PASSWORDを設定
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/borrow_return
      PHOTO_STORAGE_DIR: /app/storage
      PDF_STORAGE_DIR: /app/storage
      SIGNAGE_RENDER_DIR: /app/storage/signage-rendered
      SIGNAGE_PDF_DPI: "240"
      CAMERA_TYPE: mock
      ALERTS_DIR: /app/alerts
      DROPBOX_ACCESS_TOKEN: ${DROPBOX_ACCESS_TOKEN:-}
      DROPBOX_APP_KEY: ${DROPBOX_APP_KEY:-}
      DROPBOX_APP_SECRET: ${DROPBOX_APP_SECRET:-}
      DROPBOX_REFRESH_TOKEN: ${DROPBOX_REFRESH_TOKEN:-}
      GMAIL_CLIENT_ID: ${GMAIL_CLIENT_ID:-}
      GMAIL_CLIENT_SECRET: ${GMAIL_CLIENT_SECRET:-}
    volumes:
      - photo-storage:/app/storage/photos
      - thumbnail-storage:/app/storage/thumbnails
      - pdf-storage:/app/storage/pdfs
      - pdf-pages-storage:/app/storage/pdf-pages
      - signage-rendered-storage:/app/storage/signage-rendered
      - /opt/RaspberryPiSystem_002/alerts:/app/alerts
      - /opt/RaspberryPiSystem_002/config:/app/config
      # 環境変数ファイルのバックアップ用にマウント（読み取り専用）
      - /opt/RaspberryPiSystem_002/apps/api:/app/host/apps/api:ro
      - /opt/RaspberryPiSystem_002/apps/web:/app/host/apps/web:ro
      - /opt/RaspberryPiSystem_002/infrastructure/docker:/app/host/infrastructure/docker:ro
      - /opt/RaspberryPiSystem_002/clients/nfc-agent:/app/host/clients/nfc-agent:ro
      # Ansibleによるクライアント端末バックアップ用にマウント（読み取り専用）
      - /opt/RaspberryPiSystem_002/infrastructure/ansible:/app/host/infrastructure/ansible:ro
      # AnsibleによるSSH接続用にSSH鍵をマウント（読み取り専用）
      - /home/denkon5sd02/.ssh:/root/.ssh:ro
      # CPU温度を取得するために/sys/class/thermalを読み取り専用でマウント
      - /sys/class/thermal:/sys/class/thermal:ro
    # セキュリティ強化: ポートマッピングを削除（Docker内部ネットワークでのみアクセス可能）
    # Caddyからは `api:8080` でアクセス可能
    # Ansibleデプロイ時のヘルスチェック用に一時的に公開（本番環境では削除推奨）
    ports:
      - "127.0.0.1:8080:8080"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  web:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.web
    restart: always
    depends_on:
      - api
    volumes:
      - thumbnail-storage:/srv/storage/thumbnails:ro # サムネイルを読み取り専用でマウント
      # 自己署名証明書を使用する場合（工場現場での運用に推奨）
      - /opt/RaspberryPiSystem_002/certs:/srv/certs:ro
      - /var/log/caddy:/var/log/caddy
    # HTTPS設定オプション:
    # 1. 自己署名証明書を使用（工場現場での運用に推奨）
    environment:
      USE_LOCAL_CERTS: "true"
      # NFCエージェントのIPアドレス（Wi-Fi変更時はここを更新）
      # ラズパイ4のIPアドレスを設定（例: 192.168.128.102）
      NFC_AGENT_HOST: ${NFC_AGENT_HOST:-192.168.10.224}
      # 管理画面へのアクセスを許可するネットワーク（CIDRの空白区切りリスト）
      ADMIN_ALLOW_NETS: ${ADMIN_ALLOW_NETS:-"192.168.10.0/24 192.168.128.0/24 100.64.0.0/10 127.0.0.1/32"}
    ports:
      - "80:80"
      - "443:443"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    # 2. Let's Encryptを使用（インターネット接続とドメイン名が必要）
    #    environment:
    #      DOMAIN: your-domain.com
    #      CADDY_ADMIN_EMAIL: admin@your-domain.com
    #    ports:
    #      - "80:80"
    #      - "443:443"
    # 3. HTTPのみ（開発用、カメラAPIは動作しない）
    #    ports:
    #      - "4173:80"

volumes:
  db-data:
  photo-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/RaspberryPiSystem_002/storage/photos
  thumbnail-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/RaspberryPiSystem_002/storage/thumbnails
  pdf-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/RaspberryPiSystem_002/storage/pdfs
  pdf-pages-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/RaspberryPiSystem_002/storage/pdf-pages
  signage-rendered-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/RaspberryPiSystem_002/storage/signage-rendered
