all:
  children:
    server:
      hosts:
        raspberrypi5:
          ansible_host: "{{ server_ip }}"
          ansible_user: denkon5sd02
          ansible_connection: local  # ローカル実行のため
          ansible_python_interpreter: /usr/bin/python3
          tailscale_enabled: true
          # API環境変数
          api_database_url: "postgresql://postgres:postgres@db:5432/borrow_return"
          api_jwt_access_secret: "{{ vault_api_jwt_access_secret | default('change-me-in-production') }}"
          api_jwt_refresh_secret: "{{ vault_api_jwt_refresh_secret | default('change-me-in-production') }}"
          # Web環境変数
          web_api_base_url: "/api"
          web_ws_base_url: "/ws"
          web_agent_ws_url: "{{ websocket_agent_url }}"
          # Docker Compose環境変数はgroup_vars/all.ymlで定義済み
    clients:
      hosts:
        raspberrypi4:
          ansible_host: "{{ kiosk_ip }}"
          ansible_user: tools03
          tailscale_enabled: true
          status_agent_client_id: raspberrypi4-kiosk1
          status_agent_client_key: "{{ vault_status_agent_client_key | default('client-key-raspberrypi4-kiosk1') }}"
          status_agent_location: "ラズパイ4 - キオスク1"
          kiosk_url: "{{ kiosk_full_url }}"
          # kiosk-browser.serviceを管理対象にする
          manage_kiosk_browser: true
          # このホストで再起動するサービスリスト
          services_to_restart:
            - kiosk-browser.service
            - status-agent.service
            - status-agent.timer
          sudo_nopasswd_commands:
            - /usr/bin/systemctl start kiosk-browser.service
            - /usr/bin/systemctl stop kiosk-browser.service
            - /usr/bin/systemctl restart kiosk-browser.service
            - /usr/bin/systemctl start status-agent.service
            - /usr/bin/systemctl stop status-agent.service
            - /usr/bin/systemctl restart status-agent.service
            - /usr/bin/systemctl start status-agent.timer
            - /usr/bin/systemctl stop status-agent.timer
            - /usr/bin/systemctl restart status-agent.timer
          # NFCエージェント環境変数
          nfc_agent_api_base_url: "{{ api_base_url }}"
          nfc_agent_client_id: "raspberrypi4-kiosk1"
          nfc_agent_client_secret: "{{ vault_nfc_agent_client_secret | default('client-key-raspberrypi4-kiosk1') }}"
        raspberrypi3:
          ansible_host: "{{ signage_ip }}"
          ansible_user: signageras3
          tailscale_enabled: true
          status_agent_client_id: raspberrypi3-signage1
          status_agent_client_key: "{{ vault_status_agent_client_key | default('client-key-raspberrypi3-signage1') }}"
          status_agent_location: "ラズパイ3 - サイネージ1"
          signage_server_url: "{{ server_base_url }}"
          signage_client_key: "{{ vault_signage_client_key | default('client-key-raspberrypi3-signage1') }}"
          # signage-lite.serviceを管理対象にする
          manage_signage_lite: true
          # このホストで再起動するサービスリスト
          services_to_restart:
            - signage-lite.service
            - signage-lite-update.timer
            - status-agent.service
            - status-agent.timer
          sudo_nopasswd_commands:
            - /usr/bin/systemctl start signage-lite.service
            - /usr/bin/systemctl stop signage-lite.service
            - /usr/bin/systemctl restart signage-lite.service
            - /usr/bin/systemctl start signage-lite-update.timer
            - /usr/bin/systemctl stop signage-lite-update.timer
            - /usr/bin/systemctl restart signage-lite-update.timer
            - /usr/bin/systemctl start status-agent.service
            - /usr/bin/systemctl stop status-agent.service
            - /usr/bin/systemctl restart status-agent.service
            - /usr/bin/systemctl start status-agent.timer
            - /usr/bin/systemctl stop status-agent.timer
            - /usr/bin/systemctl restart status-agent.timer
      vars:
        # StrictHostKeyCheckingを無効化（ホストキー確認プロンプトを回避）
        # 注意: RequestTTY=forceはAnsibleのsftpファイル転送と干渉するため削除（KB-098参照）
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        ansible_python_interpreter: /usr/bin/python3
        status_agent_api_base_url: "{{ api_base_url }}"
        status_agent_tls_skip_verify: "1"
