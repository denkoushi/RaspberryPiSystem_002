#!/bin/bash
set -euo pipefail

LOG_DIR="{{ trivy_log_dir }}"
LOG_FILE="${LOG_DIR}/trivy-image-scan.log"
mkdir -p "${LOG_DIR}"

WEBHOOK_URL="${WEBHOOK_URL:-{{ alert_webhook_url | default('') }}}"
WEBHOOK_TIMEOUT_SECONDS="${WEBHOOK_TIMEOUT_SECONDS:-{{ alert_webhook_timeout_seconds | default(5) }}}"

TIMESTAMP="$(date +%Y-%m-%dT%H:%M:%S)"
echo "[$TIMESTAMP] Starting Trivy image scan..." >> "${LOG_FILE}"

PROJECT_DIR="/opt/RaspberryPiSystem_002"
COMPOSE_FILE="${PROJECT_DIR}/infrastructure/docker/docker-compose.server.yml"

# Dockerイメージを取得（docker compose imagesで確認）
API_IMAGE=$(docker compose -f "${COMPOSE_FILE}" images api --format json 2>/dev/null | jq -r '.[0].Repository + ":" + .[0].Tag' || echo "")
WEB_IMAGE=$(docker compose -f "${COMPOSE_FILE}" images web --format json 2>/dev/null | jq -r '.[0].Repository + ":" + .[0].Tag' || echo "")

if [[ -z "${API_IMAGE}" ]] && [[ -z "${WEB_IMAGE}" ]]; then
  echo "[$TIMESTAMP] No Docker images found. Skipping image scan." >> "${LOG_FILE}"
  exit 0
fi

scan_image() {
  local image_name="$1"
  local image_type="$2"
  
  echo "[$TIMESTAMP] Scanning ${image_type} image: ${image_name}" >> "${LOG_FILE}"
  
  TRIVY_CMD=(/usr/bin/trivy image
    --severity HIGH,CRITICAL
    --ignore-unfixed
    --exit-code 1
    --quiet
    "${image_name}"
  )
  
  set +e
  "${TRIVY_CMD[@]}" >> "${LOG_FILE}" 2>&1
  TRIVY_EXIT=$?
  set -e
  
  if [[ ${TRIVY_EXIT} -eq 1 && -x "{{ alert_script_path }}" ]]; then
    RAW_DETAILS="$(grep -E '^(CRITICAL|HIGH):' -A5 "${LOG_FILE}" | tail -n 50)"
{% if trivy_alert_ignore_patterns %}
    FILTERED_DETAILS="${RAW_DETAILS}"
{% for ignore in trivy_alert_ignore_patterns %}
    FILTERED_DETAILS="$(echo "${FILTERED_DETAILS}" | grep -v "{{ ignore }}" || true)"
{% endfor %}
{% else %}
    FILTERED_DETAILS="${RAW_DETAILS}"
{% endif %}
    if [[ -n "${FILTERED_DETAILS}" ]]; then
      WEBHOOK_URL="${WEBHOOK_URL:-}" WEBHOOK_TIMEOUT_SECONDS="${WEBHOOK_TIMEOUT_SECONDS:-5}" \
        "{{ alert_script_path }}" \
          "trivy-image-detection" \
          "Trivyイメージスキャン（${image_type}）で脆弱性を検知しました" \
          "${FILTERED_DETAILS}"
    fi
  elif [[ ${TRIVY_EXIT} -gt 1 && -x "{{ alert_script_path }}" ]]; then
    WEBHOOK_URL="${WEBHOOK_URL:-}" WEBHOOK_TIMEOUT_SECONDS="${WEBHOOK_TIMEOUT_SECONDS:-5}" \
      "{{ alert_script_path }}" \
        "trivy-image-scan-error" \
        "Trivyイメージスキャン（${image_type}）でエラーが発生しました" \
        "詳細ログ: ${LOG_FILE}"
  fi
}

if [[ -n "${API_IMAGE}" ]]; then
  scan_image "${API_IMAGE}" "api"
fi

if [[ -n "${WEB_IMAGE}" ]]; then
  scan_image "${WEB_IMAGE}" "web"
fi

echo "[$(date +%Y-%m-%dT%H:%M:%S)] Trivy image scan completed." >> "${LOG_FILE}"
