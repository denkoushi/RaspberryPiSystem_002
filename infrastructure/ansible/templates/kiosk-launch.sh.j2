{% set kiosk_origin = kiosk_url | regex_replace('(/.*)$', '') %}
#!/usr/bin/env bash
export DISPLAY={{ kiosk_display | default(':0') }}
export XAUTHORITY=/home/{{ ansible_user }}/.Xauthority
export GTK_USE_PORTAL=0
export XDG_CURRENT_DESKTOP={{ kiosk_desktop | default('LXDE') }}
export XDG_SESSION_TYPE=x11
export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus
export CHROME_WRAPPER=/usr/bin/chromium-browser
# キーリングを無効化（パスワードダイアログを表示しない）
export GNOME_KEYRING_CONTROL=""
export SSH_AUTH_SOCK=""
# NetworkManagerの認証ダイアログを抑制
export NM_CLI_NO_TERSE=1
export NM_CLI_NO_ASK_PASSWORD=1

# 画面上部のパネルを非表示にする
pkill -x lxpanel || true

CHROMIUM_FLAGS=(
  # ウィンドウ上端のメニュー/パネルを残すため、kioskフラグは無効化
  --app="{{ kiosk_url }}"
  --start-maximized
  --noerrdialogs
  --disable-session-crashed-bubble
  --autoplay-policy=no-user-gesture-required
  --disable-translate
  --overscroll-history-navigation=0
  --use-fake-ui-for-media-stream
  --allow-insecure-localhost
  --allow-running-insecure-content
  --ignore-certificate-errors
  --unsafely-treat-insecure-origin-as-secure={{ kiosk_origin }},http://localhost:7071
  # 警告バーを非表示にする（--ignore-certificate-errorsの警告も抑制）
  --disable-infobars
  # テストモードとして実行（コマンドラインフラグの警告を抑制）
  --test-type
  # キーリングを無効化（パスワードストアをbasicに設定）
  --password-store=basic
)

exec chromium-browser "${CHROMIUM_FLAGS[@]}"
