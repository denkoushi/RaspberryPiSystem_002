#!/bin/bash
set -euo pipefail

LOG_DIR="{{ clamav_log_dir }}"
LOG_FILE="${LOG_DIR}/{{ clamav_log_file }}"
mkdir -p "${LOG_DIR}"

SCAN_TARGETS=(
{% for path in clamav_scan_paths %}
"{{ path }}"
{% endfor %}
)

TIMESTAMP="$(date +%Y-%m-%dT%H:%M:%S)"
echo "[$TIMESTAMP] Starting ClamAV scan..." >> "${LOG_FILE}"

/usr/bin/clamscan \
  --recursive \
  --infected \
  --quiet \
  --max-filesize=200M \
  --max-scansize=400M \
  "${SCAN_TARGETS[@]}" >> "${LOG_FILE}" 2>&1 || true

echo "[$(date +%Y-%m-%dT%H:%M:%S)] Scan completed." >> "${LOG_FILE}"
