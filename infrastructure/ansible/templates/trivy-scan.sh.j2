#!/bin/bash
set -euo pipefail

LOG_DIR="{{ trivy_log_dir }}"
LOG_FILE="${LOG_DIR}/{{ trivy_log_file }}"
mkdir -p "${LOG_DIR}"

TIMESTAMP="$(date +%Y-%m-%dT%H:%M:%S)"
echo "[$TIMESTAMP] Starting Trivy filesystem scan..." >> "${LOG_FILE}"

/usr/bin/trivy fs \
  --severity HIGH,CRITICAL \
  --ignore-unfixed \
  --exit-code 0 \
  --quiet \
  "{{ trivy_scan_target }}" >> "${LOG_FILE}" 2>&1 || true

echo "[$(date +%Y-%m-%dT%H:%M:%S)] Trivy scan completed." >> "${LOG_FILE}"
