#!/usr/bin/env bash
set -euo pipefail

QUEUE_FILE="${1:-}"
if [[ -z "${QUEUE_FILE}" || ! -f "${QUEUE_FILE}" ]]; then
  exit 0
fi

REPO_ROOT="/opt/RaspberryPiSystem_002"
ANSIBLE_DIR="${REPO_ROOT}/infrastructure/ansible"
INVENTORY="${ANSIBLE_DIR}/inventory.yml"
PLAYBOOK="${ANSIBLE_DIR}/playbooks/power-control.yml"
LOG_DIR="${REPO_ROOT}/logs/power-actions"
PROCESSED_DIR="${REPO_ROOT}/power-actions/processed"
FAILED_DIR="${REPO_ROOT}/power-actions/failed"

mkdir -p "${LOG_DIR}" "${PROCESSED_DIR}" "${FAILED_DIR}"

read_action_and_key() {
  python3 - <<'PY' "${QUEUE_FILE}"
import json
import sys
from pathlib import Path

path = Path(sys.argv[1])
data = json.loads(path.read_text(encoding="utf-8"))
action = data.get("action")
client_key = data.get("clientKey")
if action not in ("reboot", "poweroff") or not client_key:
    raise SystemExit(1)
print(action)
print(client_key)
PY
}

if ! mapfile -t parsed < <(read_action_and_key); then
  mv "${QUEUE_FILE}" "${FAILED_DIR}/$(basename "${QUEUE_FILE}")" || true
  exit 1
fi

ACTION="${parsed[0]}"
CLIENT_KEY="${parsed[1]}"

if ! command -v ansible-inventory >/dev/null 2>&1; then
  mv "${QUEUE_FILE}" "${FAILED_DIR}/$(basename "${QUEUE_FILE}")" || true
  exit 1
fi

HOST=$(
  ANSIBLE_CONFIG="${ANSIBLE_DIR}/ansible.cfg" ANSIBLE_ROLES_PATH="${ANSIBLE_DIR}/roles" \
  ansible-inventory -i "${INVENTORY}" --list | \
  python3 - <<'PY' "${CLIENT_KEY}"
import json
import sys

client_key = sys.argv[1]
data = json.load(sys.stdin)
hostvars = data.get("_meta", {}).get("hostvars", {})
for host, vars in hostvars.items():
    if vars.get("status_agent_client_key") == client_key or vars.get("nfc_agent_client_secret") == client_key:
        print(host)
        raise SystemExit(0)
raise SystemExit(1)
PY
)

if [[ -z "${HOST}" ]]; then
  mv "${QUEUE_FILE}" "${FAILED_DIR}/$(basename "${QUEUE_FILE}")" || true
  exit 1
fi

LOG_FILE="${LOG_DIR}/$(basename "${QUEUE_FILE}").log"

set +e
ANSIBLE_CONFIG="${ANSIBLE_DIR}/ansible.cfg" ANSIBLE_ROLES_PATH="${ANSIBLE_DIR}/roles" \
ansible-playbook "${PLAYBOOK}" -i "${INVENTORY}" --limit "${HOST}" -e "power_action=${ACTION}" \
  >> "${LOG_FILE}" 2>&1
rc=$?
set -e

if [[ $rc -ne 0 ]]; then
  mv "${QUEUE_FILE}" "${FAILED_DIR}/$(basename "${QUEUE_FILE}")" || true
  exit $rc
fi

mv "${QUEUE_FILE}" "${PROCESSED_DIR}/$(basename "${QUEUE_FILE}")" || true
