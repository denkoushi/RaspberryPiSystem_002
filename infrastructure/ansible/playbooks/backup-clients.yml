---
- name: Backup client device files
  hosts: "{{ client_host }}"
  gather_facts: false
  vars:
    ansible_python_interpreter: /usr/bin/python3
    client_host: "{{ client_host | default('') }}"
    client_file_path: "{{ client_file_path | default('') }}"
    backup_destination: "{{ backup_destination | default('/tmp') }}"
  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - client_host != ''
          - client_file_path != ''
          - backup_destination != ''
        fail_msg: "client_host, client_file_path, and backup_destination are required"
        quiet: true
      delegate_to: localhost
      run_once: true

    - name: Fetch file from client device
      ansible.builtin.fetch:
        src: "{{ client_file_path }}"
        dest: "{{ backup_destination }}/{{ inventory_hostname }}_{{ client_file_path | basename }}"
        flat: true
      register: fetch_result
      ignore_errors: true

    - name: Fail if file fetch failed
      ansible.builtin.fail:
        msg: "Failed to fetch file from {{ inventory_hostname }}: {{ client_file_path }}"
      when: fetch_result.failed | default(true)
      delegate_to: localhost
      run_once: true

    - name: Set output file path
      ansible.builtin.set_fact:
        output_file: "{{ backup_destination }}/{{ inventory_hostname }}_{{ client_file_path | basename }}"
      delegate_to: localhost
      run_once: true
