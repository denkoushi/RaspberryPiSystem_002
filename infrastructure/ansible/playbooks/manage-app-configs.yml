---
- name: Manage application configuration files
  hosts: server:clients
  gather_facts: true
  become: true
  vars:
    repo_path: /opt/RaspberryPiSystem_002

  tasks:
    - name: Validate required API variables
      ansible.builtin.assert:
        that:
          - api_database_url is defined
          - api_jwt_access_secret is defined
          - api_jwt_refresh_secret is defined
        fail_msg: "API環境変数が定義されていません（inventory.ymlを確認してください）"
      when: '"server" in group_names'

    - name: Validate required Web variables
      ansible.builtin.assert:
        that:
          - web_api_base_url is defined
          - web_agent_ws_url is defined
        fail_msg: "Web環境変数（VITE_*）が定義されていません（inventory.ymlを確認してください）"
      when: '"server" in group_names'

    - name: Validate required Docker Compose variables
      ansible.builtin.assert:
        that:
          - docker_server_ip is defined
        fail_msg: "Docker Compose用SERVER_IPが定義されていません（inventory.ymlを確認してください）"
      when: '"server" in group_names'

    - name: Validate required NFC agent variables
      ansible.builtin.assert:
        that:
          - nfc_agent_client_id is defined
          - nfc_agent_client_secret is defined
        fail_msg: "NFCエージェントのCLIENT_ID/CLIENT_SECRETが定義されていません（inventory.ymlを確認してください）"
      when:
        - '"clients" in group_names'
        - nfc_agent_client_id is defined

    # API環境変数ファイルの管理（サーバーのみ）
    - name: Ensure API .env directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/apps/api"
        state: directory
        mode: '0755'
      when: '"server" in group_names'

    - name: Deploy API environment variables
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/api.env.j2"
        dest: "{{ repo_path }}/apps/api/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: '"server" in group_names'
      register: api_env_result
      notify: restart api

    # Web環境変数ファイルの管理（サーバーのみ）
    - name: Ensure Web .env directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/apps/web"
        state: directory
        mode: '0755'
      when: '"server" in group_names'

    - name: Deploy Web environment variables
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/web.env.j2"
        dest: "{{ repo_path }}/apps/web/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: '"server" in group_names'
      register: web_env_result
      notify: restart web

    # NFCエージェント環境変数ファイルの管理（クライアントのみ）
    - name: Ensure NFC agent .env directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/clients/nfc-agent"
        state: directory
        mode: '0755'
      when: '"clients" in group_names'

    - name: Deploy NFC agent environment variables
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/nfc-agent.env.j2"
        dest: "{{ repo_path }}/clients/nfc-agent/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when:
        - '"clients" in group_names'
        - nfc_agent_client_id is defined
      register: nfc_agent_env_result

    # Docker Compose環境変数ファイルの管理（サーバーのみ）
    - name: Ensure Docker Compose .env directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/infrastructure/docker"
        state: directory
        mode: '0755'
      when: '"server" in group_names'

    - name: Deploy Docker Compose environment variables
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/docker.env.j2"
        dest: "{{ repo_path }}/infrastructure/docker/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: '"server" in group_names'
      register: docker_env_result
      notify: restart docker

    - name: Validate API .env syntax
      ansible.builtin.shell: |
        python3 - <<'PY'
        from pathlib import Path
        import sys
        path = Path("{{ repo_path }}/apps/api/.env")
        invalid = []
        for lineno, line in enumerate(path.read_text().splitlines(), 1):
            stripped = line.strip()
            if not stripped or stripped.startswith("#"):
                continue
            if "=" not in stripped:
                invalid.append(f"{lineno}:{line}")
        if invalid:
            raise SystemExit("Invalid API .env lines -> " + ", ".join(invalid))
        PY
      when:
        - '"server" in group_names'
        - api_env_result.changed | default(false)
      changed_when: false

    - name: Validate Web .env syntax
      ansible.builtin.shell: |
        python3 - <<'PY'
        from pathlib import Path
        import sys
        path = Path("{{ repo_path }}/apps/web/.env")
        invalid = []
        for lineno, line in enumerate(path.read_text().splitlines(), 1):
            stripped = line.strip()
            if not stripped or stripped.startswith("#"):
                continue
            if "=" not in stripped:
                invalid.append(f"{lineno}:{line}")
        if invalid:
            raise SystemExit("Invalid Web .env lines -> " + ", ".join(invalid))
        PY
      when:
        - '"server" in group_names'
        - web_env_result.changed | default(false)
      changed_when: false

    - name: Validate Docker Compose .env syntax
      ansible.builtin.shell: |
        python3 - <<'PY'
        from pathlib import Path
        import sys
        path = Path("{{ repo_path }}/infrastructure/docker/.env")
        invalid = []
        for lineno, line in enumerate(path.read_text().splitlines(), 1):
            stripped = line.strip()
            if not stripped or stripped.startswith("#"):
                continue
            if "=" not in stripped:
                invalid.append(f"{lineno}:{line}")
        if invalid:
            raise SystemExit("Invalid docker .env lines -> " + ", ".join(invalid))
        PY
      when:
        - '"server" in group_names'
        - docker_env_result.changed | default(false)
      changed_when: false

    - name: Validate NFC agent .env syntax
      ansible.builtin.shell: |
        python3 - <<'PY'
        from pathlib import Path
        import sys
        path = Path("{{ repo_path }}/clients/nfc-agent/.env")
        invalid = []
        for lineno, line in enumerate(path.read_text().splitlines(), 1):
            stripped = line.strip()
            if not stripped or stripped.startswith("#"):
                continue
            if "=" not in stripped:
                invalid.append(f"{lineno}:{line}")
        if invalid:
            raise SystemExit("Invalid NFC agent .env lines -> " + ", ".join(invalid))
        PY
      when:
        - '"clients" in group_names'
        - nfc_agent_client_id is defined
        - nfc_agent_env_result.changed | default(false)
      changed_when: false

  handlers:
    - name: restart api
      ansible.builtin.systemd:
        name: docker
        state: restarted
      when:
        - '"server" in group_names'
        - api_env_result.changed | default(false)

    - name: restart web
      ansible.builtin.systemd:
        name: docker
        state: restarted
      when:
        - '"server" in group_names'
        - web_env_result.changed | default(false)

    - name: restart docker compose services
      ansible.builtin.shell: |
        cd {{ repo_path }}/infrastructure/docker
        docker compose -f docker-compose.server.yml up -d api web
      when:
        - '"server" in group_names'
        - docker_env_result.changed | default(false)
      ignore_errors: true

