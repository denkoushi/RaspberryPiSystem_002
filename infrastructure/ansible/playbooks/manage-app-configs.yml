---
- name: Manage application configuration files
  hosts: server:clients
  gather_facts: true
  become: true
  vars:
    repo_path: /opt/RaspberryPiSystem_002

  tasks:
    - name: Validate required API variables
      ansible.builtin.assert:
        that:
          - api_database_url is defined
        fail_msg: "API環境変数（DATABASE_URL）が定義されていません（inventory.ymlを確認してください）"
      when: '"server" in group_names'

    - name: Validate required Web variables
      ansible.builtin.assert:
        that:
          - web_api_base_url is defined
          - web_agent_ws_url is defined
        fail_msg: "Web環境変数（VITE_*）が定義されていません（inventory.ymlを確認してください）"
      when: '"server" in group_names'

    - name: Validate required Docker Compose variables
      ansible.builtin.assert:
        that:
          - docker_server_ip is defined
        fail_msg: "Docker Compose用SERVER_IPが定義されていません（inventory.ymlを確認してください）"
      when: '"server" in group_names'

    - name: Validate required NFC agent variables
      ansible.builtin.assert:
        that:
          - nfc_agent_client_id is defined
          - nfc_agent_client_secret is defined
        fail_msg: "NFCエージェントのCLIENT_ID/CLIENT_SECRETが定義されていません（inventory.ymlを確認してください）"
      when: '"clients" in group_names'

    # API環境変数ファイルの管理（サーバーのみ）
    - name: Ensure API .env directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/apps/api"
        state: directory
        mode: '0755'
      when: '"server" in group_names'

    - name: Stat existing API .env (for preserving JWT secrets)
      ansible.builtin.stat:
        path: "{{ repo_path }}/apps/api/.env"
      register: api_env_stat
      when: '"server" in group_names'

    - name: Read existing API .env (for preserving JWT secrets)
      ansible.builtin.slurp:
        path: "{{ repo_path }}/apps/api/.env"
      register: api_env_slurp
      when:
        - '"server" in group_names'
        - api_env_stat.stat.exists | default(false)
      no_log: true

    - name: Extract existing JWT secrets from API .env
      ansible.builtin.set_fact:
        existing_api_jwt_access_secret: >-
          {{
            (
              (
                (api_env_slurp.content | b64decode)
                | regex_findall('^JWT_ACCESS_SECRET=(.*)$', multiline=True)
              )
              | first
            )
            | default('')
          }}
        existing_api_jwt_refresh_secret: >-
          {{
            (
              (
                (api_env_slurp.content | b64decode)
                | regex_findall('^JWT_REFRESH_SECRET=(.*)$', multiline=True)
              )
              | first
            )
            | default('')
          }}
      when:
        - '"server" in group_names'
        - api_env_stat.stat.exists | default(false)
      no_log: true

    - name: Resolve effective JWT secrets for API .env
      ansible.builtin.set_fact:
        api_jwt_access_secret_effective: >-
          {{
            (
              (
                (api_jwt_access_secret | default('') | length) >= 32
                and ((api_jwt_access_secret | default('') | regex_search('change-me|test-|dev-|example')) == None)
              )
              | ternary((api_jwt_access_secret | default('')), (existing_api_jwt_access_secret | default('')))
            )
          }}
        api_jwt_refresh_secret_effective: >-
          {{
            (
              (
                (api_jwt_refresh_secret | default('') | length) >= 32
                and ((api_jwt_refresh_secret | default('') | regex_search('change-me|test-|dev-|example')) == None)
              )
              | ternary((api_jwt_refresh_secret | default('')), (existing_api_jwt_refresh_secret | default('')))
            )
          }}
      when: '"server" in group_names'
      no_log: true

    - name: Validate effective JWT secrets (must be strong in production)
      ansible.builtin.assert:
        that:
          - (api_jwt_access_secret_effective | length) >= 32
          - (api_jwt_refresh_secret_effective | length) >= 32
        fail_msg: >-
          JWT secrets are missing or weak.
          Set strong secrets in Ansible vars (vault_api_jwt_*), or ensure existing {{ repo_path }}/apps/api/.env has strong JWT_*_SECRET.
      when: '"server" in group_names'
      no_log: true

    - name: Deploy API environment variables
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/api.env.j2"
        dest: "{{ repo_path }}/apps/api/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: '"server" in group_names'
      register: api_env_result
      notify: restart api

    # Web環境変数ファイルの管理（サーバーのみ）
    - name: Ensure Web .env directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/apps/web"
        state: directory
        mode: '0755'
      when: '"server" in group_names'

    - name: Deploy Web environment variables
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/web.env.j2"
        dest: "{{ repo_path }}/apps/web/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: '"server" in group_names'
      register: web_env_result
      notify: restart web

    # NFCエージェント環境変数ファイルの管理（クライアントのみ）
    - name: Ensure NFC agent .env directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/clients/nfc-agent"
        state: directory
        mode: '0755'
      when: '"clients" in group_names'

    - name: Deploy NFC agent environment variables
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/nfc-agent.env.j2"
        dest: "{{ repo_path }}/clients/nfc-agent/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: '"clients" in group_names'
      register: nfc_agent_env_result

    # Docker Compose環境変数ファイルの管理（サーバーのみ）
    - name: Ensure Docker Compose .env directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/infrastructure/docker"
        state: directory
        mode: '0755'
      when: '"server" in group_names'

    - name: Stat existing Docker Compose .env
      ansible.builtin.stat:
        path: "{{ repo_path }}/infrastructure/docker/.env"
      register: docker_env_stat
      when: '"server" in group_names'

    - name: Read existing Docker Compose .env (for preserving manual values)
      ansible.builtin.slurp:
        path: "{{ repo_path }}/infrastructure/docker/.env"
      register: docker_env_slurp
      when:
        - '"server" in group_names'
        - docker_env_stat.stat.exists | default(false)
      no_log: true

    - name: Extract existing SLACK_KIOSK_SUPPORT_WEBHOOK_URL from Docker Compose .env
      ansible.builtin.set_fact:
        existing_slack_kiosk_support_webhook_url: >-
          {{
            (
              (
                (docker_env_slurp.content | b64decode)
                | regex_findall('^SLACK_KIOSK_SUPPORT_WEBHOOK_URL=(.*)$', multiline=True)
              )
              | first
            )
            | default('')
          }}
      when:
        - '"server" in group_names'
        - docker_env_stat.stat.exists | default(false)
      no_log: true

    - name: Deploy Docker Compose environment variables
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/docker.env.j2"
        dest: "{{ repo_path }}/infrastructure/docker/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: '"server" in group_names'
      register: docker_env_result
      notify: restart docker compose services

    - name: Validate API .env syntax
      ansible.builtin.shell: |
        python3 - <<'PY'
        from pathlib import Path
        import sys
        path = Path("{{ repo_path }}/apps/api/.env")
        invalid = []
        for lineno, line in enumerate(path.read_text().splitlines(), 1):
            stripped = line.strip()
            if not stripped or stripped.startswith("#"):
                continue
            if "=" not in stripped:
                invalid.append(f"{lineno}:{line}")
        if invalid:
            raise SystemExit("Invalid API .env lines -> " + ", ".join(invalid))
        PY
      when:
        - '"server" in group_names'
        - api_env_result.changed | default(false)
      changed_when: false

    - name: Validate Web .env syntax
      ansible.builtin.shell: |
        python3 - <<'PY'
        from pathlib import Path
        import sys
        path = Path("{{ repo_path }}/apps/web/.env")
        invalid = []
        for lineno, line in enumerate(path.read_text().splitlines(), 1):
            stripped = line.strip()
            if not stripped or stripped.startswith("#"):
                continue
            if "=" not in stripped:
                invalid.append(f"{lineno}:{line}")
        if invalid:
            raise SystemExit("Invalid Web .env lines -> " + ", ".join(invalid))
        PY
      when:
        - '"server" in group_names'
        - web_env_result.changed | default(false)
      changed_when: false

    - name: Validate Docker Compose .env syntax
      ansible.builtin.shell: |
        python3 - <<'PY'
        from pathlib import Path
        import sys
        path = Path("{{ repo_path }}/infrastructure/docker/.env")
        invalid = []
        for lineno, line in enumerate(path.read_text().splitlines(), 1):
            stripped = line.strip()
            if not stripped or stripped.startswith("#"):
                continue
            if "=" not in stripped:
                invalid.append(f"{lineno}:{line}")
        if invalid:
            raise SystemExit("Invalid docker .env lines -> " + ", ".join(invalid))
        PY
      when:
        - '"server" in group_names'
        - docker_env_result.changed | default(false)
      changed_when: false

    # backup.jsonの存在保証と健全性チェック（サーバーのみ）
    - name: Ensure backup.json config directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}/config"
        state: directory
        mode: '0755'
      when: '"server" in group_names'

    - name: Stat existing backup.json
      ansible.builtin.stat:
        path: "{{ repo_path }}/config/backup.json"
      register: backup_json_stat
      when: '"server" in group_names'

    - name: Check backup.json health (if exists)
      ansible.builtin.shell: |
        python3 - <<'PY'
        import json
        import sys
        from pathlib import Path
        path = Path("{{ repo_path }}/config/backup.json")
        try:
            config = json.loads(path.read_text())
            storage = config.get('storage', {})
            provider = storage.get('provider', 'local')
            options = storage.get('options', {})
            
            # Dropbox運用なのに必要な設定が空の場合、警告を出す
            if provider == 'dropbox':
                missing = []
                if not options.get('appKey'):
                    missing.append('appKey')
                if not options.get('appSecret'):
                    missing.append('appSecret')
                if not options.get('refreshToken'):
                    missing.append('refreshToken')
                
                if missing:
                    print(f"WARNING: backup.json uses dropbox provider but missing: {', '.join(missing)}")
                    print("Please configure Dropbox OAuth via management console or API:")
                    print("  GET /api/backup/oauth/authorize -> follow redirect -> /api/backup/oauth/callback")
                    sys.exit(1)
            
            # Gmail運用なのに必要な設定が空の場合、警告を出す
            if provider == 'gmail':
                missing = []
                if not options.get('clientId'):
                    missing.append('clientId')
                if not options.get('clientSecret'):
                    missing.append('clientSecret')
                if not options.get('refreshToken'):
                    missing.append('refreshToken')
                
                if missing:
                    print(f"WARNING: backup.json uses gmail provider but missing: {', '.join(missing)}")
                    print("Please configure Gmail OAuth via management console or API:")
                    print("  GET /api/gmail/oauth/authorize -> follow redirect -> /api/gmail/oauth/callback")
                    print("See docs/guides/gmail-setup-guide.md for details")
                    sys.exit(1)
        except json.JSONDecodeError as e:
            print(f"ERROR: backup.json is not valid JSON: {e}")
            sys.exit(1)
        except Exception as e:
            print(f"ERROR: Failed to check backup.json: {e}")
            sys.exit(1)
        PY
      when:
        - '"server" in group_names'
        - backup_json_stat.stat.exists | default(false)
      changed_when: false
      failed_when: false
      register: backup_json_health_check

    - name: Create minimal backup.json if missing
      ansible.builtin.copy:
        content: |
          {
            "storage": {
              "provider": "local",
              "options": {
                "basePath": "/opt/backups"
              }
            },
            "pathMappings": [
              {
                "hostPath": "/opt/RaspberryPiSystem_002/apps/api/.env",
                "containerPath": "/app/host/apps/api/.env"
              },
              {
                "hostPath": "/opt/RaspberryPiSystem_002/apps/web/.env",
                "containerPath": "/app/host/apps/web/.env"
              },
              {
                "hostPath": "/opt/RaspberryPiSystem_002/infrastructure/docker/.env",
                "containerPath": "/app/host/infrastructure/docker/.env"
              },
              {
                "hostPath": "/opt/RaspberryPiSystem_002/clients/nfc-agent/.env",
                "containerPath": "/app/host/clients/nfc-agent/.env"
              }
            ],
            "targets": [],
            "retention": {
              "days": 30,
              "maxBackups": 100
            },
            "csvImports": [],
            "csvImportSubjectPatterns": {
              "employees": [
                "[Pi5 CSV Import] employees",
                "[CSV Import] employees",
                "CSV Import - employees",
                "従業員CSVインポート"
              ],
              "items": [
                "[Pi5 CSV Import] items",
                "[CSV Import] items",
                "CSV Import - items",
                "アイテムCSVインポート"
              ],
              "measuringInstruments": [
                "[Pi5 CSV Import] measuring-instruments",
                "[CSV Import] measuring-instruments",
                "CSV Import - measuring-instruments",
                "計測機器CSVインポート"
              ],
              "riggingGears": [
                "[Pi5 CSV Import] rigging-gears",
                "[CSV Import] rigging-gears",
                "CSV Import - rigging-gears",
                "吊具CSVインポート"
              ]
            },
            "csvImportHistory": {
              "retentionDays": 90,
              "cleanupSchedule": "0 2 * * *"
            },
            "restoreFromDropbox": {
              "enabled": false,
              "verifyIntegrity": true
            }
          }
        dest: "{{ repo_path }}/config/backup.json"
        owner: root
        group: root
        mode: '0644'
      when:
        - '"server" in group_names'
        - not (backup_json_stat.stat.exists | default(false))
      register: backup_json_created

    - name: Warn about backup.json creation
      ansible.builtin.debug:
        msg: |
          backup.json was missing and has been created with minimal configuration.
          To configure Dropbox OAuth, use the management console or API:
            GET /api/backup/oauth/authorize -> follow redirect -> /api/backup/oauth/callback
          See docs/guides/dropbox-oauth-setup-guide.md for details.
      when:
        - '"server" in group_names'
        - backup_json_created.changed | default(false)

    - name: Validate NFC agent .env syntax
      ansible.builtin.shell: |
        python3 - <<'PY'
        from pathlib import Path
        import sys
        path = Path("{{ repo_path }}/clients/nfc-agent/.env")
        invalid = []
        for lineno, line in enumerate(path.read_text().splitlines(), 1):
            stripped = line.strip()
            if not stripped or stripped.startswith("#"):
                continue
            if "=" not in stripped:
                invalid.append(f"{lineno}:{line}")
        if invalid:
            raise SystemExit("Invalid NFC agent .env lines -> " + ", ".join(invalid))
        PY
      when:
        - '"clients" in group_names'
        - nfc_agent_env_result.changed | default(false)
      changed_when: false

  handlers:
    - name: restart api
      ansible.builtin.shell: |
        cd {{ repo_path }}/infrastructure/docker
        docker compose -f docker-compose.server.yml up -d --force-recreate api
      args:
        executable: /bin/bash
      when:
        - '"server" in group_names'
        - api_env_result.changed | default(false)

    - name: restart web
      ansible.builtin.shell: |
        cd {{ repo_path }}/infrastructure/docker
        docker compose -f docker-compose.server.yml up -d --force-recreate web
      args:
        executable: /bin/bash
      when:
        - '"server" in group_names'
        - web_env_result.changed | default(false)

    - name: restart docker compose services
      ansible.builtin.shell: |
        cd {{ repo_path }}/infrastructure/docker
        docker compose -f docker-compose.server.yml up -d --force-recreate api
      when:
        - '"server" in group_names'
        - docker_env_result.changed | default(false)
      ignore_errors: true

