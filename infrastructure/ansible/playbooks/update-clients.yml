---
- name: Deploy latest RaspberryPiSystem_002 to Raspberry Pi server and clients
  hosts: server:clients
  gather_facts: false
  become: true
  serial: 5
  vars:
    repo_path: /opt/RaspberryPiSystem_002
    repo_remote: "{{ lookup('env', 'RASPI_SYSTEM_REPO') | default('https://github.com/denkoushi/RaspberryPiSystem_002.git', true) }}"
    repo_version: feature/production-deployment-management
    services_to_restart:
      - signage-lite.service
      - signage-lite-update.timer
      - kiosk-browser.service
    server_services_to_restart:
      - docker  # Docker Composeサービスを再起動するため
  pre_tasks:
    - name: Ensure repository parent directory exists
      ansible.builtin.file:
        path: "{{ repo_path }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Clean untracked files before checkout
      ansible.builtin.shell: |
        set -euo pipefail
        cd {{ repo_path }} && git clean -fd || true
      args:
        executable: /bin/bash
      ignore_errors: true

    - name: Sync repository to desired state
      ansible.builtin.git:
        repo: "{{ repo_remote }}"
        dest: "{{ repo_path }}"
        version: "{{ repo_version }}"
        force: true
        accept_hostkey: true
        key_file: "{{ lookup('env', 'RASPI_SYSTEM_DEPLOY_KEY') | default(omit) }}"
      register: git_result

  tasks:
    - name: Install production dependencies (optional)
      ansible.builtin.shell: |
        set -euo pipefail
        cd {{ repo_path }} && pnpm install --filter signage-lite-client --prod
      args:
        executable: /bin/bash
      register: install_result
      changed_when: "'added' in (install_result.stdout | default('')) or 'audited' in (install_result.stdout | default(''))"
      failed_when: false

    # status-agentの設定（クライアントのみ）
    - name: Ensure status-agent configuration directory exists
      ansible.builtin.file:
        path: /etc
        state: directory
      when: '"server" not in group_names'

    - name: Create status-agent configuration file
      ansible.builtin.template:
        src: "{{ repo_path }}/clients/status-agent/status-agent.conf.j2"
        dest: /etc/raspi-status-agent.conf
        owner: root
        group: root
        mode: '0644'
      when: '"server" not in group_names and status_agent_client_id is defined'
      register: status_agent_config_result

    - name: Copy status-agent systemd service file
      ansible.builtin.copy:
        src: "{{ repo_path }}/clients/status-agent/status-agent.service"
        dest: /etc/systemd/system/status-agent.service
        owner: root
        group: root
        mode: '0644'
      when: '"server" not in group_names'
      register: status_agent_service_result

    - name: Copy status-agent systemd timer file
      ansible.builtin.copy:
        src: "{{ repo_path }}/clients/status-agent/status-agent.timer"
        dest: /etc/systemd/system/status-agent.timer
        owner: root
        group: root
        mode: '0644'
      when: '"server" not in group_names'
      register: status_agent_timer_result

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true
      when: '"server" not in group_names and (status_agent_service_result.changed or status_agent_timer_result.changed)'

    - name: Enable and start status-agent timer
      ansible.builtin.systemd:
        name: status-agent.timer
        enabled: true
        state: started
        daemon_reload: true
      when: '"server" not in group_names'
      register: status_agent_timer_enable_result

    - name: Restart required services (clients)
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
        daemon_reload: true
      loop: "{{ services_to_restart }}"
      register: restart_result
      ignore_errors: true
      failed_when: false
      when: '"server" not in group_names'

    - name: Restart Docker Compose services (server)
      ansible.builtin.shell: |
        set -euo pipefail
        cd {{ repo_path }} && docker compose -f infrastructure/docker/docker-compose.server.yml restart api web
      args:
        executable: /bin/bash
      register: docker_restart_result
      ignore_errors: true
      failed_when: false
      when: '"server" in group_names'

    - name: Collect health check info
      ansible.builtin.shell: |
        set -euo pipefail
        echo "=== systemctl status signage-lite ==="
        systemctl status signage-lite --no-pager | head -n 20 || true
        echo "=== recent kiosk-browser logs ==="
        journalctl -u kiosk-browser.service -n 50 || true
      args:
        executable: /bin/bash
      register: health_info
      changed_when: false

    - name: Summarize deployment result
      ansible.builtin.debug:
        msg:
          - "Git: {{ 'changed' if git_result.changed else 'up-to-date' }}"
          - "Service restarts: {{ services_to_restart | join(', ') }}"

    - name: Attach health info to run output
      ansible.builtin.debug:
        var: health_info.stdout_lines

  post_tasks:
    - name: Collect failed hosts summary
      ansible.builtin.debug:
        msg: "Failed hosts: {{ ansible_failed_hosts | default([]) | join(', ') }}"
      when: ansible_failed_hosts | default([]) | length > 0
      run_once: true

    - name: Collect unreachable hosts summary
      ansible.builtin.debug:
        msg: "Unreachable hosts: {{ ansible_unreachable_hosts | default([]) | join(', ') }}"
      when: ansible_unreachable_hosts | default([]) | length > 0
      run_once: true

    - name: Deployment summary
      ansible.builtin.debug:
        msg:
          - "=== Deployment Summary ==="
          - "Total hosts: {{ ansible_play_hosts | length }}"
          - "Successful: {{ ansible_play_hosts | difference(ansible_failed_hosts | default([])) | difference(ansible_unreachable_hosts | default([])) | length }}"
          - "Failed: {{ ansible_failed_hosts | default([]) | length }}"
          - "Unreachable: {{ ansible_unreachable_hosts | default([]) | length }}"
      run_once: true
