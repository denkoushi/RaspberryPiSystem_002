- name: Install production dependencies (optional)
  ansible.builtin.shell: |
    set -euo pipefail
    cd {{ repo_path }} && pnpm install --filter signage-lite-client --prod
  args:
    executable: /bin/bash
  register: install_result
  changed_when: "'added' in (install_result.stdout | default('')) or 'audited' in (install_result.stdout | default(''))"
  failed_when: false
  become: false
  become_user: "{{ ansible_user }}"
  when:
    - '"server" not in group_names'

# signage-update.shのIPアドレスを自動更新（ネットワーク変更時の再発防止）
- name: Update signage-update.sh server URL
  ansible.builtin.replace:
    path: /usr/local/bin/signage-update.sh
    regexp: 'SERVER_URL=https?://[0-9.]+'
    replace: "SERVER_URL={{ signage_server_url }}"
    backup: true
  when:
    - '"server" not in group_names'
    - signage_server_url is defined
    - manage_signage_lite | default(false) | bool
  register: signage_update_script_result

- name: Re-enable signage-lite service before restart
  ansible.builtin.systemd:
    name: signage-lite.service
    enabled: true
  when:
    - '"server" not in group_names'
    - manage_signage_lite | default(false) | bool

- name: Re-enable signage-lite update timer before restart
  ansible.builtin.systemd:
    name: signage-lite-update.timer
    enabled: true
  when:
    - '"server" not in group_names'
    - manage_signage_lite | default(false) | bool

- name: Start signage-lite update timer
  ansible.builtin.systemd:
    name: signage-lite-update.timer
    state: started
  when:
    - '"server" not in group_names'
    - manage_signage_lite | default(false) | bool

- name: Start signage-lite service
  ansible.builtin.systemd:
    name: signage-lite.service
    state: started
  when:
    - '"server" not in group_names'
    - manage_signage_lite | default(false) | bool

- name: Collect health check info
  ansible.builtin.shell: |
    set -euo pipefail
    echo "=== systemctl status signage-lite ==="
    systemctl status signage-lite --no-pager | head -n 20 || true
    echo "=== recent kiosk-browser logs ==="
    journalctl -u kiosk-browser.service -n 50 || true
  args:
    executable: /bin/bash
  register: health_info
  changed_when: false

- name: Summarize deployment result
  ansible.builtin.debug:
    msg:
      - "Git: {{ 'changed' if git_result.changed else 'up-to-date' }}"
      - "Client service restart summary: {{ client_restart_results | default([]) }}"
      - "Docker restart summary: {{ docker_restart_summary | default([]) }}"

- name: Attach health info to run output
  ansible.builtin.debug:
    var: health_info.stdout_lines

- name: Verify kiosk UI is reachable
  ansible.builtin.uri:
    url: "{{ kiosk_url }}"
    method: GET
    validate_certs: false
    status_code: 200
  register: kiosk_health
  retries: 5
  delay: 5
  until: kiosk_health.status == 200
  when:
    - '"server" not in group_names'
    - kiosk_url is defined

- name: Verify signage status endpoint is reachable
  ansible.builtin.uri:
    url: "{{ signage_server_url }}/api/signage/render/status"
    method: GET
    validate_certs: false
    status_code: [200, 401]  # 401も許容（認証エラーは別途確認）
    headers:
      x-client-key: "{{ signage_client_key | default('') }}"
  register: signage_health
  retries: 3
  delay: 3
  until: signage_health.status in [200, 401]
  failed_when: false  # 401エラーは警告として扱う（認証が必要なエンドポイントのため）
  when:
    - '"server" not in group_names'
    - signage_server_url is defined
    - signage_client_key is defined
    - manage_signage_lite | default(false) | bool

- name: Warn if signage status endpoint requires authentication
  ansible.builtin.debug:
    msg: "Signage status endpoint returned 401 (authentication required). This is expected if the endpoint requires a token."
  when:
    - '"server" not in group_names'
    - signage_health.status | default(0) == 401
    - manage_signage_lite | default(false) | bool
