---
# Preflight tasks for Pi3 signage deployment
# These tasks ensure Pi3 is in a safe state before deployment:
# - Stop and disable services/timers to free memory
# - Mask services to prevent auto-restart
# - Clean up stale Ansible processes
# - Verify sufficient memory is available

- name: Preflight checks for Pi3 signage deployment
  block:
    - name: Stop and disable signage-lite update timer
      ansible.builtin.systemd:
        name: signage-lite-update.timer
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Stop and disable signage-lite watchdog timer
      ansible.builtin.systemd:
        name: signage-lite-watchdog.timer
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Stop and disable signage-daily-reboot timer
      ansible.builtin.systemd:
        name: signage-daily-reboot.timer
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Stop and disable status-agent timer
      ansible.builtin.systemd:
        name: status-agent.timer
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Stop signage-lite service
      ansible.builtin.systemd:
        name: signage-lite.service
        state: stopped
      ignore_errors: true

    - name: Disable signage-lite service
      ansible.builtin.systemd:
        name: signage-lite.service
        enabled: false
      ignore_errors: true

    - name: Mask signage-lite service (runtime only, prevents auto-restart)
      ansible.builtin.shell: systemctl mask --runtime signage-lite.service
      register: mask_result
      changed_when: mask_result.rc == 0
      failed_when: false
      # Note: --runtime mask does not conflict with existing service files
      # It creates a runtime-only symlink that prevents auto-restart during deployment

    # Pi3はメモリが非常に限られているため(416MB)、デプロイ中はlightdmを停止して
    # 約100MBのメモリを確保する。デプロイ完了後にPi3を再起動してGUIを復活させる。
    - name: Stop lightdm to free memory for deployment (Pi3 only)
      ansible.builtin.systemd:
        name: lightdm
        state: stopped
      register: lightdm_stopped
      ignore_errors: true
    # region agent log
    - name: Capture signage-lite unit file state after mask attempt
      ansible.builtin.shell: |
        set -euo pipefail
        if [ -e /etc/systemd/system/signage-lite.service ]; then
          if [ -L /etc/systemd/system/signage-lite.service ]; then
            echo "symlink:$(readlink -f /etc/systemd/system/signage-lite.service)"
          else
            echo "file"
          fi
        else
          echo "missing"
        fi
      register: signage_unit_state
      changed_when: false

    - name: Capture signage-lite systemd states
      ansible.builtin.shell: |
        set -euo pipefail
        echo "enabled=$(systemctl is-enabled signage-lite.service 2>/dev/null || true)"
        echo "active=$(systemctl is-active signage-lite.service 2>/dev/null || true)"
        echo "update_enabled=$(systemctl is-enabled signage-lite-update.timer 2>/dev/null || true)"
      register: signage_systemd_state
      changed_when: false

    - name: Log preflight systemd state
      ansible.builtin.shell: "printf '%s\n' {{ log_payload | to_json | quote }} >> {{ lookup('env', 'HOME') }}/.cursor/debug.log 2>/dev/null || true"
      delegate_to: localhost
      changed_when: false
      ignore_errors: true
      vars:
        log_payload:
          sessionId: "debug-session"
          runId: "preflight"
          hypothesisId: "H1"
          location: "infrastructure/ansible/tasks/preflight-pi3-signage.yml"
          message: "preflight_systemd_state"
          data:
            host: "{{ inventory_hostname }}"
            unit_file_state: "{{ signage_unit_state.stdout | default('') }}"
            systemd_state: "{{ signage_systemd_state.stdout | default('') }}"
          timestamp: "{{ lookup('pipe', 'python3 -c \"import time;print(int(time.time()*1000))\"') }}"
    # endregion

    - name: Wait for services to fully stop
      ansible.builtin.pause:
        seconds: 3

    - name: Clean up stale Ansible processes (AnsiballZ older than 120 seconds)
      ansible.builtin.shell: |
        set -euo pipefail
        ps aux | grep -E 'AnsiballZ_.*\.py' | grep -v grep | while read line; do
          pid=$(echo "$line" | awk '{print $2}')
          etimes=$(ps -o etimes= -p "$pid" 2>/dev/null || echo "0")
          if [ "$etimes" -gt 120 ]; then
            echo "Killing stale Ansible process: PID=$pid, etimes=${etimes}s"
            kill -9 "$pid" 2>/dev/null || true
          fi
        done
      register: cleanup_result
      changed_when: cleanup_result.stdout | length > 0
      failed_when: false

    - name: Check available memory
      ansible.builtin.shell: free -m | awk '/^Mem:/ {print $7}'
      register: available_memory_mb_raw
      changed_when: false

    - name: Extract available memory value
      ansible.builtin.set_fact:
        available_memory_mb: "{{ available_memory_mb_raw.stdout | trim | int }}"
    # region agent log
    - name: Log preflight memory snapshot
      ansible.builtin.shell: "printf '%s\n' {{ log_payload | to_json | quote }} >> {{ lookup('env', 'HOME') }}/.cursor/debug.log 2>/dev/null || true"
      delegate_to: localhost
      changed_when: false
      ignore_errors: true
      vars:
        log_payload:
          sessionId: "debug-session"
          runId: "preflight"
          hypothesisId: "H2"
          location: "infrastructure/ansible/tasks/preflight-pi3-signage.yml"
          message: "preflight_memory_snapshot"
          data:
            host: "{{ inventory_hostname }}"
            available_memory_mb: "{{ available_memory_mb | default(0) }}"
            raw_memory_stdout: "{{ available_memory_mb_raw.stdout | default('') }}"
          timestamp: "{{ lookup('pipe', 'python3 -c \"import time;print(int(time.time()*1000))\"') }}"
    # endregion

    - name: Fail if insufficient memory available
      ansible.builtin.fail:
        msg: >
          CRITICAL: Insufficient memory available on {{ inventory_hostname }}.
          Available: {{ available_memory_mb }}MB (required: >= 120MB)
          
          To free memory, manually stop the following services:
          - sudo systemctl stop signage-lite.service
          - sudo systemctl stop signage-lite-update.timer
          - sudo systemctl stop signage-lite-watchdog.timer
          - sudo systemctl stop signage-daily-reboot.timer
          - sudo systemctl stop status-agent.timer
          
          Then wait a few seconds and retry deployment.
      when: available_memory_mb | default(0) < 120

