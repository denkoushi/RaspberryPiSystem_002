---
- name: Check if {{ service_name }} exists
  ansible.builtin.command: "systemctl list-unit-files {{ service_name }} --no-pager"
  register: service_exists_check
  changed_when: false
  failed_when: false

- block:
    - name: Check if {{ service_name }} is enabled
      ansible.builtin.command: "systemctl is-enabled {{ service_name }}"
      register: service_enabled_check
      changed_when: false
      failed_when: false

    - name: Re-enable {{ service_name }} if disabled
      ansible.builtin.systemd:
        name: "{{ service_name }}"
        enabled: true
      when: service_enabled_check.rc != 0

    - name: Restart {{ service_name }} on client
      ansible.builtin.systemd:
        name: "{{ service_name }}"
        state: restarted
        daemon_reload: true
      register: client_service_restart
      retries: 3
      delay: 10
      until: client_service_restart is succeeded

    - name: Wait for {{ service_name }} to settle
      ansible.builtin.pause:
        seconds: 2

    - name: Check if {{ service_name }} is a oneshot service
      ansible.builtin.command: "systemctl show {{ service_name }} --property=Type --value"
      register: service_type_check
      changed_when: false
      failed_when: false
      when: service_name is match('.*\\.service$')

    - name: Verify {{ service_name }} is active (for non-oneshot services)
      ansible.builtin.command: "systemctl is-active {{ service_name }}"
      register: client_service_status
      changed_when: false
      failed_when: client_service_status.stdout.strip() not in ['active', 'activating']
      retries: 3
      delay: 5
      until: client_service_status.stdout.strip() in ['active', 'activating']
      when:
        - service_name is match('.*\\.service$')
        - service_type_check.stdout.strip() | default('') != 'oneshot'

    - name: Ensure {{ service_name }} result is success
      ansible.builtin.command: "systemctl show {{ service_name }} --property=Result --value"
      register: client_service_result
      changed_when: false
      failed_when: client_service_result.stdout.strip() not in ['success', 'none', 'na']
      when: service_name is match('.*\\.service$')

    - name: Ensure {{ service_name }} is not in failed state
      ansible.builtin.command: "systemctl is-failed {{ service_name }}"
      register: client_service_failed_check
      changed_when: false
      failed_when: client_service_failed_check.rc == 0
      when: service_name is match('.*\\.service$')

    - name: Record restart success for {{ service_name }}
      ansible.builtin.set_fact:
        client_restart_results: "{{ (client_restart_results | default([])) + [ {'service': service_name, 'status': 'ok'} ] }}"
  when: service_exists_check.rc == 0
  rescue:
    - name: Check if service does not exist (skip silently)
      ansible.builtin.fail:
        msg: "Service {{ service_name }} does not exist, skipping"
      when: service_exists_check.rc != 0
      failed_when: false

    - name: Capture latest logs for {{ service_name }}
      ansible.builtin.shell: |
        set -euo pipefail
        journalctl -u {{ service_name }} -n 50 --no-pager || true
      args:
        executable: /bin/bash
      register: client_service_logs
      changed_when: false
      when: service_exists_check.rc == 0

    - name: Record restart failure for {{ service_name }}
      ansible.builtin.set_fact:
        client_restart_results: "{{ (client_restart_results | default([])) + [ {'service': service_name, 'status': 'failed', 'log': client_service_logs.stdout | default('')} ] }}"
      when: service_exists_check.rc == 0

    - name: Fail current host due to service restart failure
      ansible.builtin.fail:
        msg: >
          Service {{ service_name }} failed to restart on {{ inventory_hostname }}.
          See journal snippet above for details.
      when: service_exists_check.rc == 0
