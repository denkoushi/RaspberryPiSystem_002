---
- name: Ensure docker restart summary fact exists
  ansible.builtin.set_fact:
    docker_restart_summary: "{{ docker_restart_summary | default([]) }}"

- name: Validate required API variables
  ansible.builtin.assert:
    that:
      - api_database_url is defined
      - api_jwt_access_secret is defined
      - api_jwt_refresh_secret is defined
    fail_msg: "API環境変数が定義されていません（inventory.ymlを確認してください）"

- name: Validate required Web variables
  ansible.builtin.assert:
    that:
      - web_api_base_url is defined
      - web_agent_ws_url is defined
    fail_msg: "Web環境変数（VITE_*）が定義されていません（inventory.ymlを確認してください）"

- name: Validate required Docker Compose variables
  ansible.builtin.assert:
    that:
      - docker_server_ip is defined
    fail_msg: "Docker Compose用SERVER_IPが定義されていません（inventory.ymlを確認してください）"

- name: Ensure API .env directory exists
  ansible.builtin.file:
    path: "{{ repo_path }}/apps/api"
    state: directory
    mode: '0755'

- name: Deploy API environment variables
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/api.env.j2"
    dest: "{{ repo_path }}/apps/api/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  register: api_env_result

- name: Ensure Web .env directory exists
  ansible.builtin.file:
    path: "{{ repo_path }}/apps/web"
    state: directory
    mode: '0755'

- name: Deploy Web environment variables
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/web.env.j2"
    dest: "{{ repo_path }}/apps/web/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  register: web_env_result

- name: Ensure Docker Compose .env directory exists
  ansible.builtin.file:
    path: "{{ repo_path }}/infrastructure/docker"
    state: directory
    mode: '0755'

- name: Ensure power action queue directory exists
  ansible.builtin.file:
    path: "{{ repo_path }}/power-actions"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Stat existing Docker Compose .env
  ansible.builtin.stat:
    path: "{{ repo_path }}/infrastructure/docker/.env"
  register: docker_env_stat

- name: Read existing Docker Compose .env (for preserving manual values)
  ansible.builtin.slurp:
    path: "{{ repo_path }}/infrastructure/docker/.env"
  register: docker_env_slurp
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing SLACK_KIOSK_SUPPORT_WEBHOOK_URL from Docker Compose .env
  ansible.builtin.set_fact:
    existing_slack_kiosk_support_webhook_url: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^SLACK_KIOSK_SUPPORT_WEBHOOK_URL=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing DROPBOX_APP_KEY from Docker Compose .env
  ansible.builtin.set_fact:
    existing_dropbox_app_key: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^DROPBOX_APP_KEY=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing DROPBOX_APP_SECRET from Docker Compose .env
  ansible.builtin.set_fact:
    existing_dropbox_app_secret: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^DROPBOX_APP_SECRET=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing DROPBOX_REFRESH_TOKEN from Docker Compose .env
  ansible.builtin.set_fact:
    existing_dropbox_refresh_token: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^DROPBOX_REFRESH_TOKEN=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing DROPBOX_ACCESS_TOKEN from Docker Compose .env
  ansible.builtin.set_fact:
    existing_dropbox_access_token: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^DROPBOX_ACCESS_TOKEN=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing ALERTS_DISPATCHER_ENABLED from Docker Compose .env
  ansible.builtin.set_fact:
    existing_alerts_dispatcher_enabled: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^ALERTS_DISPATCHER_ENABLED=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing ALERTS_SLACK_WEBHOOK_DEPLOY from Docker Compose .env
  ansible.builtin.set_fact:
    existing_alerts_slack_webhook_deploy: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^ALERTS_SLACK_WEBHOOK_DEPLOY=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing ALERTS_SLACK_WEBHOOK_OPS from Docker Compose .env
  ansible.builtin.set_fact:
    existing_alerts_slack_webhook_ops: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^ALERTS_SLACK_WEBHOOK_OPS=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing ALERTS_SLACK_WEBHOOK_SECURITY from Docker Compose .env
  ansible.builtin.set_fact:
    existing_alerts_slack_webhook_security: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^ALERTS_SLACK_WEBHOOK_SECURITY=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Extract existing ALERTS_SLACK_WEBHOOK_SUPPORT from Docker Compose .env
  ansible.builtin.set_fact:
    existing_alerts_slack_webhook_support: >-
      {{
        (
          (
            (docker_env_slurp.content | b64decode)
            | regex_findall('^ALERTS_SLACK_WEBHOOK_SUPPORT=(.*)$', multiline=True)
          )
          | first
        )
        | default('')
      }}
  when: docker_env_stat.stat.exists | default(false)
  no_log: true

- name: Deploy Docker Compose environment variables
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/docker.env.j2"
    dest: "{{ repo_path }}/infrastructure/docker/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  register: docker_env_result

- name: Validate API .env syntax
  ansible.builtin.shell: |
    python3 - <<'PY'
    from pathlib import Path
    path = Path("{{ repo_path }}/apps/api/.env")
    invalid = []
    for lineno, line in enumerate(path.read_text().splitlines(), 1):
        stripped = line.strip()
        if not stripped or stripped.startswith("#"):
            continue
        if "=" not in stripped:
            invalid.append(f"{lineno}:{line}")
    if invalid:
        raise SystemExit("Invalid API .env lines -> " + ", ".join(invalid))
    PY
  when: api_env_result.changed | default(false)
  changed_when: false

- name: Validate Web .env syntax
  ansible.builtin.shell: |
    python3 - <<'PY'
    from pathlib import Path
    path = Path("{{ repo_path }}/apps/web/.env")
    invalid = []
    for lineno, line in enumerate(path.read_text().splitlines(), 1):
        stripped = line.strip()
        if not stripped or stripped.startswith("#"):
            continue
        if "=" not in stripped:
            invalid.append(f"{lineno}:{line}")
    if invalid:
        raise SystemExit("Invalid Web .env lines -> " + ", ".join(invalid))
    PY
  when: web_env_result.changed | default(false)
  changed_when: false

- name: Validate Docker Compose .env syntax
  ansible.builtin.shell: |
    python3 - <<'PY'
    from pathlib import Path
    path = Path("{{ repo_path }}/infrastructure/docker/.env")
    invalid = []
    for lineno, line in enumerate(path.read_text().splitlines(), 1):
        stripped = line.strip()
        if not stripped or stripped.startswith("#"):
            continue
        if "=" not in stripped:
            invalid.append(f"{lineno}:{line}")
    if invalid:
        raise SystemExit("Invalid docker .env lines -> " + ", ".join(invalid))
    PY
  when: docker_env_result.changed | default(false)
  changed_when: false

- name: Apply server security hardening
  ansible.builtin.import_tasks: security.yml

- name: Apply malware protection tasks
  ansible.builtin.import_tasks: malware.yml

- name: Configure security monitoring
  ansible.builtin.import_tasks: monitoring.yml

- name: Rebuild and restart Docker services on server when repo changed
  block:
    - name: Rebuild/Restart docker compose services
      ansible.builtin.shell: |
        set -euo pipefail
        cd {{ repo_path }}
        docker compose -f infrastructure/docker/docker-compose.server.yml up -d --force-recreate --build api web
      args:
        executable: /bin/bash
      register: docker_restart_result
      retries: 3
      delay: 10
      until: docker_restart_result is succeeded
      failed_when: docker_restart_result.rc != 0

    - name: Record docker restart success
      ansible.builtin.set_fact:
        docker_restart_summary: "{{ docker_restart_summary + [ {'status': 'ok'} ] }}"
  rescue:
    - name: Capture docker compose logs
      ansible.builtin.shell: |
        set -euo pipefail
        if command -v docker >/dev/null 2>&1; then
          cd {{ repo_path }} && docker compose -f infrastructure/docker/docker-compose.server.yml logs --tail=50 api web
        else
          echo "[WARN] docker command not found. Showing systemd logs instead."
          journalctl -u docker.service -n 100 || true
        fi
      args:
        executable: /bin/bash
      register: docker_restart_logs
      changed_when: false

    - name: Record docker restart failure
      ansible.builtin.set_fact:
        docker_restart_summary: "{{ docker_restart_summary + [ {'status': 'failed', 'log': docker_restart_logs.stdout | default('')} ] }}"

    - name: Fail current host due to docker restart failure
      ansible.builtin.fail:
        msg: >
          Docker Compose restart failed on {{ inventory_hostname }}.
          See captured logs above for details.
  when: (repo_changed | default(false)) or (force_docker_rebuild | default(false) | bool)

- name: Force recreate api when Docker .env changed
  ansible.builtin.shell: |
    set -euo pipefail
    cd {{ repo_path }}
    docker compose -f infrastructure/docker/docker-compose.server.yml up -d --force-recreate api
  args:
    executable: /bin/bash
  when:
    - docker_env_result.changed | default(false)

- name: Run Prisma migrations on server (fail-fast)
  block:
    - name: Run prisma migrate deploy
      ansible.builtin.shell: |
        set -euo pipefail
        cd {{ repo_path }}
        docker compose -f infrastructure/docker/docker-compose.server.yml exec -T api pnpm prisma migrate deploy
      args:
        executable: /bin/bash
      register: prisma_migrate_deploy_result
      retries: 3
      delay: 5
      until: prisma_migrate_deploy_result is succeeded
      changed_when: false

    - name: Run prisma migrate status
      ansible.builtin.shell: |
        set -euo pipefail
        cd {{ repo_path }}
        docker compose -f infrastructure/docker/docker-compose.server.yml exec -T api pnpm prisma migrate status
      args:
        executable: /bin/bash
      register: prisma_migrate_status_result
      changed_when: false
  rescue:
    - name: Capture docker compose logs after migration failure
      ansible.builtin.shell: |
        set -euo pipefail
        cd {{ repo_path }}
        docker compose -f infrastructure/docker/docker-compose.server.yml logs --tail=80 api db
      args:
        executable: /bin/bash
      register: prisma_migrate_logs
      changed_when: false

    - name: Fail current host due to migration failure
      ansible.builtin.fail:
        msg: >
          Prisma migration failed on {{ inventory_hostname }}.
          See captured logs above for details.

- name: Wait for API health endpoint to recover
  ansible.builtin.uri:
    url: "{{ api_healthcheck_url }}"
    method: GET
    status_code: 200
    return_content: true
    validate_certs: false  # 自己署名証明書対応
  register: api_health_result
  retries: 8
  delay: 5
  until:
    - api_health_result.status == 200
    - (api_health_result.json.status | default('')) == 'ok'

- name: Verify API container environment variables after .env update
  ansible.builtin.shell: |
    set -euo pipefail
    cd {{ repo_path }}
    ENV_OUTPUT="$(docker compose -f infrastructure/docker/docker-compose.server.yml exec -T api printenv)"

    get_env_value() {
      local key="$1"
      printf "%s\n" "${ENV_OUTPUT}" | awk -F= -v k="${key}" '$1==k {print substr($0, index($0,"=")+1)}'
    }

    missing=()
    dispatcher_enabled="$(get_env_value 'ALERTS_DISPATCHER_ENABLED')"

    if [ "${dispatcher_enabled}" = "true" ]; then
      for key in ALERTS_SLACK_WEBHOOK_DEPLOY ALERTS_SLACK_WEBHOOK_OPS ALERTS_SLACK_WEBHOOK_SECURITY ALERTS_SLACK_WEBHOOK_SUPPORT; do
        value="$(get_env_value "${key}")"
        if [ -z "${value}" ]; then
          missing+=("${key}")
        fi
      done
    fi

    kiosk_support="$(get_env_value 'SLACK_KIOSK_SUPPORT_WEBHOOK_URL')"
    if [ -z "${kiosk_support}" ]; then
      missing+=("SLACK_KIOSK_SUPPORT_WEBHOOK_URL")
    fi

    missing_count="$(printf '%s\n' "${missing[@]}" | wc -l | tr -d ' ')"
    if [ "${missing_count}" -gt 0 ]; then
      printf "Missing required environment variables: %s\n" "$(IFS=,; echo "${missing[*]}")" >&2
      exit 1
    fi
  args:
    executable: /bin/bash
  when:
    - docker_env_result.changed | default(false)
  changed_when: false

- name: Apply status-agent configuration and systemd units
  ansible.builtin.import_tasks: status-agent.yml

- name: Deploy Pi5 power dispatcher script
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/pi5-power-dispatcher.sh.j2"
    dest: /usr/local/bin/pi5-power-dispatcher.sh
    owner: root
    group: root
    mode: '0755'

- name: Deploy Pi5 power dispatcher systemd service
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/pi5-power-dispatcher.service.j2"
    dest: /etc/systemd/system/pi5-power-dispatcher.service
    owner: root
    group: root
    mode: '0644'

- name: Deploy Pi5 power dispatcher systemd path
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/pi5-power-dispatcher.path.j2"
    dest: /etc/systemd/system/pi5-power-dispatcher.path
    owner: root
    group: root
    mode: '0644'

- name: Reload systemd for power dispatcher units
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable and start power dispatcher path
  ansible.builtin.systemd:
    name: pi5-power-dispatcher.path
    enabled: true
    state: started
