---
- name: Check if curl is already installed
  ansible.builtin.command: which curl
  register: curl_check
  failed_when: false
  changed_when: false

- name: Ensure curl is installed (required for Tailscale install script)
  ansible.builtin.package:
    name: curl
    state: present
  when: curl_check.rc != 0

- name: Install Tailscale package
  ansible.builtin.shell: |
    set -euo pipefail
    curl -fsSL {{ tailscale_install_script }} | sh
  args:
    executable: /bin/bash
    creates: /usr/sbin/tailscaled

- name: Ensure tailscaled service is enabled and started
  ansible.builtin.service:
    name: tailscaled
    enabled: true
    state: started

- name: Check current Tailscale status
  ansible.builtin.command: tailscale status --json
  register: tailscale_status
  failed_when: false
  changed_when: false

- name: Parse current Tailscale backend state
  ansible.builtin.set_fact:
    tailscale_backend_state: "{{ ((tailscale_status.stdout | default('{}')) | from_json).BackendState | default('') }}"
  when: tailscale_status.rc == 0

- name: Determine if Tailscale is connected
  ansible.builtin.set_fact:
    tailscale_connected: "{{ tailscale_backend_state | default('') == 'Running' }}"
  when: tailscale_status.rc == 0

- name: Bring up Tailscale with auth key
  ansible.builtin.command: >-
    tailscale up {{ tailscale_extra_args }}
    --authkey={{ tailscale_auth_key }}
  when:
    - (tailscale_connected | default(false)) | bool == false
    - tailscale_auth_key | default('') | length > 0
  no_log: true

- name: Fail when tailscale_auth_key is missing and Tailscale is not connected
  ansible.builtin.fail:
    msg: >-
      tailscale_auth_key が未設定のため、{{ inventory_hostname }} で
      Tailscale を自動で有効化できません。
      先に vault_tailscale_auth_key を設定するか、
      既に接続済みであることを確認してください。
  when:
    - (tailscale_connected | default(false)) | bool == false
    - tailscale_auth_key | default('') | length == 0

