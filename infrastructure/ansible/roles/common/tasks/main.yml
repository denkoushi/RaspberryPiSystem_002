---
- name: Ensure repository parent directory exists
  ansible.builtin.file:
    path: "{{ repo_path }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Generate backup timestamp
  ansible.builtin.set_fact:
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"
  when: '"server" not in group_names'

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ backup_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  when: '"server" not in group_names'

- name: Check existing polkit rule
  ansible.builtin.stat:
    path: /etc/polkit-1/rules.d/50-pcscd-allow-all.rules
  register: polkit_rule_stat
  when: '"server" not in group_names'

- name: Backup polkit rule before deployment
  ansible.builtin.copy:
    src: /etc/polkit-1/rules.d/50-pcscd-allow-all.rules
    dest: "{{ backup_dir }}/polkit-50-pcscd-allow-all.rules.{{ backup_timestamp }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
    remote_src: true
  when:
    - '"server" not in group_names'
    - polkit_rule_stat.stat.exists

- name: Check systemd service files to back up
  ansible.builtin.stat:
    path: "/etc/systemd/system/{{ item }}"
  loop: "{{ backup_service_files }}"
  register: service_backup_stats
  when: '"server" not in group_names'

- name: Backup systemd service units before deployment
  ansible.builtin.copy:
    src: "/etc/systemd/system/{{ item.item }}"
    dest: "{{ backup_dir }}/{{ item.item }}.{{ backup_timestamp }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
    remote_src: true
  loop: "{{ service_backup_stats.results | default([]) }}"
  when:
    - '"server" not in group_names'
    - item.stat.exists

- name: Check if repository exists
  ansible.builtin.stat:
    path: "{{ repo_path }}/.git"
  register: repo_git_stat

- name: Check host_vars directory exists
  ansible.builtin.stat:
    path: "{{ repo_path }}/infrastructure/ansible/host_vars"
  register: host_vars_stat
  when: repo_git_stat.stat.exists | default(false)

- name: Find vault.yml files in host_vars
  ansible.builtin.find:
    paths: "{{ repo_path }}/infrastructure/ansible/host_vars"
    patterns: "vault.yml"
    file_type: file
  register: vault_files
  when:
    - repo_git_stat.stat.exists | default(false)
    - host_vars_stat.stat.exists | default(false)

- name: Fix vault.yml ownership if needed
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  loop: "{{ vault_files.files | default([]) }}"
  loop_control:
    label: "{{ item.path }}"
  when:
    - repo_git_stat.stat.exists | default(false)
    - host_vars_stat.stat.exists | default(false)
    - (vault_files.matched | default(0)) | int > 0
    - ansible_user is defined
  become: true

- name: Capture current repo HEAD (if exists)
  ansible.builtin.shell: |
    set -euo pipefail
    cd "{{ repo_path }}"
    git rev-parse HEAD
  args:
    executable: /bin/bash
  register: repo_prev_head
  changed_when: false
  failed_when: false
  when: repo_git_stat.stat.exists | default(false)

- name: Sync repository to desired state (with retries)
  ansible.builtin.shell: |
    set -euo pipefail
    if [ ! -d "{{ repo_path }}/.git" ]; then
      rm -rf "{{ repo_path }}"
      git clone {{ repo_remote | quote }} "{{ repo_path }}"
    fi
    cd "{{ repo_path }}"
    git remote set-url origin {{ repo_remote | quote }}
    git fetch --all --prune --tags
    git checkout {{ repo_version | quote }}
    git reset --hard origin/{{ repo_version | quote }}
  args:
    executable: /bin/bash
  environment: "{{ git_environment }}"
  register: git_result
  retries: 3
  delay: 10
  until: git_result.rc == 0

- name: Capture repo HEAD after sync
  ansible.builtin.shell: |
    set -euo pipefail
    cd "{{ repo_path }}"
    git rev-parse HEAD
  args:
    executable: /bin/bash
  register: repo_new_head
  changed_when: false

- name: Determine if repo changed
  ansible.builtin.set_fact:
    repo_prev_head: "{{ repo_prev_head.stdout | default('') }}"
    repo_new_head: "{{ repo_new_head.stdout | default('') }}"
    repo_changed: "{{ (repo_prev_head.stdout | default('')) != (repo_new_head.stdout | default('')) }}"

- name: Collect repo diff file list (for docker build decision)
  ansible.builtin.shell: |
    set -euo pipefail
    cd "{{ repo_path }}"
    git diff --name-only "{{ repo_prev_head.stdout }}" "{{ repo_new_head.stdout }}"
  args:
    executable: /bin/bash
  register: repo_diff_files_raw
  changed_when: false
  failed_when: false
  when:
    - (repo_prev_head.stdout | default('')) != ''
    - (repo_new_head.stdout | default('')) != ''

- name: Determine if docker build is needed on server
  ansible.builtin.set_fact:
    repo_changed_files: "{{ repo_diff_files_raw.stdout_lines | default([]) }}"
    repo_diff_unavailable: >-
      {{
        (repo_prev_head.stdout | default('')) == ''
        or (repo_new_head.stdout | default('')) == ''
        or (repo_diff_files_raw.rc | default(0)) != 0
      }}
    server_docker_build_needed: >-
      {{
        (repo_prev_head.stdout | default('')) == ''
        or (repo_new_head.stdout | default('')) == ''
        or (repo_diff_files_raw.rc | default(0)) != 0
        or (repo_diff_files_raw.stdout_lines | default([]) | select('match', '^apps/(api|web)/') | list | length > 0)
        or (repo_diff_files_raw.stdout_lines | default([]) | select('match', '^packages/') | list | length > 0)
        or (repo_diff_files_raw.stdout_lines | default([]) | select('match', '^pnpm-lock\\.yaml$') | list | length > 0)
        or (repo_diff_files_raw.stdout_lines | default([]) | select('match', '^package\\.json$') | list | length > 0)
        or (repo_diff_files_raw.stdout_lines | default([]) | select('match', '^pnpm-workspace\\.yaml$') | list | length > 0)
        or (repo_diff_files_raw.stdout_lines | default([]) | select('match', '^infrastructure/docker/') | list | length > 0)
        or (repo_diff_files_raw.stdout_lines | default([]) | select('match', '^apps/api/prisma/') | list | length > 0)
      }}

- name: Fix .git directory ownership (prevent detached execution failures)
  ansible.builtin.file:
    path: "{{ repo_path }}/.git"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: true
    state: directory
  when:
    - repo_git_stat.stat.exists | default(false)
    - ansible_user is defined
  changed_when: false
  # Note: This task ensures .git directory is owned by ansible_user to prevent
  # permission errors during detached execution (KB-219)

- name: Remove unnecessary documentation directory to save storage
  ansible.builtin.file:
    path: "{{ repo_path }}/docs"
    state: absent
  register: docs_removal_result
  changed_when: docs_removal_result.path is defined

- name: Configure Tailscale when enabled
  ansible.builtin.import_tasks: tailscale.yml
  when: tailscale_enabled | default(false)
