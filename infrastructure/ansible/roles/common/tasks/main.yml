---
- name: Ensure repository parent directory exists
  become: true
  ansible.builtin.file:
    path: "{{ repo_path }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Check .git directory exists (permission healing)
  ansible.builtin.stat:
    path: "{{ repo_path }}/.git"
  register: repo_git_dir

- name: Ensure .git directory ownership is correct (prevents git fetch permission errors)
  become: true
  ansible.builtin.file:
    path: "{{ repo_path }}/.git"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: true
  when: repo_git_dir.stat.exists

- name: Generate backup timestamp
  ansible.builtin.set_fact:
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"
  when: '"server" not in group_names'

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ backup_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  when: '"server" not in group_names'

- name: Check existing polkit rule
  ansible.builtin.stat:
    path: /etc/polkit-1/rules.d/50-pcscd-allow-all.rules
  register: polkit_rule_stat
  when: '"server" not in group_names'

- name: Backup polkit rule before deployment
  ansible.builtin.copy:
    src: /etc/polkit-1/rules.d/50-pcscd-allow-all.rules
    dest: "{{ backup_dir }}/polkit-50-pcscd-allow-all.rules.{{ backup_timestamp }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
    remote_src: true
  when:
    - '"server" not in group_names'
    - polkit_rule_stat.stat.exists

- name: Check systemd service files to back up
  ansible.builtin.stat:
    path: "/etc/systemd/system/{{ item }}"
  loop: "{{ backup_service_files }}"
  register: service_backup_stats
  when: '"server" not in group_names'

- name: Backup systemd service units before deployment
  ansible.builtin.copy:
    src: "/etc/systemd/system/{{ item.item }}"
    dest: "{{ backup_dir }}/{{ item.item }}.{{ backup_timestamp }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
    remote_src: true
  loop: "{{ service_backup_stats.results | default([]) }}"
  when:
    - '"server" not in group_names'
    - item.stat.exists

- name: Clean untracked files before checkout (excluding protected directories)
  block:
    - name: Run git clean with protected directories
      ansible.builtin.shell: |
        set -euo pipefail
        cd {{ repo_path }} && git clean -fd \
          -e storage/ -e 'storage/**' \
          -e certs/ -e 'certs/**' \
          -e alerts/ -e 'alerts/**' \
          -e logs/ -e 'logs/**'
      args:
        executable: /bin/bash
      register: git_clean_result
      changed_when: git_clean_result.stdout | length > 0
  rescue:
    - name: Warn when git clean failed
      ansible.builtin.debug:
        msg: >
          git clean failed on {{ inventory_hostname }} ({{ git_clean_result.stderr | default('no stderr') }}).
          Continuing because protected directories might not exist.

- name: Sync repository to desired state (with retries)
  ansible.builtin.shell: |
    set -euo pipefail
    if [ ! -d "{{ repo_path }}/.git" ]; then
      rm -rf "{{ repo_path }}"
      git clone {{ repo_remote | quote }} "{{ repo_path }}"
    fi
    cd "{{ repo_path }}"
    git remote set-url origin {{ repo_remote | quote }}
    git fetch --all --prune --tags
    # NOTE:
    # - ブランチ指定の場合、ローカルブランチが古いと `git reset --hard <branch>` では更新されない
    # - origin/<branch> が存在する場合はそれを基準にローカルブランチを更新する
    if git show-ref --verify --quiet "refs/remotes/origin/{{ repo_version }}"; then
      git checkout -B {{ repo_version | quote }} "origin/{{ repo_version }}"
    else
      git checkout {{ repo_version | quote }}
      git reset --hard {{ repo_version | quote }}
    fi
  args:
    executable: /bin/bash
  environment: "{{ git_environment }}"
  register: git_result
  retries: 3
  delay: 10
  until: git_result.rc == 0

- name: Remove unnecessary documentation directory to save storage
  ansible.builtin.file:
    path: "{{ repo_path }}/docs"
    state: absent
  register: docs_removal_result
  changed_when: docs_removal_result.path is defined

- name: Configure Tailscale when enabled
  ansible.builtin.import_tasks: tailscale.yml
  when: tailscale_enabled | default(false)
