---
- name: Install Japanese input method (ibus-mozc)
  ansible.builtin.apt:
    name:
      - ibus-mozc
      - ibus-gtk
      - ibus-gtk3
      - ibus-gtk4
    state: present
    update_cache: yes
  become: yes

- name: Create ibus autostart directory
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.config/autostart"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Deploy ibus autostart desktop file
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/ibus-autostart.desktop.j2"
    dest: "/home/{{ ansible_user }}/.config/autostart/ibus.desktop"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Persist IBus engine order and hotkey for kiosk user
  ansible.builtin.shell: |
    set -eu
    uid="$(id -u)"
    runtime_dir="/run/user/${uid}"
    bus="${runtime_dir}/bus"
    if [ ! -S "${bus}" ]; then
      echo "skip:no-user-bus"
      exit 0
    fi

    export XDG_RUNTIME_DIR="${runtime_dir}"
    export DBUS_SESSION_BUS_ADDRESS="unix:path=${bus}"

    changed=0
    desired_engines="['xkb:jp::jpn', 'mozc-jp']"
    current_engines="$(gsettings get org.freedesktop.ibus.general engines-order || true)"
    if [ "${current_engines}" != "${desired_engines}" ]; then
      gsettings set org.freedesktop.ibus.general engines-order "${desired_engines}"
      changed=1
    fi

    desired_triggers="['<Control>space']"
    current_triggers="$(gsettings get org.freedesktop.ibus.general.hotkey triggers || true)"
    if [ "${current_triggers}" != "${desired_triggers}" ]; then
      gsettings set org.freedesktop.ibus.general.hotkey triggers "${desired_triggers}"
      changed=1
    fi

    if [ "${changed}" -eq 1 ]; then
      echo "changed:ibus-settings"
    else
      echo "ok:ibus-settings"
    fi
  args:
    executable: /bin/bash
  become: yes
  become_user: "{{ ansible_user }}"
  changed_when: "'changed:ibus-settings' in ibus_settings_result.stdout"
  register: ibus_settings_result

- name: Deploy kiosk-launch script
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/kiosk-launch.sh.j2"
    dest: /usr/local/bin/kiosk-launch.sh
    owner: root
    group: root
    mode: '0755'
  when: manage_kiosk_browser | default(false) | bool
  register: kiosk_launch_script_result

- name: Deploy kiosk-browser.service
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/kiosk-browser.service.j2"
    dest: /etc/systemd/system/kiosk-browser.service
    owner: root
    group: root
    mode: '0644'
  when: manage_kiosk_browser | default(false) | bool
  register: kiosk_browser_result

- name: Validate kiosk-browser.service unit
  ansible.builtin.command: systemd-analyze verify /etc/systemd/system/kiosk-browser.service
  when:
    - manage_kiosk_browser | default(false) | bool
    - kiosk_browser_result is defined
    - kiosk_browser_result.changed
  changed_when: false

- name: Verify kiosk UI is reachable
  ansible.builtin.uri:
    url: "{{ kiosk_url }}"
    method: GET
    validate_certs: false
    status_code: 200
  register: kiosk_health
  retries: 5
  delay: 5
  until: kiosk_health.status == 200
  when:
    - kiosk_url is defined
    - manage_kiosk_browser | default(false) | bool

- name: Apply kiosk malware protection
  ansible.builtin.import_tasks: security.yml
