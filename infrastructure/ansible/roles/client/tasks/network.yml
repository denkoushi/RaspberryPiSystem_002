---
# NetworkManager Wi-Fi設定: 不要なネットワークへの自動接続を無効化し、認証ダイアログを抑制

- name: Check if NetworkManager is installed
  ansible.builtin.command: which nmcli
  register: nmcli_check
  changed_when: false
  failed_when: false

- name: Disable auto-connect for unknown WiFi networks (prevent password dialogs)
  ansible.builtin.shell: |
    set -euo pipefail
    # すべてのWi-Fi接続を取得
    connections=$(nmcli -t -f NAME,TYPE connection show | grep ':802-11-wireless' | cut -d: -f1 || true)
    if [ -n "$connections" ]; then
      while IFS= read -r conn_name; do
        if [ -n "$conn_name" ]; then
          # 自動接続を無効化（認証ダイアログを表示しない）
          nmcli connection modify "$conn_name" connection.autoconnect no 2>/dev/null || true
        fi
      done <<< "$connections"
    fi
  args:
    executable: /bin/bash
  when:
    - nmcli_check.rc == 0
  changed_when: false
  failed_when: false
  register: disable_autoconnect_result

- name: Ensure NetworkManager.conf exists
  ansible.builtin.file:
    path: /etc/NetworkManager/NetworkManager.conf
    state: touch
    mode: '0644'
  when: nmcli_check.rc == 0

- name: Ensure [main] section exists in NetworkManager.conf
  ansible.builtin.lineinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    regexp: '^\[main\]'
    line: '[main]'
    state: present
  when: nmcli_check.rc == 0
  register: networkmanager_conf_check

- name: Add no-auto-default configuration to NetworkManager
  ansible.builtin.lineinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    regexp: '^no-auto-default='
    line: 'no-auto-default=*'
    insertafter: '^\[main\]'
    state: present
  when:
    - nmcli_check.rc == 0
    - networkmanager_conf_check is defined

- name: Add auth-polkit=false to suppress password dialogs
  ansible.builtin.lineinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    regexp: '^auth-polkit='
    line: 'auth-polkit=false'
    insertafter: '^\[main\]'
    state: present
  when:
    - nmcli_check.rc == 0
    - networkmanager_conf_check is defined
  register: auth_polkit_setting

- name: Restart NetworkManager if configuration changed
  ansible.builtin.systemd:
    name: NetworkManager
    state: restarted
  when:
    - nmcli_check.rc == 0
    - auth_polkit_setting.changed | default(false)
