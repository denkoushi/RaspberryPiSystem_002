---
# NetworkManager Wi-Fi設定: 認証ダイアログを抑制（既存の接続は維持）
#
# 原因: Pi3/Pi4は既にPi5へのWi-Fi接続が確立されているが、NetworkManagerは複数の保存済みネットワークを管理している
# そのうちの一部（例: TP-Link_D2EC_5G_EXT）は認証情報が無効になっており、接続を試みる際に認証ダイアログが表示される
# 解決策: 認証ダイアログを抑制する設定を追加し、新しいネットワークへの自動接続を無効化する

- name: Check if NetworkManager is installed
  ansible.builtin.command: which nmcli
  register: nmcli_check
  changed_when: false
  failed_when: false

# 注意: すべてのWi-Fi接続の自動接続を無効化しない
# Pi3/Pi4からPi5への接続は維持する必要があるため、認証ダイアログを抑制する設定のみを適用

- name: Ensure NetworkManager.conf exists
  ansible.builtin.file:
    path: /etc/NetworkManager/NetworkManager.conf
    state: touch
    mode: '0644'
  when: nmcli_check.rc == 0

- name: Ensure [main] section exists in NetworkManager.conf
  ansible.builtin.lineinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    regexp: '^\[main\]'
    line: '[main]'
    state: present
  when: nmcli_check.rc == 0
  register: networkmanager_conf_check

- name: Add no-auto-default configuration to NetworkManager
  ansible.builtin.lineinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    regexp: '^no-auto-default='
    line: 'no-auto-default=*'
    insertafter: '^\[main\]'
    state: present
  when:
    - nmcli_check.rc == 0
    - networkmanager_conf_check is defined

- name: Add auth-polkit=false to suppress password dialogs
  ansible.builtin.lineinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    regexp: '^auth-polkit='
    line: 'auth-polkit=false'
    insertafter: '^\[main\]'
    state: present
  when:
    - nmcli_check.rc == 0
    - networkmanager_conf_check is defined
  register: auth_polkit_setting

- name: Restart NetworkManager if configuration changed
  ansible.builtin.systemd:
    name: NetworkManager
    state: restarted
  when:
    - nmcli_check.rc == 0
    - auth_polkit_setting.changed | default(false)
