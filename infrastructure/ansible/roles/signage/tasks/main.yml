---
- name: Pause signage-lite workload before deployment
  block:
    - name: Stop and disable signage-lite update timer (prevent auto-restart)
      ansible.builtin.systemd:
        name: signage-lite-update.timer
        state: stopped
        enabled: false
      register: signage_timer_stopped

    - name: Stop and disable signage-lite watchdog timer
      ansible.builtin.systemd:
        name: signage-lite-watchdog.timer
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Stop and disable signage-daily-reboot timer
      ansible.builtin.systemd:
        name: signage-daily-reboot.timer
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Disable signage-lite service to prevent auto-restart
      ansible.builtin.systemd:
        name: signage-lite.service
        enabled: false
      register: signage_service_disabled

    - name: Stop signage-lite service
      ansible.builtin.systemd:
        name: signage-lite.service
        state: stopped
      register: signage_service_stopped

    - name: Wait for signage-lite to fully stop
      ansible.builtin.pause:
        seconds: 3
      when: signage_service_stopped.changed | default(false)

- name: Install production dependencies (optional)
  ansible.builtin.shell: |
    set -euo pipefail
    cd {{ repo_path }} && pnpm install --filter signage-lite-client --prod
  args:
    executable: /bin/bash
  register: install_result
  changed_when: "'added' in (install_result.stdout | default('')) or 'audited' in (install_result.stdout | default(''))"
  failed_when: false

- name: Install tmpfiles configuration for /run/signage
  ansible.builtin.template:
    src: signage-lite.tmpfiles.conf.j2
    dest: /etc/tmpfiles.d/signage-lite.conf
    mode: '0644'
  notify: systemd-tmpfiles

- name: Ensure /run/signage directory exists (via tmpfiles)
  ansible.builtin.command:
    cmd: systemd-tmpfiles --create /etc/tmpfiles.d/signage-lite.conf
    creates: /run/signage
  changed_when: true

- name: Deploy signage-update.sh script
  ansible.builtin.template:
    src: signage-update.sh.j2
    dest: /usr/local/bin/signage-update.sh
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy signage-display.sh script
  ansible.builtin.template:
    src: signage-display.sh.j2
    dest: /usr/local/bin/signage-display.sh
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy signage-stop.sh script
  ansible.builtin.template:
    src: signage-stop.sh.j2
    dest: /usr/local/bin/signage-stop.sh
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy signage-lite-watchdog.sh script
  ansible.builtin.template:
    src: signage-lite-watchdog.sh.j2
    dest: /usr/local/bin/signage-lite-watchdog.sh
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy signage-lite.service
  ansible.builtin.template:
    src: signage-lite.service.j2
    dest: /etc/systemd/system/signage-lite.service
    mode: '0644'
  notify: systemd-reload

- name: Deploy signage-lite-update.service
  ansible.builtin.template:
    src: signage-lite-update.service.j2
    dest: /etc/systemd/system/signage-lite-update.service
    mode: '0644'
  notify: systemd-reload

- name: Deploy signage-lite-update.timer
  ansible.builtin.template:
    src: signage-lite-update.timer.j2
    dest: /etc/systemd/system/signage-lite-update.timer
    mode: '0644'
  notify: systemd-reload

- name: Deploy signage-lite-watchdog.service
  ansible.builtin.template:
    src: signage-lite-watchdog.service.j2
    dest: /etc/systemd/system/signage-lite-watchdog.service
    mode: '0644'
  notify: systemd-reload

- name: Deploy signage-lite-watchdog.timer
  ansible.builtin.template:
    src: signage-lite-watchdog.timer.j2
    dest: /etc/systemd/system/signage-lite-watchdog.timer
    mode: '0644'
  notify: systemd-reload

- name: Deploy signage-daily-reboot.service
  ansible.builtin.template:
    src: signage-daily-reboot.service.j2
    dest: /etc/systemd/system/signage-daily-reboot.service
    mode: '0644'
  notify: systemd-reload

- name: Deploy signage-daily-reboot.timer
  ansible.builtin.template:
    src: signage-daily-reboot.timer.j2
    dest: /etc/systemd/system/signage-daily-reboot.timer
    mode: '0644'
  notify: systemd-reload

- name: Ensure systemd units are reloaded
  ansible.builtin.systemd:
    daemon_reload: true

- name: Unmask signage-lite service (ensure it can be started after preflight runtime mask)
  ansible.builtin.shell: systemctl unmask signage-lite.service
  register: unmask_result
  changed_when: unmask_result.rc == 0
  failed_when: false
  # Note: systemctl unmask removes both runtime and persistent masks

- name: Re-enable signage-lite service (ensure enabled state convergence)
  ansible.builtin.systemd:
    name: signage-lite.service
    enabled: true

- name: Re-enable signage-lite update timer (ensure enabled state convergence)
  ansible.builtin.systemd:
    name: signage-lite-update.timer
    enabled: true

- name: Re-enable signage-lite watchdog timer (ensure enabled state convergence)
  ansible.builtin.systemd:
    name: signage-lite-watchdog.timer
    enabled: true

- name: Re-enable signage-daily-reboot timer (ensure enabled state convergence)
  ansible.builtin.systemd:
    name: signage-daily-reboot.timer
    enabled: true

# region agent log
- name: Log before starting signage timers
  ansible.builtin.shell: "printf '%s\n' {{ log_payload | to_json | quote }} >> {{ lookup('env', 'HOME') }}/.cursor/debug.log 2>/dev/null || true"
  delegate_to: localhost
  changed_when: false
  ignore_errors: true
  vars:
    log_payload:
      sessionId: "debug-session"
      runId: "signage"
      hypothesisId: "H3"
      location: "infrastructure/ansible/roles/signage/tasks/main.yml"
      message: "before_start_signage_timers"
      data:
        host: "{{ inventory_hostname }}"
        note: "about_to_start_signage-lite_update_timer"
      timestamp: "{{ lookup('pipe', 'python3 -c \"import time;print(int(time.time()*1000))\"') }}"
# endregion

- name: Start signage-lite update timer
  ansible.builtin.systemd:
    name: signage-lite-update.timer
    state: started

# region agent log
- name: Log after starting signage update timer
  ansible.builtin.shell: "printf '%s\n' {{ log_payload | to_json | quote }} >> /Users/tsudatakashi/RaspberryPiSystem_002/.cursor/debug.log"
  delegate_to: localhost
  changed_when: false
  vars:
    log_payload:
      sessionId: "debug-session"
      runId: "signage"
      hypothesisId: "H3"
      location: "infrastructure/ansible/roles/signage/tasks/main.yml"
      message: "after_start_signage_update_timer"
      data:
        host: "{{ inventory_hostname }}"
        note: "signage-lite-update.timer started task completed"
      timestamp: "{{ lookup('pipe', 'python3 -c \"import time;print(int(time.time()*1000))\"') }}"
# endregion

- name: Start signage-lite watchdog timer
  ansible.builtin.systemd:
    name: signage-lite-watchdog.timer
    state: started

- name: Start signage-daily-reboot timer
  ansible.builtin.systemd:
    name: signage-daily-reboot.timer
    state: started

- name: Start signage-lite service
  ansible.builtin.systemd:
    name: signage-lite.service
    state: started
