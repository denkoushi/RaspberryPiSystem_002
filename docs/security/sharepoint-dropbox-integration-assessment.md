# SharePoint → Dropbox → Pi5 データ連携スキームのセキュリティ評価

最終更新: 2025-12-14

## 概要

SharePointリストからPowerAutomateでCSV出力し、DropboxにCSV保存して、Pi5がDropboxからCSVデータを取得するスキームについて、セキュリティの観点から評価します。

## スキームの概要

```
SharePointリスト
    ↓ (PowerAutomate)
Dropbox（CSV保存）
    ↓ (Pi5が取得)
Raspberry Pi 5（CSVインポート）
```

## セキュリティ評価：所見

### ✅ セキュアに稼働可能（適切な実装により）

**結論**: 適切なセキュリティ対策を実装すれば、セキュアに稼働可能です。

### セキュリティ上の懸念点と対策

#### 1. Dropbox API認証情報の管理

**懸念点**:
- Dropbox APIトークン（アクセストークン/リフレッシュトークン）の漏洩リスク
- トークンが漏洩した場合、Dropbox上のCSVファイルに不正アクセスされる可能性

**対策**:
- ✅ **環境変数で管理**: `DROPBOX_ACCESS_TOKEN`を環境変数として管理（`.env`ファイル、Ansible変数）
- ✅ **Ansible Vaultで暗号化**: 機密情報としてAnsible Vaultで暗号化
- ✅ **最小権限の原則**: Dropboxアプリには必要最小限の権限（特定フォルダの読み取りのみ）を付与
- ✅ **トークンのローテーション**: 定期的なトークン更新（リフレッシュトークンを使用）

#### 2. Pi5からDropboxへの接続（インターネット経由）

**懸念点**:
- Pi5がインターネットに接続する必要がある（現在の運用方針「通常運用: ローカルネットワークのみ」と矛盾）
- インターネット経由の通信が傍受されるリスク

**対策**:
- ✅ **HTTPS通信**: Dropbox APIはHTTPS必須（TLS 1.2以上）
- ✅ **証明書検証**: Dropbox APIの証明書を検証（デフォルトで実装）
- ✅ **接続タイムアウト**: 適切なタイムアウト設定（例: 30秒）
- ✅ **リトライロジック**: ネットワークエラー時の適切なリトライ（指数バックオフ）

#### 3. CSVファイルの改ざんリスク

**懸念点**:
- Dropbox上のCSVファイルが改ざんされる可能性
- 改ざんされたCSVをPi5が取り込むと、データベースが汚染される

**対策**:
- ✅ **ファイル整合性検証**: CSVファイルのハッシュ値（SHA256）を検証
  - PowerAutomateでハッシュ値を計算し、メタデータとして保存
  - Pi5でダウンロード後にハッシュ値を検証
- ✅ **署名検証**: PowerAutomateでCSVファイルにデジタル署名を追加（GPG署名など）
- ✅ **バージョン管理**: Dropboxのファイルバージョン履歴を確認
- ✅ **データ検証**: CSVインポート時の厳密なバリデーション（既存のZodスキーマを活用）

#### 4. データの機密性

**懸念点**:
- CSVファイルに機密情報（従業員情報、工具情報）が含まれる可能性
- Dropbox上でのデータ漏洩リスク

**対策**:
- ✅ **暗号化**: PowerAutomateでCSVファイルを暗号化してからDropboxに保存（GPG暗号化）
  - Pi5でダウンロード後に復号
- ✅ **最小データ原則**: CSVに含めるデータを必要最小限に
- ✅ **アクセス制御**: Dropboxフォルダへのアクセスを特定ユーザーのみに制限

#### 5. 認証・認可

**懸念点**:
- Pi5がDropboxからCSVを取得する際の認証・認可
- 不正なCSVファイルの取得を防ぐ

**対策**:
- ✅ **APIキー認証**: Dropbox APIトークンによる認証
- ✅ **IP制限**: Dropboxアプリの設定で、Pi5のIPアドレス（Tailscale IP）のみ許可（可能な場合）
- ✅ **ファイル名検証**: 期待されるファイル名パターンに一致する場合のみ処理
- ✅ **タイムスタンプ検証**: CSVファイルの更新日時を確認し、古いファイルは処理しない

#### 6. エラーハンドリングと監視

**懸念点**:
- Dropbox接続エラー、CSV解析エラーが適切に処理されない可能性
- 異常なCSVファイルの取り込みを検知できない

**対策**:
- ✅ **エラーログ**: すべてのエラーをログに記録（既存のログ機能を活用）
- ✅ **アラート通知**: Dropbox接続エラー、CSV検証エラー時にアラートを生成（既存の`generate-alert.sh`を活用）
- ✅ **監査ログ**: CSVインポートの履歴を記録（誰が/いつ/どのファイルをインポートしたか）

### 実装上の推奨事項

#### 1. 接続方式の選択

**推奨**: **Pull方式（Pi5がDropboxから取得）**
- Pi5が定期的に（例: 毎日1回）DropboxからCSVを取得
- PowerAutomateはCSVを生成してDropboxに保存するだけ
- Pi5側で取得タイミングを制御可能

**代替**: Push方式（PowerAutomateがPi5に直接送信）
- より複雑（Pi5側にWebhookエンドポイントが必要）
- セキュリティリスクが高い（Pi5をインターネットに公開する必要がある）

#### 2. インターネット接続の運用方針

**現在の運用方針との整合性**:
- **現在**: 通常運用はローカルネットワークのみ（インターネット接続なし）
- **新スキーム**: Pi5がDropboxからCSVを取得するため、インターネット接続が必要

**推奨される運用方針**:
- **通常運用**: ローカルネットワークのみ（インターネット接続なし）
- **CSV取得時**: メンテナンス時間帯にインターネット接続を有効化し、CSVを取得
- **取得後**: インターネット接続を無効化（通常運用に戻る）

または

- **CSV取得専用のネットワーク**: Tailscale経由でDropboxに接続（メンテナンス時のみ）
- **自動取得**: systemd timerで定期的に（例: 毎日4時）Tailscale経由でCSVを取得

#### 3. セキュリティ機能の活用

**既存のセキュリティ機能を活用**:
- ✅ **レート制限**: Dropbox API呼び出しにレート制限を適用（既存の`rate-limit.ts`を拡張）
- ✅ **監視**: Dropbox接続エラーを`security-monitor.sh`で監視
- ✅ **アラート**: エラー時に既存の`generate-alert.sh`でアラート生成
- ✅ **ログ**: 既存のログ機能でDropbox接続ログを記録

### リスク評価

| リスク | 影響度 | 発生確率 | 対策の有効性 | 総合評価 |
|--------|--------|----------|--------------|----------|
| **Dropbox APIトークン漏洩** | 高 | 低 | 高（環境変数管理、Ansible Vault） | 🟢 低リスク |
| **CSVファイル改ざん** | 高 | 中 | 高（ハッシュ検証、署名検証） | 🟡 中リスク |
| **データ漏洩** | 高 | 低 | 高（暗号化、アクセス制御） | 🟢 低リスク |
| **インターネット接続** | 中 | 高 | 中（HTTPS、タイムアウト、リトライ） | 🟡 中リスク |
| **エラー処理不足** | 中 | 中 | 高（既存のログ・アラート機能） | 🟢 低リスク |

### 結論

**セキュアに稼働可能**: ✅ **はい**

**条件**:
1. Dropbox APIトークンを適切に管理（環境変数、Ansible Vault）
2. CSVファイルの整合性を検証（ハッシュ値、署名）
3. データの暗号化（GPG暗号化）
4. 適切なエラーハンドリングと監視（既存機能を活用）
5. インターネット接続の運用方針を明確化（メンテナンス時のみ、またはTailscale経由）

**推奨される実装順序**:
1. **Phase 1**: Dropbox API接続の基本実装（認証、ファイル取得）
2. **Phase 2**: CSVファイルの整合性検証（ハッシュ値検証）
3. **Phase 3**: データ暗号化（GPG暗号化・復号）
4. **Phase 4**: エラーハンドリングと監視の統合
5. **Phase 5**: 運用方針の明確化とドキュメント化

## 関連ドキュメント

- [セキュリティ要件定義](./requirements.md)
- [Phase 9/10 詳細仕様書](./phase9-10-specifications.md)
- [CSVインポート機能](../api/imports.md)
