# アスクルランサムウェア攻撃への対応可否評価

最終更新: 2025-12-13

## 概要

本ドキュメントでは、[アスクル株式会社のランサムウェア攻撃事故報告](https://prtimes.jp/main/html/rd/p/000000500.000021550.html)（2025年10月19日発生）を踏まえ、Raspberry Piシステムが同様の攻撃パターンに対応可能かを評価します。

## アスクルの攻撃パターン分析

### 攻撃の時系列と手法

1. **認証情報の窃取による初期侵入**
   - パスワードのみの認証で侵入に成功
   - MFA（多要素認証）が未適用

2. **EDR等の無効化**
   - 攻撃者がEDR（Endpoint Detection and Response）を無効化
   - 複数種のランサムウェアを使用（EDRシグネチャで検知困難なものも含む）

3. **横移動と権限昇格**
   - ネットワーク内で偵察を開始
   - 複数サーバ間を移動して認証情報を収集
   - 必要な権限を取得してネットワーク全体へのアクセス能力を獲得

4. **ランサムウェア展開とバックアップ削除**
   - ランサムウェアを複数サーバに展開
   - ファイル暗号化を一斉に実行
   - **バックアップファイルも同時に暗号化・削除**

5. **侵入検知の遅れ**
   - 検知が遅れ、攻撃が進行

6. **復旧の長期化**
   - バックアップも暗号化されていたため、復旧に時間を要した

## 現在のシステムの対応可否評価

### ✅ 対応可能な攻撃パターン

#### 1. バックアップの保護（ランサムウェア対策）

**アスクルの問題点**:
- バックアップファイルも暗号化・削除された
- オンラインバックアップのみで、オフライン保存がなかった

**現在のシステムの対策**:
- ✅ **バックアップの暗号化**: GPGによる暗号化（`backup-encrypted.sh`）
- ✅ **オフライン保存**: USB/HDDへのコピー機能（`/mnt/backup-usb`）
- ✅ **オフライン検証**: `backup-offline-verify.sh`でオフラインバックアップの整合性確認

**評価**: ✅ **完全対応可能**
- オフラインバックアップにより、ランサムウェアがバックアップを削除・暗号化しても復旧可能
- 暗号化により、バックアップファイルの漏洩リスクも低減

#### 2. ネットワーク分離とアクセス制御

**アスクルの問題点**:
- ネットワーク全体へのアクセス能力を獲得された
- 複数サーバ間を移動して権限を取得

**現在のシステムの対策**:
- ✅ **ローカルネットワーク運用**: 通常運用時はインターネット接続なし
- ✅ **Tailscale VPN**: メンテナンス時のみVPN経由で接続
- ✅ **ファイアウォール（UFW）**: 80/443/22のみ許可、ローカルLAN/TailscaleのみSSH許可
- ✅ **管理画面IP制限**: Caddyで`ADMIN_ALLOW_NETS`による制限
- ✅ **fail2ban**: SSH/HTTPブルートフォース対策

**評価**: ✅ **ほぼ対応可能**
- ローカルネットワーク運用が主のため、インターネット経由の攻撃リスクが低い
- Tailscale経由の接続もVPNで保護されている
- ただし、ローカルネットワーク内での横移動は完全には防げない（追加対策が必要）

#### 3. 侵入検知と監視

**アスクルの問題点**:
- 侵入検知が遅れた
- EDRが無効化された

**現在のシステムの対策**:
- ✅ **fail2ban**: SSH/HTTP不正アクセスを自動検知・Ban
- ✅ **セキュリティ監視**: `security-monitor.sh`が15分間隔で実行
- ✅ **マルウェアスキャン**: ClamAV/Trivy/rkhunterの定期スキャン
- ✅ **アラート生成**: 検知時に`alerts/*.json`を自動生成
- ✅ **ログ長期保持**: 52週保持でフォレンジック対応

**評価**: ⚠️ **部分的対応可能**
- fail2banによる自動検知は有効だが、リアルタイム検知ではない（15分間隔）
- EDR相当のリアルタイム監視は未導入（ClamAV/Trivy/rkhunterは定期スキャンのみ）

#### 4. レート制限とDDoS対策

**アスクルの問題点**:
- ブルートフォース攻撃による認証情報窃取

**現在のシステムの対策**:
- ✅ **Fastifyレート制限**: 
  - 認証エンドポイント: 10 req/min
  - システムAPI: 60 req/min
  - 管理画面: 30 req/min
- ✅ **fail2ban**: SSH/HTTPブルートフォースを自動Ban

**評価**: ✅ **対応可能**
- レート制限によりブルートフォース攻撃を緩和
- fail2banによる自動Banで継続的な攻撃を遮断

### ⚠️ 部分的対応・改善が必要な攻撃パターン

#### 1. 多要素認証（MFA）の未実装

**アスクルの問題点**:
- パスワードのみの認証で侵入に成功
- MFAが未適用だった

**現在のシステムの状況**:
- ❌ **MFA未実装**: JWT認証のみ（パスワードベース）
- ✅ **管理画面IP制限**: CaddyでIP制限（部分的対策）
- ✅ **Tailscale**: VPN経由の接続（メンテナンス時）

**評価**: ⚠️ **改善が必要**
- パスワード漏洩時のリスクが高い
- MFA導入により、認証情報窃取による侵入を大幅に低減可能

**推奨対策**:
- TOTP（Time-based One-Time Password）ベースのMFA導入
- 管理画面ログイン時にMFA必須化

#### 2. EDR相当のリアルタイム監視の未導入

**アスクルの問題点**:
- EDRが無効化された
- 複数種のランサムウェアが使用された（検知困難なものも含む）

**現在のシステムの状況**:
- ✅ **定期スキャン**: ClamAV/Trivy/rkhunterの日次/週次スキャン
- ❌ **リアルタイム監視**: EDR相当のリアルタイム検知は未導入
- ✅ **ログ監視**: fail2banログの15分間隔監視

**評価**: ⚠️ **改善が必要**
- 定期スキャンでは、侵入から検知までに時間がかかる可能性
- EDR相当のリアルタイム監視により、早期検知が可能

**推奨対策**:
- ファイルシステムの整合性監視（AIDE等）
- プロセス監視（異常なプロセスの検知）
- ネットワーク通信の監視（異常な通信パターンの検知）

#### 3. 権限管理の強化

**アスクルの問題点**:
- 必要な権限を取得してネットワーク全体へのアクセス能力を獲得
- 複数サーバ間を移動して権限を取得

**現在のシステムの状況**:
- ✅ **RBAC**: ロールベースアクセス制御（ADMIN/MANAGER/VIEWER）
- ✅ **最小権限の原則**: 各ロールに必要な権限のみ付与
- ⚠️ **権限監査**: 権限変更の監査ログは未実装

**評価**: ⚠️ **改善が必要**
- RBACは実装済みだが、権限変更の監査が不十分
- 権限昇格の試行を検知する仕組みが必要

**推奨対策**:
- 権限変更の監査ログ
- 異常な権限昇格の試行を検知するアラート

### ❌ 対応困難な攻撃パターン

#### 1. 内部犯行・内部者による不正アクセス

**アスクルの問題点**:
- 認証情報の窃取方法が不明（フィッシング、内部者による漏洩の可能性）

**現在のシステムの状況**:
- ⚠️ **内部者対策**: 限定的（ログ監視のみ）

**評価**: ❌ **対応困難**
- 内部者による不正アクセスは検知が困難
- MFA導入によりリスクを低減可能だが、完全な対策は困難

**推奨対策**:
- MFA導入（必須）
- アクセスログの定期的な監査
- 異常なアクセスパターンの検知

## 総合評価

### 現在のシステムの強み

1. ✅ **オフラインバックアップ**: ランサムウェアがバックアップを削除・暗号化しても復旧可能
2. ✅ **ネットワーク分離**: ローカルネットワーク運用が主のため、インターネット経由の攻撃リスクが低い
3. ✅ **バックアップ暗号化**: バックアップファイルの漏洩リスクを低減
4. ✅ **レート制限**: ブルートフォース攻撃を緩和
5. ✅ **侵入検知**: fail2banによる自動検知・Ban

### 改善が必要な点

1. ⚠️ **MFA未実装**: 認証情報窃取による侵入リスクが高い
2. ⚠️ **リアルタイム監視の不足**: EDR相当のリアルタイム検知が未導入
3. ⚠️ **権限監査の不足**: 権限変更の監査ログが不十分

### アスクル型攻撃への対応可否

| 攻撃パターン | 対応可否 | 評価 |
|-------------|---------|------|
| バックアップ削除・暗号化 | ✅ **完全対応** | オフラインバックアップにより復旧可能 |
| ネットワーク横移動 | ✅ **ほぼ対応** | ローカルネットワーク運用が主のためリスク低 |
| 侵入検知の遅れ | ⚠️ **部分的対応** | 15分間隔監視は有効だが、リアルタイムではない |
| 認証情報窃取 | ⚠️ **改善必要** | MFA未実装のため、パスワード漏洩時のリスクが高い |
| EDR無効化 | ⚠️ **改善必要** | EDR相当のリアルタイム監視が未導入 |
| 権限昇格 | ⚠️ **改善必要** | RBACは実装済みだが、権限監査が不十分 |

## 推奨される追加対策

### 高優先度

1. **MFA（多要素認証）の導入**
   - TOTPベースのMFAを管理画面ログインに必須化
   - 認証情報窃取による侵入リスクを大幅に低減

2. **リアルタイム監視の強化**
   - ファイルシステム整合性監視（AIDE等）
   - プロセス監視（異常なプロセスの検知）
   - ネットワーク通信の監視

### 中優先度

3. **権限監査の実装**
   - 権限変更の監査ログ
   - 異常な権限昇格の試行を検知するアラート

4. **セッション管理の強化**
   - セッションタイムアウトの短縮
   - 異常なセッションの検知

## 結論

### 現在のシステムの安全性評価

**ローカルネットワーク運用時**: ✅ **安全運用可能**
- オフラインバックアップにより、ランサムウェア攻撃でも復旧可能
- ネットワーク分離により、インターネット経由の攻撃リスクが低い
- レート制限とfail2banにより、ブルートフォース攻撃を緩和

**インターネット接続時**: ⚠️ **ほぼ安全運用可能（MFA導入推奨）**
- Tailscale VPNにより、メンテナンス時の接続は保護されている
- 管理画面IP制限により、未許可IPからのアクセスを遮断
- **MFA未実装のため、認証情報窃取時のリスクが残る**

### アスクル型攻撃への対応可否

**結論**: ⚠️ **部分的対応可能。MFA導入により大幅に改善可能。**

**対応可能な点**:
- ✅ バックアップ削除・暗号化 → オフラインバックアップで完全対応
- ✅ ネットワーク横移動 → ローカルネットワーク運用が主のためリスク低
- ✅ ブルートフォース攻撃 → レート制限とfail2banで対応

**改善が必要な点**:
- ⚠️ 認証情報窃取 → MFA導入により大幅に改善可能
- ⚠️ リアルタイム監視 → EDR相当の監視導入により改善可能
- ⚠️ 権限監査 → 監査ログの実装により改善可能

**推奨アクション**:
1. **MFA導入を最優先**（認証情報窃取による侵入リスクを大幅に低減）
2. リアルタイム監視の強化（早期検知のため）
3. 権限監査の実装（権限昇格の試行を検知）

## 参考資料

- [アスクル株式会社 ランサムウェア攻撃の影響調査結果および安全性強化に向けた取り組みのご報告（第13報）](https://prtimes.jp/main/html/rd/p/000000500.000021550.html)
- [インシデント対応手順](./incident-response.md)
- [セキュリティ要件定義](./requirements.md)
- [セキュリティ強化ExecPlan](../plans/security-hardening-execplan.md)
