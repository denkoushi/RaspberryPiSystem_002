# 標準セキュリティチェックリスト監査レポート

最終更新: 2025-12-18

## 概要

IPA（情報処理推進機構）、OWASP、CISベンチマークなどの標準的なセキュリティチェックリストに基づき、Raspberry Pi NFC持出返却システムのセキュリティ実装状況を監査しました。

## 参照した標準チェックリスト

1. **IPA「安全なウェブサイトの作り方」**
   - SQLインジェクション、XSS、CSRF、セッション管理などの脆弱性対策
   - ウェブアプリケーションのセキュリティ実装チェックリスト

2. **OWASP Top 10 2021**
   - アクセス制御の不備、暗号化の失敗、インジェクション、セキュリティ設定ミスなど
   - Webアプリケーションの最も重大なセキュリティリスク

3. **CISベンチマーク**
   - Docker環境のセキュリティ強化ガイドライン
   - PostgreSQLデータベースのセキュリティ設定

## 監査結果サマリー

| カテゴリ | 実施状況 | 未実施項目数 | 必要性評価 |
|---------|---------|------------|----------|
| **IPA「安全なウェブサイトの作り方」** | ✅ ほぼ完了 | 2件 | 🟡 中優先度 |
| **OWASP Top 10 2021** | ✅ ほぼ完了 | 3件 | 🟡 中優先度 |
| **CIS Dockerベンチマーク** | ⚠️ 一部未実施 | 5件 | 🟢 低優先度 |
| **CIS PostgreSQLベンチマーク** | ⚠️ 一部未実施 | 4件 | 🟡 中優先度 |

## 詳細監査結果

### 1. IPA「安全なウェブサイトの作り方」チェックリスト

#### ✅ 実施済み項目

1. **SQLインジェクション対策**
   - ✅ **実装状況**: Prismaを使用しており、パラメータ化クエリが自動的に実装されている
   - ✅ **検証**: すべてのデータベースクエリがPrisma経由で実行され、SQLインジェクション攻撃は防止されている
   - **参照**: `apps/api/src/services/` のすべてのサービス層でPrismaを使用

2. **クロスサイト・スクリプティング（XSS）対策**
   - ✅ **実装状況**: Reactのデフォルトエスケープ機能を使用
   - ✅ **検証**: Reactは自動的にJSX内の値をエスケープするため、XSS攻撃は防止されている
   - **参照**: `apps/web/src/` のすべてのReactコンポーネント

3. **セッション管理の不備対策**
   - ✅ **実装状況**: JWT（アクセストークン/リフレッシュトークン）を使用
   - ✅ **検証**: トークンベースの認証により、セッション管理の不備を回避
   - **参照**: `apps/api/src/routes/auth/` の認証ルート

4. **アクセス制御や認可制御の欠落対策**
   - ✅ **実装状況**: ロールベースアクセス制御（RBAC）を実装
   - ✅ **検証**: `authorizeRoles`関数で適切な認可制御を実施
   - **参照**: `apps/api/src/plugins/authorization.ts`

5. **パス名パラメータの未チェック／ディレクトリ・トラバーサル対策**
   - ✅ **実装状況**: ファイルパスのバリデーションを実装
   - ✅ **検証**: パストラバーサル攻撃を防止するバリデーションを実施
   - **参照**: `apps/api/src/services/backup/` のバックアップサービス

6. **HTTPヘッダ・インジェクション対策**
   - ✅ **実装状況**: セキュリティヘッダーを実装（Strict-Transport-Security含む）
   - ✅ **検証**: Caddyとアプリケーション層で適切なヘッダーを設定
   - **参照**: `apps/api/src/plugins/security-headers.ts`

#### ⚠️ 未実施項目

1. **クロスサイト・リクエスト・フォージェリ（CSRF）対策**
   - ⚠️ **現状**: CSRFトークンの実装が未確認
   - **リスク**: 認証済みユーザーが意図しない操作を実行される可能性
   - **必要性**: 🟡 **中優先度**
     - **理由**: 
       - 現在はJWT認証を使用しており、Cookieベースのセッション管理ではない
       - ただし、SameSite Cookie属性の設定やCSRFトークンの追加は推奨される
   - **推奨対策**:
     - SameSite Cookie属性の設定（Caddy設定で実装可能）
     - CSRFトークンの実装（重要な操作エンドポイントに追加）

2. **メールヘッダ・インジェクション対策**
   - ⚠️ **現状**: メール送信機能が未実装（将来実装予定）
   - **リスク**: メール送信機能実装時にメールヘッダ・インジェクションのリスク
   - **必要性**: 🟢 **低優先度**（現時点では未実装機能のため）
   - **推奨対策**: メール送信機能実装時に、メールヘッダのバリデーションを実装

### 2. OWASP Top 10 2021 チェックリスト

#### ✅ 実施済み項目

1. **A01:2021 – アクセス制御の不備（Broken Access Control）**
   - ✅ **実装状況**: ロールベースアクセス制御（RBAC）を実装
   - ✅ **検証**: `authorizeRoles`関数で適切なアクセス制御を実施
   - **参照**: `apps/api/src/plugins/authorization.ts`

2. **A02:2021 – 暗号化の失敗（Cryptographic Failures）**
   - ✅ **実装状況**: HTTPS強制、バックアップ暗号化（GPG）を実装
   - ✅ **検証**: CaddyによるTLS終端、GPGによるバックアップ暗号化
   - **参照**: `infrastructure/docker/Caddyfile.production`, `scripts/server/backup-encrypted.sh`

3. **A03:2021 – インジェクション（Injection）**
   - ✅ **実装状況**: PrismaによるSQLインジェクション対策、入力バリデーション（zod）
   - ✅ **検証**: すべてのAPIエンドポイントでzodによるバリデーションを実施
   - **参照**: `apps/api/src/routes/` のすべてのルート

4. **A05:2021 – セキュリティの設定ミス（Security Misconfiguration）**
   - ✅ **実装状況**: Docker Composeのポートマッピング削除、セキュリティヘッダー実装
   - ✅ **検証**: 不要なポート公開を削除、適切なセキュリティヘッダーを設定
   - **参照**: `infrastructure/docker/docker-compose.server.yml`, `apps/api/src/plugins/security-headers.ts`

5. **A06:2021 – 脆弱で古くなったコンポーネントの使用（Vulnerable and Outdated Components）**
   - ✅ **実装状況**: TrivyによるDockerイメージスキャン、CIでの脆弱性検出
   - ✅ **検証**: CIパイプラインでHIGH/CRITICAL脆弱性を検出・Fail
   - **参照**: `.github/workflows/ci.yml`

6. **A07:2021 – 識別と認証の失敗（Identification and Authentication Failures）**
   - ✅ **実装状況**: MFA（多要素認証）、JWT認証、レート制限を実装
   - ✅ **検証**: TOTP/バックアップコードによるMFA、認証エンドポイントのレート制限
   - **参照**: `apps/api/src/routes/auth/`, `apps/api/src/plugins/rate-limit.ts`

7. **A09:2021 – セキュリティログとモニタリングの失敗（Security Logging and Monitoring Failures）**
   - ✅ **実装状況**: セキュリティログ監視、アラート通知、リアルタイム監視を実装
   - ✅ **検証**: fail2ban監視、マルウェアスキャン結果のアラート化、ファイル整合性監視
   - **参照**: `scripts/server/security-monitor.sh`, `scripts/server/generate-alert.sh`

#### ⚠️ 未実施項目

1. **A04:2021 – 安全でない設計（Insecure Design）**
   - ⚠️ **現状**: セキュリティ設計の包括的なレビューが未実施
   - **リスク**: 設計段階でのセキュリティ欠陥が残存する可能性
   - **必要性**: 🟡 **中優先度**
     - **理由**: 
       - 現在の実装は適切だが、設計レビューによる追加の安全性確保が推奨される
       - 特に、新機能追加時のセキュリティ設計レビューが重要
   - **推奨対策**:
     - セキュリティ設計レビューの実施（年1回）
     - 新機能追加時のセキュリティ設計チェックリストの作成

2. **A08:2021 – ソフトウェアとデータの整合性の失敗（Software and Data Integrity Failures）**
   - ⚠️ **現状**: 依存関係の整合性検証（SRI、パッケージ署名検証）が未実装
   - **リスク**: 改ざんされた依存関係やパッケージの使用リスク
   - **必要性**: 🟡 **中優先度**
     - **理由**: 
       - 現在はpnpmのロックファイルとTrivyスキャンで対策しているが、より厳密な検証が推奨される
       - 特に、本番環境での依存関係の整合性検証が重要
   - **推奨対策**:
     - パッケージ署名検証の実装（pnpmの`verifySignatures`機能）
     - Subresource Integrity (SRI) の実装（CDN経由のリソース読み込み時）

3. **A10:2021 – サーバーサイドリクエストフォージェリ（SSRF）（Server-Side Request Forgery）**
   - ⚠️ **現状**: SSRF対策の明示的な実装が未確認
   - **リスク**: 内部ネットワークへの不正アクセスの可能性
   - **必要性**: 🟢 **低優先度**（現時点では外部URLへのリクエスト機能が限定的）
   - **推奨対策**: 
     - 外部URLへのリクエスト機能実装時に、URLバリデーションとホワイトリスト制御を実装
     - 内部ネットワークへのアクセスを制限

### 3. CIS Dockerベンチマーク チェックリスト

#### ✅ 実施済み項目

1. **コンテナイメージのセキュリティ**
   - ✅ **実装状況**: TrivyによるDockerイメージスキャン、CIでの脆弱性検出
   - ✅ **検証**: CIパイプラインでHIGH/CRITICAL脆弱性を検出・Fail
   - **参照**: `.github/workflows/ci.yml`

2. **コンテナの実行時セキュリティ**
   - ✅ **実装状況**: 非rootユーザーでのコンテナ実行、リソース制限の設定
   - ✅ **検証**: Dockerfileで非rootユーザーを指定、リソース制限を設定
   - **参照**: `infrastructure/docker/Dockerfile.api`, `infrastructure/docker/Dockerfile.web`

3. **ネットワークセキュリティ**
   - ✅ **実装状況**: Docker Composeのポートマッピング削除、Docker内部ネットワークの使用
   - ✅ **検証**: PostgreSQL（5432）とAPI（8080）のポートマッピングを削除
   - **参照**: `infrastructure/docker/docker-compose.server.yml`

#### ⚠️ 未実施項目

1. **コンテナの読み取り専用ルートファイルシステム**
   - ⚠️ **現状**: コンテナのルートファイルシステムが読み書き可能
   - **リスク**: コンテナ内でのファイル改ざんリスク
   - **必要性**: 🟢 **低優先度**
     - **理由**: 
       - 現在はアプリケーションログや一時ファイルの書き込みが必要
       - 読み取り専用ファイルシステムの実装は複雑で、運用への影響が大きい
   - **推奨対策**: 
     - 必要最小限のディレクトリのみ書き込み可能にする（`tmpfs`の使用）
     - 重要なディレクトリを読み取り専用でマウント

2. **コンテナのセキュリティコンテキストの設定**
   - ⚠️ **現状**: セキュリティコンテキスト（`securityContext`）の明示的な設定が未実施
   - **リスク**: コンテナの権限が過剰になる可能性
   - **必要性**: 🟢 **低優先度**
     - **理由**: 
       - 現在は非rootユーザーでの実行により対策されている
       - より厳密な設定は推奨されるが、現時点では優先度が低い
   - **推奨対策**: 
     - `securityContext`の設定（`runAsNonRoot: true`, `readOnlyRootFilesystem: true`など）

3. **コンテナのリソース制限の強化**
   - ⚠️ **現状**: メモリ制限は設定されているが、CPU制限が未設定
   - **リスク**: CPUリソースの過剰使用によるDoS攻撃の可能性
   - **必要性**: 🟢 **低優先度**
     - **理由**: 
       - Raspberry Pi 5のリソース制約を考慮すると、CPU制限は不要
       - ただし、将来的なスケーリングを考慮すると推奨される
   - **推奨対策**: 
     - CPU制限の設定（`cpus: "1.0"`など）

4. **コンテナのログドライバーの設定**
   - ⚠️ **現状**: ログドライバーの明示的な設定が未実施
   - **リスク**: ログの漏洩や改ざんリスク
   - **必要性**: 🟢 **低優先度**
     - **理由**: 
       - 現在はDocker Composeのデフォルトログドライバーを使用
       - ログローテーション設定は実装済み
   - **推奨対策**: 
     - ログドライバーの明示的な設定（`json-file`、`max-size`、`max-file`の設定）

5. **コンテナのヘルスチェックの実装**
   - ⚠️ **現状**: Docker Composeのヘルスチェック設定が未確認
   - **リスク**: コンテナの異常状態の検知が遅れる可能性
   - **必要性**: 🟢 **低優先度**
     - **理由**: 
       - 現在はアプリケーション層でヘルスチェックエンドポイントを実装
       - Dockerレベルのヘルスチェックは追加の安全性を提供する
   - **推奨対策**: 
     - Docker Composeの`healthcheck`設定の追加

### 4. CIS PostgreSQLベンチマーク チェックリスト

#### ✅ 実施済み項目

1. **認証と認可**
   - ✅ **実装状況**: PostgreSQLの認証設定、パスワードポリシー（環境変数で管理）
   - ✅ **検証**: Docker Composeで環境変数による認証設定を実施
   - **参照**: `infrastructure/docker/docker-compose.server.yml`

2. **ネットワークセキュリティ**
   - ✅ **実装状況**: Docker内部ネットワークでのみアクセス可能、ポートマッピング削除
   - ✅ **検証**: PostgreSQL（5432）のポートマッピングを削除
   - **参照**: `infrastructure/docker/docker-compose.server.yml`

3. **ログと監視**
   - ✅ **実装状況**: PostgreSQLのログ設定、アプリケーション層での監視
   - ✅ **検証**: Docker Composeでログ設定を実施、アプリケーション層でデータベース監視
   - **参照**: `infrastructure/docker/docker-compose.server.yml`, `apps/api/src/routes/system/health.ts`

#### ⚠️ 未実施項目

1. **PostgreSQLのSSL/TLS接続の強制**
   - ⚠️ **現状**: Docker内部ネットワークでのみアクセス可能だが、SSL/TLS接続が未強制
   - **リスク**: Docker内部ネットワークでの通信傍受リスク（低リスク）
   - **必要性**: 🟡 **中優先度**
     - **理由**: 
       - Docker内部ネットワークは比較的安全だが、より厳密なセキュリティが推奨される
       - 特に、本番環境でのSSL/TLS接続の強制が重要
   - **推奨対策**: 
     - PostgreSQLのSSL設定の有効化（`postgresql.conf`の`ssl = on`）
     - クライアント接続でのSSL/TLS接続の強制（`pg_hba.conf`の設定）

2. **PostgreSQLのパスワードポリシーの強化**
   - ⚠️ **現状**: デフォルトパスワード（`postgres/postgres`）が使用されている
   - **リスク**: 弱いパスワードによる不正アクセスリスク
   - **必要性**: 🔴 **高優先度**
     - **理由**: 
       - デフォルトパスワードは重大なセキュリティリスク
       - 本番環境では強力なパスワードに変更すべき
   - **推奨対策**: 
     - 強力なパスワードへの変更（環境変数で管理）
     - パスワードポリシーの設定（最小長、複雑性要件など）

3. **PostgreSQLの不要な機能の無効化**
   - ⚠️ **現状**: PostgreSQLの設定ファイル（`postgresql.conf`）の最適化が未実施
   - **リスク**: 不要な機能による攻撃面の拡大
   - **必要性**: 🟡 **中優先度**
     - **理由**: 
       - 現在は基本的な設定のみで運用
       - 不要な機能の無効化により、攻撃面を縮小できる
   - **推奨対策**: 
     - `postgresql.conf`の最適化（不要な拡張機能の無効化など）
     - 最小権限の原則に基づいた設定

4. **PostgreSQLの監査ログの設定**
   - ⚠️ **現状**: PostgreSQLの監査ログ設定が未実施
   - **リスク**: データベース操作の追跡が困難
   - **必要性**: 🟡 **中優先度**
     - **理由**: 
       - 現在はアプリケーション層でログを記録しているが、データベース層での監査ログも推奨される
       - 特に、データベースへの直接アクセス時の監査が重要
   - **推奨対策**: 
     - PostgreSQLの監査ログ設定（`log_statement`、`log_connections`など）
     - 監査ログの外部保存と分析

## 優先度別の推奨対策

### 🔴 高優先度（即座に実施）

1. **PostgreSQLのパスワードポリシーの強化**
   - **現状**: デフォルトパスワード（`postgres/postgres`）が使用されている
   - **対策**: 強力なパスワードへの変更（環境変数で管理）
   - **影響**: 重大なセキュリティリスクの解消
   - **実装難易度**: 低（環境変数の設定のみ）

### 🟡 中優先度（1ヶ月以内に実施）

1. **CSRF対策の実装**
   - **現状**: CSRFトークンの実装が未確認
   - **対策**: SameSite Cookie属性の設定、CSRFトークンの実装
   - **影響**: 認証済みユーザーの意図しない操作の防止
   - **実装難易度**: 中（Caddy設定とアプリケーション層の実装）

2. **PostgreSQLのSSL/TLS接続の強制**
   - **現状**: Docker内部ネットワークでのみアクセス可能だが、SSL/TLS接続が未強制
   - **対策**: PostgreSQLのSSL設定の有効化、クライアント接続でのSSL/TLS接続の強制
   - **影響**: Docker内部ネットワークでの通信傍受リスクの低減
   - **実装難易度**: 中（PostgreSQL設定ファイルの変更）

3. **PostgreSQLの監査ログの設定**
   - **現状**: PostgreSQLの監査ログ設定が未実施
   - **対策**: PostgreSQLの監査ログ設定（`log_statement`、`log_connections`など）
   - **影響**: データベース操作の追跡と分析の向上
   - **実装難易度**: 低（PostgreSQL設定ファイルの変更）

4. **セキュリティ設計レビューの実施**
   - **現状**: セキュリティ設計の包括的なレビューが未実施
   - **対策**: セキュリティ設計レビューの実施（年1回）、新機能追加時のセキュリティ設計チェックリストの作成
   - **影響**: 設計段階でのセキュリティ欠陥の早期発見
   - **実装難易度**: 中（レビューの実施とチェックリストの作成）

5. **依存関係の整合性検証の強化**
   - **現状**: 依存関係の整合性検証（SRI、パッケージ署名検証）が未実装
   - **対策**: パッケージ署名検証の実装、Subresource Integrity (SRI) の実装
   - **影響**: 改ざんされた依存関係やパッケージの使用リスクの低減
   - **実装難易度**: 中（pnpm設定とアプリケーション層の実装）

### 🟢 低優先度（将来の拡張）

1. **コンテナの読み取り専用ルートファイルシステム**
2. **コンテナのセキュリティコンテキストの設定**
3. **コンテナのリソース制限の強化**
4. **コンテナのログドライバーの明示的な設定**
5. **コンテナのヘルスチェックの実装**
6. **PostgreSQLの不要な機能の無効化**

## 総合評価

### ✅ 現在の実装状況: **良好**

**理由**:
1. **主要なセキュリティ対策が実装済み**: IPA「安全なウェブサイトの作り方」とOWASP Top 10の主要項目がほぼ完了
2. **多層防御の実装**: ネットワーク層→アプリケーション層→データ層→監視層の多層防御が実装されている
3. **標準チェックリストとの整合性**: 世間標準のセキュリティチェックリストに対して、高い実施率を達成

### ⚠️ 改善が必要な点

1. **高優先度**: PostgreSQLのパスワードポリシーの強化（デフォルトパスワードの変更）
2. **中優先度**: CSRF対策、PostgreSQLのSSL/TLS接続の強制、監査ログの設定
3. **低優先度**: Dockerコンテナのセキュリティ設定の強化

### 推奨される次のステップ

1. **短期（1週間以内）**
   - PostgreSQLのパスワードを強力なパスワードに変更（環境変数で管理）

2. **中期（1ヶ月以内）**
   - CSRF対策の実装（SameSite Cookie属性の設定、CSRFトークンの実装）
   - PostgreSQLのSSL/TLS接続の強制
   - PostgreSQLの監査ログの設定

3. **長期（必要に応じて）**
   - セキュリティ設計レビューの実施（年1回）
   - 依存関係の整合性検証の強化
   - Dockerコンテナのセキュリティ設定の強化

## 関連ドキュメント

- [セキュリティ要件定義](./requirements.md)
- [セキュリティ実装の妥当性評価](./implementation-assessment.md)
- [ポートセキュリティ監査レポート](./port-security-audit.md)
- [IPA「安全なウェブサイトの作り方」](https://www.ipa.go.jp/security/vuln/website.html)
- [OWASP Top 10 2021](https://owasp.org/Top10/2021/ja/)
- [CIS Dockerベンチマーク](https://www.cisecurity.org/benchmark/docker)
- [CIS PostgreSQLベンチマーク](https://www.cisecurity.org/benchmark/postgresql)
