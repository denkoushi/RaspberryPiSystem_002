# セキュリティ実装の妥当性評価

最終更新: 2025-12-14

## 概要

本ドキュメントでは、Raspberry Pi NFC 持出返却システムのセキュリティ実装について、現時点での妥当性と残タスクを評価します。

### 追加の外部インシデント評価（2025-12-13）
- 2025年10月のアスクル社ランサムウェア攻撃（[事故報告](https://prtimes.jp/main/html/rd/p/000000500.000021550.html)）を分析し、本システムへの当てはまりを評価。
- **対応可能な点**: オフライン暗号化バックアップでバックアップ削除・暗号化に耐性／ローカル運用＋Tailscaleでインターネット経由の横移動リスク低／レート制限＋fail2banでブルートフォース緩和。
- **改善が必要な点**: MFA未実装による認証情報窃取リスク／EDR相当のリアルタイム監視なし／権限変更の監査不足。
- **更新（2025-12-14）**: ✅ MFA実装完了（TOTP/バックアップコード/30日記憶オプション、統合テスト・実機テスト完了）。✅ リアルタイム監視実装完了（ファイル整合性・プロセス・ポート監視、実機テスト完了）。✅ 権限監査実装完了（異常パターン検知・アラート生成、統合テスト・実機テスト完了）。

## 実装完了状況の総括

### ✅ 完了した対策（Phase 1-10）

1. **メンテナンス時のセキュリティ**
   - ✅ Tailscale VPN導入（メンテナンス時の安全なSSH接続）
   - ✅ IPアドレス管理の変数化（`group_vars/all.yml`）
   - ✅ ネットワークモード自動検出API（`/api/system/network-mode`）
   - ✅ 運用モード可視化（管理画面のNetworkModeBadge）

2. **通常運用時のセキュリティ**
   - ✅ ファイアウォール（UFW）設定
     - HTTP/HTTPS（80/443）のみ許可
     - SSHは信頼ネットワークのみ（192.168.10.0/24、100.64.0.0/10）
     - VNCはローカルネットワークのみ（192.168.10.0/24、192.168.128.0/24）
   - ✅ HTTPS強制（CaddyによるHTTP→HTTPSリダイレクト）
   - ✅ fail2ban（SSH/Caddy HTTP認証のブルートフォース対策）
   - ✅ Caddyアクセスログとfail2ban連携

3. **ランサムウェア対策**
   - ✅ バックアップ暗号化（GPG）
   - ✅ バックアップ復元テスト（検証用DBで実施済み）
   - ⚠️ オフライン保存用USBメディアテストは未実施（USB接続時に実施予定）

4. **マルウェア対策**
   - ✅ Pi5: ClamAV/Trivy/rkhunter（日次スキャン）
   - ✅ Pi4: 軽量ClamAV/rkhunter（週次スキャン）
   - ✅ スキャン結果の自動アラート化
   - 🔸 TrivyのDockerイメージ単位スキャンは未実装

5. **監視・アラート**
   - ✅ fail2ban Banイベントの自動監視（15分間隔）
   - ✅ マルウェアスキャン結果の自動アラート化
   - ✅ 管理画面でのアラート表示
   - ✅ Webhookアラート通知（Slack等への外部通知、実機テスト完了）
   - ✅ リアルタイム監視強化（ファイル整合性・プロセス・ポート監視、実機テスト完了）

6. **インターネット接続時の追加防御（Phase 9）**
   - ✅ 管理画面IP制限（Caddyの`ADMIN_ALLOW_NETS`、実機テスト完了）
   - ✅ セキュリティヘッダー（Strict-Transport-Security含む、実機テスト完了）
   - ✅ DDoS/ブルートフォース緩和（レート制限: 認証10 req/min、グローバル120 req/min、実機テスト完了）
   - ✅ DockerイメージTrivyスキャン（CIに追加、Pi5上で定期実行スクリプト追加）
   - ✅ ログローテーション設定（52週保持、次回デプロイ時に適用予定）

7. **認証・監視強化（Phase 10）**
   - ✅ MFA（多要素認証）導入（TOTP/バックアップコード/30日記憶オプション、統合テスト・実機テスト完了）
   - ✅ リアルタイム監視強化（ファイル整合性・プロセス・ポート監視、実機テスト完了）
   - ✅ 権限監査（異常パターン検知・アラート生成、統合テスト・実機テスト完了）

## 残タスクと優先度

### 🔴 高優先度（必須）

1. **オフライン保存用USBメディアテスト**
   - **現状**: バックアップ暗号化・復元は検証済みだが、USBメディアへの実際のコピー/削除テストは未実施
   - **影響**: ランサムウェア対策の完全性に欠ける
   - **対応**: USBメディア接続時に実施

### 🟡 中優先度（推奨）

2. **TrivyのDockerイメージ単位スキャン（Pi5上での定期実行確認）**
   - **現状**: CIに追加済み、Pi5上で定期実行スクリプト追加済み（次回デプロイ後に確認予定）
   - **影響**: 低（CIで動作確認済み）
   - **対応**: 次回デプロイ後に定期実行を確認

3. **ログローテーション設定のデプロイ**
   - **現状**: Ansibleタスクで定義済みだが、次回デプロイ時に適用予定
   - **影響**: 低（ログは正常に記録されている）
   - **対応**: 次回デプロイ時に適用

### 🟢 低優先度（将来の拡張）

4. **IPアドレス直接記述箇所の完全な変数化**
   - **現状**: 主要な箇所は変数化済みだが、一部のテンプレートやスクリプトに残存
   - **影響**: ネットワーク環境変更時の手動修正が必要
   - **対応**: 残存箇所を順次変数参照に変更

5. **IPアドレス直接記述箇所の完全な変数化**
   - **現状**: 主要な箇所は変数化済みだが、一部のテンプレートやスクリプトに残存
   - **影響**: ネットワーク環境変更時の手動修正が必要
   - **対応**: 残存箇所を順次変数参照に変更

## 実装の妥当性評価

### ✅ 十分な機能を備えている点

1. **多層防御の実装**
   - ファイアウォール（UFW）→ HTTPS強制 → fail2ban → マルウェアスキャン → 監視・アラートの5層防御が実装されている
   - 各層が独立して機能し、1つの対策が失敗しても他の対策で保護される

2. **運用環境への適応**
   - ローカルネットワークのみの通常運用と、インターネット接続が必要なメンテナンス時の両方に対応
   - Tailscaleによる安全なリモートアクセス
   - ネットワークモードの自動検出と可視化

3. **リソース制約への配慮**
   - Pi3はサイネージ常時起動のためセキュリティソフト導入を見送り（適切な判断）
   - Pi4は軽量設定で週次スキャン（リソース負荷を最小化）
   - Pi5はフル機能で日次スキャン（サーバーとして適切）

4. **自動化と監視**
   - セキュリティスキャンが自動実行され、検知時に自動アラート化
   - fail2banのBanイベントも自動監視・アラート化
   - 管理画面でアラートを確認可能

5. **バックアップと復旧**
   - GPG暗号化によるバックアップ
   - 検証用DBでの復元テスト実施済み
   - ランサムウェア対策として有効

### ⚠️ 改善の余地がある点

1. **管理画面のアクセス制限**
   - 現状はローカルネットワーク内の誰でもアクセス可能
   - Tailscale ACLまたはufwでIP制限を追加すべき

2. **Dockerイメージのスキャン**
   - ファイルシステムモードのみで、コンテナ内の脆弱性検出が不完全
   - Dockerイメージ単位のスキャンを追加すべき

3. **外部通知の欠如**
   - ファイルベースのアラートのみで、リアルタイム通知がない
   - 運用者が管理画面を開かないとアラートに気づけない

4. **オフライン保存の未検証**
   - USBメディアへの実際のコピー/削除テストが未実施
   - ランサムウェア対策の完全性に欠ける

5. **MFA導入** ✅ 完了（2025-12-14）
   - ✅ Prismaスキーマ/マイグレーションで`mfaEnabled/totpSecret/mfaBackupCodes`追加
   - ✅ ログインAPIにTOTP/バックアップコード検証を実装、MFA管理API（init/activate/disable）追加
   - ✅ フロントのログイン画面にMFA入力欄を追加
   - ✅ QR/バックアップ配布UI（Securityページ）を実装
   - ✅ 30日記憶オプション（remember-me）を実装
   - ✅ 統合テスト・実機テスト完了

### 追加推奨対策とユーザビリティ影響（2025-12-13）

| 対策 | 概要 | ユーザビリティ影響 | セキュリティ効果 |
|------|------|------------------|----------------|
| **MFA導入** | パスワード＋スマホの6桁コード（TOTP）を管理画面ログインに必須化 | ログイン時に10秒程度の追加手順。30日記憶・バックアップコードで軽減 | 認証情報窃取リスクを大幅低減 |
| **リアルタイム監視強化** | ファイル整合性・プロセス・ネットワーク異常を即時検知（AIDE等） | 通常操作への影響なし。CPU/メモリ5-10%増加の可能性 | 侵入検知の遅れを短縮、EDR無効化リスクを補完 |
| **権限監査** | 誰が/いつ/何を/どう権限変更したかを履歴化し異常検知 | 操作手順は同じ、履歴閲覧機能が増えるだけ | 権限昇格の不正を可視化、透明性向上 |

推奨実装順序:
1. **MFA**（最優先: 効果最大、UX低下は軽微）
2. **権限監査**（UX影響なし、実装容易）
3. **リアルタイム監視**（UX影響なし、段階導入）

## 総合評価

### 現時点での評価: **十分な機能を備えている** ✅

**理由**:
1. **多層防御の実装**: 5層の防御機構が実装され、基本的なセキュリティ要件を満たしている
2. **運用環境への適応**: ローカル運用とメンテナンス時の両方に対応
3. **自動化と監視**: セキュリティスキャンとアラートが自動化されている
4. **リソース制約への配慮**: 各デバイスのリソースに応じた適切な設定

**ただし、以下の点で改善の余地がある**:
- オフライン保存テスト（高優先度だが、USB接続時に実施可能）
- ログローテーション設定のデプロイ（次回デプロイ時に適用予定）

### 推奨される次のステップ

1. **短期（1週間以内）**
   - USBメディア接続時にオフライン保存テストを実施
   - ログローテーション設定をデプロイ（次回デプロイ時に適用）

2. **中期（1ヶ月以内）**
   - TrivyのDockerイメージ単位スキャンの定期実行を確認（次回デプロイ後）
   - 残存するIPアドレス直接記述箇所を変数化

3. **長期（必要に応じて）**
   - セキュリティログの長期保存と分析
   - インシデント対応演習の実施（年1回計画）

## 結論

現時点で、**ローカルネットワークとインターネットの両環境で安全に運用可能**と評価できます。Phase 9/10の実装により、以下の機能が追加されました：

- ✅ 管理画面IP制限（インターネット接続時の追加防御）
- ✅ セキュリティヘッダー（Strict-Transport-Security含む）
- ✅ DDoS/ブルートフォース緩和（レート制限）
- ✅ Webhookアラート通知（外部通知）
- ✅ MFA（多要素認証）
- ✅ リアルタイム監視強化（ファイル整合性・プロセス・ポート）
- ✅ 権限監査（異常パターン検知）

**特に優れている点**：
- 多層防御の実装（ネットワーク層→アプリケーション層→データ層→監視層→インシデント対応層）
- 自動化と監視（セキュリティスキャン・アラートが自動化）
- リソース制約への適切な配慮（デバイス別の最適化）
- バックアップと復旧機能（暗号化・オフライン保存）
- 実機テストによる動作確認（Phase 9/10の主要機能を実機で検証済み）

**残タスク**：
- オフライン保存用USBメディアテスト（USB接続時に実施可能）
- ログローテーション設定のデプロイ（次回デプロイ時に適用予定）

残タスクは優先度に応じて段階的に実施することで、より強固なセキュリティ体制を維持できます。

**詳細仕様**: [Phase 9/10 詳細仕様書](./phase9-10-specifications.md)を参照

