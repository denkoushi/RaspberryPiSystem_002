# セキュリティ実装の妥当性評価

最終更新: 2025-12-05

## 概要

本ドキュメントでは、Raspberry Pi NFC 持出返却システムのセキュリティ実装について、現時点での妥当性と残タスクを評価します。

### 追加の外部インシデント評価（2025-12-13）
- 2025年10月のアスクル社ランサムウェア攻撃（[事故報告](https://prtimes.jp/main/html/rd/p/000000500.000021550.html)）を分析し、本システムへの当てはまりを評価。
- **対応可能な点**: オフライン暗号化バックアップでバックアップ削除・暗号化に耐性／ローカル運用＋Tailscaleでインターネット経由の横移動リスク低／レート制限＋fail2banでブルートフォース緩和。
- **改善が必要な点**: MFA未実装による認証情報窃取リスク／EDR相当のリアルタイム監視なし／権限変更の監査不足。

## 実装完了状況の総括

### ✅ 完了した対策（Phase 1-7）

1. **メンテナンス時のセキュリティ**
   - ✅ Tailscale VPN導入（メンテナンス時の安全なSSH接続）
   - ✅ IPアドレス管理の変数化（`group_vars/all.yml`）
   - ✅ ネットワークモード自動検出API（`/api/system/network-mode`）
   - ✅ 運用モード可視化（管理画面のNetworkModeBadge）

2. **通常運用時のセキュリティ**
   - ✅ ファイアウォール（UFW）設定
     - HTTP/HTTPS（80/443）のみ許可
     - SSHは信頼ネットワークのみ（192.168.10.0/24、100.64.0.0/10）
     - VNCはローカルネットワークのみ（192.168.10.0/24、192.168.128.0/24）
   - ✅ HTTPS強制（CaddyによるHTTP→HTTPSリダイレクト）
   - ✅ fail2ban（SSH/Caddy HTTP認証のブルートフォース対策）
   - ✅ Caddyアクセスログとfail2ban連携

3. **ランサムウェア対策**
   - ✅ バックアップ暗号化（GPG）
   - ✅ バックアップ復元テスト（検証用DBで実施済み）
   - ⚠️ オフライン保存用USBメディアテストは未実施（USB接続時に実施予定）

4. **マルウェア対策**
   - ✅ Pi5: ClamAV/Trivy/rkhunter（日次スキャン）
   - ✅ Pi4: 軽量ClamAV/rkhunter（週次スキャン）
   - ✅ スキャン結果の自動アラート化
   - 🔸 TrivyのDockerイメージ単位スキャンは未実装

5. **監視・アラート**
   - ✅ fail2ban Banイベントの自動監視（15分間隔）
   - ✅ マルウェアスキャン結果の自動アラート化
   - ✅ 管理画面でのアラート表示

## 残タスクと優先度

### 🔴 高優先度（必須）

1. **オフライン保存用USBメディアテスト**
   - **現状**: バックアップ暗号化・復元は検証済みだが、USBメディアへの実際のコピー/削除テストは未実施
   - **影響**: ランサムウェア対策の完全性に欠ける
   - **対応**: USBメディア接続時に実施

### 🟡 中優先度（推奨）

2. **TrivyのDockerイメージ単位スキャン**
   - **現状**: ファイルシステムモードのみ実装済み
   - **影響**: Dockerコンテナ内の脆弱性検出が不完全
   - **対応**: `trivy image` コマンドを使用したDockerイメージスキャンを追加

3. **管理画面のIP制限**
   - **現状**: 未実装（Tailscale ACLと連携予定）
   - **影響**: ローカルネットワーク内の誰でも管理画面にアクセス可能
   - **対応**: Tailscale ACLまたはufwで管理画面へのアクセスを特定IPに制限

### 🟢 低優先度（将来の拡張）

4. **外部通知（Slack等）**
   - **現状**: ファイルベースのアラートのみ
   - **影響**: リアルタイム通知がない
   - **対応**: `generate-alert.sh` を拡張してSlack等への通知を追加

5. **IPアドレス直接記述箇所の完全な変数化**
   - **現状**: 主要な箇所は変数化済みだが、一部のテンプレートやスクリプトに残存
   - **影響**: ネットワーク環境変更時の手動修正が必要
   - **対応**: 残存箇所を順次変数参照に変更

## 実装の妥当性評価

### ✅ 十分な機能を備えている点

1. **多層防御の実装**
   - ファイアウォール（UFW）→ HTTPS強制 → fail2ban → マルウェアスキャン → 監視・アラートの5層防御が実装されている
   - 各層が独立して機能し、1つの対策が失敗しても他の対策で保護される

2. **運用環境への適応**
   - ローカルネットワークのみの通常運用と、インターネット接続が必要なメンテナンス時の両方に対応
   - Tailscaleによる安全なリモートアクセス
   - ネットワークモードの自動検出と可視化

3. **リソース制約への配慮**
   - Pi3はサイネージ常時起動のためセキュリティソフト導入を見送り（適切な判断）
   - Pi4は軽量設定で週次スキャン（リソース負荷を最小化）
   - Pi5はフル機能で日次スキャン（サーバーとして適切）

4. **自動化と監視**
   - セキュリティスキャンが自動実行され、検知時に自動アラート化
   - fail2banのBanイベントも自動監視・アラート化
   - 管理画面でアラートを確認可能

5. **バックアップと復旧**
   - GPG暗号化によるバックアップ
   - 検証用DBでの復元テスト実施済み
   - ランサムウェア対策として有効

### ⚠️ 改善の余地がある点

1. **管理画面のアクセス制限**
   - 現状はローカルネットワーク内の誰でもアクセス可能
   - Tailscale ACLまたはufwでIP制限を追加すべき

2. **Dockerイメージのスキャン**
   - ファイルシステムモードのみで、コンテナ内の脆弱性検出が不完全
   - Dockerイメージ単位のスキャンを追加すべき

3. **外部通知の欠如**
   - ファイルベースのアラートのみで、リアルタイム通知がない
   - 運用者が管理画面を開かないとアラートに気づけない

4. **オフライン保存の未検証**
   - USBメディアへの実際のコピー/削除テストが未実施
   - ランサムウェア対策の完全性に欠ける

### 追加推奨対策とユーザビリティ影響（2025-12-13）

| 対策 | 概要 | ユーザビリティ影響 | セキュリティ効果 |
|------|------|------------------|----------------|
| **MFA導入** | パスワード＋スマホの6桁コード（TOTP）を管理画面ログインに必須化 | ログイン時に10秒程度の追加手順。30日記憶・バックアップコードで軽減 | 認証情報窃取リスクを大幅低減 |
| **リアルタイム監視強化** | ファイル整合性・プロセス・ネットワーク異常を即時検知（AIDE等） | 通常操作への影響なし。CPU/メモリ5-10%増加の可能性 | 侵入検知の遅れを短縮、EDR無効化リスクを補完 |
| **権限監査** | 誰が/いつ/何を/どう権限変更したかを履歴化し異常検知 | 操作手順は同じ、履歴閲覧機能が増えるだけ | 権限昇格の不正を可視化、透明性向上 |

推奨実装順序:
1. **MFA**（最優先: 効果最大、UX低下は軽微）
2. **権限監査**（UX影響なし、実装容易）
3. **リアルタイム監視**（UX影響なし、段階導入）

## 総合評価

### 現時点での評価: **十分な機能を備えている** ✅

**理由**:
1. **多層防御の実装**: 5層の防御機構が実装され、基本的なセキュリティ要件を満たしている
2. **運用環境への適応**: ローカル運用とメンテナンス時の両方に対応
3. **自動化と監視**: セキュリティスキャンとアラートが自動化されている
4. **リソース制約への配慮**: 各デバイスのリソースに応じた適切な設定

**ただし、以下の点で改善の余地がある**:
- 管理画面のIP制限（中優先度）
- Dockerイメージスキャン（中優先度）
- オフライン保存テスト（高優先度だが、USB接続時に実施可能）

### 推奨される次のステップ

1. **短期（1-2週間）**
   - USBメディア接続時にオフライン保存テストを実施
   - 管理画面のIP制限を追加（Tailscale ACLまたはufw）

2. **中期（1-2ヶ月）**
   - TrivyのDockerイメージ単位スキャンを実装
   - 残存するIPアドレス直接記述箇所を変数化

3. **長期（必要に応じて）**
   - Slack等への外部通知を追加
   - セキュリティログの長期保存と分析

## 結論

現時点で、**小規模なローカルネットワーク環境での運用に必要なセキュリティ機能は十分に備わっている**と評価できます。残タスクは主に「より強固な防御」や「運用の利便性向上」に関するものであり、基本的なセキュリティ要件は満たされています。

特に、以下の点で優れています：
- 多層防御の実装
- 自動化と監視
- リソース制約への適切な配慮
- バックアップと復旧機能

残タスクは優先度に応じて段階的に実施することで、より強固なセキュリティ体制を構築できます。

