# Dropboxバックアップ機能の状況調査結果

調査実施日: 2026-01-23

## 調査サマリー

✅ **Dropboxバックアップ機能は正常に動作しています**

### 主要な発見事項

1. **バックアップスケジューラー**: 正常に起動し、25個のタスクが登録されています
2. **Dropbox認証**: アクセストークンとリフレッシュトークンが設定されています
3. **バックアップ実行**: 過去30日間で104件のバックアップが実行され、68件が成功、35件が失敗
4. **最新の実行**: 2026-01-23 02:19（JST）に最新のバックアップが実行され、すべて成功

## 詳細な調査結果

### 1. 設定ファイルの確認

**設定ファイルの場所**: `/app/config/backup.json`（Dockerコンテナ内）

**ストレージプロバイダー**: `dropbox`

**Dropbox認証情報**:
- ✅ `accessToken`: 設定済み（有効）
- ✅ `refreshToken`: 設定済み（有効）
- ✅ `appKey`: 設定済み
- ✅ `appSecret`: 設定済み

**バックアップ対象**: 25個のターゲットが設定されています

### 2. バックアップスケジューラーの状態

**起動状態**: ✅ 正常に起動しています

**登録されているタスク**:
- `database`: 毎日4時 (`0 4 * * *`)
- `csv-employees`: 月〜金の5時 (`0 5 * * 1,2,3,4,5`)
- `csv-items`: 毎日5時 (`0 5 * * *`)
- `image-photo-storage`: 水曜日の6時 (`0 6 * * 3`)
- `file` (各種.envファイル): 毎日4時 (`0 4 * * *`)
- その他20個のタスク

### 3. バックアップ実行履歴（過去30日間）

**統計**:
- **総実行数**: 104件
- **成功**: 68件（65.4%）
- **失敗**: 35件（33.7%）
- **ファイル存在**: 94件（90.4%）

**過去7日間の統計**（2026-01-16以降）:
- **file**: 7件（すべて成功）
- **csv**: 4件（すべて成功）
- **image**: 3件（すべて成功）
- **database**: 2件（すべて成功）
- **client-directory**: 1件（成功）

### 4. 最新のバックアップ実行状況

**最新実行時刻**: 2026-01-23 02:19（JST）

**実行されたバックアップ**:
1. `database` - 2026-01-23 02:18:55 → 02:19:00（成功、970KB）
2. `file` (apps/api/.env) - 2026-01-23 02:19:00 → 02:19:01（成功、646B）
3. `file` (apps/web/.env) - 2026-01-23 02:19:02 → 02:19:03（成功、304B）
4. `file` (infrastructure/docker/.env) - 2026-01-23 02:19:03 → 02:19:04（成功、2.9KB）
5. `image` (photo-storage) - 2026-01-23 02:19:04 → 02:19:06（成功、713KB）
6. `csv` (employees) - 2026-01-23 02:19:06 → 02:19:07（成功、348B）
7. `csv` (items) - 2026-01-23 02:19:07 → 02:19:09（成功、193B）

**前回実行時刻**: 2026-01-23 00:47（JST）

### 5. スケジュール実行の確認

**設定されているスケジュール**:
- `database`: 毎日4時 (`0 4 * * *`)
- `csv-employees`: 月〜金の5時 (`0 5 * * 1,2,3,4,5`)
- `csv-items`: 毎日5時 (`0 5 * * *`)
- `image`: 水曜日の6時 (`0 6 * * 3`)
- `file` (.env): 毎日4時 (`0 4 * * *`)

**実際の実行時刻**:
- 2026-01-23 02:19（JST）に実行 → **スケジュール時刻と異なる**（手動実行の可能性）
- 2026-01-23 00:47（JST）に実行 → **スケジュール時刻と異なる**（手動実行の可能性）

**注意**: 最新の実行時刻（02:19）は設定されているスケジュール（4時、5時、6時）と一致していません。これは手動実行の可能性が高いです。

### 6. 失敗したバックアップの分析

**過去30日間の失敗**: 35件

**過去7日間の失敗**: 0件（すべて成功）

**失敗の傾向**: 過去7日間はすべて成功しており、最近の失敗は解消されている可能性があります。

## 結論

### ✅ 正常に動作している項目

1. **バックアップスケジューラー**: 正常に起動し、すべてのタスクが登録されています
2. **Dropbox認証**: アクセストークンとリフレッシュトークンが設定されています
3. **バックアップ実行**: 過去7日間で17件のバックアップが実行され、すべて成功しています
4. **ファイルアップロード**: Dropboxへのアップロードは正常に完了しています

### ⚠️ 注意が必要な項目

1. **スケジュール実行の確認**: 最新の実行時刻がスケジュール時刻と一致していないため、手動実行の可能性があります。次回のスケジュール実行（毎日4時、5時、6時）を監視して、自動実行が正常に動作していることを確認する必要があります。

2. **過去の失敗**: 過去30日間で35件の失敗がありますが、過去7日間はすべて成功しています。失敗の原因を特定するため、失敗したバックアップのエラーメッセージを確認することを推奨します。

## 推奨される次のステップ

1. **次回のスケジュール実行を監視**:
   - 毎日4時、5時、6時のスケジュール実行を監視
   - ログで自動実行を確認: `docker logs api | grep "BackupScheduler.*Starting scheduled backup"`

2. **失敗したバックアップの原因調査**:
   - 過去30日間の失敗したバックアップのエラーメッセージを確認
   - 失敗パターンを分析（特定のターゲット、特定の時刻など）

3. **定期的な監視**:
   - バックアップ履歴を定期的に確認
   - 失敗率が高い場合はアラートを設定

4. **Dropbox容量対策（2026-01-24追加）**:
   - Dropbox容量が逼迫している場合、管理者向けの破壊的メンテナンスとして以下を使用可能:
     - **全削除**: `POST /api/backup/dropbox/purge`
     - **選択削除（最新DBだけ残す）**: `POST /api/backup/dropbox/purge-selective`（`dryRun`対応、強い確認テキスト必須）
   - 今回は容量が既に約25%消費されていたため、**`purge-selective`で最新DBを残し既存バックアップを削除**（ワンショット対応）
   - 以後の増加抑制は、`backup.json`のスケジュール頻度/保持（`retention`）最適化で実施する（別タスク）

5. **注意: パス形式の混在（2026-01-24追加）**:
   - Dropboxのlist結果や履歴の`path`は、`/backups/...` のような完全パスを返し得る。
   - 選択削除ロジックは、`/backups/database/...` と `database/...` の両方をDBバックアップとして判定できるように対処済み。
   - API仕様は `docs/api/backup.md` を参照。

## 関連ドキュメント

- [バックアップ設定ガイド](./backup-configuration.md)
- [バックアップ・リストア手順](./backup-and-restore.md)
- [Dropbox連携セットアップガイド](./dropbox-setup-guide.md)
