---
title: Gmail連携セットアップガイド
tags: [Gmail, OAuth, 設定, PowerAutomate]
audience: [運用者, 開発者]
last-verified: 2025-12-29
related: [powerautomate-gmail-integration.md, csv-import-export.md]
category: guides
update-frequency: medium
---

# Gmail連携セットアップガイド

最終更新: 2025-12-29

## 概要

本ドキュメントでは、PowerAutomateからGmail経由でCSVファイルやJPEGファイルをPi5に送信し、自動的にインポートするためのGmail連携設定手順を説明します。

## 前提条件

- Googleアカウント（Gmail APIを使用するためのアカウント）
- Google Cloud Consoleへのアクセス権限
- Pi5への管理コンソールアクセス権限（ADMINロール）

## セットアップ手順

### 1. Google Cloud Consoleでの設定

#### 1.1 プロジェクトの作成

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成（または既存のプロジェクトを選択）
3. プロジェクト名を設定（例: "Pi5 Gmail Integration"）

#### 1.2 Gmail APIの有効化

1. 左メニューから「APIとサービス」→「ライブラリ」を選択
2. 「Gmail API」を検索
3. 「Gmail API」を選択して「有効にする」をクリック

#### 1.3 OAuth 2.0認証情報の作成

1. 左メニューから「APIとサービス」→「認証情報」を選択
2. 「認証情報を作成」→「OAuth クライアント ID」を選択
3. 同意画面の設定（初回の場合）:
   - ユーザータイプ: 「外部」を選択
   - アプリ名: 「Pi5 Gmail Integration」など
   - ユーザーサポートメール: あなたのメールアドレス
   - デベロッパーの連絡先情報: あなたのメールアドレス
   - 「保存して次へ」をクリック
   - スコープ: デフォルトのまま「保存して次へ」
   - テストユーザー: 使用するGmailアカウントを追加
   - 「保存して次へ」→「ダッシュボードに戻る」

4. OAuth クライアント IDの作成:
   - アプリケーションの種類: 「ウェブアプリケーション」を選択
   - 名前: 「Pi5 Gmail Client」など
   - 承認済みのリダイレクト URI:
     - `http://<Pi5のIPアドレス>:8080/api/gmail/oauth/callback`
     - 例: `http://192.168.1.100:8080/api/gmail/oauth/callback`
     - HTTPSを使用している場合: `https://<Pi5のドメイン>/api/gmail/oauth/callback`
   - 「作成」をクリック

5. 認証情報の保存:
   - **Client ID**をコピー（後で使用します）
   - **Client Secret**をコピー（後で使用します）
   - ⚠️ **重要**: Client Secretは一度しか表示されません。必ず安全な場所に保存してください

### 2. Pi5側の設定

#### 2.1 管理コンソールでの設定

1. Pi5の管理コンソールにログイン（ADMINロールが必要）
2. 左メニューから「Gmail設定」を選択
3. 「新規設定」ボタンをクリック
4. 以下の情報を入力:
   - **Client ID**: Google Cloud Consoleで取得したClient ID
   - **Client Secret**: Google Cloud Consoleで取得したClient Secret
   - **件名パターン**（任意）: メール検索時に使用する件名パターン
     - 例: `[Pi5 CSV Import]`
     - Gmail検索クエリ形式で指定（例: `subject:"[Pi5 CSV Import]"`）
   - **送信元メールアドレス**（任意）: メール検索時に使用する送信元アドレス
     - 例: `powerautomate@example.com`
     - 指定しない場合はすべてのメールを検索
   - **リダイレクトURI**: Google Cloud Consoleで設定したリダイレクトURIと一致させる
     - 例: `http://192.168.1.100:8080/api/gmail/oauth/callback`
5. 「保存」をクリック

#### 2.2 OAuth認証の実行

1. 「OAuth認証」ボタンをクリック
2. 新しいウィンドウが開き、Googleの認証画面が表示されます
3. 使用するGmailアカウントを選択
4. 「許可」をクリックして、Pi5がGmailにアクセスすることを承認
5. 認証が完了すると、自動的にコールバックURLにリダイレクトされます
6. 認証成功メッセージが表示されます

#### 2.3 設定の確認

1. Gmail設定画面で以下の情報が表示されることを確認:
   - ✓ Client IDが設定されている
   - ✓ Client Secretがマスクされて表示されている（例: `***1234`）
   - ✓ アクセストークン: ✓ 設定済み
   - ✓ リフレッシュトークン: ✓ 設定済み

### 3. CSVインポートスケジュールの設定

1. 左メニューから「CSVインポート」を選択
2. 「新規作成」ボタンをクリック
3. 以下の情報を入力:
   - **ID**: スケジュールの一意なID（例: `gmail-daily-import`）
   - **名前**: スケジュールの名前（例: `Gmail経由日次インポート`）
   - **プロバイダー**: `gmail`を選択
   - **従業員CSVパス**: Gmail検索用の件名パターン（例: `[Pi5 CSV Import] employees`）
   - **アイテムCSVパス**: Gmail検索用の件名パターン（例: `[Pi5 CSV Import] items`）
   - **スケジュール**: cron形式（例: `0 2 * * *` = 毎日午前2時）
   - **有効**: チェックを入れる
   - **既存データを置き換え**: 必要に応じてチェック
   - **リトライ設定**（任意）:
     - 最大リトライ回数: `3`（デフォルト）
     - リトライ間隔（秒）: `60`（デフォルト）
     - 指数バックオフ: チェック（推奨）
4. 「保存」をクリック

## トラブルシューティング

### OAuth認証が失敗する

**症状**: OAuth認証ボタンをクリックしても認証画面が表示されない、またはエラーが発生する

**原因と対処法**:
1. **リダイレクトURIの不一致**
   - Google Cloud Consoleで設定したリダイレクトURIとPi5側の設定が一致しているか確認
   - HTTPSを使用している場合、HTTPとHTTPSの違いに注意

2. **テストユーザーが追加されていない**
   - Google Cloud Consoleの「OAuth同意画面」で、使用するGmailアカウントをテストユーザーとして追加

3. **Gmail APIが有効化されていない**
   - Google Cloud Consoleで「Gmail API」が有効化されているか確認

### メールが見つからない

**症状**: CSVインポートが実行されても、メールが見つからないエラーが発生する

**原因と対処法**:
1. **件名パターンが一致していない**
   - PowerAutomate側で送信するメールの件名が、Pi5側で設定した件名パターンと一致しているか確認
   - 大文字・小文字は区別されませんが、スペースや記号は正確に一致させる必要があります

2. **送信元メールアドレスが一致していない**
   - PowerAutomate側で送信するメールの送信元アドレスが、Pi5側で設定した送信元アドレスと一致しているか確認
   - 送信元アドレスを設定していない場合は、すべてのメールを検索します

3. **メールが既にアーカイブされている**
   - GmailStorageProviderは、処理済みのメールを自動的にアーカイブします
   - テスト用のメールを再送信するか、Gmailの「すべてのメール」フォルダから検索対象のメールを確認

### トークンの有効期限切れ

**症状**: しばらく使用していないと、Gmail APIへのアクセスが失敗する

**原因と対処法**:
1. **リフレッシュトークンが設定されているか確認**
   - Gmail設定画面で「リフレッシュトークン: ✓ 設定済み」が表示されているか確認
   - 表示されていない場合は、OAuth認証を再実行

2. **手動でトークンをリフレッシュ**
   - Gmail設定画面で「トークン更新」ボタンをクリック
   - これにより、リフレッシュトークンを使用して新しいアクセストークンを取得します

### CSVインポートが失敗する

**症状**: CSVインポートスケジュールが実行されても、エラーが発生する

**原因と対処法**:
1. **添付ファイルが存在しない**
   - PowerAutomate側で送信するメールに、CSVファイルが添付されているか確認
   - 複数の添付ファイルがある場合、最初の添付ファイルが使用されます

2. **CSVファイルの形式が正しくない**
   - CSVファイルがUTF-8エンコーディングで保存されているか確認
   - ヘッダー行が正しいか確認（`employeeCode,displayName`など）

3. **リトライ設定の確認**
   - 一時的なネットワークエラーの場合、リトライ機能が自動的に再試行します
   - リトライ設定で最大リトライ回数やリトライ間隔を調整できます

## 関連ドキュメント

- [PowerAutomate Gmail連携仕様](./powerautomate-gmail-integration.md): PowerAutomate側の設定仕様
- [CSVインポート・エクスポート](./csv-import-export.md): CSVインポート機能の詳細
- [バックアップ・リストア手順](./backup-and-restore.md): バックアップ設定の詳細

