# Phase 3実機検証手順

最終更新: 2025-12-17

## 検証環境

- **Raspberry Pi 5**: サーバー（API/DB/Web UI）
- **IPアドレス**: `100.106.158.2`（Tailscale経由）
- **ブランチ**: `feature/dropbox-csv-import-phase1`
- **最新コミット**: `f57605d feat: Phase 3管理画面UI実装`

## 検証前の確認

### ✅ 完了している確認項目

1. **デプロイ完了**: Phase 3のコードがPi5にデプロイ済み
2. **データベーススキーマ**: `BackupHistory`テーブルが存在し、マイグレーションが適用済み
3. **コードコンパイル**: すべてのサービスがコンパイル済み
4. **管理画面UI**: Phase 3の管理画面ページが実装済み
5. **設定ファイル**: `backup.json`が存在し、`csvImports`は空配列（初期状態）

### 現在の状態

- **バックアップ履歴**: 0件（正常）
- **CSVインポートスケジュール**: 0件（初期状態）
- **APIヘルスチェック**: 正常

## 検証手順

### 1. バックアップ履歴UIの動作確認

#### 1.1 管理画面へのアクセス

1. ブラウザで `https://100.106.158.2/admin` にアクセス
2. ログイン（認証トークンはブラウザが自動管理）
3. 左メニューから「バックアップ」をクリック
4. 「バックアップ履歴」ページに遷移することを確認

#### 1.2 バックアップ履歴の表示確認

- **期待結果**: 空の履歴リストが表示される（現在0件のため）
- **確認項目**:
  - ページが正常に読み込まれる
  - エラーメッセージが表示されない
  - フィルタ・ページングUIが表示される（使用可能かは後で確認）

### 2. DropboxからのリストアUIの動作確認

#### 2.1 リストアページへのアクセス

1. バックアップ履歴ページから「Dropboxからリストア」リンクをクリック
2. または、直接 `https://100.106.158.2/admin/backup/restore` にアクセス

#### 2.2 リストアフォームの表示確認

- **期待結果**: リストアフォームが表示される
- **確認項目**:
  - バックアップパス入力フィールド
  - ターゲット種別選択（database, csv, allなど）
  - 整合性検証チェックボックス
  - 「リストア実行」ボタン

#### 2.3 リストア実行（テスト）

**注意**: 実際のリストアを実行する場合は、事前にバックアップが存在することを確認してください。

1. バックアップパスを入力（例: `/backups/2025-12-17/backup.tar.gz`）
2. ターゲット種別を選択
3. 整合性検証を有効化（推奨）
4. 「リストア実行」ボタンをクリック
5. 成功/失敗メッセージが表示されることを確認
6. バックアップ履歴ページで履歴が記録されることを確認

### 3. CSVインポートスケジュール管理UIの動作確認

#### 3.1 スケジュール管理ページへのアクセス

1. 左メニューから「CSVインポート」をクリック
2. または、直接 `https://100.106.158.2/admin/imports/schedule` にアクセス

#### 3.2 スケジュール一覧の表示確認

- **期待結果**: 空のスケジュールリストが表示される（現在0件のため）
- **確認項目**:
  - ページが正常に読み込まれる
  - エラーメッセージが表示されない
  - 「新規作成」ボタンが表示される

#### 3.3 スケジュールの作成

1. 「新規作成」ボタンをクリック
2. スケジュールフォームに以下を入力:
   - **ID**: `test-schedule-001`（一意のID）
   - **名前**: `テストスケジュール`（任意）
   - **従業員CSVパス**: `/test/employees.csv`（Dropboxパス）
   - **アイテムCSVパス**: `/test/items.csv`（Dropboxパス、オプション）
   - **スケジュール（cron）**: `0 0 * * *`（毎日0時）
   - **有効化**: ✅
   - **既存データ置き換え**: ⬜
   - **インポート後自動バックアップ**: ✅ 有効化
     - **バックアップ対象**: `csv`（または`all`）

3. 「作成」ボタンをクリック
4. 成功メッセージが表示されることを確認
5. スケジュール一覧に新規スケジュールが表示されることを確認

#### 3.4 スケジュールの編集

1. 作成したスケジュールの「編集」ボタンをクリック
2. 名前やスケジュールを変更
3. 「更新」ボタンをクリック
4. 変更が反映されることを確認

#### 3.5 スケジュールの手動実行

1. 作成したスケジュールの「実行」ボタンをクリック
2. 実行確認ダイアログが表示されることを確認
3. 「実行」をクリック
4. 実行結果（成功/失敗）が表示されることを確認

#### 3.6 スケジュールの削除

1. 作成したスケジュールの「削除」ボタンをクリック
2. 削除確認ダイアログが表示されることを確認
3. 「削除」をクリック
4. スケジュール一覧から削除されることを確認

### 4. CSVインポート後の自動バックアップ機能の確認

#### 4.1 自動バックアップ設定の確認

1. CSVインポートスケジュールを作成/編集時に「インポート後自動バックアップ」を有効化
2. バックアップ対象を選択（`csv`, `database`, `all`）

#### 4.2 スケジュール実行後の確認

1. CSVインポートスケジュールを手動実行
2. インポートが成功したことを確認
3. バックアップ履歴ページにアクセス
4. 自動バックアップの履歴が記録されていることを確認
   - **操作種別**: `BACKUP`
   - **ターゲット種別**: 設定した対象（`csv`, `database`, `all`）
   - **ステータス**: `COMPLETED`

### 5. バックアップ履歴APIの動作確認（フィルタ・ページング）

#### 5.1 フィルタ機能の確認

1. バックアップ履歴ページでフィルタを設定:
   - **操作種別**: `BACKUP` または `RESTORE`
   - **ステータス**: `COMPLETED` など
   - **日付範囲**: 開始日・終了日

2. 「検索」ボタンをクリック
3. フィルタ条件に一致する履歴のみが表示されることを確認

#### 5.2 ページング機能の確認

1. 複数のバックアップ履歴が存在する場合（10件以上）
2. ページネーションUIが表示されることを確認
3. 次のページに移動できることを確認
4. 前のページに戻れることを確認

## 検証結果の記録

検証実施後、以下の情報を記録してください:

- **検証日時**: 
- **検証者**: 
- **検証結果**: 
  - [ ] バックアップ履歴UI: ✅ 成功 / ❌ 失敗
  - [ ] DropboxからのリストアUI: ✅ 成功 / ❌ 失敗
  - [ ] CSVインポートスケジュール管理UI: ✅ 成功 / ❌ 失敗
  - [ ] 自動バックアップ機能: ✅ 成功 / ❌ 失敗
  - [ ] バックアップ履歴API（フィルタ・ページング）: ✅ 成功 / ❌ 失敗

- **発見された問題**: 
  - （問題があれば記録）

- **次のステップ**: 
  - （追加の検証が必要な場合は記録）

## トラブルシューティング

### 管理画面にアクセスできない

- SSL証明書のエラーが表示される場合: `https://100.106.158.2` にアクセスして証明書を承認
- 404エラーが表示される場合: Webコンテナが正常に起動しているか確認

### APIエラーが発生する

- ブラウザの開発者ツール（F12）でネットワークタブを確認
- APIレスポンスのエラーメッセージを確認
- APIコンテナのログを確認: `docker compose logs api`

### バックアップ履歴が表示されない

- データベースに`BackupHistory`テーブルが存在するか確認
- APIエンドポイントが正常に動作しているか確認（認証トークンが必要）

### CSVインポートスケジュールが保存されない

- `config/backup.json`ファイルの書き込み権限を確認
- APIコンテナのログでエラーメッセージを確認
