# Phase 3実機検証 - 次のステップ

最終更新: 2025-12-17

## 現在の状況

### ✅ 完了していること

1. **Phase 3の実装**: すべてのタスク（3.1〜3.8）が実装完了
2. **CIテスト**: すべて成功（BackupVerifier 12件、自動バックアップ機能 21件、バックアップAPI統合テストすべて成功）
3. **デプロイ**: Phase 3のコードはPi5にデプロイ済み（最新コミット: `03aacf8`）
4. **データベーススキーマ**: `BackupHistory`テーブルが存在し、マイグレーション適用済み
5. **コードコンパイル**: すべてのサービスがコンパイル済み
6. **サービスレベルの動作確認**: `BackupHistoryService.getHistoryWithFilter()`が正常に動作
7. **管理画面UI**: Phase 3の管理画面ページが実装完了（バックアップ履歴、Dropboxリストア、CSVインポートスケジュール管理）
8. **実機検証**: バックエンド・フロントエンド・CRUD操作・スケジュール実行・トークンリフレッシュのすべてが完了
9. **トークンリフレッシュ修正**: `CsvImportScheduler.executeImport`で`refreshToken`の未渡しを修正、動作確認済み

### ⏳ 要ユーザー確認項目

**実際のデータファイルを使用したエンドツーエンドテスト**は、実際のCSVファイルやバックアップファイルが必要なため、ユーザーが実施してください。

**管理画面から操作する場合は認証トークン不要**です（ブラウザが自動管理）。

## 実機検証の推奨方法

### 方法1: 管理画面から操作（推奨）

**認証トークン不要** - ブラウザが自動的にトークンを管理します。

#### 1. CSVインポート後の自動バックアップ機能の検証

1. **管理画面にアクセス**
   - URL: `https://100.106.158.2/admin`
   - ログイン（ユーザー名: `admin`）

2. **CSVインポートスケジュールを作成**
   - 管理画面でCSVインポートスケジュールを作成
   - `autoBackupAfterImport.enabled: true`を設定
   - テスト用CSVファイルをDropboxに配置

3. **スケジュールを実行**
   - 手動実行APIを呼び出す（管理画面から操作）
   - または、スケジュール時刻まで待つ

4. **自動バックアップの確認**
   - 管理画面でバックアップ履歴を確認
   - `BackupHistory`テーブルに履歴が記録されていることを確認
   - Dropboxにバックアップファイルが作成されていることを確認（Dropboxストレージを使用している場合）

#### 2. Dropboxからのリストア機能の検証

1. **事前準備: バックアップの作成**
   - 管理画面から手動バックアップを実行
   - Dropboxにバックアップファイルが作成されていることを確認

2. **リストアの実行**
   - 管理画面で「Dropboxからリストア」を操作
   - バックアップファイルを選択
   - リストアを実行

3. **リストアの確認**
   - リストアが成功することを確認
   - 管理画面でバックアップ履歴を確認
   - `BackupHistory`テーブルにリストア履歴が記録されていることを確認

#### 3. バックアップ履歴APIの検証

1. **管理画面でバックアップ履歴を表示**
   - 管理画面で「バックアップ履歴」を表示
   - 履歴が正しく表示されることを確認
   - フィルタ・ページング機能が動作することを確認

### 方法2: APIを直接呼び出す（補完的）

**認証トークンが必要** - ブラウザの開発者ツールで取得する必要があります。

詳細は `docs/guides/phase3-manual-verification-steps.md` を参照してください。

## 重要なドキュメント

- `docs/guides/phase3-production-usage-clarification.md`: 本番運用と実機検証の整理
- `docs/guides/phase3-authentication-clarification.md`: 認証トークンの整理（2種類のトークン）
- `docs/guides/phase3-manual-verification-steps.md`: 手動検証手順（APIを直接呼び出す場合）
- `docs/guides/phase3-verification-checklist.md`: 実機検証チェックリスト
- `docs/guides/phase3-real-device-verification-status.md`: 実機検証の現状

## 次のステップ

### 1. 実際のデータファイルを使用したエンドツーエンドテスト

**CSVインポートと自動バックアップのテスト**:
1. 実際のCSVファイルをDropboxに配置
2. CSVインポートスケジュールを作成（自動バックアップ有効）
3. スケジュールを手動実行
4. CSVインポートが成功することを確認
5. 自動バックアップが実行されることを確認
6. バックアップ履歴に記録されることを確認

**Dropboxからのリストアテスト**:
1. 事前にバックアップを作成（Dropboxに保存）
2. 管理画面から「Dropboxからリストア」を操作
3. バックアップファイルを選択
4. リストアが成功することを確認
5. バックアップ履歴に記録されることを確認

### 2. 本番運用への移行準備

**確認項目**:
- [ ] 実際のCSVファイルを使用したエンドツーエンドテストが成功
- [ ] 実際のバックアップファイルを使用したリストアテストが成功
- [ ] トークンリフレッシュが正常に動作することを確認（長期運用）
- [ ] エラーハンドリングが適切に動作することを確認

### 3. ドキュメントの最終更新

- [x] 検証結果を `docs/guides/phase3-verification-checklist.md` に記録 ✅
- [x] `docs/analysis/dropbox-csv-integration-status.md` を更新 ✅
- [x] 実機検証完了サマリーを作成 ✅

## 注意事項

- **CSVインポート後の自動バックアップ機能**: システムが自動実行するため、認証トークン不要
- **管理画面から操作する機能**: ブラウザが自動的にトークンを管理するため、ユーザーが意識する必要はない
- **APIを直接curlで呼び出す場合のみ認証トークンが必要**（補完的な方法）
