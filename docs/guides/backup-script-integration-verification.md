# バックアップスクリプトとの整合性確認結果

最終更新: 2025-12-29

## 概要

本ドキュメントでは、`scripts/server/backup.sh`スクリプトと管理コンソールのバックアップ機能の整合性を確認した結果を記録します。

## 検証結果

### ✅ 整合性確認完了

**検証日時**: 2025-12-29

**検証内容**:
1. `/api/backup/internal`エンドポイントの存在確認
2. バックアップスクリプトが使用する`kind`と`source`の組み合わせの確認
3. 管理コンソールのバックアップ機能との対応関係の確認

### 検証結果詳細

#### 1. `/api/backup/internal`エンドポイント

- **エンドポイント**: `POST /api/backup/internal`
- **アクセス制限**: localhostからのアクセスのみ許可（`127.0.0.1`、`::1`、`172.*`）
- **レート制限**: 無効化（`config: { rateLimit: false }`）
- **機能**: 通常の`/api/backup`エンドポイントと同じ機能を提供
- **用途**: バックアップスクリプト（`scripts/server/backup.sh`）から呼び出される

#### 2. バックアップスクリプトの動作

`scripts/server/backup.sh`は以下のバックアップ対象を処理します：

| `backup.sh`の処理 | APIの`kind` | APIの`source` | 備考 |
|------------------|------------|--------------|------|
| データベース（`pg_dump`） | `database` | `postgresql://postgres:...@db:5432/borrow_return` | ✅ 整合性あり |
| 環境変数ファイル（`.env`） | `file` | `/opt/RaspberryPiSystem_002/apps/api/.env` など | ✅ 整合性あり |
| 写真ディレクトリ（`tar.gz`） | `image` | `photo-storage` | ✅ 整合性あり |
| CSVデータ（従業員・アイテム） | `csv` | `employees`, `items` | ✅ 整合性あり |

**動作**:
- APIが利用可能な場合、API経由でバックアップを実行（設定ファイルのDropbox設定が自動的に使用される）
- APIが利用できない場合、またはAPI経由のバックアップが失敗した場合、ローカルバックアップにフォールバック
- ローカルバックアップは常に実行される（API経由のバックアップが成功しても、フォールバック用に保持）

#### 3. 管理コンソールのバックアップ機能との対応

管理コンソールのバックアップ機能は`/api/backup`エンドポイントを使用しますが、`/api/backup/internal`エンドポイントと同じロジックを使用しているため、整合性が保たれています。

**対応関係**:
- ✅ バックアップスクリプトと管理コンソールは同じバックアップロジックを使用
- ✅ 設定ファイル（`backup.json`）の設定が両方で有効
- ✅ Dropbox設定が両方で自動的に使用される
- ✅ バックアップ履歴が両方で正しく記録される

### 発見された問題

**問題なし**: バックアップスクリプトと管理コンソールのバックアップ機能は完全に整合性が取れています。

### 推奨事項

1. **バックアップスクリプトの使用**: 自動バックアップ（cronなど）では`scripts/server/backup.sh`を使用することを推奨
2. **管理コンソールの使用**: 手動バックアップでは管理コンソールのバックアップ機能を使用することを推奨
3. **設定ファイルの管理**: 両方の方法で同じ設定ファイル（`/opt/RaspberryPiSystem_002/config/backup.json`）が使用されるため、設定の一元管理が可能

---

## 関連ドキュメント

- [バックアップ・リストア手順](./backup-and-restore.md)
- [バックアップ設定ガイド](./backup-configuration.md)
- [バックアップリストア機能の実機検証結果](./backup-restore-verification-results.md)
