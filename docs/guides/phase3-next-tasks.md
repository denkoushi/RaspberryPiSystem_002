# Phase 3 次のタスク

最終更新: 2025-12-17

## 概要

Phase 3の必須検証が完了し、本番運用可能な状態になりました。以下のタスクは推奨事項として実施することを推奨します。

## 推奨タスク

### 1. バックアップ履歴の記録機能を追加 🔴 推奨

**問題**: `executeAutoBackup`メソッドが`BackupHistoryService`を使用してバックアップ履歴に記録していない

**影響**: 
- バックアップ履歴APIで自動バックアップの履歴が確認できない
- バックアップの実行履歴を追跡できない

**対応方法**:
- `apps/api/src/services/imports/csv-import-scheduler.ts`の`executeAutoBackup`メソッドを修正
- `BackupHistoryService`を使用してバックアップ履歴に記録する機能を追加
- バックアップ成功時に`BackupHistoryService.createHistory()`を呼び出す

**見積もり**: 1-2時間

**優先度**: 🔴 **高**（運用上の可視性のため）

---

### 2. リストアAPIのパス処理を改善 🟡 推奨

**問題**: `backupPath`は`basePath`を除いた相対パスで指定する必要がある

**影響**: 
- ユーザーが`/backups/csv/...`のような絶対パスを指定するとエラーになる
- パスの指定方法が直感的でない

**対応方法**:
- `apps/api/src/routes/backup.ts`の`POST /api/backup/restore/from-dropbox`エンドポイントを修正
- `backupPath`が`basePath`で始まる場合、自動的に`basePath`を削除する処理を追加
- または、`DropboxStorageProvider`の`normalizePath`メソッドを修正して、既に`basePath`が含まれている場合は追加しないようにする

**見積もり**: 1時間

**優先度**: 🟡 **中**（ユーザビリティの改善）

---

### 3. 残りのエラーハンドリングテスト 🟡 推奨

**未実施の検証項目**:
1. **バックアップ失敗時の動作確認**
   - Dropbox APIエラー時の動作確認
   - バックアップ履歴に失敗が記録されることを確認

2. **リストア失敗時の動作確認**
   - 不正なバックアップファイルを選択してリストアを実行
   - 整合性検証が失敗することを確認
   - リストアが中断されることを確認
   - エラーメッセージが適切に表示されることを確認

**見積もり**: 1-2時間

**優先度**: 🟡 **中**（エラーハンドリングの完全性のため）

---

### 4. 長期運用テスト 🟢 推奨

**検証項目**:
1. **トークンリフレッシュの長期動作確認**
   - 数日間スケジュールを実行し続ける
   - トークンリフレッシュが正常に動作することを確認

2. **スケジュール実行の継続性確認**
   - 定期的にスケジュールを実行し、継続的に正常に動作することを確認

**見積もり**: 数日間の観察

**優先度**: 🟢 **低**（本番運用開始後でも実施可能）

---

### 5. 監視・アラート設定 🟢 推奨

**検証項目**:
1. **バックアップ失敗時のアラート**
   - バックアップが失敗した場合にアラートが発火することを確認

2. **リストア失敗時のアラート**
   - リストアが失敗した場合にアラートが発火することを確認

**見積もり**: 2-3時間

**優先度**: 🟢 **低**（本番運用開始後でも実施可能）

---

## 本番運用開始の判断

### ✅ 本番運用可能な状態

必須検証が完了し、以下の機能が正常に動作することを確認済み：
- CSVインポート機能
- 自動バックアップ機能
- Dropboxからのリストア機能
- CSVインポート失敗時のエラーハンドリング

### ⚠️ 推奨事項

本番運用開始前に以下のタスクを実施することを推奨：
1. **バックアップ履歴の記録機能を追加**（優先度: 高）
2. **リストアAPIのパス処理を改善**（優先度: 中）
3. **残りのエラーハンドリングテスト**（優先度: 中）

これらのタスクは本番運用開始後でも実施可能ですが、運用上の可視性とユーザビリティの向上のため、事前に実施することを推奨します。

---

## 関連ドキュメント

- [phase3-production-readiness-assessment.md](./phase3-production-readiness-assessment.md): 本番運用可否評価
- [phase3-mandatory-verification-results.md](./phase3-mandatory-verification-results.md): 必須検証結果
- [dropbox-csv-integration-status.md](../analysis/dropbox-csv-integration-status.md): Phase 3実装状況
