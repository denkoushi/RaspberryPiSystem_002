# Phase 3 次のタスク

最終更新: 2025-12-17

## 概要

Phase 3の必須検証が完了し、本番運用可能な状態になりました。以下のタスクは推奨事項として実施することを推奨します。

## 推奨タスク

### 1. バックアップ履歴の記録機能を追加 ✅ 完了

**問題**: `executeAutoBackup`メソッドが`BackupHistoryService`を使用してバックアップ履歴に記録していない

**対応完了**: ✅ **実装完了**（2025-12-17）
- `apps/api/src/services/imports/csv-import-scheduler.ts`の`executeAutoBackup`メソッドを修正
- `BackupHistoryService`を使用してバックアップ履歴に記録する機能を追加
- バックアップ成功時に`BackupHistoryService.createHistory()`を呼び出し、完了として更新
- バックアップ失敗時に失敗として更新
- `BackupVerifier`を使用してハッシュを計算して履歴に記録

---

### 2. リストアAPIのパス処理を改善 ✅ 完了

**問題**: `backupPath`は`basePath`を除いた相対パスで指定する必要がある

**対応完了**: ✅ **実装完了**（2025-12-17）
- `apps/api/src/routes/backup.ts`の`POST /api/backup/restore/from-dropbox`エンドポイントを修正
- `backupPath`が`basePath`で始まる場合、自動的に`basePath`を削除する処理を追加
- 正規化されたパスを使用してダウンロード・履歴記録を実行
- ログには正規化されたパスと元のパスの両方を記録

---

### 3. 残りのエラーハンドリングテスト 🟡 推奨

**未実施の検証項目**:
1. **バックアップ失敗時の動作確認**
   - Dropbox APIエラー時の動作確認
   - バックアップ履歴に失敗が記録されることを確認

2. **リストア失敗時の動作確認**
   - 不正なバックアップファイルを選択してリストアを実行
   - 整合性検証が失敗することを確認
   - リストアが中断されることを確認
   - エラーメッセージが適切に表示されることを確認

**見積もり**: 1-2時間

**優先度**: 🟡 **中**（エラーハンドリングの完全性のため）

---

### 4. 長期運用テスト 🟢 推奨

**検証項目**:
1. **トークンリフレッシュの長期動作確認**
   - 数日間スケジュールを実行し続ける
   - トークンリフレッシュが正常に動作することを確認

2. **スケジュール実行の継続性確認**
   - 定期的にスケジュールを実行し、継続的に正常に動作することを確認

**見積もり**: 数日間の観察

**優先度**: 🟢 **低**（本番運用開始後でも実施可能）

---

### 5. 監視・アラート設定 🟢 推奨

**検証項目**:
1. **バックアップ失敗時のアラート**
   - バックアップが失敗した場合にアラートが発火することを確認

2. **リストア失敗時のアラート**
   - リストアが失敗した場合にアラートが発火することを確認

**見積もり**: 2-3時間

**優先度**: 🟢 **低**（本番運用開始後でも実施可能）

---

## 本番運用開始の判断

### ✅ 本番運用可能な状態

必須検証が完了し、以下の機能が正常に動作することを確認済み：
- CSVインポート機能
- 自動バックアップ機能
- Dropboxからのリストア機能
- CSVインポート失敗時のエラーハンドリング

### ✅ 推奨事項の実施状況

本番運用開始前に推奨されていたタスク：
1. ✅ **バックアップ履歴の記録機能を追加**（優先度: 高）: **完了**
2. ✅ **リストアAPIのパス処理を改善**（優先度: 中）: **完了**
3. ⏳ **残りのエラーハンドリングテスト**（優先度: 中）: **未実施**（本番運用開始後でも実施可能）

**結論**: 本番運用開始可能な状態です。残りのエラーハンドリングテストは本番運用開始後でも実施可能です。

---

## 関連ドキュメント

- [phase3-production-readiness-assessment.md](./phase3-production-readiness-assessment.md): 本番運用可否評価
- [phase3-mandatory-verification-results.md](./phase3-mandatory-verification-results.md): 必須検証結果
- [dropbox-csv-integration-status.md](../analysis/dropbox-csv-integration-status.md): Phase 3実装状況
