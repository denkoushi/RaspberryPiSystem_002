# 計測機器管理システム 実機検証手順

最終更新: 2025-12-09

## 概要

本ドキュメントでは、ラズパイ4キオスクでの計測機器管理機能の実機検証手順を説明します。

## 検証環境

- **Raspberry Pi 5**: サーバー（API/DB/Web UI）
- **Raspberry Pi 4**: クライアント（キオスク + NFCリーダーRC-S300/S1）

## 前提条件

1. **サーバー側の準備**
   - ラズパイ5でAPI/Web/DBが起動していること
   - featureブランチの最新コードがデプロイされていること
     ```bash
     # ラズパイ5で実行
     cd /opt/RaspberryPiSystem_002
     ./scripts/server/deploy.sh feature/measuring-instruments-requirements
     ```
   - シードデータが投入されていること（計測機器テストデータ含む）
     ```bash
     # ラズパイ5で実行（デプロイ後）
     cd /opt/RaspberryPiSystem_002/apps/api
     docker compose -f ../../infrastructure/docker/docker-compose.server.yml exec -T api pnpm prisma db seed
     ```

2. **クライアント側の準備**
   - ラズパイ4でNFCエージェントが起動していること
   - ブラウザでキオスク画面にアクセス可能なこと

## 検証項目

### 1. 計測機器持出フロー（OKケース）

#### 1.1 準備

1. **管理画面でデータ確認**
   - `http://<ラズパイ5のIP>:4173/admin/tools/measuring-instruments` にアクセス
   - 計測機器が3件（MI-001, MI-002, MI-003）登録されていることを確認
   - 点検項目が各計測機器に3項目ずつ登録されていることを確認

2. **キオスク画面にアクセス**
   - `http://<ラズパイ5のIP>:4173/kiosk/instruments/borrow` にアクセス
   - 計測機器選択ドロップダウンが表示されることを確認

#### 1.2 検証手順

1. **計測機器選択**
   - ドロップダウンから「デジタルマルチメータ（MI-001）」を選択
   - 点検項目が3項目表示されることを確認
   - 各点検項目の内容・基準・方法が表示されることを確認

2. **氏名タグスキャン（自動送信）**
   - 氏名タグ入力欄にフォーカスが当たっていることを確認
   - 従業員タグ（UID: `04C362E1330289`）をスキャン
   - 500msデバウンス後に自動送信されることを確認（点検項目がなくても自動送信される）
   - 「持出登録完了」メッセージが表示されることを確認

**注意**: 2025-12-08の修正により、点検項目がなくても自動送信されます。

3. **点検記録の確認**
   - 管理画面の「点検記録」ページで確認
   - 3件の点検記録が作成され、すべて「PASS」になっていることを確認

**期待される結果**: 
- ✅ 計測機器選択→点検項目表示→氏名タグスキャン→自動送信が正常に動作
- ✅ 点検記録が全項目PASSで作成される

### 2. 計測機器持出フロー（NGケース）

#### 2.1 検証手順

1. **計測機器選択**
   - ドロップダウンから「ノギス（MI-002）」を選択
   - 点検項目が表示されることを確認

2. **NGボタン押下**
   - 「NGにする」ボタンをクリック
   - 氏名タグUID入力欄が有効になることを確認
   - 従業員タグ（UID: `04C362E1330289`）をスキャンまたは手入力
   - 「NGにする」ボタンを再度クリック
   - 「持出登録完了（NG）」メッセージが表示されることを確認

3. **点検記録の確認**
   - 管理画面の「点検記録」ページで確認
   - NGケースでは点検記録が作成されていないことを確認（Loanのみ作成）

**期待される結果**: 
- ✅ NGボタン押下→氏名タグ入力→送信が正常に動作
- ✅ NGケースでは点検記録が作成されない

### 3. 計測機器返却フロー

#### 3.1 準備

- 上記の持出フローで計測機器を1件以上持出登録しておく

#### 3.2 検証手順

1. **返却画面にアクセス**
   - `http://<ラズパイ5のIP>:4173/kiosk/instruments/return` にアクセス
   - 「貸出中の計測機器」セクションが表示されることを確認
   - 持出登録した計測機器が一覧に表示されることを確認

2. **返却操作**
   - 返却したい計測機器の「返却」ボタンをクリック
   - 「返却完了」メッセージが表示されることを確認
   - 一覧から該当計測機器が消えることを確認

3. **ステータス確認**
   - 管理画面の「計測機器」ページで確認
   - 返却した計測機器のステータスが「AVAILABLE」になっていることを確認

**期待される結果**: 
- ✅ 貸出中計測機器一覧表示→返却操作→ステータス更新が正常に動作

### 4. 計測機器タグUID自動選択（手動入力で検証）

#### 4.1 検証手順

1. **タグUID手動入力（選択なしで検証）**
   - 計測機器選択ドロップダウンは「選択してください」のまま
   - 計測機器タグUID入力欄に「MI-MI-001」を入力
   - 500msデバウンス後に「デジタルマルチメータ」が自動選択されることを確認
   - 点検項目が自動表示されることを確認

2. **選択のみで検証（タグUIDなし）**
   - 計測機器タグUID入力欄は空のまま
   - ドロップダウンから「デジタルマルチメータ（MI-001）」を選択
   - 点検項目が表示されることを確認
   - 氏名タグをスキャンして自動送信されることを確認

**期待される結果**: 
- ✅ タグUID入力→計測機器自動選択→点検項目表示が正常に動作
- ✅ 選択のみでも持出登録が可能（タグUIDなし）
- ✅ 選択 or タグUIDのどちらかでOK（両方必須ではない）
- ⚠️ TS100による自動スキャンは実機が利用可能になったら検証予定

**注意**: 2025-12-08の修正により、計測機器は「選択」または「タグUID入力」のどちらかでOKになりました。両方必須ではありません。

### 5. サイネージ表示（計測機器ステータス・校正期限アラート）

#### 5.1 準備

- ラズパイ3のサイネージ画面が表示されていること

#### 5.2 検証手順

1. **サイネージ画面確認**
   - サイネージ画面で計測機器セクションが表示されることを確認
   - 計測機器カードが表示されることを確認

2. **校正期限アラート確認**
   - MI-001（期限切れ）: 赤色バッジ「校正期限切れ」が表示されることを確認
   - MI-002（期限間近）: 黄色バッジ「校正期限間近」が表示されることを確認
   - MI-003（正常）: 緑色バッジ「正常」が表示されることを確認

3. **計測機器情報確認**
   - 各カードに名称・管理番号・保管場所・ステータス・校正期限が表示されることを確認

**期待される結果**: 
- ✅ 計測機器情報がサイネージに表示される
- ✅ 校正期限アラートが正しく表示される（色分け・バッジ）

## トラブルシューティング

### 問題1: 計測機器が選択できない

**確認事項**:
- 管理画面で計測機器が登録されているか
- ブラウザのコンソールにエラーがないか（フルスクリーン環境ではsystemdログを確認）
- APIがclient-key認証で動作しているか

**対処法**:
- 管理画面で計測機器を確認
- APIログを確認: `docker logs docker-api-1 | grep measuring-instruments`
- client-key認証が正しく動作しているか確認: `curl -H 'x-client-key: client-key-raspberrypi4-kiosk1' http://<Pi5のIP>:8080/api/measuring-instruments`
- ブラウザをリロード
- キオスクブラウザサービスを再起動: `sudo systemctl restart kiosk-browser.service`

**注意**: 2025-12-08の修正により、キオスクから計測機器一覧を取得できるようになりました（client-key認証対応）。

### 問題2: 点検項目が表示されない

**確認事項**:
- 選択した計測機器に点検項目が登録されているか
- APIエンドポイント `/api/measuring-instruments/:id/inspection-items` が正常に動作しているか

**対処法**:
- 管理画面で点検項目を確認・追加
- APIログを確認

### 問題3: 氏名タグスキャンで自動送信されない

**確認事項**:
- NFCエージェントが起動しているか
- WebSocket接続が確立されているか
- 氏名タグUIDが正しく入力されているか
- 計測機器が選択されているか、またはタグUIDが入力されているか（どちらかでOK）

**対処法**:
- NFCエージェントのステータスを確認: `curl http://localhost:7071/api/agent/status`
- ブラウザのコンソールでWebSocket接続を確認（フルスクリーン環境ではsystemdログを確認）
- 計測機器を選択するか、タグUIDを入力する（どちらかでOK）
- 点検項目がなくても自動送信される（2025-12-08修正済み）
- 手動入力で代替検証

**注意**: 2025-12-08の修正により、計測機器は「選択」または「タグUID入力」のどちらかでOKになりました。両方必須ではありません。また、点検項目がなくても自動送信されます。

### 問題4: サイネージに計測機器が表示されない

**確認事項**:
- `/api/signage/content` のレスポンスに `measuringInstruments` が含まれているか
- サイネージ画面のコードが最新か

**対処法**:
- APIレスポンスを確認: `curl http://<ラズパイ5のIP>:8080/api/signage/content`
- サイネージ画面をリロード

### 問題5: キオスクブラウザ起動が空URLでカメラ・APIが動かない

**事象**:
- `/usr/local/bin/kiosk-launch.sh` の変数展開が壊れ、`--app=""` / `--user-data-dir=` / `--unsafely-treat-insecure-origin-as-secure=` が空になる
- Chromiumが空URLで起動し、カメラAPI起動遅延・API 401/404・UI未描画が発生

**原因**:
- テンプレート外の手作業修正で変数が消失し、従来のAnsibleテンプレート (`infrastructure/ansible/templates/kiosk-launch.sh.j2`) と乖離

**対処法**:
- Pi4で修正済みスクリプトを再配置し、サービスを再起動
  ```bash
  # Pi4 (tools03)
  sudo cp /tmp/kiosk-launch-fixed.sh /usr/local/bin/kiosk-launch.sh
  sudo chmod +x /usr/local/bin/kiosk-launch.sh
  sudo systemctl restart kiosk-browser.service
  ```
- 正常なフラグが入っていることを確認  
  `--app=https://100.106.158.2/kiosk`  
  `--user-data-dir=/home/tools03/.config/chromium-kiosk`  
  `--unsafely-treat-insecure-origin-as-secure=https://100.106.158.2`  
  `--use-fake-ui-for-media-stream` / `--ignore-certificate-errors`

**再発防止**:
- kiosk-launch.sh は必ず Ansible テンプレートを適用し、手作業上書きを避ける
- 変更時は `systemctl restart kiosk-browser.service` 後に `journalctl -u kiosk-browser.service -n 50` で起動オプションを確認

### 問題6: エラーメッセージが古い／リセットが効かない

**事象**:
- 「エラーが発生しました」のまま文言が変わらない
- 「リセット」ボタンが動作しない

**原因**:
- フロントエンドのビルドが古いままデプロイされ、最新の文言・挙動が反映されていなかった

**対処法**:
- ラズパイ5でフロントを再ビルドしてwebコンテナへ反映  
  `pnpm --filter @raspi-system/web build`  
  `docker cp dist/. docker-web-1:/srv/site/`
- `index.html` が最新JS（例: `/assets/index-*.js`）を参照しているか確認
- キオスクブラウザを再起動しキャッシュをクリア  
  `sudo systemctl restart kiosk-browser.service`

**期待される挙動（最新ビルド）**:
- 未登録タグ: 「タグ未登録（アイテム）」/「タグ未登録（社員）」を表示
- その他: 「登録エラーが発生しました」を表示
- リセットボタン: 画面をリロード（F5相当）して初期化

## 検証完了条件

以下のすべてが確認できれば検証完了：

- ✅ 計測機器持出フロー（OKケース）が正常に動作
- ✅ 計測機器の識別は「最初に操作した方法（ドロップダウン or タグUID入力/NFC/TS100）」のみが採用される
- ✅ 計測機器持出フロー（NGケース）が正常に動作
- ✅ 計測機器返却フローが正常に動作
- ✅ タグUIDによる自動選択が正常に動作（手動入力で検証）
- ✅ サイネージ表示が正常に動作（校正期限アラート含む）

## 関連ドキュメント

- [計測機器管理システム要件定義](../requirements/measuring-instruments-requirements.md)
- [計測機器管理モジュール](../modules/measuring-instruments/README.md)
- [検証チェックリスト](./verification-checklist.md)
