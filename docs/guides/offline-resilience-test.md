# オフライン耐性の実機検証手順

最終更新: 2025-11-24

## 何を検証するか

**問題**: ネットワークが切れている時、NFCカードをかざしてもイベントが失われてしまう

**解決策**: オフライン時にイベントをキューに保存し、ネットワークが復旧したら自動的に再送する

**検証内容**: この機能が実際に動作することを確認する

## 検証手順（簡単版）

### 準備

1. **ラズパイ4でNFCエージェントを起動**
   ```bash
   cd /opt/RaspberryPiSystem_002/clients/nfc-agent
   poetry run python -m nfc_agent
   ```

2. **ブラウザでキオスク画面を開く**
   - `http://<ラズパイ5のIP>:4173/kiosk` にアクセス
   - WebSocket接続が確立される

### 検証1: オフライン時の動作確認

1. **ブラウザを閉じる**（WebSocket接続を切断）
2. **NFCカードをかざす**（複数回かざしてもOK）
3. **キューに保存されているか確認**
   ```bash
   curl http://localhost:7071/api/agent/queue
   ```
   - 結果に `"events": [...]` が表示されればOK
   - イベントが保存されていることを確認

### 検証2: オンライン復帰後の再送確認

1. **ブラウザでキオスク画面を再度開く**（WebSocket接続を再確立）
2. **キューが空になることを確認**
   ```bash
   curl http://localhost:7071/api/agent/queue
   ```
   - `"events": []` が表示されればOK
   - イベントが再送されたことを確認

3. **キオスク画面でイベントが処理されることを確認**
   - 持出画面で、かざしたカードのUIDが表示されることを確認

## 期待される結果

✅ **成功**: オフライン時にかざしたカードのイベントが、オンライン復帰後に自動的に再送され、キオスク画面で処理される

❌ **失敗**: イベントが失われる、または再送されない

## トラブルシューティング

### キューにイベントが保存されない

- NFCエージェントのログを確認: `poetry run python -m nfc_agent` の出力を見る
- NFCリーダーが認識されているか確認: `curl http://localhost:7071/api/agent/status`

### イベントが再送されない

- WebSocket接続が確立されているか確認（ブラウザの開発者ツールで確認）
- NFCエージェントのログを確認（再送のログが出力される）

### キューが空にならない

- WebSocket接続が確立されているか確認
- ブラウザのコンソールでエラーが出ていないか確認

## 検証のタイミング

**今すぐ検証すべきか？**

- ✅ **実装は完了している**: コードは実装済み
- ✅ **動作確認が必要**: 実機で動作することを確認する必要がある
- ⚠️ **必須ではない**: システムは既に動作しているが、オフライン耐性が追加された

**推奨**: 
- システムが安定して動作している場合は、実機検証は後回しでもOK
- オフライン環境で使用する予定がある場合は、今すぐ検証すべき

