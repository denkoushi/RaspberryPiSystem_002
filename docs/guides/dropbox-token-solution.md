# Dropboxトークン常時アクセス解決策

最終更新: 2025-12-15

## 問題の整理

**現状**: Dropboxバックアップ機能は、スケジュール実行時に自動的にDropboxにアップロードする必要があります。しかし、トークンが期限切れになると、バックアップが失敗します。

**要件**: **常時アクセス可能なトークンが必要**（スケジュールバックアップが自動実行されるため）

## 解決策

### ⚠️ 重要な確認事項

**「Access token expiration」設定は存在しません**

Dropboxは2021年9月30日以降、長期アクセストークンの新規発行を停止し、この設定も削除されました。現在、App Consoleの「Generated access token」で生成されるトークンも**短期トークン（約4時間）**です。

### 解決策1: 新しいトークンを生成して設定（暫定対応）

短期トークンでも、新しいトークンを生成して設定することで一時的に動作します。

#### 手順

1. **Dropbox App Consoleで新しいトークンを生成**
   - https://www.dropbox.com/developers/apps を開く
   - アプリを選択
   - 「Generated access token」セクションで「Generate」ボタンをクリック
   - 表示されたトークンをコピー（`sl.`で始まる長い文字列）

2. **Pi5に設定**
   ```bash
   # Macのターミナルから実行
   DROPBOX_TOKEN="sl.新しいトークン"
   ssh denkon5sd02@100.106.158.2 "cd /opt/RaspberryPiSystem_002/infrastructure/docker && sed -i 's/DROPBOX_ACCESS_TOKEN=.*/DROPBOX_ACCESS_TOKEN=$DROPBOX_TOKEN/' .env && grep DROPBOX_ACCESS_TOKEN .env"
   
   # APIコンテナを再起動
   ssh denkon5sd02@100.106.158.2 "cd /opt/RaspberryPiSystem_002 && docker compose -f infrastructure/docker/docker-compose.server.yml restart api"
   ```

**注意**: このトークンは約4時間で期限切れになります。定期的に更新が必要です。

### 解決策2: OAuth 2.0フローでリフレッシュトークンを取得（将来的な実装）

「No expiration」設定が利用できない場合、またはよりセキュアな方法が必要な場合：

1. **OAuth 2.0フローを実装**
   - リフレッシュトークンを取得
   - アクセストークンが期限切れになったら自動的にリフレッシュ

2. **現在の実装状況**
   - ⚠️ **未実装**: 現在のシステムはリフレッシュトークンの自動更新機能を持っていません
   - 実装には追加開発が必要です

### 解決策3: 定期的なトークン更新スクリプト（暫定対応）

短期トークンしか取得できない場合の暫定対応：

1. **トークン更新スクリプトを作成**
   - 定期的に（例: 3時間ごと）新しいトークンを生成
   - `.env`ファイルを自動更新
   - APIコンテナを再起動

2. **cronジョブで自動実行**
   - Pi5上でcronジョブを設定
   - ただし、この方法は推奨されません（手動トークン生成が必要）

## 推奨される対応

### 短期対応（今すぐ実行可能）

1. **新しいトークンを生成して設定**（解決策1）
   - 約4時間ごとに手動で更新が必要
   - スケジュールバックアップが4時間以内に実行される場合は動作します

### 恒久対応（実装が必要）

2. **OAuth 2.0フローとリフレッシュトークンの自動更新機能を実装**（解決策2）
   - **これが唯一の恒久解決策です**
   - リフレッシュトークンは無期限で、アクセストークンを自動更新できます
   - 実装には追加開発が必要ですが、スケジュールバックアップには必須です

## 現実的な対応

**現時点での推奨**:
1. 新しいトークンを生成して設定（解決策1）
2. スケジュールバックアップの実行時刻を確認（4時間以内であれば動作）
3. OAuth 2.0フローの実装を計画（恒久解決策）

## トラブルシューティング

### 「Access token expiration」設定が見つからない

- アプリの種類を確認（「Full Dropbox」アクセスに変更を検討）
- または、アプリを再作成して「Full Dropbox」アクセスで作成

### トークンを設定しても期限切れエラーが続く

1. トークンが正しく設定されているか確認
2. APIコンテナが再起動されているか確認
3. 新しいトークンを再生成して設定

### 長期的な解決が必要

- OAuth 2.0フローとリフレッシュトークンの自動更新機能を実装することを検討
- 実装には追加開発が必要です
