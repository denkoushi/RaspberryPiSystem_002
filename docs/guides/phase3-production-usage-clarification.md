# Phase 3の本番運用と実機検証の整理

最終更新: 2025-12-16

## 重要な整理：認証トークンについて

### 認証トークンは常に必要

**重要なポイント**: APIを呼び出すには、認証トークンは**常に必要**です。

ただし、**取得・設定方法が異なる**だけです：

1. **管理画面から操作する場合**（本番運用・実機検証共通）
   - ログイン時にブラウザが自動的にトークンを取得・保存
   - 以降のAPIリクエストは自動的にトークンが含まれる
   - **ユーザーはトークンを意識する必要がない**（ブラウザが自動管理）

2. **curlでAPIを直接呼び出す場合**（実機検証の補完的方法）
   - 手動でトークンを取得する必要がある
   - リクエストヘッダーに`Authorization: Bearer <トークン>`を付与する必要がある

### Phase 3の機能と認証トークンの関係

#### 1. CSVインポート後の自動バックアップ機能（タスク3.1）

**本番運用での動作**:
- **システムが自動実行**（`CsvImportScheduler`がcronで実行）
- **認証トークン不要**（システム内部の処理、APIを呼び出さない）
- ユーザーは設定ファイル（`backup.json`）で有効/無効を切り替えるだけ

**実機検証での確認方法**:
- ✅ **認証トークン不要**（システムが自動実行するため）
- CSVインポートスケジュールを設定して実行
- 自動的にバックアップが実行されることを確認
- `BackupHistory`テーブルに履歴が記録されることを確認

#### 2. Dropboxからのリストア機能（タスク3.2）

**本番運用での動作**:
- **ユーザーが管理画面から操作**
- ブラウザが自動的に認証トークンを取得・設定（ユーザーが意識する必要はない）
- ユーザーは管理画面で「リストア」ボタンをクリックするだけ

**実機検証での確認方法**:
- ✅ **管理画面から操作する場合**: ブラウザが自動的にトークンを管理（ユーザーは意識しない）
- ⚠️ **curlでAPIを直接呼び出す場合**: 手動でトークンを取得する必要がある
- 実機検証では、管理画面から操作して動作確認するのが適切

#### 3. バックアップ履歴API（タスク3.4, 3.6）

**本番運用での動作**:
- **ユーザーが管理画面で確認**
- ブラウザが自動的に認証トークンを取得・設定（ユーザーが意識する必要はない）
- ユーザーは管理画面で「バックアップ履歴」を表示するだけ

**実機検証での確認方法**:
- ✅ **管理画面から操作する場合**: ブラウザが自動的にトークンを管理（ユーザーは意識しない）
- ⚠️ **curlでAPIを直接呼び出す場合**: 手動でトークンを取得する必要がある
- 実機検証では、管理画面から操作して動作確認するのが適切

## 本番運用での認証トークン

**結論**: 本番運用では、ユーザーが**手動で認証トークンを取得する必要はありません**。

- **管理画面から操作する場合**: ブラウザが自動的にトークンを取得・設定（ユーザーは意識しない）
- **システムが自動実行する場合**: 認証トークン不要（システム内部の処理、APIを呼び出さない）

## 実機検証での認証トークン

**結論**: 実機検証でも、**管理画面から操作する場合は、ユーザーが手動でトークンを取得する必要はありません**。

- **CSVインポート後の自動バックアップ機能**: 認証トークン不要（システムが自動実行）
- **管理画面から操作する機能**: ブラウザが自動的にトークンを取得・設定（ユーザーは意識しない）

**curlでAPIを直接呼び出す場合のみ、手動でトークンを取得する必要があります**が、これは実機検証の補完的な方法です。

## 推奨される実機検証方法

### 方法1: 管理画面から操作（推奨）

1. **CSVインポート後の自動バックアップ機能**
   - 管理画面でCSVインポートスケジュールを作成
   - スケジュールを実行（または自動実行を待つ）
   - 管理画面でバックアップ履歴を確認

2. **Dropboxからのリストア機能**
   - 管理画面で「Dropboxからリストア」を操作
   - リストアが成功することを確認
   - 管理画面でバックアップ履歴を確認

3. **バックアップ履歴API**
   - 管理画面で「バックアップ履歴」を表示
   - 履歴が正しく表示されることを確認

**この方法では認証トークンは不要**（ブラウザが自動管理）

### 方法2: APIを直接呼び出す（補完的）

- APIを直接curlで呼び出す場合のみ認証トークンが必要
- これは実機検証の補完的な方法

## まとめ

### 認証トークンの取得・設定方法

| 操作方法 | 本番運用 | 実機検証 | トークン取得方法 |
|---------|---------|---------|----------------|
| 管理画面から操作 | ✅ ブラウザが自動管理 | ✅ ブラウザが自動管理 | ユーザーは意識しない |
| curlでAPI直接呼び出し | ❌ 通常は使用しない | ⚠️ 補完的な方法 | 手動で取得が必要 |
| システム自動実行 | ✅ トークン不要 | ✅ トークン不要 | システム内部処理 |

### 重要なポイント

1. **認証トークンは常に必要**（APIを呼び出すため）
2. **ただし、管理画面から操作する場合は、ブラウザが自動的に取得・設定する**
3. **本番運用でも実機検証でも、管理画面から操作する場合は同じ**（ブラウザが自動管理）
4. **curlでAPIを直接呼び出す場合のみ、手動でトークンを取得する必要がある**

実機検証は、**管理画面から操作する方法**で実施するのが適切です。この方法では、ユーザーが手動でトークンを取得する必要はありません。
