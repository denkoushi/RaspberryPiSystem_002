# セキュリティ機能の使い方ガイド（ユーザー向け）

最終更新: 2025-12-14

## はじめに

このガイドでは、Phase 9/10で実装したセキュリティ機能について、**管理コンソールやキオスクを使う方**向けに、平易に詳しく説明します。

**重要なポイント**:
- 通常の使い方は**今まで通り**です
- ただし、**初回のみ**MFA（多要素認証）のセットアップが必要です
- セキュリティインシデントが発生した場合は、**通知**が届き、**対応が必要**な場合があります

---

## 通常運用時の使い方

### 管理コンソール（Pi5）

#### 今まで通り使えます

- ログイン方法、画面の見た目、操作方法は**すべて今まで通り**です
- 工具の持出・返却、従業員管理、データ確認など、すべて通常通り使えます

#### 初回のみ：MFA（多要素認証）のセットアップが必要

**MFAとは？**
- パスワードに加えて、スマートフォンのアプリで表示される6桁のコードを入力するセキュリティ機能です
- パスワードが盗まれても、スマートフォンがないとログインできません

**セットアップ手順**（初回のみ、5分程度）:

1. **管理コンソールにログイン**（通常通り）
   - ユーザー名とパスワードでログイン

2. **「セキュリティ」ページを開く**
   - 左メニューから「セキュリティ」をクリック
   - または `/admin/security` に直接アクセス

3. **MFAを有効化**
   - 「MFAセットアップ」セクションで「セットアップ開始」ボタンをクリック
   - QRコードが表示されます

4. **スマートフォンでQRコードを読み取る**
   - Google Authenticator、Microsoft Authenticatorなどの認証アプリをインストール
   - アプリでQRコードをスキャン
   - 6桁のコードが表示されます

5. **コードを入力して有効化**
   - 表示された6桁のコードを入力
   - 「有効化」ボタンをクリック
   - **バックアップコードを必ず保存**してください（スマートフォンを紛失した場合に必要）

6. **次回ログインから**
   - ユーザー名とパスワードを入力
   - 認証アプリで表示される6桁のコードを入力
   - 「30日間記憶する」にチェックを入れると、30日間はコード入力が不要になります

**MFAを無効化したい場合**:
- 「セキュリティ」ページの「MFA無効化」セクションで、パスワードを入力して無効化できます

**バックアップコードを紛失した場合**:
- MFAを無効化してから、再度セットアップしてください

#### その他の機能（自動で動作）

以下の機能は**自動で動作**しており、**特別な操作は不要**です：

- **管理画面へのIP制限**: 許可されたネットワークからのみアクセス可能（通常は問題ありません）
- **セキュリティヘッダー**: ブラウザのセキュリティを強化（自動で適用されます）
- **レート制限**: 短時間に大量のリクエストを送ると一時的にブロックされます（通常の使い方では問題ありません）
- **リアルタイム監視**: ファイルの改ざん、プロセスの異常、許可外ポートを自動監視（バックグラウンドで動作）

### キオスク（Pi4）

#### 今まで通り使えます

- **一切変更ありません**
- 工具の持出・返却、計測機器の持出・返却など、すべて通常通り使えます
- セキュリティ機能は**サーバー側（Pi5）で動作**しており、キオスク側には影響しません

---

## インシデント発生時の対応

### 通知の受け取り方

セキュリティインシデントが発生した場合、以下の方法で**通知**が届きます：

#### 1. 管理画面のアラート一覧（推奨）

**確認方法**:
- 管理コンソールのトップページ（`/admin`）にアクセス
- 「アラート」セクションに、最新のセキュリティアラートが表示されます
- アラートの種類と重要度（Critical/High/Medium/Low）が表示されます

**確認頻度**:
- **推奨**: 1日1回、管理コンソールを開いたときに確認
- 重要なアラートは赤色で表示されます

#### 2. Webhook通知（設定時のみ）

**設定方法**（システム管理者が実施）:
- Slack、Microsoft TeamsなどのWebhook URLを設定すると、アラートが自動送信されます
- 未設定の場合は、管理画面のアラート一覧のみで確認できます

**通知内容**:
- アラートの種類（侵入試行、マルウェア検知、権限変更など）
- 発生時刻
- 詳細情報

### アラートの種類と対応方法

#### 1. 侵入試行（fail2ban Ban）

**通知内容**:
- 「fail2banがIP XXX.XXX.XXX.XXX を遮断しました」

**対応方法**:
- **通常は対応不要**です
- fail2banが自動的に不正アクセスをブロックしています
- 継続的に発生する場合は、システム管理者に連絡してください

**確認方法**:
```bash
# Pi5にSSH接続して確認（システム管理者向け）
sudo fail2ban-client status sshd
```

#### 2. マルウェア検知（ClamAV/Trivy/rkhunter）

**通知内容**:
- 「ClamAVがウイルスを検知しました」
- 「Trivyが脆弱性を検知しました」
- 「rkhunterが異常を検知しました」

**対応方法**:
- **すぐにシステム管理者に連絡**してください
- アラートの詳細を確認し、影響範囲を特定します
- 必要に応じて、感染が疑われるファイルを隔離します

**確認方法**:
```bash
# Pi5にSSH接続して確認（システム管理者向け）
sudo cat /var/log/clamav/scan.log | grep FOUND
sudo cat /var/log/trivy/scan.log | grep -E "HIGH|CRITICAL"
```

#### 3. ファイル整合性の異常

**通知内容**:
- 「重要ファイルのハッシュが変更されました」

**対応方法**:
- **すぐにシステム管理者に連絡**してください
- ファイルの改ざんが疑われます
- バックアップからの復元が必要な場合があります

**確認方法**:
```bash
# Pi5にSSH接続して確認（システム管理者向け）
cat /opt/RaspberryPiSystem_002/alerts/alert-*.json | jq .
```

#### 4. 必須プロセスの欠落

**通知内容**:
- 「必須プロセスが見つかりません: sshd caddy」

**対応方法**:
- **すぐにシステム管理者に連絡**してください
- 重要なサービスが停止している可能性があります
- サービスの再起動が必要な場合があります

**確認方法**:
```bash
# Pi5にSSH接続して確認（システム管理者向け）
ps aux | grep -E "(sshd|caddy)"
docker ps
```

#### 5. 許可外ポートの検知

**通知内容**:
- 「許可されていないLISTENポートを検出: 8080」

**対応方法**:
- **すぐにシステム管理者に連絡**してください
- 不正なサービスが起動している可能性があります
- ポートを確認し、必要に応じてサービスを停止します

**確認方法**:
```bash
# Pi5にSSH接続して確認（システム管理者向け）
sudo netstat -tuln | grep LISTEN
```

#### 6. 権限変更の異常パターン

**通知内容**:
- 「権限変更: ユーザー名 を VIEWER から ADMIN に変更」
- 「異常パターン: 自己変更 / ADMIN昇格 / 業務時間外」

**対応方法**:
- **すぐにシステム管理者に連絡**してください
- 不正な権限変更が疑われます
- 権限監査ログを確認し、必要に応じて権限を元に戻します

**確認方法**:
- 管理コンソールの「セキュリティ」ページで「権限監査ログ」を確認

---

## よくある質問（FAQ）

### Q1: MFAを設定しなくても使えますか？

**A**: はい、**設定しなくても使えます**。ただし、セキュリティが弱くなるため、**設定を推奨**します。

### Q2: スマートフォンがない場合、MFAは設定できませんか？

**A**: MFAはスマートフォンの認証アプリが必要です。スマートフォンがない場合は、MFAを設定せずに使用できますが、セキュリティが弱くなります。

### Q3: 認証アプリのコードが表示されない場合は？

**A**: 以下の点を確認してください：
- スマートフォンの時刻が正しいか（自動設定を推奨）
- 認証アプリが正しくインストールされているか
- QRコードを正しくスキャンしたか

それでも解決しない場合は、MFAを無効化してから再度セットアップしてください。

### Q4: バックアップコードを紛失した場合は？

**A**: MFAを無効化してから、再度セットアップしてください。バックアップコードは再発行できません。

### Q5: アラートが頻繁に表示される場合は？

**A**: アラートの種類を確認してください：
- **fail2ban Ban**: 通常は問題ありません（自動でブロックされています）
- **マルウェア検知**: システム管理者に連絡してください
- **その他のアラート**: システム管理者に連絡してください

### Q6: 管理画面にアクセスできない場合は？

**A**: 以下の点を確認してください：
- ネットワーク接続が正常か（ローカルネットワークまたはTailscale経由）
- IPアドレスが許可されているか（通常は問題ありません）
- ブラウザのキャッシュをクリアしてみる

それでも解決しない場合は、システム管理者に連絡してください。

### Q7: キオスクが動作しない場合は？

**A**: キオスク側のセキュリティ機能は変更されていません。通常のトラブルシューティング手順に従ってください。

### Q8: レート制限に引っかかった場合は？

**A**: 短時間に大量のリクエストを送ると、一時的にブロックされます。数分待ってから再度試してください。通常の使い方では問題ありません。

---

## まとめ

### 通常運用時

- **管理コンソール**: 今まで通り使えます。初回のみMFAのセットアップを推奨します。
- **キオスク**: 一切変更ありません。今まで通り使えます。

### インシデント発生時

- **通知**: 管理画面のアラート一覧で確認できます（1日1回の確認を推奨）
- **対応**: アラートの種類に応じて、システム管理者に連絡してください
- **自動対応**: fail2banによる侵入試行のブロックは自動で行われます

### 追加の操作が必要な場合

- **初回のみ**: MFAのセットアップ（推奨）
- **インシデント発生時**: アラートの確認とシステム管理者への連絡

**基本的には、今まで通り使えば問題ありません。** セキュリティ機能は**バックグラウンドで自動的に動作**しており、通常の操作に影響を与えません。

---

## 関連ドキュメント

- [セキュリティ要件定義](../security/requirements.md)
- [Phase 9/10 詳細仕様書](../security/phase9-10-specifications.md)
- [インシデント対応手順](../security/incident-response.md)
- [デプロイメントガイド](./deployment.md)
