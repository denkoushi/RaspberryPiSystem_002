# Validation 6: オフライン耐性の実機検証結果

最終更新: 2025-11-24

## 検証概要

オフライン耐性機能の実機検証を実施し、オフライン時に発生したNFCイベントがキューに保存され、オンライン復帰後に自動的に再送されることを確認しました。

## 検証環境

- **Raspberry Pi 5**: サーバー（API/DB/Web UI）
- **Raspberry Pi 4**: クライアント（キオスク + NFCリーダー）
- **NFCリーダー**: SONY FeliCa RC-S300/S

## 検証手順

### 1. システム更新

#### ラズパイ5（サーバー）
```bash
cd /opt/RaspberryPiSystem_002
git pull origin main
curl http://localhost:8080/api/system/health
# 結果: {"status":"ok",...}
```

#### ラズパイ4（クライアント/NFCエージェント）
```bash
cd /opt/RaspberryPiSystem_002
git pull origin main
cd clients/nfc-agent
poetry install
pkill -f "python -m nfc_agent"
poetry run python -m nfc_agent
```

### 2. NFCエージェントの動作確認

```bash
curl http://localhost:7071/api/agent/status
# 結果: {"readerConnected":true,"queueSize":291,...}
```

**確認事項**:
- ✅ NFCリーダーが正常に認識されている
- ✅ キューに以前のテストで残ったイベントが保存されている（291件）

### 3. オフライン時の動作確認

1. **ブラウザでキオスク画面を開く**
   - `http://<ラズパイ5のIP>:4173/kiosk` にアクセス
   - 持出画面が表示されることを確認

2. **ブラウザを閉じる**（WebSocket接続を切断）

3. **NFCカードをかざす**
   - アイテムタグと従業員証を順番にかざす

4. **キューに保存されているか確認**
   ```bash
   curl http://localhost:7071/api/agent/queue
   ```
   - 結果: `{"events":[...]}` が表示される
   - かざした回数分のイベントが保存されていることを確認

### 4. オンライン復帰後の再送確認

1. **ブラウザでキオスク画面を再度開く**（WebSocket接続を再確立）
   - `http://<ラズパイ5のIP>:4173/kiosk` にアクセス

2. **キューが空になることを確認**
   ```bash
   curl http://localhost:7071/api/agent/queue
   ```
   - 結果: `{"events":[]}` が表示される
   - イベントが再送されたことを確認

3. **キオスク画面でイベントが処理されることを確認**
   - 持出画面で、かざしたカードのUIDが表示される
   - 持出が正常に処理される
   - 返却も正常に動作する

## 検証結果

### ✅ 成功した項目

1. **システム更新**
   - ラズパイ5の更新が正常に完了
   - ラズパイ4の更新が正常に完了
   - NFCエージェントの再起動が正常に完了

2. **オフライン時の動作**
   - オフライン時にキューにイベントが保存されることを確認
   - 以前のテストで残った291件のイベントも含めて、すべてのイベントがキューに保存されていることを確認

3. **オンライン復帰後の再送**
   - オンライン復帰後にイベントが自動的に再送されることを確認
   - キューが空になることを確認（`{"events":[]}`）

4. **キオスク画面での処理**
   - かざしたカードのUIDが表示されることを確認
   - 持出が正常に処理されることを確認
   - 返却も正常に動作することを確認

### 確認できた動作

- ✅ オフライン時にNFCイベントがキューに保存される
- ✅ オンライン復帰後にキューに保存されたイベントが自動的に再送される
- ✅ 再送されたイベントがキオスク画面で正常に処理される
- ✅ 持出・返却が正常に動作する

## 検証日時

- **検証実施日**: 2025-11-24
- **検証者**: 実機検証実施

## 次のステップ

- ✅ Validation 6: オフライン耐性（完了）
- ⏳ Validation 7: USB一括登録（次回実施予定）

## 備考

- 検証時点で、キューに以前のテストで残った291件のイベントが保存されていた
- これらのイベントも含めて、すべて正常に再送され、処理されることを確認
- オフライン耐性機能が正常に動作することを実機で確認完了


