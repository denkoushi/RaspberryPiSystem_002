# オフライン耐性機能の実装

最終更新: 2025-11-24

## 概要

NFCエージェントにオフライン耐性機能を実装しました。オフライン時に発生したNFCイベントをSQLiteキューに保存し、オンライン復帰後にWebSocket経由で再配信します。

## 実装内容

### 1. キュー再送ワーカー（`resend_worker.py`）

**機能**:
- バックグラウンドで定期的（30秒ごと）にキューをチェック
- WebSocket接続がある場合、キューに保存されたイベントを再配信
- 再送成功したイベントをキューから削除

**実装詳細**:
- `ResendWorker`クラスを作成
- `start()`/`stop()`メソッドでワーカーの開始・停止を制御
- エラーハンドリングを実装し、エラーが発生しても継続して動作

### 2. WebSocket接続時の即座再送

**機能**:
- WebSocket接続が確立された直後に、キューに保存されたイベントを再送
- `resend_worker`の定期チェックを待たずに、接続直後に再送することで遅延を最小化

**実装詳細**:
- `/stream`エンドポイントで接続確立後、即座にキューをチェック
- 最大100件のイベントを順次再送
- エラーが発生した場合は、その時点で停止（順序を保つため）

### 3. 既存機能との統合

**変更点**:
- `main.py`に`ResendWorker`を統合
- アプリケーション起動時に`resend_worker`を開始
- アプリケーション終了時に`resend_worker`を停止

## 動作フロー

1. **通常時（オンライン）**:
   - NFCイベントが発生
   - イベントがキューに保存される
   - WebSocket経由で即座に配信される
   - 配信成功後、キューから削除（実際には`resend_worker`が削除）

2. **オフライン時**:
   - NFCイベントが発生
   - イベントがキューに保存される
   - WebSocket接続がないため、配信されない
   - キューに保存されたままになる

3. **オンライン復帰時**:
   - WebSocket接続が確立される
   - 接続直後にキューに保存されたイベントを再送
   - `resend_worker`が定期的にチェックして、残りのイベントを再送
   - 再送成功したイベントをキューから削除

## 検証方法

### Validation 6: オフライン耐性の検証

1. **オフライン状態での動作確認**:
   ```bash
   # NFCエージェントを起動
   cd /opt/RaspberryPiSystem_002/clients/nfc-agent
   poetry run python -m nfc_agent
   
   # WebSocket接続を切断（ブラウザを閉じる、またはネットワークを切断）
   # NFCカードをかざす
   # キューに保存されることを確認
   curl http://localhost:7071/api/agent/queue
   ```

2. **オンライン復帰後の再送確認**:
   ```bash
   # WebSocket接続を再確立（ブラウザを開く）
   # キューに保存されたイベントが再送されることを確認
   # キューが空になることを確認
   curl http://localhost:7071/api/agent/queue
   ```

3. **キューサイズの確認**:
   ```bash
   # ステータスAPIでキューサイズを確認
   curl http://localhost:7071/api/agent/status
   # "queueSize"フィールドでキューサイズを確認
   ```

## 注意事項

1. **キューサイズの制限**:
   - 現在、キューサイズの上限は設定されていません
   - 長時間オフラインの場合、キューが大きくなる可能性があります
   - 必要に応じて、キューサイズの上限を設定することを検討してください

2. **イベントの順序**:
   - イベントは保存された順序で再送されます
   - エラーが発生した場合は、その時点で停止し、残りのイベントは次回の再送で処理されます

3. **パフォーマンス**:
   - 大量のイベントがある場合、再送に時間がかかる可能性があります
   - 現在は100件ずつ処理していますが、必要に応じて調整可能です

## 次のステップ

1. **実機検証**:
   - Validation 6（オフライン耐性）の実機検証を実施
   - 長時間オフライン時の動作確認
   - 大量のイベントがある場合の動作確認

2. **改善案**:
   - キューサイズの上限設定
   - 再送のバッチサイズの調整
   - エラー時のリトライロジックの改善

