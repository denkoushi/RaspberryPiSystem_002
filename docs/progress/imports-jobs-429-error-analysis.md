# /api/imports/jobs の429エラー 原因分析

最終更新: 2025-11-24

## 現在の状況

- `/api/imports/jobs`に`config: { rateLimit: false }`を設定している
- しかし、ログを見ると429エラーが発生している
- `skip`関数を追加したが、動作していない
- プラグインの登録順序を変更したが、まだ動作していない

## 問題の構造

### ルート登録の構造

```
app (FastifyInstance)
  └─ app.register(subApp, { prefix: '/api' })
      └─ registerRoutes(subApp)
          └─ registerImportRoutes(subApp)
              └─ app.get('/imports/jobs', { config: { rateLimit: false } })
```

### レート制限プラグインの登録

```
app (FastifyInstance)
  └─ registerRateLimit(app)  // ルート登録後に実行
```

## 真因の仮説

**サブルーター（`app.register`で`{ prefix: '/api' }`を指定）に登録されたルートの`config`が、親アプリのレート制限プラグインで正しく認識されていない可能性が高い。**

### 理由

1. **サブルーターのルートの`config`が親アプリのプラグインで認識されない**
   - `app.register(subApp, { prefix: '/api' })`でサブルーターを作成
   - サブルーター内のルートの`config`が親アプリのプラグインで認識されない可能性がある

2. **プラグインの登録順序の問題**
   - ルートを登録した後にレート制限プラグインを登録しているが、サブルーターのルートの`config`が認識されていない

3. **`skip`関数の問題**
   - `request.routeOptions`が正しく取得できていない可能性がある
   - サブルーターのルートの場合、`routeOptions`の構造が異なる可能性がある

## 解決策の候補

### 1. レート制限プラグインをサブルーター内で登録する（推奨）

サブルーター内でレート制限プラグインを登録し、サブルーターのルートの`config`を正しく認識させる。

### 2. `skip`関数でURLパスをチェックする

`skip`関数でURLパスをチェックして、特定のパスをスキップする。

### 3. レート制限プラグインをルート登録前に登録し、サブルーター内でも登録する

親アプリとサブルーターの両方でレート制限プラグインを登録する。

## 検証方法

1. **サブルーターのルートの`config`が認識されているか確認**
   - デバッグログを追加して、`skip`関数が呼び出されているか確認
   - `request.routeOptions`の内容を確認

2. **他のエンドポイント（`/api/tools/loans/active`など）が正しく動作しているか確認**
   - 同じサブルーター内の他のエンドポイントが正しく動作しているか確認

3. **レート制限プラグインの登録方法を変更**
   - サブルーター内でレート制限プラグインを登録する方法を試す

