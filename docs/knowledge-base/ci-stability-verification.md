# CIの継続的な成功確認ガイド

このドキュメントは、CIの継続的な成功確認の方法を説明します。

## 目的

CIの1回の成功だけでは不十分です。複数回実行して安定性を確認する必要があります。

## 確認方法

### 1. GitHub Actionsの実行履歴を確認

GitHubのWeb UIで確認:
1. リポジトリの「Actions」タブを開く
2. 最新のワークフロー実行を確認
3. 連続して成功しているか確認

### 2. CIログ取得スクリプトを使用

```bash
# 最新のワークフロー実行のログを取得
./scripts/ci/get-logs.sh

# 特定のジョブのログのみ取得
./scripts/ci/get-logs.sh lint-and-test

# エラーのみを抽出して表示
./scripts/ci/get-logs.sh lint-and-test --errors-only
```

詳細は [CIログ取得スクリプト](scripts/ci/README.md) を参照してください。

### 3. 複数回のコミットでCIを実行

小さな変更（コメント追加、ドキュメント更新など）を加えてCIを再実行し、安定性を確認します。

## 目標

- **連続5回以上の成功**: バックアップ/リストアテストが安定して通ることを確認
- **成功率90%以上**: 10回実行して9回以上成功することを確認

## 確認項目

### バックアップ/リストアテスト

- [ ] PostgreSQLコンテナの起動が安定しているか
- [ ] Prismaマイグレーションが毎回成功するか
- [ ] テストデータの挿入が安定しているか
- [ ] バックアップ/リストアが毎回成功するか
- [ ] データの検証が正しく動作しているか

### APIテスト

- [ ] 統合テストが毎回成功するか
- [ ] タイムアウトエラーが発生していないか
- [ ] データベース接続エラーが発生していないか

### E2Eテスト

- [ ] Playwrightテストが安定して動作するか
- [ ] タイミング問題が発生していないか

## トラブルシューティング

### CIが失敗する場合

1. **ログを確認**: `./scripts/ci/get-logs.sh`でエラーを確認
2. **再実行**: GitHub ActionsのWeb UIから「Re-run jobs」を実行
3. **原因を特定**: エラーメッセージから原因を特定
4. **修正**: 原因に応じて修正を実施

### 不安定なテストがある場合

- テストをスキップする（`test.skip(process.env.CI, '説明')`）
- タイムアウトを延長する（`testTimeout: 30000`）
- リトライを追加する（`retries: 2`）

詳細は [テストアーキテクチャ設計](docs/architecture/test-architecture.md) を参照してください。

## 関連ドキュメント

- [KB-024: CI/テストアーキテクチャの設計不足](troubleshooting-knowledge.md#kb-024-ciテストアーキテクチャの設計不足)
- [テストアーキテクチャ設計](docs/architecture/test-architecture.md)
- [CIログ取得スクリプト](scripts/ci/README.md)

