# トラブルシューティングナレッジベース

このドキュメントは、これまでの課題解決の経験をナレッジとして蓄積し、同じ問題を繰り返さないようにするためのものです。

## 記録フォーマット

各課題は以下のフォーマットで記録します：

```markdown
### [課題ID] 課題名

**事象**: 
- 何が起きたか（エラーメッセージ、症状など）

**要因**: 
- なぜ起きたか（根本原因）

**試行した対策**: 
- [試行1] 対策内容 → 結果（成功/失敗）
- [試行2] 対策内容 → 結果（成功/失敗）
- ...

**有効だった対策**: 
- 最終的に有効だった対策

**学んだこと**: 
- この経験から学んだこと、今後同じ問題を避けるための知見

**関連ファイル**: 
- 関連するファイルのパス
```

---

## 課題一覧

### [KB-001] 429エラー（レート制限エラー）が発生する

**事象**: 
- ダッシュボード・履歴ページで429エラーが発生
- レート制限を無効化（max=100000）しても解決しない
- `config: { rateLimit: false }`が機能していない

**要因**: 
- **根本原因**: レート制限プラグインが3箇所で重複登録されていた
  1. `apps/api/src/app.ts` (22行目)
  2. `apps/api/src/routes/index.ts` (20行目) - `/api`サブルーター
  3. `apps/api/src/routes/tools/index.ts` (19行目) - `/tools`サブルーター
- この重複登録により、レート制限の設定が競合し、429エラーが発生していた
- Fastifyの`@fastify/rate-limit`プラグインは、サブルーターの`config: { rateLimit: false }`を認識しない可能性がある
- `skip`関数を使おうとしたが、型エラーで実装できなかった

**試行した対策**: 
- [試行1] `max: 100000`に設定して実質的に無効化 → **失敗**（429エラーが継続）
- [試行2] `config: { rateLimit: false }`を各ルートに設定 → **失敗**（サブルーターで認識されない）
- [試行3] `skip`関数を実装しようとした → **失敗**（型エラー: `'skip' does not exist in type 'FastifyRegisterOptions<RateLimitPluginOptions>'`）
- [試行4] サブルーター内でレート制限プラグインを登録 → **失敗**（429エラーが継続）
- [試行5] レート制限プラグインを3箇所で登録（`app.ts`, `routes/index.ts`, `routes/tools/index.ts`） → **失敗**（重複登録により429エラーが継続）

**有効だった対策**: 
- 未解決（継続中）

**学んだこと**: 
- Fastifyのプラグインは、ルート登録前に登録する必要がある
- サブルーターの`config`は親アプリのプラグインで認識されない可能性がある
- `@fastify/rate-limit`のv9では、`skip`関数の型定義が正しくない可能性がある

**関連ファイル**: 
- `apps/api/src/plugins/rate-limit.ts`
- `apps/api/src/routes/index.ts`
- `apps/api/src/routes/tools/index.ts`
- `apps/api/src/app.ts`

**次の調査方向**: 
- レート制限プラグインの重複登録を解消（現在3箇所で登録されている）
- レート制限プラグインを完全に削除するか、1箇所のみで登録する
- Fastifyの公式ドキュメントを確認
- 実環境でのログを確認して、実際にレート制限が適用されているか確認

**発見事項（2025-11-25）**:
- レート制限プラグインが3箇所で重複登録されている：
  1. `apps/api/src/app.ts` (22行目)
  2. `apps/api/src/routes/index.ts` (20行目) - `/api`サブルーター
  3. `apps/api/src/routes/tools/index.ts` (19行目) - `/tools`サブルーター
- この重複登録が429エラーの原因である可能性が高い
- `config: { rateLimit: false }`が機能しない理由は、プラグインがルート登録後に登録されているためではなく、重複登録により設定が上書きされているためかもしれない

---

### [KB-002] 404エラーが発生する

**事象**: 
- ダッシュボード・履歴ページで404エラーが発生

**要因**: 
- 未特定（ルーティングは一致していることを確認済み）

**試行した対策**: 
- [試行1] フロントエンドとバックエンドのエンドポイントを確認 → **確認済み**（一致している）

**有効だった対策**: 
- 未解決（継続中）

**学んだこと**: 
- ルーティングが一致していても404エラーが発生する可能性がある
- Caddyのリバースプロキシ設定を確認する必要がある

**関連ファイル**: 
- `apps/web/src/api/client.ts`
- `apps/api/src/routes/tools/transactions/list.ts`
- `infrastructure/docker/Caddyfile`

**次の調査方向**: 
- 実環境でのリクエストログを確認
- Caddyのログを確認
- ブラウザの開発者ツールで実際のリクエストURLを確認

---

### [KB-003] P2002エラー（nfcTagUidの重複）が発生する

**事象**: 
- CSVインポート時にP2002エラーが発生
- nfcTagUidの重複チェックが正しく動作していない

**要因**: 
- CSV内の重複チェックと既存データとの重複チェックのロジックに問題がある可能性

**試行した対策**: 
- [試行1] CSV内の重複チェックを追加 → **部分的成功**（エラーメッセージは改善されたが、根本原因は解決していない）

**有効だった対策**: 
- 未解決（継続中）

**学んだこと**: 
- PrismaのP2002エラーは、ユニーク制約違反を示す
- エラーメッセージを改善しても、根本原因が解決されない場合は、ロジックを見直す必要がある

**関連ファイル**: 
- `apps/api/src/routes/imports.ts`

---

### [KB-004] 削除機能が動作しない

**事象**: 
- 返却済みの貸出記録があっても削除できない
- 1件だけ削除できたが、他の従業員・アイテムは削除できない

**要因**: 
- データベースの外部キー制約が正しく適用されていない可能性
- 削除ロジックのバグ

**試行した対策**: 
- [試行1] データベーススキーマを変更して`ON DELETE SET NULL`を設定 → **部分的成功**（1件だけ削除できた）

**有効だった対策**: 
- 未解決（継続中）

**学んだこと**: 
- データベースの外部キー制約は、マイグレーションが正しく適用されていない可能性がある
- 1件だけ削除できたということは、ロジック自体は動作している可能性がある

**関連ファイル**: 
- `apps/api/src/routes/tools/employees/delete.ts`
- `apps/api/src/routes/tools/items/delete.ts`
- `apps/api/prisma/schema.prisma`

---

## ナレッジベースの使い方

1. **新しい課題が発生したら**: このドキュメントに追加する
2. **対策を試行したら**: 「試行した対策」セクションに記録する
3. **解決したら**: 「有効だった対策」と「学んだこと」を記録する
4. **同じ問題が発生したら**: このドキュメントを参照して、過去の試行を確認する

## 更新履歴

- 2025-11-25: 初版作成（KB-001, KB-002, KB-003, KB-004を追加）

