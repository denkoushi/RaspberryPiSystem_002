
## KB-098: CSVリストア時のバリデーションエラー問題

**問題**: Dropbox経由のCSVリストア時に、バリデーションエラーが発生する。2行目の`employeeCode`が数字4桁の形式（`/^\d{4}$/`）に適合していない。

**原因**:
1. バックアップされたCSVデータに、現在のバリデーションルールに適合しないデータが含まれている
2. `employeeCode`は数字4桁（`/^\d{4}$/`）である必要があるが、バックアップファイルには異なる形式のデータが含まれている可能性がある

**調査結果**:
- リストア機能自体は正常動作（Dropboxからファイルをダウンロードできている）
- CSVデータのパース処理も正常動作
- バリデーションエラーはデータの問題であり、リストア機能の問題ではない

**対応**:
1. **バックアップファイルの内容を確認**: Dropbox上で実際のCSVファイルの内容を確認し、問題のあるデータを特定
2. **バリデーションルールの確認**: 現在のバリデーションルール（`/^\d{4}$/`）が適切か確認
3. **データ形式の整合性確認**: バックアップ時のデータ形式とリストア時のバリデーションルールの整合性を確認

**学んだこと**:
- リストア機能は正常動作しているが、データの整合性チェックで失敗する
- バリデーションエラーの詳細なメッセージが表示されるため、問題のあるデータを特定可能
- バックアップ時のデータ形式とリストア時のバリデーションルールの整合性を保つことが重要

**解決状況**: ⚠️ **調査完了、データの問題として記録**（2025-12-29）

**関連ファイル**:
- `apps/api/src/routes/imports.ts`（CSVバリデーションスキーマ）
- `apps/api/src/services/backup/targets/csv-backup.target.ts`（CSVリストア処理）

**実機検証結果**（2025-12-29）:
- ✅ リストア機能は正常動作（Dropboxからファイルをダウンロード成功）
- ⚠️ CSVデータのバリデーションエラーが発生（2行目の`employeeCode`が数字4桁の形式に適合しない）
- ✅ エラーメッセージが詳細に表示される（問題のあるデータを特定可能）

**次のステップ**:
- バックアップファイルの内容を確認して、問題のあるデータを特定
- 必要に応じてバリデーションルールを調整、またはデータ形式を修正

---
