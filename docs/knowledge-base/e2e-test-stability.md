# E2Eテストの安定化ガイド

このドキュメントは、E2Eテストの安定化の現状と今後の改善計画を説明します。

## 現状（2025-11-26）

E2Eテストは既に「CI環境で確実に動作する範囲に限定」されています。

### 実行されるテスト

#### auth.spec.ts
- ✅ ログイン画面が表示される
- ✅ 無効な認証情報でログインに失敗する
- ✅ 未認証ユーザーが管理画面にアクセスするとログイン画面にリダイレクトされる

#### kiosk.spec.ts
- ✅ キオスク持出画面が表示される
- ✅ キオスク返却画面が表示される
- ✅ 持出と返却のナビゲーションが動作する

#### admin.spec.ts
- ✅ ダッシュボードが表示される
- ✅ 従業員管理画面にアクセスできる
- ✅ アイテム管理画面にアクセスできる
- ✅ 履歴画面にアクセスできる

### CI環境でスキップされるテスト

#### auth.spec.ts
- ⏭️ 有効な認証情報でログインに成功し、管理画面にリダイレクトされる
  - **理由**: CI環境ではタイミングの問題でログイン後のリダイレクトが不安定
  - **代替**: 認証ロジックは`apps/api/src/routes/__tests__/auth.integration.test.ts`で統合テストとして実施されている

#### kiosk.spec.ts
- ⏭️ NFCスキャンのE2Eテスト（コメントアウト）
  - **理由**: CI環境には物理的なNFCリーダーが存在しない
  - **代替**: 状態マシンのロジックは`borrowMachine.test.ts`でユニットテストされている
  - **代替**: APIの統合テストは`loans.integration.test.ts`で実施されている

## 設計方針

### CI環境でのテスト範囲

1. **画面表示の確認**: 各ページが正しく表示されることを確認
2. **ナビゲーションの確認**: リンククリックで正しく遷移することを確認
3. **フォームの表示確認**: 入力フィールドやボタンが表示されることを確認

### CI環境でテストしない範囲

1. **認証フローの詳細**: タイミング問題により不安定なため、統合テストでカバー
2. **NFCスキャン**: 物理デバイスが必要なため、実機環境でテスト
3. **複雑な状態遷移**: ユニットテストや統合テストでカバー

## テストカバレッジ

### E2Eテストでカバー
- 画面表示の確認
- ナビゲーションの動作確認
- 基本的なUI要素の表示確認

### 統合テストでカバー
- 認証ロジック（`auth.integration.test.ts`）
- APIエンドポイント（`*.integration.test.ts`）
- ビジネスロジック（サービス層のテスト）

### ユニットテストでカバー
- 状態マシンのロジック（`borrowMachine.test.ts`）
- 個々の関数・クラス

## 今後の改善計画

### Phase 5 ステップ4完了後の改善

1. [ ] **E2Eテストの安定性向上**
   - タイムアウトの最適化
   - 待機条件の改善
   - リトライロジックの追加

2. [ ] **テストカバレッジの可視化**
   - Playwrightのカバレッジレポートを生成
   - カバレッジが不足している領域を特定

3. [ ] **CI環境での実行時間の短縮**
   - テストの並列実行
   - 不要な待機時間の削減

### 長期的な改善

1. [ ] **実機環境でのE2Eテスト**
   - ステージング環境でのNFCスキャンテスト
   - 実際のハードウェア統合テスト

2. [ ] **視覚的回帰テスト**
   - Playwrightのスクリーンショット比較
   - UIの変更を自動検出

## 関連ドキュメント

- [KB-024: CI/テストアーキテクチャの設計不足](troubleshooting-knowledge.md#kb-024-ciテストアーキテクチャの設計不足)
- [テストアーキテクチャ設計](docs/architecture/test-architecture.md)
- [CIの継続的な成功確認ガイド](ci-stability-verification.md)

