# インフラストラクチャ共通基盤

最終更新: 2025-11-25

## 概要

本ドキュメントでは、システム全体で共通して使用するインフラストラクチャ機能（バックアップ・リストア、監視・アラート、パフォーマンス監視）について説明します。これらの機能は、将来のモジュール追加時にも共通基盤として利用できます。

## 共通基盤の位置づけ

### スケール性の観点

以下の機能は、**システム全体の共通基盤**として設計されています：

1. **バックアップ・リストア機能**
   - システム全体のデータベースをバックアップ・リストア
   - 将来のモジュール（documents, logistics）が追加されても、同じデータベースを使用するため共通で利用可能
   - モジュール固有のデータも自動的にバックアップに含まれる

2. **監視・アラート機能**
   - システム全体のヘルスチェックとメトリクス収集
   - モジュールが増えても、システム全体の監視として共通で利用可能
   - 各モジュール固有のメトリクスも追加可能

3. **パフォーマンス監視**
   - システム全体のAPIレスポンス時間とページ読み込み時間の監視
   - モジュールが増えても、システム全体のパフォーマンスとして共通で利用可能

### モジュール追加時の影響

将来、新しいモジュール（例：documents, logistics）を追加する場合：

- **バックアップ・リストア**: 変更不要。新しいモジュールのテーブルも自動的にバックアップに含まれる
- **監視・アラート**: 変更不要。システム全体の監視として機能し続ける
- **パフォーマンス監視**: 変更不要。システム全体のパフォーマンスとして監視し続ける

## 共通基盤の構成

### 1. バックアップ・リストア基盤

**ファイル**:
- `scripts/server/backup.sh`: バックアップスクリプト
- `scripts/server/restore.sh`: リストアスクリプト
- `docs/guides/backup-and-restore.md`: 詳細手順

**対象**:
- PostgreSQLデータベース全体（すべてのテーブル）
- 環境変数ファイル（`.env`）
- Dockerボリューム（`db-data`）

**特徴**:
- モジュール非依存：データベース全体をバックアップするため、新しいモジュールのテーブルも自動的に含まれる
- 拡張可能：新しいモジュール固有のバックアップ要件があれば、スクリプトを拡張可能

### 2. 監視・アラート基盤

**ファイル**:
- `scripts/server/monitor.sh`: 監視スクリプト
- `apps/api/src/routes/system/health.ts`: ヘルスチェックエンドポイント
- `apps/api/src/routes/system/metrics.ts`: メトリクスエンドポイント
- `docs/guides/monitoring.md`: 詳細手順

**対象**:
- APIヘルスチェック（`/api/system/health`）
- メトリクス収集（`/api/system/metrics`）
- Dockerコンテナの稼働状態
- ディスク使用量
- メモリ使用量

**特徴**:
- システム全体の監視：モジュールが増えても、システム全体の監視として機能
- 拡張可能：新しいモジュール固有のメトリクスを追加可能

### 3. パフォーマンス監視基盤

**ファイル**:
- `apps/api/src/routes/__tests__/performance.test.ts`: パフォーマンステスト
- `docs/guides/monitoring.md`: パフォーマンス監視手順

**対象**:
- APIレスポンス時間（1秒以内）
- ページ読み込み時間（3秒以内）

**特徴**:
- システム全体のパフォーマンス：モジュールが増えても、システム全体のパフォーマンスとして監視
- 拡張可能：新しいモジュール固有のパフォーマンステストを追加可能

## モジュール追加時のガイドライン

### バックアップ・リストア

新しいモジュールを追加する場合：

1. **データベーステーブル**: Prismaスキーマに新しいテーブルを追加するだけで、自動的にバックアップに含まれる
2. **環境変数**: モジュール固有の環境変数があれば、`backup.sh`に追加（オプション）
3. **ボリューム**: モジュール固有のDockerボリュームがあれば、`backup.sh`に追加（オプション）

### 監視・アラート

新しいモジュールを追加する場合：

1. **ヘルスチェック**: モジュール固有のヘルスチェックが必要な場合、`/api/system/health`エンドポイントを拡張
2. **メトリクス**: モジュール固有のメトリクスが必要な場合、`/api/system/metrics`エンドポイントを拡張
3. **監視スクリプト**: モジュール固有の監視が必要な場合、`monitor.sh`に新しいチェック関数を追加

### パフォーマンス監視

新しいモジュールを追加する場合：

1. **APIエンドポイント**: モジュール固有のAPIエンドポイントのパフォーマンステストを`performance.test.ts`に追加
2. **ページ読み込み**: モジュール固有のページのパフォーマンステストを追加（E2Eテストで実施）

## 関連ドキュメント

- [システム要件定義](../requirements/system-requirements.md): 非機能要件（NFR-001, NFR-004）
- [バックアップ・リストア手順](../guides/backup-and-restore.md): 詳細手順
- [監視・アラートガイド](../guides/monitoring.md): 詳細手順
- [アーキテクチャ概要](./overview.md): システム全体のアーキテクチャ
- [モジュール構成](../modules/): 各モジュールの詳細仕様

