---
title: インフラ基盤
tags: [アーキテクチャ, インフラ, Docker, スケール性]
audience: [アーキテクト, 運用者, 開発者]
last-verified: 2025-11-27
related: [overview.md, ../guides/deployment.md, ../guides/monitoring.md]
category: architecture
update-frequency: low
---

# インフラ基盤

## 概要

本ドキュメントでは、Raspberry Pi NFC 持出返却システムのインフラ基盤について説明します。スケール性、可用性、保守性の観点から設計されています。

## インフラ構成

### 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│              Raspberry Pi 5 (サーバー)                  │
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   Caddy      │  │   Fastify    │  │  PostgreSQL  │ │
│  │ (リバース    │  │     API      │  │     DB      │ │
│  │  プロキシ)   │  │  (Node.js)   │  │  (Container) │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│         │                  │                  │         │
│         └──────────────────┴──────────────────┘         │
│                     内部ネットワーク                      │
└─────────────────────────────────────────────────────────┘
                          │ HTTPS
                          │
┌─────────────────────────┴─────────────────────────────────┐
│              Raspberry Pi 4 (クライアント)                 │
│                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   React      │  │   NFC Agent  │  │  NFC Reader  │   │
│  │  (Web UI)    │  │   (Python)   │  │  RC-S300/S1  │   │
│  └──────┬───────┘  └──────┬───────┘  └──────────────┘   │
│         │                  │                             │
│         └──────────────────┘                             │
│              WebSocket (localhost)                        │
└───────────────────────────────────────────────────────────┘
```

### コンポーネント構成

#### 1. データベース（PostgreSQL）

- **イメージ**: `postgres:15-alpine`
- **ポート**: `5432`
- **データ永続化**: Dockerボリューム `db-data`
- **役割**: 
  - 従業員、アイテム、貸出履歴、トランザクションの永続化
  - トランザクション管理とデータ整合性の保証

**スケール性の考慮**:
- 現在は単一インスタンス構成
- 将来の拡張: レプリケーション、読み取り専用レプリカの追加が可能
- データベースサイズの増加に対応するため、定期的なバックアップとアーカイブ戦略が必要

#### 2. APIサーバー（Fastify）

- **ビルド**: `Dockerfile.api`
- **ポート**: `8080`
- **依存関係**: PostgreSQL
- **役割**:
  - REST APIエンドポイントの提供
  - 認証・認可の処理
  - ビジネスロジックの実行

**スケール性の考慮**:
- **水平スケール**: 複数のAPIインスタンスを起動可能（ロードバランサー経由）
- **垂直スケール**: Raspberry Pi 5のリソース制約内で最適化
- **将来の拡張**: 
  - 複数のRaspberry Pi 5への分散配置
  - 外部ロードバランサーの導入

#### 3. Webサーバー（Caddy）

- **ビルド**: `Dockerfile.web`
- **ポート**: `4173` (HTTP), `443` (HTTPS、本番環境)
- **依存関係**: APIサーバー
- **役割**:
  - 静的ファイル（Reactビルド成果物）の配信
  - APIリクエストのリバースプロキシ
  - SPAルーティングのフォールバック

**スケール性の考慮**:
- 静的ファイル配信は軽量で、複数インスタンスへの分散が容易
- 本番環境ではHTTPS対応（Let's Encrypt自動証明書取得）

#### 4. NFCエージェント（Python）

- **実行環境**: Raspberry Pi 4（クライアント側）
- **ポート**: `7071` (WebSocket, REST API)
- **役割**:
  - NFCリーダー（RC-S300/S1）からのUID取得
  - WebSocket経由でのUID配信
  - オフライン時のキューイング（SQLite）

**スケール性の考慮**:
- クライアント側コンポーネントのため、サーバー側のスケール性に影響しない
- 複数のRaspberry Pi 4クライアントを追加可能

## データ永続化

### Dockerボリューム

- **`db-data`**: PostgreSQLのデータディレクトリ
  - 場所: `/var/lib/postgresql/data`（コンテナ内）
  - 永続化: Dockerボリュームとして管理
  - バックアップ: `scripts/server/backup.sh`で定期バックアップ

### バックアップ戦略

- **データベース**: `pg_dump`によるフルダンプ（gzip圧縮）
- **環境変数**: `.env`ファイルのバックアップ
- **頻度**: 手動実行（将来はcronによる自動化）

詳細は [バックアップ・リストア手順](../guides/backup-and-restore.md) を参照してください。

## ネットワーク構成

### サーバー側（Raspberry Pi 5）

- **内部ネットワーク**: Docker Composeのデフォルトネットワーク
  - サービス間通信: サービス名で解決（例: `api:8080`, `db:5432`）
- **外部公開ポート**:
  - `4173`: Web UI（HTTP）
  - `8080`: API（直接アクセス用、本番環境では非公開推奨）
  - `5432`: PostgreSQL（直接アクセス用、本番環境では非公開推奨）

### クライアント側（Raspberry Pi 4）

- **Web UI**: HTTPS経由でサーバーに接続
- **NFCエージェント**: `localhost:7071`でWebSocket/REST APIを提供
- **ネットワーク要件**: 
  - サーバーへのHTTPS接続が可能であること
  - 固定IPまたはDNS解決が推奨

## スケール性の設計

### 現在の構成（小規模運用）

- **サーバー**: Raspberry Pi 5 × 1台
- **クライアント**: Raspberry Pi 4 × 複数台（必要に応じて追加）
- **想定ユーザー数**: 10-50名程度

### 将来の拡張シナリオ

#### シナリオ1: ユーザー数の増加（50-200名）

**対応策**:
- APIサーバーの水平スケール（複数インスタンス）
- データベースの読み取り専用レプリカ追加
- ロードバランサーの導入

**必要な変更**:
- Docker Composeの複数インスタンス設定
- 外部ロードバランサー（例: Nginx, Traefik）の導入
- データベースレプリケーション設定

#### シナリオ2: 地理的な分散（複数拠点）

**対応策**:
- 各拠点にRaspberry Pi 5サーバーを配置
- 中央データベースへの同期（将来的な機能）
- または、各拠点で独立運用

**必要な変更**:
- データベース同期メカニズムの実装
- または、マルチテナント対応

#### シナリオ3: 高可用性の要件

**対応策**:
- サーバーの冗長化（Raspberry Pi 5 × 2台）
- データベースのマスター-スレーブ構成
- 自動フェイルオーバー

**必要な変更**:
- PostgreSQLレプリケーション設定
- ヘルスチェックと自動フェイルオーバー機構
- ロードバランサーによるトラフィック分散

### リソース制約の考慮

#### Raspberry Pi 5の制約

- **CPU**: 4コア（ARM64）
- **メモリ**: 8GB（推奨）
- **ストレージ**: microSD（推奨: 64GB以上、Class 10以上）

**最適化ポイント**:
- Dockerイメージの軽量化（Alpine Linuxベース）
- データベースクエリの最適化
- 不要なログの削減

#### Raspberry Pi 4の制約

- **CPU**: 4コア（ARM64）
- **メモリ**: 4GB以上推奨
- **ネットワーク**: Wi-Fiまたは有線LAN

**最適化ポイント**:
- Web UIの軽量化（コード分割、遅延読み込み）
- NFCエージェントの効率的な実装

## セキュリティ考慮事項

### 現在の実装

- **認証**: JWT（アクセストークン + リフレッシュトークン）
- **HTTPS**: 本番環境で有効化（Let's Encrypt）
- **データベース**: 内部ネットワークのみアクセス可能
- **環境変数**: `.env`ファイルで管理（Gitにコミットしない）

### 将来の強化項目

- **APIレート制限**: 現在は実質的に無効化（将来の実装予定）
- **CORS設定**: 本番環境での適切な設定
- **データベース暗号化**: 機密データの暗号化
- **監査ログ**: 操作履歴の記録と分析

## 監視とアラート

### 現在の実装

- **ヘルスチェック**: `/api/system/health`
- **メトリクス**: `/api/system/metrics` (Prometheus形式)
- **監視スクリプト**: `scripts/server/monitor.sh`

詳細は [監視・アラートガイド](../guides/monitoring.md) を参照してください。

### 将来の拡張

- **Prometheus + Grafana**: メトリクスの可視化
- **アラート通知**: メール、Slack、LINE通知
- **ログ集約**: ELK Stack、Loki等の導入

## デプロイメント

### 現在の方法

- **手動デプロイ**: `scripts/server/deploy.sh`
- **更新方法**: `git pull` + Docker Compose再ビルド

詳細は [デプロイメントガイド](../guides/deployment.md) を参照してください。

### 将来の改善

- **CI/CDパイプライン**: GitHub Actionsによる自動デプロイ
- **ブルー・グリーンデプロイ**: ダウンタイムゼロのデプロイ
- **ロールバック機能**: 問題発生時の自動ロールバック

## 関連ドキュメント

- [システムアーキテクチャ概要](./overview.md)
- [デプロイメントガイド](../guides/deployment.md)
- [監視・アラートガイド](../guides/monitoring.md)
- [バックアップ・リストア手順](../guides/backup-and-restore.md)
