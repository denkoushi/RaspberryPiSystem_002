---
title: Ansible改善 Phase1-2 実機テスト計画
tags: [Ansible, テスト計画, 実機検証]
audience: [開発者, 運用者]
last-verified: 2025-12-01
related: [ansible-improvement-plan.md]
category: plans
update-frequency: high
---

# Ansible改善 Phase1-2 実機テスト計画

最終更新: 2025-12-01

## テスト目的

Phase1（エラーハンドリング強化）とPhase2（バリデーション強化）の実装が正常に動作することを確認する。

## テスト環境

- **Ansible Controller**: Raspberry Pi 5 (192.168.128.131)
- **テスト対象**: 
  - Raspberry Pi 4 (192.168.128.102) - キオスク
  - Raspberry Pi 3 (192.168.128.152) - サイネージ

## テスト項目

### テスト1: シンタックスチェック ✅ 完了

**目的**: プレイブックの構文エラーがないことを確認

**手順**:
```bash
ansible-playbook -i inventory.yml playbooks/update-clients.yml --syntax-check
ansible-playbook -i inventory.yml playbooks/manage-system-configs.yml --syntax-check
ansible-playbook -i inventory.yml playbooks/manage-app-configs.yml --syntax-check
```

**期待結果**: エラーなし

**結果**: ✅ 完了（2025-12-01）

---

### テスト2: バリデーション機能のテスト

#### テスト2-1: 必須変数チェック（assert）

**目的**: 必須変数が未定義の場合にエラーになることを確認

**手順**:
1. `inventory.yml`から`nfc_agent_client_id`を一時的に削除
2. `manage-app-configs.yml`を実行
3. assertエラーが発生することを確認
4. 変数を復元

**期待結果**: 
- `nfc_agent_client_id`が未定義の場合、assertエラーが発生
- エラーメッセージが明確

**優先度**: 🔴 高

#### テスト2-2: .envファイル構文チェック

**目的**: 不正な.envファイルがデプロイされないことを確認

**手順**:
1. テンプレートに不正な構文（例: `KEY=value`の後に改行なしで続く）を意図的に追加
2. `manage-app-configs.yml`を実行
3. バリデーションエラーが発生することを確認

**期待結果**: 
- 不正な構文の場合、バリデーションエラーが発生
- エラーメッセージが明確

**優先度**: 🔴 高

#### テスト2-3: systemdユニットファイル検証

**目的**: 不正なsystemdユニットファイルがデプロイされないことを確認

**手順**:
1. `kiosk-browser.service.j2`テンプレートに不正な構文を意図的に追加
2. `manage-system-configs.yml`を実行
3. `systemd-analyze verify`エラーが発生することを確認

**期待結果**: 
- 不正な構文の場合、検証エラーが発生
- エラーメッセージが明確

**優先度**: 🔴 高

---

### テスト3: エラーハンドリング機能のテスト

#### テスト3-1: Git操作のリトライ機能

**目的**: 一時的なネットワークエラーで自動リトライされることを確認

**手順**:
1. ネットワークを一時的に切断（またはGitHubへの接続をブロック）
2. `update-clients.yml`を実行
3. リトライが実行されることを確認
4. ネットワークを復旧
5. 最終的に成功することを確認

**期待結果**: 
- ネットワークエラー時に自動リトライ（最大3回）
- リトライ間隔が適切（5秒）
- 最終的に成功する

**優先度**: 🟡 中（ネットワーク障害の再現が困難なため）

#### テスト3-2: サービス再起動のrescue処理

**目的**: サービス再起動失敗時にrescueブロックが実行されることを確認

**手順**:
1. 存在しないサービス名を`services_to_restart`に追加
2. `update-clients.yml`を実行
3. rescueブロックが実行され、エラーログが出力されることを確認
4. プレイブックが適切に失敗することを確認

**期待結果**: 
- サービス再起動失敗時にrescueブロックが実行
- エラーログが詳細に出力される
- プレイブックが適切に失敗する

**優先度**: 🔴 高

#### テスト3-3: Docker再起動のrescue処理

**目的**: Docker再起動失敗時にrescueブロックが実行されることを確認

**手順**:
1. Dockerサービスを停止
2. `update-clients.yml`を実行（サーバーのみ）
3. rescueブロックが実行され、エラーログが出力されることを確認
4. Dockerサービスを再起動

**期待結果**: 
- Docker再起動失敗時にrescueブロックが実行
- エラーログが詳細に出力される
- プレイブックが適切に失敗する

**優先度**: 🔴 高

---

### テスト4: 正常系の動作確認

#### テスト4-1: 通常のデプロイ動作確認

**目的**: 改善後のプレイブックが正常に動作することを確認

**手順**:
1. `update-clients.yml`を実行
2. すべてのタスクが成功することを確認
3. ログ出力が適切であることを確認

**期待結果**: 
- すべてのタスクが成功
- ログ出力が構造化されている
- デプロイサマリーが出力される

**優先度**: 🔴 高

#### テスト4-2: 設定ファイル管理の動作確認

**目的**: 設定ファイル管理プレイブックが正常に動作することを確認

**手順**:
1. `manage-system-configs.yml`を実行
2. systemdユニットファイルが正しくデプロイされることを確認
3. `manage-app-configs.yml`を実行
4. .envファイルが正しくデプロイされることを確認

**期待結果**: 
- すべてのタスクが成功
- 設定ファイルが正しくデプロイされる
- バリデーションが実行される

**優先度**: 🔴 高

---

## テスト実行順序

1. ✅ テスト1: シンタックスチェック（完了）
2. ✅ テスト4-1: 通常のデプロイ動作確認（正常系の確認）
3. ✅ テスト4-2: 設定ファイル管理の動作確認（正常系の確認）
4. ✅ テスト2-1: 必須変数チェック（バリデーション）
5. テスト2-3: systemdユニットファイル検証（バリデーション）
6. テスト3-2: サービス再起動のrescue処理（エラーハンドリング）
7. テスト3-3: Docker再起動のrescue処理（エラーハンドリング）
8. テスト2-2: .envファイル構文チェック
9. テスト3-1: Git操作のリトライ機能（ネットワーク障害テスト）

## テスト結果記録

各テストの結果を以下に記録する：

| テストID | テスト名 | 結果 | 備考 |
|---------|---------|------|------|
| テスト1 | シンタックスチェック | ✅ 成功 | 2025-12-01：3本のプレイブックすべて構文OK |
| テスト2-1 | 必須変数チェック | ✅ 成功 | raspberrypi4から`nfc_agent_client_id`/`secret`削除→assertで停止 |
| テスト2-2 | .envファイル構文チェック | ⏳ 未実施 | 要：テンプレートに意図的な構文エラーを埋め込み |
| テスト2-3 | systemdユニットファイル検証 | ⏳ 未実施 | 要：テンプレートに意図的な構文エラーを埋め込み |
| テスト3-1 | Git操作のリトライ機能 | ⏳ 未実施 | ネットワーク障害の再現が困難 |
| テスト3-2 | サービス再起動のrescue処理 | ⚠️ 途中 | `services_to_restart`をextra-varsで上書きする際にJSON指定が必要。次回: `-e '{\"services_to_restart\":[\"fake.service\"]}'`をsudo対応込みで再実施 |
| テスト3-3 | Docker再起動のrescue処理 | ⏳ 未実施 | docker compose restartの検証は未実施（現状でも`args`警告があるため要修正） |
| テスト4-1 | 通常のデプロイ動作確認 | ✅ 成功 | `update-clients.yml`を全ホスト対象で実行。既知のkiosk-browser実行ファイル欠如ログあり |
| テスト4-2 | 設定ファイル管理の動作確認 | ✅ 成功 | `manage-system-configs.yml` / `manage-app-configs.yml`を実行。バリデーション含め成功 |

## 次のステップ

1. **残テストの実施**: テスト2-2/2-3/3-1/3-2/3-3を実施（必要に応じて一時的な故障条件を作成）
2. **エラーパターンの再現**: `services_to_restart`をJSON形式で上書きし、rescueブロックの実行ログを取得
3. **問題の修正**: kiosk-browser.service の実行ファイル欠如、docker-compose `args` 警告など既知の課題整理
4. **再テスト**: 修正後に該当テストを再実行
5. **ドキュメント更新**: テスト結果を本ドキュメントに随時反映

