# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ– ExecPlan

ã“ã®ExecPlanã¯ `.agent/PLANS.md` ã®æ–¹é‡ã«å¾“ã„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®å®Ÿè£…å‰ã®èª¿æŸ»ãƒ»è¨­è¨ˆãƒ»æ¤œè¨¼æ‰‹é †ã‚’å®Œå…¨è‡ªèµ°ã§ãã‚‹ã‚ˆã†è‡ªå¾‹çš„ã«æ›´æ–°ã•ã‚Œã‚‹ç”ŸããŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ç¶­æŒã™ã‚‹ã€‚

**å½¹å‰²**: ã“ã®ExecPlanã¯ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã€é€šå¸¸é‹ç”¨æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã€ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢å¯¾ç­–ã€ãƒžãƒ«ã‚¦ã‚§ã‚¢å¯¾ç­–ã€ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®è©³ç´°è¨ˆç”»ã‚’æ‹…å½“ã™ã‚‹ã€‚

## Purpose / Big Picture

Raspberry Pi 5ã‚µãƒ¼ãƒãƒ¼ã®é‹ç”¨ç’°å¢ƒã«ãŠã„ã¦ã€ä»¥ä¸‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã«å¯¾å‡¦ã™ã‚‹ï¼š
1. **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®ãƒªã‚¹ã‚¯**: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§Ansibleå®Ÿè¡Œãƒ»GitHubã‹ã‚‰pullã™ã‚‹éš›ã®SSHãƒãƒ¼ãƒˆå…¬é–‹ã«ã‚ˆã‚‹ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹
2. **é€šå¸¸é‹ç”¨æ™‚ã®ãƒªã‚¹ã‚¯**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã§ã®ç®¡ç†ç”»é¢ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã€APIçµŒç”±ã®æ”»æ’ƒ
3. **ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ãƒªã‚¹ã‚¯**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã®æš—å·åŒ–ã«ã‚ˆã‚‹æ¥­å‹™åœæ­¢
4. **ãƒžãƒ«ã‚¦ã‚§ã‚¢ãƒªã‚¹ã‚¯**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸çµŒç”±ã®æ„ŸæŸ“
5. **é‹ç”¨åŠ¹çŽ‡ã®ãƒªã‚¹ã‚¯**: IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®ç…©é›‘ã•ã«ã‚ˆã‚‹è¨­å®šãƒŸã‚¹ãƒ»é‹ç”¨è² è·

**é‹ç”¨ç’°å¢ƒã®å‰æ**:
- **é€šå¸¸é‹ç”¨**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šãªã—ï¼‰
- **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚**: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šãŒå¿…è¦ï¼ˆMacã‹ã‚‰Raspberry Piã¸æŒ‡ä»¤ã€GitHubã‹ã‚‰pullï¼‰

ã“ã®è¨ˆç”»ãŒå®Œäº†ã™ã‚‹ã¨ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§ã‚‚å®‰å…¨ã«Ansibleã‚’å®Ÿè¡Œã§ãã€é€šå¸¸é‹ç”¨æ™‚ã‚‚é©åˆ‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãŒå®Ÿè£…ã•ã‚Œã€ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ã‚„ãƒžãƒ«ã‚¦ã‚§ã‚¢ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¿è­·ã§ãã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ãŒåŠ¹çŽ‡åŒ–ã•ã‚Œã‚‹ã€‚

## Progress

### Phase 0: æº–å‚™ãƒ»è¨­è¨ˆ
- [x] (2025-12-04) ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶å®šç¾©ã®ä½œæˆå®Œäº†
- [x] (2025-12-04) IPã‚¢ãƒ‰ãƒ¬ã‚¹ç›´æŽ¥è¨˜è¿°ç®‡æ‰€ã®æ´—ã„å‡ºã—å®Œäº†
- [x] (2025-12-04) å®Ÿè£…è¨ˆç”»ã®è©³ç´°åŒ–å®Œäº†

### Phase 1: IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®å¤‰æ•°åŒ–ã¨é‹ç”¨ãƒ¢ãƒ¼ãƒ‰å¯è¦–åŒ–ï¼ˆæœ€å„ªå…ˆï¼‰
- [x] (2025-12-04) Ansibleã®`group_vars/all.yml`ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ•°ã‚’å®šç¾©
- [x] (2025-12-04) `inventory.yml`ã§å¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
- [x] (2025-12-04) ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`.j2`ï¼‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä¿®æ­£
- [x] (2025-12-04) `scripts/register-clients.sh`ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ•°å‚ç…§ã«å¤‰æ›´
- [x] (2025-12-04) ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨Tailscaleã®åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
- [x] (2025-12-04) é‹ç”¨ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•æ¤œå‡ºAPIã®å®Ÿè£…ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šã®æœ‰ç„¡ã§åˆ¤å®šï¼‰
- [x] (2025-12-04) ç®¡ç†ç”»é¢ã§ã®é‹ç”¨ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¾ãŸã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰

### Phase 2: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®å®‰å…¨åŒ–ï¼ˆTailscaleå°Žå…¥ï¼‰
- [x] (2025-12-04) Macã®Tailscaleè¨­å®šç¢ºèªï¼ˆâœ… å®Œäº†æ¸ˆã¿ï¼‰
- [x] (2025-12-04) Raspberry Pi 5ã«Tailscaleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»èªè¨¼
- [x] (2025-12-04) Raspberry Pi 4ã«Tailscaleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»èªè¨¼
- [x] (2025-12-04) Raspberry Pi 3ã«Tailscaleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»èªè¨¼ï¼ˆã‚µã‚¤ãƒãƒ¼ã‚¸åœæ­¢å¾Œï¼‰
- [x] (2025-12-04) Tailscale IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’`group_vars/all.yml`ã«è¨­å®š
- [x] (2025-12-04) SSHæŽ¥ç¶šè¨­å®šã‚’2ã¤ç”¨æ„ï¼ˆTailscale IPç”¨ã¨ãƒ­ãƒ¼ã‚«ãƒ«IPç”¨ï¼‰
- [x] (2025-12-04) SSHæŽ¥ç¶šãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ»Tailscaleä¸¡æ–¹æˆåŠŸï¼‰

### Phase 3: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ï¼ˆæœ€å„ªå…ˆï¼‰
- [x] (2025-12-05) ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æš—å·åŒ–æ©Ÿèƒ½ã‚’è¿½åŠ ï¼ˆ`backup-encrypted.sh`ï¼‰
- [x] (2025-12-05) ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ç”¨USB/HDDã¸ã®ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’å®Ÿè£…ï¼ˆUSBæœªãƒžã‚¦ãƒ³ãƒˆæ™‚ã¯è­¦å‘Šã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰
- [x] (2025-12-05) ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆï¼ˆå¾©å·ãƒ†ã‚¹ãƒˆç”¨`restore-encrypted.sh`ã‚’å«ã‚€ï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ†ã‚¹ãƒˆï¼ˆæ¤œè¨¼ç”¨DBã§ã®ãƒ•ãƒ«ãƒªã‚¹ãƒˆã‚¢ï¼†USBãƒ¡ãƒ‡ã‚£ã‚¢å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆã¯æœªå®Ÿæ–½ï¼‰

### Phase 4: é€šå¸¸é‹ç”¨æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
- [x] (2025-12-05) ufwã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æœ‰åŠ¹åŒ–ï¼ˆPi5ï¼‰
- [x] (2025-12-05) å¿…è¦ãªãƒãƒ¼ãƒˆã®ã¿é–‹æ”¾ï¼ˆ80, 443ï¼‰
- [x] (2025-12-05) SSHãƒãƒ¼ãƒˆã®åˆ¶é™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/Tailscaleã®ã¿è¨±å¯ï¼‰
- [x] (2025-12-05) Caddyã®HTTPâ†’HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¼·åŒ–ï¼†ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°å‡ºåŠ›
- [x] (2025-12-05) HTTPSå¼·åˆ¶ã®æ–¹é‡ã‚’Caddyãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å¾¹åº•ï¼ˆã‚¢ãƒ—ãƒªå´ã®`FORCE_HTTPS`ã¯ä¸è¦ï¼‰
- [x] (2025-12-05) fail2banã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š
- [x] (2025-12-05) fail2banã®jailè¨­å®šï¼ˆSSHã€Caddy HTTP APIå…±é€šãƒ­ã‚°ï¼‰

### Phase 5: ãƒžãƒ«ã‚¦ã‚§ã‚¢å¯¾ç­–
- [x] (2025-12-05) ClamAVã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPi5ï¼‰
- [x] (2025-12-05) ClamAVã®å®šæœŸã‚¹ã‚­ãƒ£ãƒ³è¨­å®šï¼ˆcronï¼‰
- [x] (2025-12-05) Trivyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPi5ï¼‰
- [x] (2025-12-05) Trivyã®å®šæœŸã‚¹ã‚­ãƒ£ãƒ³è¨­å®šï¼ˆcron / fsã‚¹ã‚­ãƒ£ãƒ³ï¼‰
- [x] (2025-12-05) rkhunterã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPi5ï¼‰
- [x] (2025-12-05) rkhunterã®å®šæœŸã‚¹ã‚­ãƒ£ãƒ³è¨­å®šï¼ˆcronï¼‰
- [x] (2025-12-05) ClamAVã®è»½é‡è¨­å®šï¼ˆPi4ã€é€±1å›žã‚¹ã‚­ãƒ£ãƒ³ï¼‰
- [x] (2025-12-05) rkhunterã®å°Žå…¥ï¼ˆPi4ï¼‰

### Phase 6: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®ç›£è¦–è¨­å®š
- [ ] ç•°å¸¸æ¤œçŸ¥æ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥è¨­å®š
- [ ] ã‚¹ã‚­ãƒ£ãƒ³çµæžœã®ãƒ­ã‚°ç›£è¦–è¨­å®š

### Phase 7: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼
- [ ] IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
- [ ] TailscaleæŽ¥ç¶šãƒ†ã‚¹ãƒˆ
- [ ] ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šã®å‹•ä½œç¢ºèª
- [ ] HTTPSå¼·åˆ¶ã®å‹•ä½œç¢ºèª
- [ ] fail2banã®å‹•ä½œç¢ºèª
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–ãƒ»å¾©å…ƒãƒ†ã‚¹ãƒˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚½ãƒ•ãƒˆã®ã‚¹ã‚­ãƒ£ãƒ³ãƒ†ã‚¹ãƒˆ

## Surprises & Discoveries

- è¦³æ¸¬: Raspberry Pi 3ã¯ãƒªã‚½ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚½ãƒ•ãƒˆã®å°Žå…¥ã¯ä¸è¦ã¨åˆ¤æ–­ã€‚
  ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹: ã‚µã‚¤ãƒãƒ¼ã‚¸ãŒå¸¸æ™‚èµ·å‹•ã—ã¦ãŠã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚½ãƒ•ãƒˆã®è¿½åŠ è² è·ãŒã‚·ã‚¹ãƒ†ãƒ ã«æ‚ªå½±éŸ¿ã‚’ä¸Žãˆã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚
  å¯¾å¿œ: Pi5ã¯å¿…é ˆã€Pi4ã¯æŽ¨å¥¨ï¼ˆè»½é‡è¨­å®šï¼‰ã€Pi3ã¯ä¸è¦ã¨ã„ã†æ–¹é‡ã‚’æŽ¡ç”¨ã€‚

- è¦³æ¸¬: IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¤‡æ•°ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ç›´æŽ¥è¨˜è¿°ã•ã‚Œã¦ãŠã‚Šã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒå¤‰æ›´æ™‚ã«è¤‡æ•°ç®‡æ‰€ã‚’æ‰‹å‹•ã§ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
  ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹: `inventory.yml`ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãªã©ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç›´æŽ¥è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã€‚
  å¯¾å¿œ: Ansibleã®`group_vars/all.yml`ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ•°ã‚’å®šç¾©ã—ã€ä¸€æ‹¬ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

- è¦³æ¸¬: fail2banã§HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç›£è¦–ã™ã‚‹ã«ã¯ã€Caddyã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’ãƒ›ã‚¹ãƒˆå´ã¸å‡ºåŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
  ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹: æ—¢å­˜æ§‹æˆã§ã¯Caddyãƒ­ã‚°ãŒstdoutã®ã¿ã§ã€ãƒ›ã‚¹ãƒˆä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã›ãšfail2banãŒå‚ç…§ã§ããªã‹ã£ãŸã€‚
  å¯¾å¿œ: `/var/log/caddy`ã‚’ãƒžã‚¦ãƒ³ãƒˆã—ã€Caddyã®`log`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§CLFå½¢å¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’æ›¸ãå‡ºã™ã‚ˆã†ã«å¤‰æ›´ã€‚

- è¦³æ¸¬: UFWã‚’æœ‰åŠ¹åŒ–ã™ã‚‹éš›ã€æ—¢å­˜ã®SSHã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿æŒã—ã¤ã¤ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨Tailscaleã ã‘ã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
  ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆallowã®ã¾ã¾ã ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã®22ç•ªãƒãƒ¼ãƒˆãŒé–‹ã„ãŸã¾ã¾ã«ãªã‚‹ã€‚
  å¯¾å¿œ: `ufw allow from 192.168.10.0/24`ãŠã‚ˆã³`100.64.0.0/10`ã®ã¿è¨±å¯ã—ã€ãã®ä»–ã¯denyã«è¨­å®šã€‚

- è¦³æ¸¬: Debian bookwormç³»ã§ã¯TrivyãŒaptã«å«ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã€å…¬å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã€‚
  ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹: `apt-cache search trivy`ã§ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æœªæä¾›ã€‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯install.shçµŒç”±ã‚’æƒ³å®šã€‚
  å¯¾å¿œ: `/usr/local/bin`ã¸curlçµŒç”±ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€å†å®Ÿè¡Œæ™‚ã¯`creates`ã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‚ˆã†Ansibleã«å®Ÿè£…ã€‚

- è¦³æ¸¬: `freshclam`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¸¸é§ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒ­ã‚°ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹ãŸã‚ã€æ‰‹å‹•å®Ÿè¡Œæ™‚ã«ãƒ­ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚
  ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹: `freshclam --quiet`å®Ÿè¡Œæ™‚ã«`Failed to lock ... freshclam.log`ãŒç™ºç”Ÿã€‚
  å¯¾å¿œ: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ã¯è­¦å‘Šã¨ã—ã¦ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¤ã¤ã‚¹ã‚­ãƒ£ãƒ³ã‚’ç¶™ç¶šã€‚å¿…è¦ã«å¿œã˜ã¦å°†æ¥`freshclam`ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¿ã‚¤ãƒžãƒ¼èµ·å‹•ã«å¤‰æ›´ã™ã‚‹ä½™åœ°ã‚ã‚Šã€‚

## Decision Log

- Decision: Tailscaleã‚’VPNã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æŽ¡ç”¨ã€‚
  Rationale: WireGuardãƒ™ãƒ¼ã‚¹ã§æš—å·åŒ–ãŒå¼·å›ºã€è¨­å®šãŒç°¡å˜ã€ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§100ãƒ‡ãƒã‚¤ã‚¹ã¾ã§åˆ©ç”¨å¯èƒ½ã€SSHãƒãƒ¼ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã™ã‚‹å¿…è¦ãŒãªã„ã€‚ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šã™ã‚‹éš›ã«ä½¿ç”¨ã—ã€é€šå¸¸é‹ç”¨æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: Tailscaleã¯ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®ã¿ä½¿ç”¨ã—ã€é€šå¸¸é‹ç”¨æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
  Rationale: é€šå¸¸é‹ç”¨æ™‚ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šãŒãªã„ãŸã‚ã€Tailscaleã¯ä½¿ç”¨ã§ããªã„ã€‚ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šã™ã‚‹éš›ã«Tailscaleã‚’ä½¿ç”¨ã—ã¦å®‰å…¨ã«SSHæŽ¥ç¶šã™ã‚‹ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: Raspberry Pi 3ã«ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚½ãƒ•ãƒˆã‚’å°Žå…¥ã—ãªã„ã€‚
  Rationale: ãƒªã‚½ãƒ¼ã‚¹ä¸è¶³ã€ã‚µã‚¤ãƒãƒ¼ã‚¸ãŒå¸¸æ™‚èµ·å‹•ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šãªã—ã€Pi5ã§å¯¾ç­–ã—ã¦ã„ã‚Œã°ãƒªã‚¹ã‚¯ã¯ä½Žã„ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯æš—å·åŒ–ã—ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ã™ã‚‹ã€‚
  Rationale: ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ã«æ„ŸæŸ“ã—ã¦ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä¿è­·ã•ã‚Œã‚‹ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¼æ´©ãƒªã‚¹ã‚¯ã‚’ä½Žæ¸›ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã‚’Ansibleã®`group_vars/all.yml`ã§å¤‰æ•°åŒ–ã™ã‚‹ã€‚
  Rationale: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒå¤‰æ›´æ™‚ã«ä¸€ç®‡æ‰€ã®ä¿®æ­£ã§æ¸ˆã‚€ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã¨é€šå¸¸é‹ç”¨æ™‚ã®åˆ‡ã‚Šæ›¿ãˆãŒå®¹æ˜“ã€è¨­å®šãƒŸã‚¹ã‚’é˜²ã’ã‚‹ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: é‹ç”¨ãƒ¢ãƒ¼ãƒ‰ã®å¯è¦–åŒ–ã¯è‡ªå‹•æ¤œå‡ºAPIã¨UIè¡¨ç¤ºã§å®Ÿè£…ã™ã‚‹ã€‚UIã§ã®åˆ‡ã‚Šæ›¿ãˆã¯å®Ÿè£…ã—ãªã„ã€‚
  Rationale: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã¯é »åº¦ãŒä½Žãã€UIã§ã®åˆ‡ã‚Šæ›¿ãˆã¯èª¤æ“ä½œãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚DNSãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§è‡ªå‹•æ¤œå‡ºã—ã€ç®¡ç†ç”»é¢ã§è¡¨ç¤ºã™ã‚‹æ–¹ãŒå®‰å…¨ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: Tailscaleå°Žå…¥ã¯Pi5çµŒç”±ã§Pi4/Pi3ã«ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚èªè¨¼ã¯æ‰‹å‹•ã§è¡Œã†ã€‚
  Rationale: Pi5ã‹ã‚‰Pi4/Pi3ã¸ã®SSHæŽ¥ç¶šã¯ç¢ºç«‹æ¸ˆã¿ã€‚èªè¨¼URLã®è¡¨ç¤ºãŒå¿…è¦ãªãŸã‚ã€æ‰‹å‹•èªè¨¼ãŒé©åˆ‡ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: Pi3ã¸ã®Tailscaleã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã¯ã‚µã‚¤ãƒãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã™ã‚‹ã€‚
  Rationale: Pi3ã¯ãƒªã‚½ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œã¦ãŠã‚Šã€ã‚µã‚¤ãƒãƒ¼ã‚¸ç¨¼åƒä¸­ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒªã‚½ãƒ¼ã‚¹ç«¶åˆãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: SSHæŽ¥ç¶šè¨­å®šã¯`~/.ssh/config`ã«2ã¤ç”¨æ„ã™ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”¨ã¨Tailscaleç”¨ï¼‰ã€‚
  Rationale: é€šå¸¸é‹ç”¨æ™‚ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã§ä½¿ã„åˆ†ã‘ãŒã§ãã‚‹ã€‚`IdentityFile`ã¯å®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹éµã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
  Date/Author: 2025-12-04 / GPT-5.1 Codex

- Decision: Caddyã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ãƒ›ã‚¹ãƒˆã«å‡ºåŠ›ã—ã€fail2banã§HTTP/APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç›£è¦–ã™ã‚‹ã€‚
  Rationale: ã‚³ãƒ³ãƒ†ãƒŠå†…stdoutã®ã¿ã ã¨fail2banãŒè§£æžã§ããªã„ãŸã‚ã€‚ãƒ›ã‚¹ãƒˆä¸Šã®`/var/log/caddy/access.log`ã‚’å…±æœ‰ã—ã€CLFå½¢å¼ã§è¨˜éŒ²ã™ã‚‹ã€‚
  Date/Author: 2025-12-05 / GPT-5.1 Codex

- Decision: UFWã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆdeny/allowæ§‹æˆã¨ã—ã€SSHã¯ãƒ­ãƒ¼ã‚«ãƒ«LANã¨Tailscaleãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿è¨±å¯ã™ã‚‹ã€‚
  Rationale: å·¥å ´LANã¨Tailscaleä»¥å¤–ã‹ã‚‰ã®ç›´æŽ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’é®æ–­ã—ã€ç®¡ç†é¢ã®èª¤æ“ä½œã‚’é˜²ãã€‚
  Date/Author: 2025-12-05 / GPT-5.1 Codex

- Decision: Trivyã¯GitHubå…¬å¼ã®ARM64 .debãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç›´æŽ¥å°Žå…¥ã—ã€`/usr/local/bin/trivy`ã¨ã—ã¦ç®¡ç†ã™ã‚‹ã€‚
  Rationale: Debian bookwormç³»ã«Trivyã®APTãƒªãƒã‚¸ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€æœ€çŸ­ã§å®‰å®šå‹•ä½œã•ã›ã‚‹ã«ã¯å…¬å¼ãƒªãƒªãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦dpkgã§å°Žå…¥ã™ã‚‹ã®ãŒç¢ºå®Ÿã€‚
  Date/Author: 2025-12-05 / GPT-5.1 Codex

- Decision: Pi4ã§ã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é…ä¸‹ã®ã¿ã‚’å¯¾è±¡ã¨ã—ãŸé€±æ¬¡ClamAV/rkhunterã‚’å®Ÿè¡Œã—ã€CPUè² è·ã‚’æŠ‘ãˆã‚‹ã€‚
  Rationale: ã‚­ã‚ªã‚¹ã‚¯ç«¯æœ«ã¯å¸¸æ™‚UIã‚’æä¾›ã—ã¦ãŠã‚Šã€ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã¯ä½“æ„Ÿé…å»¶ã‚’ç”Ÿã‚€ã€‚å¯¾è±¡ç¯„å›²ã¨é »åº¦ã‚’é™å®šã™ã‚‹ã“ã¨ã§å®‰å…¨æ€§ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¸¡ç«‹ã•ã›ã‚‹ã€‚
  Date/Author: 2025-12-05 / GPT-5.1 Codex

- Decision: ClamAV/Trivy/rkhunterã¯Pi5ã§é€±1å›žã®cronå®Ÿè¡Œï¼‹ãƒ­ã‚°ä¿ç®¡ã§é‹ç”¨ã™ã‚‹ã€‚
  Rationale: ãƒªã‚½ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œã‚‹ãŸã‚å¸¸é§ãƒ‡ãƒ¼ãƒ¢ãƒ³ã§ã¯ãªãã€å¤œé–“ãƒãƒƒãƒã§ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹æ–¹ãŒå®‰å®šã€‚ãƒ­ã‚°ã¯`/var/log/{clamav,trivy,rkhunter}`ã«é›†ç´„ã—ã€å¾Œç¶šã®ç›£è¦–ãƒ•ã‚§ãƒ¼ã‚ºã§æ´»ç”¨ã§ãã‚‹ã€‚
  Date/Author: 2025-12-05 / GPT-5.1 Codex

## Outcomes & Retrospective

### Phase 1 & 2 å®Œäº†ï¼ˆ2025-12-04ï¼‰

**å®Œäº†ã—ãŸå®Ÿè£…**:
- âœ… IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®å¤‰æ•°åŒ–ï¼ˆAnsible `group_vars/all.yml`ï¼‰
- âœ… é‹ç”¨ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•æ¤œå‡ºAPIï¼ˆ`/api/system/network-mode`ï¼‰
- âœ… ç®¡ç†ç”»é¢ã§ã®é‹ç”¨ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆ`NetworkModeBadge`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰
- âœ… Tailscaleå°Žå…¥ï¼ˆPi5ã€Pi4ã€Pi3ï¼‰
- âœ… SSHæŽ¥ç¶šè¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”¨ã¨Tailscaleç”¨ï¼‰

**æˆæžœ**:
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒå¤‰æ›´æ™‚ã®ä¿®æ­£ç®‡æ‰€ãŒ1ç®‡æ‰€ã«é›†ç´„ã•ã‚ŒãŸ
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã¨é€šå¸¸é‹ç”¨æ™‚ã®åˆ‡ã‚Šæ›¿ãˆãŒå®¹æ˜“ã«ãªã£ãŸ
- ç¾åœ¨ã®é‹ç”¨ãƒ¢ãƒ¼ãƒ‰ãŒè¦–è¦šçš„ã«ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«SSHãƒãƒ¼ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã™ã‚‹å¿…è¦ãŒãªããªã£ãŸ

**å­¦ã‚“ã ã“ã¨**:
- DNSãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯è»½é‡ã§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šæ¤œå‡ºã«é©ã—ã¦ã„ã‚‹
- Pi3ã¯ãƒªã‚½ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€é‡ã„å‡¦ç†ã®å‰ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- SSHæŽ¥ç¶šè¨­å®šã§ã¯ã€å®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹éµã‚’ç¢ºèªã—ã¦ã‹ã‚‰è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- Tailscaleã¯ç„¡æ–™ã§åˆ©ç”¨ã§ãã€è¨­å®šãŒç°¡å˜ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚‚å¼·å›º

**æ®‹èª²é¡Œ**:
- Phase 3ä»¥é™ã®å®Ÿè£…ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãªã©ï¼‰

### Phase 3 é€²æ—ï¼ˆ2025-12-05ï¼‰

**å®Œäº†ã—ãŸå®Ÿè£…**:
- âœ… `backup-encrypted.sh` / `restore-encrypted.sh` ã‚’è¿½åŠ ã—ã€GPGæš—å·åŒ–ãƒ»å¾©å·ã‚’è‡ªå‹•åŒ–
- âœ… æš—å·åŒ–ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’Pi5ã§å–å¾—ã—ã€å¾©å·ãƒ•ã‚§ãƒ¼ã‚ºã¾ã§ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
- âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ç”¨ãƒžã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆï¼ˆ`/mnt/backup-usb`ï¼‰ã¸ã®ã‚³ãƒ”ãƒ¼å‡¦ç†ã‚’å®Ÿè£…ï¼ˆæœªãƒžã‚¦ãƒ³ãƒˆæ™‚ã¯è­¦å‘Šï¼‰

**æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯**:
- ðŸ”¸ USBãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å®Ÿéš›ã«ãƒžã‚¦ãƒ³ãƒˆã—ãŸçŠ¶æ…‹ã§ã®ã‚³ãƒ”ãƒ¼/å‰Šé™¤ãƒ†ã‚¹ãƒˆ
- ðŸ”¸ æ¤œè¨¼ç”¨DBã¸ã®ãƒ•ãƒ«ãƒªã‚¹ãƒˆã‚¢ï¼ˆæœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã›ãšã«æ•´åˆæ€§ã‚’ç¢ºèªï¼‰

### Phase 4 ç€æ‰‹ï¼ˆ2025-12-05ï¼‰

**å®Œäº†ã—ãŸå®Ÿè£…**:
- âœ… Pi5ã«`ufw`/`fail2ban`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€AnsibleåŒ–
- âœ… HTTP/HTTPS/SSH(ãƒ­ãƒ¼ã‚«ãƒ«LAN + Tailscale)ã®ã¿è¨±å¯ã—ã€ãã®ä»–ã¯deny
- âœ… Caddyã®HTTPâ†’HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’æ’ä¹…åŒ–ã—ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ãƒ›ã‚¹ãƒˆã¸å‡ºåŠ›
- âœ… fail2banã®jailã‚’`sshd`ã¨`caddy-http-auth`ã§æ§‹æˆã—ã€CLFãƒ­ã‚°ã‚’ç›£è¦–

**è¦³æ¸¬ã•ã‚ŒãŸåŠ¹æžœ**:
- ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šãŒã‚³ãƒ¼ãƒ‰åŒ–ã•ã‚Œã€å†ãƒ‡ãƒ—ãƒ­ã‚¤ã§å†ç¾å¯èƒ½ã«
- HTTPSå¼·åˆ¶ã¨ãƒ­ã‚°å‡ºåŠ›ã«ã‚ˆã‚Šã€fail2banã§HTTP/APIä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’è‡ªå‹•é®æ–­å¯èƒ½ã«

**æ®‹èª²é¡Œ**:
- UFW/fail2banã®å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’Phase7ã§å®Ÿæ–½
- APIå€‹åˆ¥ã®fail2banãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆå¿…è¦ãªã‚‰è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ¤œè¨Žï¼‰

### Phase 5 é€²æ—ï¼ˆ2025-12-05ï¼‰

**å®Œäº†ã—ãŸå®Ÿè£…**:
- âœ… Pi5ã«ClamAV/Trivy/rkhunterã‚’å°Žå…¥ã—ã€`/usr/local/bin/*-scan.sh`ã¨æ—¥æ¬¡cronã‚’é…ç½®
- âœ… Pi4ã«è»½é‡ClamAV/rkhunterã‚’å°Žå…¥ã—ã€é€±æ¬¡cronã§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã¿ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆè² è·ã‚’æœ€å°åŒ–ï¼‰
- âœ… `/var/log/{clamav,trivy,rkhunter}`ã¸ãƒ­ã‚°ã‚’é›†ç´„ã—ã€æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚‚å‹•ä½œç¢ºèªæ¸ˆã¿ï¼ˆfreshclamãƒ­ãƒƒã‚¯è­¦å‘Šã®ã¿ï¼‰

**æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯**:
- ðŸ”¸ Trivyã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸å˜ä½ã®ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆç¾åœ¨ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰

### Phase 6 é€²æ—ï¼ˆ2025-12-05ï¼‰

**å®Œäº†ã—ãŸå®Ÿè£…**:
- âœ… `security-monitor.sh`ã‚’æ—¥æ¬¡timerã§å®Ÿè¡Œã—ã€fail2ban Banã‚¤ãƒ™ãƒ³ãƒˆã‚’è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆåŒ–
- âœ… ClamAV/Trivy/rkhunterã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚¢ãƒ©ãƒ¼ãƒˆé€£æºã‚’å®Ÿè£…ã—ã€æ¤œçŸ¥æ™‚ã«`alerts/`ã¸é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
- âœ… èª¤æ¤œçŸ¥ã‚’é˜²ããŸã‚ã®é™¤å¤–ãƒªã‚¹ãƒˆï¼ˆTrivy skip dirs / rkhunter ignore patternsï¼‰ã‚’Ansibleå¤‰æ•°åŒ–

## Context and Orientation

- **ç¾çŠ¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**: 
  - âœ… èªè¨¼ãƒ»èªå¯ï¼ˆJWTã€RBACï¼‰
  - âœ… å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆzodï¼‰
  - âœ… XSS/SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆReactã‚¨ã‚¹ã‚±ãƒ¼ãƒ— + Prismaï¼‰
  - âœ… APIãƒ¬ãƒ¼ãƒˆåˆ¶é™
  - âœ… IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®å¤‰æ•°åŒ– ï¼‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•æ¤œå‡º
  - âœ… Tailscaleã«ã‚ˆã‚‹ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹VPN
  - âœ… Pi5ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ï¼ˆufwï¼‰/fail2ban/HTTPSå¼·åˆ¶
  - âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜å¯¾å¿œï¼‰
  - âœ… ãƒžãƒ«ã‚¦ã‚§ã‚¢å¯¾ç­–ï¼ˆPi5: ClamAV/Trivy/rkhunterã€Pi4: è»½é‡ClamAV+rkhunterï¼‰

- **æ®‹ã£ã¦ã„ã‚‹å¯¾ç­–**:
  - âŒ ç®¡ç†ç”»é¢ã®IPåˆ¶é™ï¼ˆä»Šå¾ŒTailscale ACLã¨é€£æºäºˆå®šï¼‰
  - âŒ ã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚°/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®å¸¸æ™‚ç›£è¦–ãƒ»é€šçŸ¥
  - âŒ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸å˜ä½ã®Trivyã‚¹ã‚­ãƒ£ãƒ³
  - âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ†ã‚¹ãƒˆï¼ˆæ¤œè¨¼ç”¨DBï¼‰

- **IPã‚¢ãƒ‰ãƒ¬ã‚¹ç›´æŽ¥è¨˜è¿°ç®‡æ‰€**:
  - `infrastructure/ansible/inventory.yml`: è¤‡æ•°ç®‡æ‰€ï¼ˆ`ansible_host`ã€URLã€WebSocket URLãªã©ï¼‰
  - `infrastructure/ansible/templates/nfc-agent.env.j2`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«å¤ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹
  - `infrastructure/ansible/templates/status-agent.conf.j2`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«å¤ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹
  - `infrastructure/ansible/templates/docker.env.j2`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«å¤ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹
  - `scripts/register-clients.sh`: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹
  - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…: å¤šæ•°ï¼ˆå‚è€ƒæƒ…å ±ã¨ã—ã¦æ®‹ã™ï¼‰

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶å®šç¾©](../security/requirements.md) - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®è©³ç´°
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ãƒ¬ãƒ“ãƒ¥ãƒ¼](../security/validation-review.md) - æ—¢å­˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼

## Plan of Work

### Phase 0: æº–å‚™ãƒ»è¨­è¨ˆ

1. **IPã‚¢ãƒ‰ãƒ¬ã‚¹ç›´æŽ¥è¨˜è¿°ç®‡æ‰€ã®æ´—ã„å‡ºã—**
   - `grep`ã§IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
   - å„ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜è¿°ç®‡æ‰€ã‚’ãƒªã‚¹ãƒˆåŒ–
   - å¤‰æ•°åŒ–ãŒå¿…è¦ãªç®‡æ‰€ã¨å‚è€ƒæƒ…å ±ã¨ã—ã¦æ®‹ã™ç®‡æ‰€ã‚’åˆ†é¡ž

### Phase 1: IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®å¤‰æ•°åŒ–

1. **Ansibleã®å¤‰æ•°å®šç¾©ä½œæˆ**
   - `infrastructure/ansible/group_vars/all.yml`ã‚’ä½œæˆ
   - ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨ã¨Tailscaleç”¨ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ•°ã‚’å®šç¾©
   - `network_mode`ã§åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã«ã™ã‚‹

2. **Ansibleã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£**
   - `infrastructure/ansible/inventory.yml`ã§å¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
   - `ansible_host`ã€URLã€WebSocket URLãªã©ã‚’å¤‰æ•°å‚ç…§ã«å¤‰æ›´

3. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£**
   - `infrastructure/ansible/templates/*.j2`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä¿®æ­£
   - å¤ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ`192.168.128.131`ãªã©ï¼‰ã‚’å‰Šé™¤
   - å¤‰æ•°ã®ã¿å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´

4. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¿®æ­£**
   - `scripts/register-clients.sh`ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ•°å‚ç…§ã«å¤‰æ›´
   - ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Ansibleå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ä¿®æ­£

5. **åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ**
   - `network_mode: "local"`ã§å‹•ä½œç¢ºèª
   - `network_mode: "tailscale"`ã§å‹•ä½œç¢ºèªï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ï¼‰

### Phase 2: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®å®‰å…¨åŒ–ï¼ˆTailscaleå°Žå…¥ï¼‰

1. **Raspberry Pi 5ã«Tailscaleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ï¼‰**
   - Pi5ã«SSHæŽ¥ç¶šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ï¼‰
   - Tailscaleã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - Tailscaleã‚’èµ·å‹•ã—ã¦èªè¨¼

2. **Raspberry Pi 4/3ã«Tailscaleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã€å¿…è¦ã«å¿œã˜ã¦ï¼‰**
   - Pi4/3ã«SSHæŽ¥ç¶šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ï¼‰
   - Tailscaleã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - Tailscaleã‚’èµ·å‹•ã—ã¦èªè¨¼

3. **SSHæŽ¥ç¶šè¨­å®šã‚’2ã¤ç”¨æ„**
   - Macå´ã®`~/.ssh/config`ã«2ã¤ã®è¨­å®šã‚’è¿½åŠ 
   - é€šå¸¸é‹ç”¨æ™‚ç”¨ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰
   - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ç”¨ï¼ˆTailscaleçµŒç”±ï¼‰

4. **é‹ç”¨ãƒ•ãƒ­ãƒ¼ã®ç¢ºç«‹**
   - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®æ‰‹é †ã‚’æ–‡æ›¸åŒ–
   - é€šå¸¸é‹ç”¨æ™‚ã®æ‰‹é †ã‚’æ–‡æ›¸åŒ–

### Phase 3: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜

1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æš—å·åŒ–æ©Ÿèƒ½ã‚’è¿½åŠ **
   - æ—¢å­˜ã®`backup.sh`ã‚’ç¢ºèª
   - GPGã¾ãŸã¯opensslã‚’ä½¿ç”¨ã—ã¦æš—å·åŒ–æ©Ÿèƒ½ã‚’è¿½åŠ 
   - æš—å·åŒ–ã‚­ãƒ¼ã®ç®¡ç†æ–¹æ³•ã‚’æ±ºå®š

2. **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ç”¨ã®USBãƒ¡ãƒ¢ãƒª/å¤–éƒ¨HDDã®è¨­å®š**
   - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜å…ˆã®è¨­å®š
   - ãƒžã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã®è¨­å®š
   - è‡ªå‹•ãƒžã‚¦ãƒ³ãƒˆã®è¨­å®š

3. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ**
   - cronã‚¸ãƒ§ãƒ–ã®è¨­å®š
   - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œãƒ­ã‚°ã®è¨˜éŒ²
   - å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è‡ªå‹•å‰Šé™¤

4. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ†ã‚¹ãƒˆ**
   - æš—å·åŒ–ã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å·åŒ–ãƒ†ã‚¹ãƒˆ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒªã‚¹ãƒˆã‚¢ãƒ†ã‚¹ãƒˆ
   - ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚¢ãƒ†ã‚¹ãƒˆ

### Phase 4: é€šå¸¸é‹ç”¨æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

1. **ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šï¼ˆufwï¼‰**
   - ufwã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - å¿…è¦ãªãƒãƒ¼ãƒˆã®ã¿é–‹æ”¾ï¼ˆ80, 443ï¼‰
   - SSHãƒãƒ¼ãƒˆã®åˆ¶é™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯TailscaleçµŒç”±ã®ã¿ï¼‰
   - ufwã®æœ‰åŠ¹åŒ–

2. **HTTPSå¼·åˆ¶è¨­å®š**
   - Caddyfile.productionã§HTTPâ†’HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¨­å®š
   - ç’°å¢ƒå¤‰æ•°`FORCE_HTTPS=true`ã‚’è¨­å®š
   - HTTPSå¼·åˆ¶ã®å‹•ä½œç¢ºèª

3. **fail2banå°Žå…¥**
   - fail2banã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - jailè¨­å®šï¼ˆSSHã€HTTPã€APIï¼‰
   - fail2banã®å‹•ä½œç¢ºèª

### Phase 5: ãƒžãƒ«ã‚¦ã‚§ã‚¢å¯¾ç­–

1. **ClamAVå°Žå…¥ï¼ˆPi5ï¼‰**
   - ClamAVã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - ã‚¦ã‚¤ãƒ«ã‚¹å®šç¾©ã®æ›´æ–°
   - å®šæœŸã‚¹ã‚­ãƒ£ãƒ³è¨­å®šï¼ˆcronã€é€±1å›žï¼‰

2. **Trivyå°Žå…¥ï¼ˆPi5ï¼‰**
   - Trivyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¹ã‚­ãƒ£ãƒ³è¨­å®š
   - å®šæœŸã‚¹ã‚­ãƒ£ãƒ³è¨­å®šï¼ˆcronã€é€±1å›žï¼‰

3. **rkhunterå°Žå…¥ï¼ˆPi5ï¼‰**
   - rkhunterã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ
   - å®šæœŸã‚¹ã‚­ãƒ£ãƒ³è¨­å®šï¼ˆcronã€é€±1å›žï¼‰

4. **ClamAVå°Žå…¥ï¼ˆPi4ã€è»½é‡è¨­å®šï¼‰**
   - ClamAVã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - è»½é‡è¨­å®šï¼ˆé€±1å›žã‚¹ã‚­ãƒ£ãƒ³ï¼‰
   - ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ã®ç›£è¦–

5. **rkhunterå°Žå…¥ï¼ˆPi4ï¼‰**
   - rkhunterã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   - åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ
   - å®šæœŸã‚¹ã‚­ãƒ£ãƒ³è¨­å®šï¼ˆcronã€é€±1å›žï¼‰

### Phase 6: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®ç›£è¦–è¨­å®š**
   - [x] (2025-12-05) fail2banãƒ­ã‚°ã®Banè¡Œã‚’ç›£è¦–ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ
   - [x] (2025-12-05) ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’systemd timerã§15åˆ†ã”ã¨ã«å®Ÿè¡Œ

2. **ç•°å¸¸æ¤œçŸ¥æ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥è¨­å®š**
   - [x] (2025-12-05) æ—¢å­˜ã®`generate-alert.sh`ã¨é€£æºã—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãªã—ã§ã‚‚ç®¡ç†ç”»é¢ã«é€šçŸ¥

3. **ã‚¹ã‚­ãƒ£ãƒ³çµæžœã®ãƒ­ã‚°ç›£è¦–è¨­å®š**
   - [x] (2025-12-05) ClamAV/Trivy/rkhunterã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æ¤œçŸ¥æ™‚ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç™ºç«
   - [x] (2025-12-05) èª¤æ¤œçŸ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆcerts/ã‚„rkhunteræ—¢çŸ¥è­¦å‘Šï¼‰ã‚’é™¤å¤–ã§ãã‚‹ã‚ˆã†ã«ã—ãŸ

## Concrete Steps

### Phase 0: æº–å‚™ãƒ»è¨­è¨ˆ

```bash
# IPã‚¢ãƒ‰ãƒ¬ã‚¹ç›´æŽ¥è¨˜è¿°ç®‡æ‰€ã®æ´—ã„å‡ºã—
cd /Users/tsudatakashi/RaspberryPiSystem_002
grep -r "192\.168\.\d+\.\d+" --include="*.yml" --include="*.yaml" --include="*.j2" --include="*.sh" infrastructure/ansible/ scripts/
```

### Phase 1: IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®å¤‰æ•°åŒ–

```bash
# 1. Ansibleã®å¤‰æ•°å®šç¾©ä½œæˆ
cd /Users/tsudatakashi/RaspberryPiSystem_002
mkdir -p infrastructure/ansible/group_vars
cat > infrastructure/ansible/group_vars/all.yml << 'EOF'
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: local ã¾ãŸã¯ tailscale
network_mode: "local"

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨IPã‚¢ãƒ‰ãƒ¬ã‚¹
local_network:
  raspberrypi5_ip: "192.168.10.230"
  raspberrypi4_ip: "192.168.10.223"
  raspberrypi3_ip: "192.168.10.109"

# Tailscaleç”¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®ã¿ä½¿ç”¨ï¼‰
# æ³¨æ„: Tailscale IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å‹•çš„ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ãŒã€ãƒ‡ãƒã‚¤ã‚¹ã”ã¨ã«å›ºå®šã•ã‚Œã‚‹
# ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã« `tailscale status` ã§ç¢ºèªã—ã¦è¨­å®šã™ã‚‹
tailscale_network:
  raspberrypi5_ip: ""  # ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«ç¢ºèªã—ã¦è¨­å®š
  raspberrypi4_ip: ""
  raspberrypi3_ip: ""

# ç¾åœ¨ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šï¼ˆnetwork_modeã«åŸºã¥ã„ã¦è‡ªå‹•é¸æŠžï¼‰
current_network: "{{ local_network if network_mode == 'local' else tailscale_network }}"
EOF

# 2. inventory.ymlã®ä¿®æ­£ï¼ˆå¤‰æ•°å‚ç…§ã«å¤‰æ›´ï¼‰
# 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£
# 4. scripts/register-clients.shã®ä¿®æ­£
# 5. åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
```

### Phase 2: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®å®‰å…¨åŒ–ï¼ˆTailscaleå°Žå…¥ï¼‰

```bash
# Raspberry Pi 5ã«Tailscaleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ï¼‰
ssh denkon5sd02@192.168.10.230
curl -fsSL https://tailscale.com/install.sh | sh
sudo tailscale up
# èªè¨¼URLãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€Macã®ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦æ‰¿èª
```

### Phase 3: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æš—å·åŒ–æ©Ÿèƒ½ã‚’è¿½åŠ 
# æ—¢å­˜ã®backup.shã‚’ç¢ºèªã—ã¦ä¿®æ­£
```

### Phase 4: é€šå¸¸é‹ç”¨æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

```bash
# ufwã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®šï¼ˆPi5ï¼‰
ssh denkon5sd02@192.168.10.230
sudo apt update
sudo apt install -y ufw
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow from 192.168.10.0/24 to any port 22
sudo ufw enable
sudo ufw status
```

### Phase 5: ãƒžãƒ«ã‚¦ã‚§ã‚¢å¯¾ç­–

```bash
# ClamAVã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPi5ï¼‰
ssh denkon5sd02@192.168.10.230
sudo apt update
sudo apt install -y clamav clamav-daemon
sudo freshclam
```

## Test Plan

### Phase 1: IPã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ã®å¤‰æ•°åŒ–ã¨é‹ç”¨ãƒ¢ãƒ¼ãƒ‰å¯è¦–åŒ–ãƒ†ã‚¹ãƒˆ

- [ ] `network_mode: "local"`ã§AnsibleãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] `network_mode: "tailscale"`ã§AnsibleãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ï¼‰
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãå¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] `scripts/register-clients.sh`ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] é‹ç”¨ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•æ¤œå‡ºAPIãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šã‚ã‚Š/ãªã—ï¼‰
- [ ] ç®¡ç†ç”»é¢ã§é‹ç”¨ãƒ¢ãƒ¼ãƒ‰ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] é‹ç”¨ãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤ºãŒå®šæœŸçš„ã«æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### Phase 2: Tailscaleå°Žå…¥ãƒ†ã‚¹ãƒˆ

- [ ] Macã‹ã‚‰Tailscale IPçµŒç”±ã§Pi5ã«SSHæŽ¥ç¶šã§ãã‚‹ã“ã¨ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šã‚ã‚Šï¼‰
- [ ] é€šå¸¸é‹ç”¨æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã§SSHæŽ¥ç¶šã§ãã‚‹ã“ã¨
- [ ] ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§Ansibleã‚’å®Ÿè¡Œã§ãã‚‹ã“ã¨
- [ ] ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«GitHubã‹ã‚‰pullã§ãã‚‹ã“ã¨

### Phase 3: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æš—å·åŒ–ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ãƒ†ã‚¹ãƒˆ

- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæš—å·åŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] æš—å·åŒ–ã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å·åŒ–ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒªã‚¹ãƒˆã‚¢ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚¢ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

### Phase 4: é€šå¸¸é‹ç”¨æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãƒ†ã‚¹ãƒˆ

- [ ] ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§ä¸è¦ãªãƒãƒ¼ãƒˆãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] HTTPSå¼·åˆ¶ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] fail2banãŒãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

### Phase 5: ãƒžãƒ«ã‚¦ã‚§ã‚¢å¯¾ç­–ãƒ†ã‚¹ãƒˆ

- [ ] ClamAVãŒæ­£å¸¸ã«ã‚¹ã‚­ãƒ£ãƒ³ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] TrivyãŒDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] rkhunterãŒæ­£å¸¸ã«ã‚¹ã‚­ãƒ£ãƒ³ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª

### Phase 6: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ

- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãŒæ­£ã—ãè¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ç•°å¸¸æ¤œçŸ¥æ™‚ã«ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ã‚¹ã‚­ãƒ£ãƒ³çµæžœãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

