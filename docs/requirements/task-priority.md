# 要件定義タスクの優先順位

最終更新: 2025-01-XX

## タスク分類

### ✅ 完了済み

- [x] Milestone 1-4: 基本実装（API、Web UI、NFCエージェント）
- [x] Milestone 6: モジュール化リファクタリング（Phase 1-4）
- [x] ファイル構造とドキュメントのリファクタリング
- [x] ロギングとエラーハンドリングの改善
- [x] サービス層の導入
- [x] 共通パッケージ（shared-types）の作成

### 🔄 未実施・仕掛中

#### 1. Milestone 5: 実機検証フェーズ（最優先）

**優先度: 🔴 最高**

**理由**: システムの信頼性と実用性を確認するため、最も重要。

**タスク**:
- [ ] Validation 1: サーバーヘルス確認（✅ 一部完了）
- [ ] Validation 2: 従業員・アイテム管理（✅ 一部完了）
- [ ] Validation 3: 持出フロー（✅ 一部完了）
- [ ] Validation 4: 返却フロー（✅ 一部完了）
- [ ] Validation 5: 履歴画面（✅ 一部完了）
- [x] Validation 6: オフライン耐性（✅ 2025-11-24 実機検証完了）
- [ ] Validation 7: USB一括登録（✅ 実装完了、実機検証待ち）
- [ ] Validation 8: NFCエージェント単体（✅ 一部完了）

**推定工数**: 2-3日

**次のアクション**: Validation 6（オフライン耐性）とValidation 7（USB一括登録）の実機検証を実施。オフライン耐性機能の実装は完了（詳細は`docs/progress/offline-resilience-implementation.md`を参照）。

---

#### 2. テストカバレッジの向上

**優先度: 🟡 高**

**理由**: リファクタリング完了後、サービス層のテストが不足している。品質保証のため重要。

**タスク**:
- [x] サービス層のユニットテスト追加
  - [x] `EmployeeService`のテスト（11ケース）
  - [x] `ItemService`のテスト（11ケース）
  - [x] `LoanService`のテスト（15ケース：持出・返却・アクティブ一覧）
  - [x] `TransactionService`のテスト（5ケース）
- [x] CIパイプラインの修正
  - [x] pnpmバージョンの不一致を修正
  - [x] Prisma Client生成ステップを追加
  - [x] health.test.tsを最新エンドポイントに更新
- [x] ルートハンドラーの統合テスト追加
  - [x] テストヘルパー関数（helpers.ts）を作成
  - [x] 従業員エンドポイントの統合テスト（GET, POST）
  - [x] アイテムエンドポイントの統合テスト（GET, POST）
  - [x] 貸出エンドポイントの統合テスト（borrow, active）
  - [x] 認証エンドポイントの統合テスト（login, refresh）
- [ ] E2Eテストの追加（Playwright等）

**推定工数**: 3-5日（サービス層テスト完了、CIパイプライン修正完了、統合テスト完了、残り1-2日）

**完了**: 2025-11-24、サービス層のユニットテストを追加完了。合計43個のテストがすべて成功。CIパイプラインの修正も完了し、GitHub Actionsで正常に動作することを確認。ルートハンドラーの統合テストを追加完了。合計20以上の統合テストケースを追加し、APIエンドポイントの動作を保証。統合テストの安定化を完了し、テストデータの分離を改善。GitHub Actions CIパイプラインで全66テストが成功することを確認。ローカルテスト環境を整備し、Docker Desktopを使用したテスト実行が可能になった。

**残タスク**:
- [x] E2Eテストの追加（Playwright）
  - 完了: 2025-11-24、Playwrightを使用したE2Eテストを実装完了。認証フロー、キオスク画面、管理画面のテストを追加。CIパイプラインにE2Eテストジョブを追加。
- [x] E2Eテストの改善とCI環境での最適化
  - 完了: 2025-11-24、ログイン後のリダイレクト問題を修正。CI環境では物理デバイスが必要なNFCスキャンテストを削除し、有効な範囲のみをテストする方針に変更。詳細は`docs/progress/e2e-testing-improvements.md`を参照。

---

#### 3. 新規モジュールの実装

**優先度: 🟢 中**

**理由**: 将来の機能拡張のため。ただし、現行システムの安定化が優先。

**タスク**:

##### 3-1. ドキュメントビューワーモジュール

- [ ] APIルートの実装（`routes/documents/`）
- [ ] サービス層の実装（`services/documents/`）
- [ ] フロントエンドページの実装（`pages/documents/`）
- [ ] ファイルストレージの設計・実装
- [ ] PDF/Excelビューワーの統合

**推定工数**: 5-7日

##### 3-2. 物流管理モジュール

- [ ] APIルートの実装（`routes/logistics/`）
- [ ] サービス層の実装（`services/logistics/`）
- [ ] フロントエンドページの実装（`pages/logistics/`）
- [ ] 在庫管理機能の実装

**推定工数**: 7-10日

**次のアクション**: 要件定義の詳細化と優先順位の決定。

---

#### 4. パフォーマンス改善

**優先度: 🟢 中**

**理由**: 現行システムで問題が発生していないが、将来の拡張に備えて重要。

**タスク**:
- [ ] APIレスポンス時間の測定とボトルネック特定
- [ ] データベースクエリの最適化（インデックス追加等）
- [ ] フロントエンドのパフォーマンス最適化（コード分割、遅延読み込み）
- [ ] キャッシュ戦略の検討・実装

**推定工数**: 3-5日

**次のアクション**: 現行システムのパフォーマンス測定から開始。

---

#### 5. セキュリティ強化

**優先度: 🟡 高**

**理由**: 本番環境での運用を考慮すると重要。

**タスク**:
- [x] 認証・認可の強化（JWT有効期限の短縮、リフレッシュトークンの実装）
  - [x] リフレッシュトークンエンドポイント（POST /api/auth/refresh）を実装
- [x] APIレート制限の実装
  - [x] 認証エンドポイントに厳しいレート制限（5リクエスト/分）を適用
  - [x] 一般APIエンドポイントにレート制限（100リクエスト/分）を適用
- [x] 入力バリデーションの強化（zodで既に実装済み、確認完了）
- [x] SQLインジェクション対策の確認（Prisma使用により既に対策済み）
- [x] XSS対策の確認（Reactのデフォルトエスケープで対策済み）
- [x] セキュリティヘッダーの追加（@fastify/helmet）
- [x] HTTPSの強制（本番環境）
  - [x] 本番環境用Caddyfile.productionを作成
  - [x] DOMAIN環境変数でHTTPS強制を制御
  - [x] Let's Encryptによる自動証明書取得をサポート
  - [x] HTTPからHTTPSへのリダイレクトを実装
  - [x] 本番環境セットアップガイドを作成

**推定工数**: 3-4日（完了）

**完了**: 2025-01-XX、APIレート制限、リフレッシュトークンエンドポイント、セキュリティヘッダー、HTTPS強制を実装完了。入力バリデーションとXSS対策の確認完了。

---

#### 6. 運用・保守性の向上

**優先度: 🟢 中**

**理由**: 長期的な運用を考慮すると重要。

**タスク**:
- [x] バックアップ・リストア手順の文書化
  - [x] バックアップスクリプト（scripts/server/backup.sh）を作成
  - [x] リストアスクリプト（scripts/server/restore.sh）を作成
  - [x] バックアップ・リストアガイド（docs/guides/backup-and-restore.md）を作成
- [x] 監視・アラートの実装（ログ監視、メトリクス収集）
  - [x] システムヘルスチェックエンドポイント（/api/system/health）を追加
  - [x] Prometheus形式のメトリクスエンドポイント（/api/system/metrics）を追加
  - [x] 監視スクリプト（scripts/server/monitor.sh）を作成
  - [x] 監視・アラートガイド（docs/guides/monitoring.md）を作成
- [x] 自動デプロイメントの実装（CI/CD）
  - [x] GitHub Actions CIパイプライン（.github/workflows/ci.yml）を作成
  - [x] デプロイスクリプト（scripts/server/deploy.sh）を更新
  - [x] デプロイメントガイド（docs/guides/deployment.md）を作成
- [x] ドキュメントの充実化
  - [x] API概要ドキュメント（docs/api/overview.md）を作成
  - [x] 認証APIドキュメント（docs/api/auth.md）を作成
  - [x] 開発者向けガイド（docs/development/getting-started.md）を作成

**推定工数**: 5-7日（実装完了、ラズパイ検証待ち）

**完了**: 2025-01-XX、バックアップ・リストア手順の文書化とスクリプト作成完了。監視・アラート機能を実装完了。CI/CDパイプラインとデプロイスクリプトを実装完了。ドキュメントの充実化完了。

**検証**: ラズパイでの検証が必要です。検証チェックリストは `docs/guides/verification-checklist.md` を参照してください。

---

## 推奨実施順序

### ✅ 完了済み
- ✅ **テストカバレッジの向上**（サービス層ユニットテスト、統合テスト、CIパイプライン）
- ✅ **セキュリティ強化**（APIレート制限、リフレッシュトークン、セキュリティヘッダー、HTTPS強制）
- ✅ **運用・保守性の向上**（バックアップ・リストア、監視・アラート、CI/CD、ドキュメント）

### 🔄 次の優先タスク

1. **Milestone 5: 実機検証フェーズ**（最優先）
   - Validation 6（オフライン耐性）
   - Validation 7（USB一括登録）
   - **推定工数**: 2-3日
   - **優先度**: 🔴 最高

2. **E2Eテストの改善**（完了）
   - ✅ Playwrightを使用したUIフローのE2Eテストを実装完了
   - ✅ CI環境でのテスト戦略を見直し、有効な範囲のみをテストする方針に変更
   - ✅ ログイン後のリダイレクト問題を修正
   - **完了日**: 2025-11-24
   - **詳細**: `docs/progress/e2e-testing-improvements.md`を参照

3. **パフォーマンス改善**
   - APIレスポンス時間の測定とボトルネック特定
   - データベースクエリの最適化（インデックス追加等）
   - **推定工数**: 3-5日
   - **優先度**: 🟢 中

4. **新規モジュールの実装**
   - 要件定義の詳細化
   - ドキュメントビューワーモジュールの実装
   - **推定工数**: 5-7日
   - **優先度**: 🟢 中

## 注意事項

- 各タスクは独立して実施可能ですが、依存関係がある場合は順序を考慮してください。
- 新規モジュールの実装は、現行システムの安定化が完了してから開始することを推奨します。
- テストカバレッジの向上は、新機能追加前に実施することで、品質を保証できます。

