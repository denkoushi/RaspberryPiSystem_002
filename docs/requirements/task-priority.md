# 要件定義タスクの優先順位

最終更新: 2025-01-XX

## タスク分類

### ✅ 完了済み

- [x] Milestone 1-4: 基本実装（API、Web UI、NFCエージェント）
- [x] Milestone 6: モジュール化リファクタリング（Phase 1-4）
- [x] ファイル構造とドキュメントのリファクタリング
- [x] ロギングとエラーハンドリングの改善
- [x] サービス層の導入
- [x] 共通パッケージ（shared-types）の作成

### 🔄 未実施・仕掛中

#### 1. Milestone 5: 実機検証フェーズ（最優先）

**優先度: 🔴 最高**

**理由**: システムの信頼性と実用性を確認するため、最も重要。

**タスク**:
- [ ] Validation 1: サーバーヘルス確認（✅ 一部完了）
- [ ] Validation 2: 従業員・アイテム管理（✅ 一部完了）
- [ ] Validation 3: 持出フロー（✅ 一部完了）
- [ ] Validation 4: 返却フロー（✅ 一部完了）
- [ ] Validation 5: 履歴画面（✅ 一部完了）
- [ ] Validation 6: オフライン耐性（未実施）
- [ ] Validation 7: USB一括登録（未実施）
- [ ] Validation 8: NFCエージェント単体（✅ 一部完了）

**推定工数**: 2-3日

**次のアクション**: Validation 6（オフライン耐性）とValidation 7（USB一括登録）を実施。

---

#### 2. テストカバレッジの向上

**優先度: 🟡 高**

**理由**: リファクタリング完了後、サービス層のテストが不足している。品質保証のため重要。

**タスク**:
- [x] サービス層のユニットテスト追加
  - [x] `EmployeeService`のテスト（11ケース）
  - [x] `ItemService`のテスト（11ケース）
  - [x] `LoanService`のテスト（15ケース：持出・返却・アクティブ一覧）
  - [x] `TransactionService`のテスト（5ケース）
- [ ] ルートハンドラーの統合テスト追加
- [ ] E2Eテストの追加（Playwright等）

**推定工数**: 3-5日（サービス層テスト完了、残り2-3日）

**完了**: 2025-01-XX、サービス層のユニットテストを追加完了。合計43個のテストがすべて成功。

---

#### 3. 新規モジュールの実装

**優先度: 🟢 中**

**理由**: 将来の機能拡張のため。ただし、現行システムの安定化が優先。

**タスク**:

##### 3-1. ドキュメントビューワーモジュール

- [ ] APIルートの実装（`routes/documents/`）
- [ ] サービス層の実装（`services/documents/`）
- [ ] フロントエンドページの実装（`pages/documents/`）
- [ ] ファイルストレージの設計・実装
- [ ] PDF/Excelビューワーの統合

**推定工数**: 5-7日

##### 3-2. 物流管理モジュール

- [ ] APIルートの実装（`routes/logistics/`）
- [ ] サービス層の実装（`services/logistics/`）
- [ ] フロントエンドページの実装（`pages/logistics/`）
- [ ] 在庫管理機能の実装

**推定工数**: 7-10日

**次のアクション**: 要件定義の詳細化と優先順位の決定。

---

#### 4. パフォーマンス改善

**優先度: 🟢 中**

**理由**: 現行システムで問題が発生していないが、将来の拡張に備えて重要。

**タスク**:
- [ ] APIレスポンス時間の測定とボトルネック特定
- [ ] データベースクエリの最適化（インデックス追加等）
- [ ] フロントエンドのパフォーマンス最適化（コード分割、遅延読み込み）
- [ ] キャッシュ戦略の検討・実装

**推定工数**: 3-5日

**次のアクション**: 現行システムのパフォーマンス測定から開始。

---

#### 5. セキュリティ強化

**優先度: 🟡 高**

**理由**: 本番環境での運用を考慮すると重要。

**タスク**:
- [x] 認証・認可の強化（JWT有効期限の短縮、リフレッシュトークンの実装）
  - [x] リフレッシュトークンエンドポイント（POST /api/auth/refresh）を実装
- [x] APIレート制限の実装
  - [x] 認証エンドポイントに厳しいレート制限（5リクエスト/分）を適用
  - [x] 一般APIエンドポイントにレート制限（100リクエスト/分）を適用
- [x] 入力バリデーションの強化（zodで既に実装済み、確認完了）
- [x] SQLインジェクション対策の確認（Prisma使用により既に対策済み）
- [x] XSS対策の確認（Reactのデフォルトエスケープで対策済み）
- [x] セキュリティヘッダーの追加（@fastify/helmet）
- [ ] HTTPSの強制（本番環境）

**推定工数**: 3-4日（レート制限、リフレッシュトークン、セキュリティヘッダー完了、残りHTTPS強制のみ）

**完了**: 2025-01-XX、APIレート制限、リフレッシュトークンエンドポイント、セキュリティヘッダーを実装完了。入力バリデーションとXSS対策の確認完了。

---

#### 6. 運用・保守性の向上

**優先度: 🟢 中**

**理由**: 長期的な運用を考慮すると重要。

**タスク**:
- [ ] バックアップ・リストア手順の文書化
- [ ] 監視・アラートの実装（ログ監視、メトリクス収集）
- [ ] 自動デプロイメントの実装（CI/CD）
- [ ] ドキュメントの充実化

**推定工数**: 5-7日

**次のアクション**: バックアップ・リストア手順の文書化から開始。

---

## 推奨実施順序

1. **Milestone 5: 実機検証フェーズ**（最優先）
   - Validation 6（オフライン耐性）
   - Validation 7（USB一括登録）

2. **テストカバレッジの向上**
   - サービス層のユニットテスト追加

3. **セキュリティ強化**
   - 認証・認可の強化
   - APIレート制限の実装

4. **パフォーマンス改善**
   - 現行システムのパフォーマンス測定

5. **新規モジュールの実装**
   - 要件定義の詳細化
   - ドキュメントビューワーモジュールの実装

6. **運用・保守性の向上**
   - バックアップ・リストア手順の文書化
   - 監視・アラートの実装

## 注意事項

- 各タスクは独立して実施可能ですが、依存関係がある場合は順序を考慮してください。
- 新規モジュールの実装は、現行システムの安定化が完了してから開始することを推奨します。
- テストカバレッジの向上は、新機能追加前に実施することで、品質を保証できます。

