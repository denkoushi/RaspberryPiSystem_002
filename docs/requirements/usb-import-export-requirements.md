# USBメモリ経由のデータインポート・エクスポート要件定義

最終更新: 2025-11-24

## 背景・目的

### 運用環境の制約

- **ローカルWi-Fi運用**: 業務用PCやインターネットから直接データをインポートできない
- **オフライン環境**: 外部ネットワークに接続できない環境での運用
- **データ搬入の必要性**: USBメモリを介してデータを搬入する必要がある

### 解決したい課題

1. マスターデータ（従業員、アイテムなど）の一括登録
2. 将来の拡張機能のデータインポート
3. 持出記録などのファクトデータのエクスポート
4. オフライン環境でのデータ交換

## 要件定義

### 1. インポート機能

#### 1.1 基本要件

- **対象デバイス**: Raspberry Pi 5（サーバー）
- **データソース**: USBメモリ
- **データ形式**: CSVファイル（UTF-8エンコーディング）
- **操作**: USBメモリをラズパイ5に接続し、自動または手動でインポート実行

#### 1.2 対象データ

**現時点**:
- 従業員マスタ（`employees.csv`）
- アイテムマスタ（`items.csv`）

**将来の拡張**:
- ドキュメント管理モジュールのデータ
- 物流管理モジュールのデータ
- その他の拡張機能のマスターデータ

#### 1.3 汎用性の考慮

- **汎用的なインポート基盤**: 複数の機能で使い回せる仕組み
- **モジュール拡張性**: 新規モジュール追加時にも同じ仕組みを使用可能
- **データ形式の統一**: CSV形式を標準とするが、将来的にJSON等にも対応可能

#### 1.4 実装方式

**推奨方式**: ラズパイ5での運用

理由：
- サーバー側でデータを管理するため、ラズパイ5で処理するのが自然
- クライアント（ラズパイ4）はキオスク端末としての役割に集中
- データの整合性を保ちやすい

**実装方法（案）**:

1. **自動検出方式**（推奨）
   - USBメモリが接続されたら自動検出
   - 指定されたディレクトリ（例: `/mnt/usb/import/`）にCSVファイルがあるか確認
   - 自動的にインポートジョブを実行
   - バックグラウンドで処理

2. **手動実行方式**（補助）
   - 管理画面から手動でインポートを実行
   - USBメモリのマウントポイントを指定
   - ファイルを選択してインポート

### 2. エクスポート機能

#### 2.1 基本要件

- **対象デバイス**: Raspberry Pi 5（サーバー）
- **出力先**: USBメモリ
- **データ形式**: CSVファイル（UTF-8エンコーディング）
- **操作**: 管理画面からエクスポート対象を選択し、USBメモリに出力

#### 2.2 対象データ

**マスターデータ**:
- 従業員マスタ
- アイテムマスタ
- その他のマスターデータ

**ファクトデータ**:
- 持出記録（Transaction）
- 貸出履歴（Loan）
- その他のトランザクションデータ

#### 2.3 UI要件

**エクスポート選択UI**:
- チェックボックスでエクスポート対象を選択
- データ種別ごとに選択可能
  - マスターデータ: 従業員、アイテム、その他
  - ファクトデータ: 持出記録、貸出履歴、その他
- 日付範囲の指定（ファクトデータの場合）
- エクスポート実行ボタン

#### 2.4 実装方式

**推奨方式**: ラズパイ5での運用

理由：
- サーバー側でデータを管理するため、ラズパイ5で処理するのが自然
- データの整合性を保ちやすい
- エクスポート処理の負荷をサーバー側で処理

**実装方法**:
1. 管理画面でエクスポート対象を選択
2. USBメモリのマウントポイントを指定（または自動検出）
3. 選択したデータをCSV形式でエクスポート
4. USBメモリに保存

### 3. 技術要件

#### 3.1 USBメモリの検出・マウント

- **自動マウント**: udevルールを使用してUSBメモリを自動マウント
- **マウントポイント**: `/mnt/usb/` または `/media/usb/`
- **権限管理**: 適切な権限でマウント（読み書き可能）

#### 3.2 ファイル形式

**CSV形式**:
- エンコーディング: UTF-8
- ヘッダー行: 必須
- 区切り文字: カンマ（`,`）
- 改行コード: LF（`\n`）

**将来の拡張**:
- JSON形式への対応
- Excel形式への対応

#### 3.3 エラーハンドリング

- USBメモリが接続されていない場合のエラー処理
- CSVファイルの形式エラー処理
- データ整合性エラー処理
- ジョブ履歴の記録

#### 3.4 セキュリティ

- 管理者権限が必要（認証必須）
- ファイル形式の検証
- データサイズの制限
- マルウェア対策（必要に応じて）

## 実装計画

### Phase 1: 現在の実装の改善（短期）

1. **429エラーの修正** ✅ 完了
2. **レート制限の無効化** ✅ 完了
3. **現在のブラウザ経由アップロード機能の動作確認**

### Phase 2: USBメモリ自動検出機能（中期）

1. **USBメモリの自動マウント設定**
   - udevルールの設定
   - マウントポイントの設定

2. **自動インポート機能の実装**
   - USBメモリ検出時の自動インポート
   - バックグラウンドジョブの実行

3. **管理画面での手動実行機能**
   - USBメモリのマウント状態確認
   - 手動インポート実行

### Phase 3: エクスポート機能（中期）

1. **エクスポート選択UIの実装**
   - データ種別の選択
   - 日付範囲の指定

2. **エクスポート機能の実装**
   - CSV形式でのエクスポート
   - USBメモリへの保存

### Phase 4: 汎用化・拡張性の向上（長期）

1. **汎用的なインポート・エクスポート基盤の構築**
   - モジュールごとの設定ファイル
   - プラグイン方式の導入

2. **データ形式の拡張**
   - JSON形式への対応
   - Excel形式への対応

## 現在の実装との違い

### 現在の実装

- **ブラウザ経由のCSVファイルアップロード**
- PCからブラウザでファイルを選択してアップロード
- 手動操作が必要

### 要件に基づく実装

- **USBメモリ経由の自動インポート**
- ラズパイ5にUSBメモリを接続して自動インポート
- 手動操作は最小限（または不要）

## 注意事項

- USBメモリの自動マウントは、システムの設定が必要
- セキュリティ面での考慮が必要（マルウェア対策など）
- データの整合性を保つためのトランザクション処理が必要
- エクスポート時のデータサイズ制限を考慮

## 参考資料

- `docs/guides/usb-import-specification.md`: 現在の実装仕様
- `docs/progress/validation-7-usb-import-test.md`: 検証手順

