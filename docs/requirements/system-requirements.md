# システム要件定義

## 概要

Raspberry Pi NFC 工場持出返却システムの要件定義書。システムの目的、機能要件、非機能要件、検証項目を定義する。

## システム目的

工場でタグ付き工具や備品の持出状況を紙に頼らず正確に把握する。Raspberry Pi 5 上で API・DB・Web UI を提供し、複数の Raspberry Pi 4 クライアントがブラウザキオスクとして接続する。

## 機能要件

### FR-001: 認証機能
- **説明**: 管理者がログインして管理画面にアクセスできる
- **詳細**:
  - JWT トークンベースの認証
  - ロールベースのアクセス制御（ADMIN, MANAGER, VIEWER）
  - セッション管理
- **検証**: Validation 2（管理画面アクセス）

### FR-002: 従業員管理機能
- **説明**: 従業員情報の登録・編集・削除・一覧表示ができる
- **詳細**:
  - 従業員コード（4桁数字）と氏名が必須
  - NFCタグUIDの登録（オプション）
  - 部署・連絡先・ステータスの管理
- **検証**: Validation 2（従業員管理）

### FR-003: アイテム管理機能
- **説明**: 工具・備品情報の登録・編集・削除・一覧表示ができる
- **詳細**:
  - 管理番号（TO + 4桁数字）と工具名が必須
  - NFCタグUIDの登録（オプション）
  - カテゴリ・保管場所・ステータス・備考の管理
- **検証**: Validation 2（アイテム管理）

### FR-004: 持出機能
- **説明**: NFCタグをスキャンして工具の持出を記録できる
- **詳細**:
  - アイテムタグ→社員証の順にスキャン
  - 順序問わずスキャンにも対応
  - 持出記録の自動登録
- **検証**: Validation 3（持出フロー）

### FR-005: 返却機能
- **説明**: 画面のボタン操作で工具の返却を記録できる
- **詳細**:
  - 返却画面で貸出中のアイテム一覧を表示
  - ボタンクリックで返却記録
  - 返却済みアイテムの自動更新
- **検証**: Validation 4（返却フロー）

### FR-006: 履歴表示機能
- **説明**: 持出・返却の履歴を一覧表示できる
- **詳細**:
  - 日時フィルタによる絞り込み
  - CSVエクスポート機能
  - スナップショット情報の表示（マスタ編集後も過去履歴の値が変わらない）
- **検証**: Validation 5（履歴画面）

### FR-007: CSV一括登録機能
- **説明**: USBメモリからCSVファイルをアップロードして従業員・アイテムを一括登録できる
- **詳細**:
  - `employees.csv`と`items.csv`のアップロード
  - バリデーション（employeeCode: 4桁数字、itemCode: TO + 4桁数字）
  - エラーハンドリングとロールバック
- **検証**: Validation 7（USB一括登録）**← 未実施**

### FR-008: オフライン耐性機能
- **説明**: ネットワークが切断されてもNFCイベントをキューに保存し、復帰後に自動送信できる
- **詳細**:
  - NFCエージェントがSQLiteキューにイベントを保存
  - オンライン復帰時に自動再送
  - WebSocket接続確立時に即座にキュー再送
- **検証**: Validation 6（オフライン耐性）**← 完了**

## 非機能要件

### NFR-001: パフォーマンス
- **説明**: レスポンス時間が許容範囲内であること
- **詳細**:
  - APIレスポンス時間: 1秒以内（通常時）
  - ページ読み込み時間: 3秒以内
- **実装状況**: ✅ 実装済み（実機検証未実施）
- **関連ドキュメント**:
  - [監視・アラートガイド](../guides/monitoring.md): メトリクスエンドポイントの詳細
  - [検証チェックリスト](../guides/verification-checklist.md): パフォーマンス検証手順

### NFR-002: 可用性
- **説明**: システムが継続的に動作すること
- **詳細**:
  - Dockerコンテナの自動再起動（`restart: always`）✅ 実装・検証済み
  - オフライン時のイベントキューイング ✅ 実装・検証済み（Validation 6）
- **実装状況**: ✅ 実装・検証済み
- **関連ドキュメント**:
  - [デプロイメントガイド](../guides/deployment.md): Dockerコンテナの設定
  - [検証チェックリスト](../guides/verification-checklist.md): オフライン耐性の検証手順（Validation 6）

### NFR-003: セキュリティ
- **説明**: 適切なセキュリティ対策が施されていること
- **詳細**:
  - JWTトークンベースの認証 ✅ 実装・検証済み
  - ロールベースのアクセス制御 ✅ 実装・検証済み
  - APIキーによるクライアント認証 ✅ 実装・検証済み
- **実装状況**: ✅ 実装・検証済み
- **関連ドキュメント**:
  - [認証APIドキュメント](../api/auth.md): JWT認証の詳細仕様
  - [検証チェックリスト](../guides/verification-checklist.md): 認証機能の検証手順（Validation 2）

### NFR-004: 保守性
- **説明**: コードとドキュメントが適切に管理されていること
- **詳細**:
  - モジュール化された構造 ✅ 実装済み（Milestone 6）
  - 統合テストとE2Eテストの実装 ✅ 実装・検証済み（Phase 4）
  - CI/CDパイプラインの整備 ✅ 実装・検証済み（Phase 4）
  - バックアップ・リストア機能 ✅ 実装済み（実機検証未実施）
  - 監視・アラート機能 ✅ 実装済み（実機検証未実施）
- **実装状況**: ✅ 実装済み（一部実機検証未実施）
- **関連ドキュメント**:
  - [バックアップ・リストア手順](../guides/backup-and-restore.md): バックアップ・リストアの詳細手順
  - [監視・アラートガイド](../guides/monitoring.md): 監視・アラート機能の詳細
  - [CI/CDトラブルシューティング](../guides/ci-troubleshooting.md): CI/CDパイプラインのトラブルシューティング
  - [検証チェックリスト](../guides/verification-checklist.md): バックアップ・リストア、監視・アラートの検証手順
  - [EXEC_PLAN.md](../../EXEC_PLAN.md): Milestone 6、Phase 4の詳細

### NFR-005: 拡張性
- **説明**: 将来の機能追加に対応できること
- **詳細**:
  - モジュール化されたアーキテクチャ ✅ 実装済み（Milestone 6）
  - 共通パッケージ（shared-types）の活用 ✅ 実装済み（Milestone 6）
  - プラグイン可能な設計 ✅ 実装済み（Milestone 6）
- **実装状況**: ✅ 実装済み
- **関連ドキュメント**:
  - [アーキテクチャ概要](../architecture/overview.md): システム全体のアーキテクチャ
  - [モジュールドキュメント](../modules/): 各モジュールの詳細仕様
  - [アーキテクチャ決定記録](../decisions/): 設計決定の記録
  - [EXEC_PLAN.md](../../EXEC_PLAN.md): Milestone 6の詳細

## 検証項目

### Validation 1: サーバーヘルスチェック
- **状態**: ✅ 完了
- **内容**: Dockerコンテナの起動とヘルスチェックエンドポイントの動作確認
- **関連ドキュメント**: [検証チェックリスト](../guides/verification-checklist.md)

### Validation 2: 管理画面アクセス
- **状態**: ✅ 完了
- **内容**: ログイン画面へのアクセス、認証、ダッシュボード表示
- **関連ドキュメント**: [検証チェックリスト](../guides/verification-checklist.md), [認証APIドキュメント](../api/auth.md)

### Validation 3: 持出フロー
- **状態**: ✅ 完了
- **内容**: NFCタグスキャンによる持出記録の作成
- **関連ドキュメント**: [検証チェックリスト](../guides/verification-checklist.md), [EXEC_PLAN.md](../../EXEC_PLAN.md) (Validation 3)

### Validation 4: 返却フロー
- **状態**: ✅ 完了
- **内容**: 返却画面からの返却記録の作成
- **関連ドキュメント**: [検証チェックリスト](../guides/verification-checklist.md), [EXEC_PLAN.md](../../EXEC_PLAN.md) (Validation 4)

### Validation 5: 履歴画面
- **状態**: ✅ 完了
- **内容**: 履歴一覧表示、フィルタ、CSVエクスポート
- **関連ドキュメント**: [検証チェックリスト](../guides/verification-checklist.md), [EXEC_PLAN.md](../../EXEC_PLAN.md) (Validation 5)

### Validation 6: オフライン耐性
- **状態**: ✅ 完了
- **内容**: オフライン時のイベントキューイングとオンライン復帰時の自動再送
- **関連ドキュメント**: [検証チェックリスト](../guides/verification-checklist.md) (オフライン耐性機能の検証), [EXEC_PLAN.md](../../EXEC_PLAN.md) (Validation 6)

### Validation 7: USB一括登録
- **状態**: ✅ **完了**（2025-11-25）
- **内容**: CSVファイルのアップロードと一括登録の動作確認
- **検証結果**: Phase 3の検証で実機環境でのCSVインポートを実施。従業員2件、工具3件のインポートに成功。バリデーションも正しく動作することを確認。
- **関連ドキュメント**: [Validation 7検証ガイド](../guides/validation-7-usb-import.md), [CSVインポート・エクスポート仕様](../guides/csv-import-export.md), [検証チェックリスト](../guides/verification-checklist.md)

### Validation 8: NFCエージェント単体
- **状態**: ✅ 一部完了
- **内容**: NFCエージェントの起動、ステータス確認、WebSocket配信
- **関連ドキュメント**: [検証チェックリスト](../guides/verification-checklist.md), [EXEC_PLAN.md](../../EXEC_PLAN.md) (Validation 8)

## 次のタスク（非機能要件の実機検証）

### 優先度: 高

#### 1. 非機能要件の実機検証（NFR-001, NFR-004の一部）

**目的**: 要件定義で定義されている非機能要件が実機環境で満たされていることを確認する

**未検証の非機能要件**（上記の該当箇所を参照）:
- **NFR-001: パフォーマンス** (79-87行目) - APIレスポンス時間、ページ読み込み時間の実機測定
- **NFR-004: 保守性** (110-122行目) - バックアップ・リストア機能の実機検証、監視・アラート機能の実機検証

**タスク**:
1. **NFR-001（パフォーマンス）の実機検証**
   - APIレスポンス時間の測定（1秒以内の要件を満たしているか）
   - ページ読み込み時間の測定（3秒以内の要件を満たしているか）
   - **関連ドキュメント**: [監視・アラートガイド](../guides/monitoring.md), [検証チェックリスト](../guides/verification-checklist.md)

2. **NFR-004（保守性）の実機検証**
   - バックアップ・リストアスクリプトの動作確認（実装済みだが実機検証未実施）
     - **スクリプト**: [`scripts/server/backup.sh`](../../scripts/server/backup.sh), [`scripts/server/restore.sh`](../../scripts/server/restore.sh)
     - **関連ドキュメント**: [バックアップ・リストア手順](../guides/backup-and-restore.md), [検証チェックリスト](../guides/verification-checklist.md) (バックアップ・リストア機能の検証)
   - 監視・アラート機能の動作確認（実装済みだが実機検証未実施）
     - **スクリプト**: [`scripts/server/monitor.sh`](../../scripts/server/monitor.sh)
     - **関連ドキュメント**: [監視・アラートガイド](../guides/monitoring.md), [検証チェックリスト](../guides/verification-checklist.md) (監視・アラート機能の検証)

3. **運用マニュアルの作成**
   - 日常的な運用手順の整理
   - トラブル時の対応手順の整理
   - 定期メンテナンス手順の整理
   - **関連ドキュメント**: [デプロイメントガイド](../guides/deployment.md), [トラブルシューティングナレッジベース](../knowledge-base/troubleshooting-knowledge.md)

**注意**: これらのタスクは「要件定義にないタスク」ではなく、「要件定義で定義されている非機能要件の実機検証」です。

### 優先度: 中

#### 2. システムの安定性向上（要件定義外の改善）

**目的**: システムの安定性と信頼性を向上させる（要件定義に明示されていない改善）

**タスク**:
1. **エラーハンドリングの改善**
   - エラーメッセージの詳細化
   - エラーログの構造化
   - エラー通知機能の実装

2. **ログ出力の最適化**
   - ログレベルの適切な設定
   - ログローテーションの設定
   - ログ分析ツールの導入検討

### 優先度: 低

#### 3. パフォーマンス最適化（要件定義外の改善）

**目的**: システムのパフォーマンスを向上させる（要件定義に明示されていない改善）

**タスク**:
1. **APIレスポンス時間の最適化**
   - データベースクエリの最適化
   - キャッシュの導入検討
   - APIエンドポイントの最適化

2. **フロントエンドのパフォーマンス改善**
   - バンドルサイズの最適化
   - レンダリングパフォーマンスの改善
   - 画像・アセットの最適化

## 関連ドキュメント

- [EXEC_PLAN.md](../../EXEC_PLAN.md): 全体の進捗管理
- [CSVインポート・エクスポート仕様](./csv-import-export.md): CSV形式の詳細仕様
- [検証チェックリスト](../guides/verification-checklist.md): 検証手順の詳細
- [トラブルシューティングナレッジベース](../knowledge-base/troubleshooting-knowledge.md): 問題解決のナレッジベース

