# システム要件定義

## 概要

Raspberry Pi NFC 工場持出返却システムの要件定義書。システムの目的、機能要件、非機能要件、検証項目を定義する。

## システム目的

工場でタグ付き工具や備品の持出状況を紙に頼らず正確に把握する。Raspberry Pi 5 上で API・DB・Web UI を提供し、複数の Raspberry Pi 4 クライアントがブラウザキオスクとして接続する。

## 機能要件

### FR-001: 認証機能
- **説明**: 管理者がログインして管理画面にアクセスできる
- **詳細**:
  - JWT トークンベースの認証
  - ロールベースのアクセス制御（ADMIN, MANAGER, VIEWER）
  - セッション管理
- **検証**: Validation 2（管理画面アクセス）

### FR-002: 従業員管理機能
- **説明**: 従業員情報の登録・編集・削除・一覧表示ができる
- **詳細**:
  - 従業員コード（4桁数字）と氏名が必須
  - NFCタグUIDの登録（オプション）
  - 部署・連絡先・ステータスの管理
- **検証**: Validation 2（従業員管理）

### FR-003: アイテム管理機能
- **説明**: 工具・備品情報の登録・編集・削除・一覧表示ができる
- **詳細**:
  - 管理番号（TO + 4桁数字）と工具名が必須
  - NFCタグUIDの登録（オプション）
  - カテゴリ・保管場所・ステータス・備考の管理
- **検証**: Validation 2（アイテム管理）

### FR-004: 持出機能
- **説明**: NFCタグをスキャンして工具の持出を記録できる
- **詳細**:
  - アイテムタグ→社員証の順にスキャン
  - 順序問わずスキャンにも対応
  - 持出記録の自動登録
- **検証**: Validation 3（持出フロー）

### FR-005: 返却機能
- **説明**: 画面のボタン操作で工具の返却を記録できる
- **詳細**:
  - 返却画面で貸出中のアイテム一覧を表示
  - ボタンクリックで返却記録
  - 返却済みアイテムの自動更新
- **検証**: Validation 4（返却フロー）

### FR-006: 履歴表示機能
- **説明**: 持出・返却の履歴を一覧表示できる
- **詳細**:
  - 日時フィルタによる絞り込み
  - CSVエクスポート機能
  - スナップショット情報の表示（マスタ編集後も過去履歴の値が変わらない）
- **検証**: Validation 5（履歴画面）

### FR-007: CSV一括登録機能
- **説明**: USBメモリからCSVファイルをアップロードして従業員・アイテムを一括登録できる
- **詳細**:
  - `employees.csv`と`items.csv`のアップロード
  - バリデーション（employeeCode: 4桁数字、itemCode: TO + 4桁数字）
  - エラーハンドリングとロールバック
- **検証**: Validation 7（USB一括登録）**← 未実施**

### FR-008: オフライン耐性機能
- **説明**: ネットワークが切断されてもNFCイベントをキューに保存し、復帰後に自動送信できる
- **詳細**:
  - NFCエージェントがSQLiteキューにイベントを保存
  - オンライン復帰時に自動再送
  - WebSocket接続確立時に即座にキュー再送
- **検証**: Validation 6（オフライン耐性）**← 完了**

## 非機能要件

### NFR-001: パフォーマンス
- **説明**: レスポンス時間が許容範囲内であること
- **詳細**:
  - APIレスポンス時間: 1秒以内（通常時）
  - ページ読み込み時間: 3秒以内

### NFR-002: 可用性
- **説明**: システムが継続的に動作すること
- **詳細**:
  - Dockerコンテナの自動再起動（`restart: always`）
  - オフライン時のイベントキューイング

### NFR-003: セキュリティ
- **説明**: 適切なセキュリティ対策が施されていること
- **詳細**:
  - JWTトークンベースの認証
  - ロールベースのアクセス制御
  - APIキーによるクライアント認証

### NFR-004: 保守性
- **説明**: コードとドキュメントが適切に管理されていること
- **詳細**:
  - モジュール化された構造
  - 統合テストとE2Eテストの実装
  - CI/CDパイプラインの整備

### NFR-005: 拡張性
- **説明**: 将来の機能追加に対応できること
- **詳細**:
  - モジュール化されたアーキテクチャ
  - 共通パッケージ（shared-types）の活用
  - プラグイン可能な設計

## 検証項目

### Validation 1: サーバーヘルスチェック
- **状態**: ✅ 完了
- **内容**: Dockerコンテナの起動とヘルスチェックエンドポイントの動作確認

### Validation 2: 管理画面アクセス
- **状態**: ✅ 完了
- **内容**: ログイン画面へのアクセス、認証、ダッシュボード表示

### Validation 3: 持出フロー
- **状態**: ✅ 完了
- **内容**: NFCタグスキャンによる持出記録の作成

### Validation 4: 返却フロー
- **状態**: ✅ 完了
- **内容**: 返却画面からの返却記録の作成

### Validation 5: 履歴画面
- **状態**: ✅ 完了
- **内容**: 履歴一覧表示、フィルタ、CSVエクスポート

### Validation 6: オフライン耐性
- **状態**: ✅ 完了
- **内容**: オフライン時のイベントキューイングとオンライン復帰時の自動再送

### Validation 7: USB一括登録
- **状態**: ⏳ **未実施**
- **内容**: CSVファイルのアップロードと一括登録の動作確認
- **次のタスク**: 実機検証を実施

### Validation 8: NFCエージェント単体
- **状態**: ✅ 一部完了
- **内容**: NFCエージェントの起動、ステータス確認、WebSocket配信

## 次のタスク

### 優先度: 高
1. **Validation 7: USB一括登録の実機検証**
   - CSVインポート機能は実装済み（Phase 3完了）
   - 実機環境での動作確認が必要
   - 検証手順: `docs/guides/verification-checklist.md`参照

### 優先度: 中
2. **運用ドキュメントの整備**
   - バックアップ・リストア手順の確認
   - 監視・アラート設定の確認
   - トラブルシューティングガイドの更新

### 優先度: 低
3. **パフォーマンス最適化**
   - APIレスポンス時間の測定
   - データベースクエリの最適化
   - フロントエンドのパフォーマンス改善

## 関連ドキュメント

- [EXEC_PLAN.md](../../EXEC_PLAN.md): 全体の進捗管理
- [CSVインポート・エクスポート仕様](./csv-import-export.md): CSV形式の詳細仕様
- [検証チェックリスト](../guides/verification-checklist.md): 検証手順の詳細
- [トラブルシューティングナレッジベース](../knowledge-base/troubleshooting-knowledge.md): 問題解決のナレッジベース

