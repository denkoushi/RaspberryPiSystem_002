# 計測機器管理 UI設計メモ

## 持ち出しフロー（キオスク）

1. **計測機器タグスキャン画面**
   - 入力: RFID/TS100から計測機器タグUID受信
   - 表示: 計測機器名称・管理番号・保管場所・測定範囲・校正期限
   - ボタン: 「再スキャン」「キャンセル」

2. **点検項目表示・入力画面**
   - 点検項目リスト（order順）をカードで表示
   - 各項目: 内容・基準・方法を表示（テキスト/数値範囲）
   - 入力: 原則「合格」とみなし、NGの場合のみ画面右上の「NGにする」ボタンを押下
   - NGボタン: 押下すると即座にNGとして送信（個別項目の記録は不要）

3. **持ち出し登録**
   - すべて合格の場合: 氏名タグスキャン（またはUID入力）で自動送信（500msデバウンス、ボタン不要）
   - NGの場合: 「NGにする」ボタン押下で即送信
   - OKの場合は送信時に Loan + InspectionRecord（全項目PASS）を一括作成
   - NGの場合は Loan のみ作成（点検記録は作成しない）

4. **完了画面**
   - 持ち出し成功メッセージ
   - 「続けてスキャンする」ボタンでタグスキャン画面へ戻る

## 管理コンソール

- 計測機器一覧（登録/編集/削除）: `/admin/tools/measuring-instruments`
- 計測機器登録/編集フォームに **NFC/RFIDタグUID** を追加（保存時にタグ紐付けを自動作成。既存UIDは409で拒否）
- 点検項目管理（登録/編集/削除）: `/admin/tools/inspection-items`
- RFIDタグ紐付け管理（登録/削除）: `/admin/tools/instrument-tags`
- 点検記録の閲覧/手動登録: `/admin/tools/inspection-records`
- 工具と計測機器の混在一覧・フィルタ（別途実装検討）

## サイネージ表示（ラズパイ3）

- **✅ 計測機器持出アイテムの識別表示（2025-12-11実装）**:
  - 工具データ（左ペイン）で計測機器の持出アイテムを表示
  - **藍系背景**: 計測機器は `rgba(49,46,129,0.6)` + `rgba(99,102,241,0.5)` のストロークで識別
  - **2行表示**: 管理番号を上段（小さめ・藍色）、名称を下段（標準・白）に表示
  - **工具との識別**: 工具は従来のダーク背景を維持し、視覚的に区別可能
  - バックエンド変更: `signage.service.ts` の `getToolsData()` で `isInstrument` / `managementNumber` フィールドを追加
  - レンダラー変更: `signage.renderer.ts` の `buildToolCardGrid()` で計測機器判定・色分け・表示ロジックを実装
- PowerBIデザインを後続で反映
- 表示候補: 計測機器のステータス、校正期限アラート、最近の点検結果

## キオスク専用画面（ラズパイ4）

- **計測機器タグ自動遷移機能**: ✅ **実装完了**（2025-12-12）
  - 持出タブ（`/kiosk/tag`）またはPHOTOモード（`/kiosk/photo`）で計測機器タグをスキャン
  - `getUnifiedItems`で事前取得したマップ、または`getMeasuringInstrumentByTagUid`でAPI判定
  - **計測機器として明示的に登録されているタグのみ** `/kiosk/instruments/borrow?tagUid=...` へ遷移
  - 未登録タグ（404）は従来の工具/従業員フローを継続（従業員タグの誤判定を防止）
  - 計測機器持出完了後の戻り先は管理コンソールの`defaultMode`設定に従う（PHOTO/TAG）
  - **ナレッジベース**: [KB-095](../../knowledge-base/frontend.md#kb-095-計測機器タグスキャン時の自動遷移機能)
- **持ち出し画面**: `/kiosk/instruments/borrow`
  - 計測機器タグUID・氏名タグUIDの手入力フォーム（実装済み）
  - NFCエージェント連携実装済み（計測機器タグ→氏名タグの順で自動送信）
  - 計測機器選択→点検項目自動表示を実装
  - 計測機器の識別方法は「ドロップダウン選択」「タグUID入力（手入力/NFC/TS100想定）」のいずれか最初に操作した方法を採用し、以後は切り替えない（入力ソース固定）
  - OKの場合: 氏名タグUID入力またはNFCスキャンで自動送信（500msデバウンス、ボタン不要）、全項目PASSとしてInspectionRecordを作成  
    - ドロップダウン選択のみ（タグ未登録）でも自動送信するよう判定を緩和済み
  - NGの場合: 「NGにする」ボタン押下で即送信、点検記録は作成しない（個別項目の記録は不要）
  - 計測機器選択後、氏名タグ入力欄に自動フォーカス
- **PHOTOモードとの干渉防止**: ✅ **実装完了**（2025-12-11）。NFC/カメラ入力は画面スコープで分離済み:
  - `useNfcStream`フックに`enabled`フラグと`enabledAt`タイムスタンプを追加
  - 各ページで`useMatch`を使用し、アクティブページのみNFC購読を有効化
  - 遷移前のイベントは`timestamp < enabledAt`でフィルタリング
  - 詳細: [plans/nfc-stream-isolation-plan.md](../../plans/nfc-stream-isolation-plan.md)、[KB-066](../../knowledge-base/frontend.md#kb-066-nfcカメラ入力のスコープ分離-別ページからのイベント横漏れ防止)
- **返却機能**: ✅ **統合完了**（2025-12-11）。専用タブを削除し、持出画面の持出一覧から返却可能に:
  - `/kiosk`（持出画面）の持出一覧で工具・計測機器の両方を表示・返却可能
  - 計測機器は「管理番号＋名称」を2行表示し、背景色を藍系に変更して工具と識別
  - 工具は従来背景を維持。写真持出は「写真撮影モード」を表示し、「アイテム情報なし」は非表示
  - 各アイテムに「返却」ボタンを配置し、クリックで返却可能
  - 以前の `/kiosk/return` と `/kiosk/instruments/return` は機能重複のため削除

## アクセシビリティ/エラーハンドリング

- ✅ **エラー時の無限ループ防止**: エラー発生時に氏名タグをクリアし、自動再送を防止（2025-12-11実装）
- ✅ **エラーメッセージの改善**: APIエラーメッセージを短縮・ユーザーフレンドリーに変換
  - 「タグ未登録（計測機器）」「タグ未登録（社員）」「既に貸出中です」など、簡潔なメッセージを表示
  - 長いメッセージは「送信に失敗しました。再スキャンしてください。」に統一
  - エラー時は氏名タグをクリアして再スキャンを促す
- スキャン失敗時のリトライ表示
- 点検項目が未取得の場合のリカバリボタン
- オフライン時はローカルキューへの保存（将来検討）