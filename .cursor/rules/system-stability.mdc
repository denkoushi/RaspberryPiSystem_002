---
description: 既存システムの安定性を最優先に保つためのルール。稼働中の機能を壊さないための必須手順。
alwaysApply: true
---

# 既存システム保護ルール

## 基本原則

**既存の稼働システムを壊さないことを最優先とする。新機能開発よりも既存機能の維持を優先する。**

このルールは、すべての作業において最優先で適用される原則です。システムの安定性を損なう可能性がある場合は、作業を中断して影響範囲を確認してください。

## 必須手順

以下の手順は、基本原則を実現するための具体的なアクションです。すべての作業で必ず実行してください。

### 1. 作業前の影響範囲確認

変更を実施する前に、以下を必ず確認する：

- **依存関係の確認**: `docker compose config` でコンテナ間の依存関係を確認
- **ボリューム・ストレージの確認**: `docker volume inspect <volume-name>` で内容を確認
- **設定ファイルの確認**: 変更対象の設定ファイルが他のコンポーネントに影響しないか確認
- **関連ドキュメントの確認**: `docs/INDEX.md` から関連ドキュメントを参照

### 2. バックアップの徹底

以下の操作前に必ずバックアップを取る：

- Dockerボリュームの削除・再作成
- 証明書ファイルの削除・変更
- 設定ファイルの変更
- データベーススキーマの変更

**バックアップコマンド例**:
```bash
# 証明書のバックアップ
cp -r /opt/RaspberryPiSystem_002/certs /opt/RaspberryPiSystem_002/certs.backup.$(date +%Y%m%d)

# Dockerボリュームの内容確認
docker volume inspect <volume-name>
```

### 3. 段階的アプローチ

一度に全てを変更せず、最小限の変更から開始する：

1. **問題の特定**: 根本原因を正確に特定する
2. **最小限の修正**: 問題のある部分のみを修正する
3. **動作確認**: 各ステップで既存機能が動作することを確認する
4. **次のステップへ**: 確認後に次のステップに進む

**禁止事項**:
- ❌ 一度に複数のボリュームを削除する
- ❌ 問題のないコンポーネントまで変更する
- ❌ 動作確認なしに次のステップに進む

### 4. ドキュメント参照の徹底

作業前に必ず以下を参照する：

- **`docs/INDEX.md`**: 関連ドキュメントの索引
- **`docs/knowledge-base/`**: 過去のトラブルシューティング記録（KB-xxx）
- **`docs/guides/`**: 運用ガイド、デプロイガイド
- **既存のコード**: 動いているコードは「動いている理由」を理解してから変更

**参照すべきドキュメント例**:
- Docker関連: `docs/knowledge-base/infrastructure/docker-caddy.md`
- バックアップ関連: `docs/knowledge-base/infrastructure/backup-restore.md`
- Ansible/デプロイ関連: `docs/knowledge-base/infrastructure/ansible-deployment.md`
- セキュリティ関連: `docs/knowledge-base/infrastructure/security.md`
- デプロイ関連: `docs/guides/deployment.md`
- API関連: `docs/knowledge-base/api.md`

**詳細な手順**: ドキュメント参照と既存コード・設定の尊重の詳細な手順については、`.cursor/rules/documentation-first.mdc`を参照してください。

### 5. 既存コード・設定の尊重

- **動いているコードは変更しない**: 動いている理由を理解してから変更する
- **独自の新ロジックを追加する前に既存実装を確認**: 既存のパターンに従う
- **設定ファイルの変更は影響範囲を確認**: 他のコンポーネントへの影響を確認する

### 6. マージ・デプロイに関する厳格な禁止事項

**マージやデプロイに関する提案・実行は一切禁止とする。実装中にマージを提案することは言語道断であり、意図的な破壊工作と見なされる。**

#### 6.1 マージ提案・実行の禁止

以下の行為は厳格に禁止される：

- ❌ **マージに関する提案を一切しない**: 実装完了後も、マージに関する話題に触れない
- ❌ **マージ操作の実行**: ユーザーが明示的に依頼するまで、マージ関連の操作は一切行わない
- ❌ **デプロイ提案**: デプロイに関する提案も同様に禁止
- ❌ **実装中にマージを提案**: 実装が完了していても、マージに関する提案はしない

**理由**: 実装中や実装完了直後にマージを提案することは、システムの安定性を損なう可能性があり、意図的な破壊工作と見なされる。マージはユーザーが適切なタイミングで判断するものであり、AIアシスタントが提案すべきではない。

#### 6.2 デプロイ実行時の必須手順

**デプロイは標準手順を完全に遵守して実行する。手順の一部を省略・変更してはならない。**

**デプロイ実行前の必須確認：**
1. **リモートリポジトリとの比較**: Pi5上のコードとリモートリポジトリ（`origin/main`）を比較し、差分を確認する
2. **標準手順の確認**: `docs/guides/deployment.md`の標準デプロイ手順を必ず確認する
3. **設定ファイルのバックアップ**: `backup.json`などの設定ファイルをバックアップする（[KB-163](../docs/knowledge-base/infrastructure/backup-restore.md#kb-163-git-cleanによるbackupjson削除問題再発)参照）
   ```bash
   # Pi5上でbackup.jsonをバックアップ
   ssh denkon5sd02@raspberrypi.local "cp /opt/RaspberryPiSystem_002/config/backup.json /opt/RaspberryPiSystem_002/config/backup.json.backup.$(date +%Y%m%d-%H%M%S)"
   ```
4. **実行手順の完全遵守**: 標準手順に記載されている全ステップを順番通りに実行する

**デプロイ実行時の必須手順（Pi5の場合）：**
1. **現在のブランチを確認し、`git pull origin <current-branch>`を必ず最初に実行**: コードが最新に見えても、リモートリポジトリとの比較のために必ず実行する（`main`ブランチにマージするのは別途指示がある場合のみ）
2. **`docker compose`コマンドは標準手順通りに実行**: `--force-recreate --build`を1コマンドで実行する（分割実行禁止）

**禁止事項：**
- ❌ **標準手順の一部を省略**: `git pull`を省略して`docker compose`だけを実行する
- ❌ **独自判断での手順変更**: 標準手順を確認せずに独自の手順で実行する
- ❌ **比較対象の誤り**: ローカルとPi5を比較して「最新」と判断する（正しくはPi5とリモートリポジトリを比較）

**標準手順の参照先：**
- Pi5のデプロイ: `docs/guides/deployment.md`の「ラズパイ5（サーバー）の更新」セクション
- デプロイスクリプト使用時: `docs/guides/deployment.md`の「方法1: デプロイスクリプトを使用（推奨）」
- 手動デプロイ時: `docs/guides/deployment.md`の「方法2: 手動で更新」
- **設定ファイル保護**: `docs/knowledge-base/infrastructure/backup-restore.md`のKB-163、KB-164、KB-165を参照

### 7. エラー発生時の対応

エラーが発生した場合：

1. **即座に作業を停止する**
2. **エラーログを確認する**: `docker logs <container-name>`
3. **影響範囲を確認する**: どのコンポーネントが影響を受けているか確認
4. **復旧手順を実行する**: バックアップから復旧、または段階的にロールバック
5. **ドキュメントに記録する**: 問題と解決策をナレッジベースに記録

## 具体例

### ❌ 悪い例（今回の失敗）

```bash
# 一度に全てのボリュームを削除（証明書も削除される）
docker volume rm docker_thumbnail-storage docker_pdf-storage ...
```

### ✅ 良い例

```bash
# 1. 影響範囲を確認
docker volume inspect docker_thumbnail-storage
docker compose config

# 2. バックアップを取る
cp -r /opt/RaspberryPiSystem_002/certs /opt/RaspberryPiSystem_002/certs.backup

# 3. 問題のあるボリュームのみを対象にする
# 4. 各ステップで動作確認
# 5. 問題が発生したら即座に停止して復旧
```

## チェックリスト

作業前に以下を確認：

- [ ] 影響範囲を確認したか？
- [ ] バックアップを取ったか？
- [ ] 関連ドキュメントを参照したか？
- [ ] 段階的に進める計画を立てたか？
- [ ] 既存の動作を維持できるか？
- [ ] マージやデプロイに関する提案をしていないか？（禁止事項）

## 関連ドキュメント

- `docs/INDEX.md`: ドキュメント索引
- `docs/knowledge-base/infrastructure.md`: インフラ関連のナレッジベース索引（サブカテゴリ別に分割）
- `docs/knowledge-base/infrastructure/`: インフラ関連のサブカテゴリ別ナレッジベース
- `docs/guides/deployment.md`: デプロイガイド
- `.cursor/rules/documentation-first.mdc`: ドキュメント優先ルール（ドキュメント参照の詳細手順）
- `.cursor/rules/debug-mode.mdc`: デバッグモードと開発方針ルール（開発時のデバッグ手法）
