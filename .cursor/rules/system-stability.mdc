---
description: 既存システムの安定性を最優先に保つためのルール。稼働中の機能を壊さないための必須手順。
alwaysApply: true
---

# 既存システム保護ルール

## 基本原則

**既存の稼働システムを壊さないことを最優先とする。新機能開発よりも既存機能の維持を優先する。**

このルールは、すべての作業において最優先で適用される原則です。システムの安定性を損なう可能性がある場合は、作業を中断して影響範囲を確認してください。

## 必須手順

以下の手順は、基本原則を実現するための具体的なアクションです。すべての作業で必ず実行してください。

### 1. 作業前の影響範囲確認

変更を実施する前に、以下を必ず確認する：

- **依存関係の確認**: `docker compose config` でコンテナ間の依存関係を確認
- **ボリューム・ストレージの確認**: `docker volume inspect <volume-name>` で内容を確認
- **設定ファイルの確認**: 変更対象の設定ファイルが他のコンポーネントに影響しないか確認
- **関連ドキュメントの確認**: `docs/INDEX.md` から関連ドキュメントを参照

**デプロイ作業の場合、追加で以下を確認**:
- **ネットワークモード設定**: Pi5上の`group_vars/all.yml`の`network_mode`が環境に合っているか（[KB-094](../docs/knowledge-base/infrastructure.md#kb-094-ansibleデプロイ時のgroup_varsallymlのnetwork_mode設定がリポジトリ更新で失われる問題)参照）
- **Ansible接続確認**: `ansible all -i inventory.yml -m ping`が成功するか（[KB-098](../docs/knowledge-base/infrastructure.md#kb-098-ansible_ssh_common_argsのrequestttyforceによるansible-pingタイムアウト)参照）
- **Pi3デプロイの場合**: Pi3を再起動してからサービス停止を実行（[KB-096](../docs/knowledge-base/infrastructure.md#kb-096-pi3デプロイに時間がかかる問題リポジトリの遅れメモリ制約)、[KB-097](../docs/knowledge-base/infrastructure.md#kb-097-pi3デプロイ時のsignage-liteサービス自動再起動の完全防止systemctl-maskの必要性)参照）
- **Pi5のGit状態**: ローカル変更がないか確認（`git status`）

### 2. バックアップの徹底

以下の操作前に必ずバックアップを取る：

- Dockerボリュームの削除・再作成
- 証明書ファイルの削除・変更
- 設定ファイルの変更
- データベーススキーマの変更

**バックアップコマンド例**:
```bash
# 証明書のバックアップ
cp -r /opt/RaspberryPiSystem_002/certs /opt/RaspberryPiSystem_002/certs.backup.$(date +%Y%m%d)

# Dockerボリュームの内容確認
docker volume inspect <volume-name>
```

### 3. 段階的アプローチ

一度に全てを変更せず、最小限の変更から開始する：

1. **問題の特定**: 根本原因を正確に特定する
2. **最小限の修正**: 問題のある部分のみを修正する
3. **動作確認**: 各ステップで既存機能が動作することを確認する
4. **次のステップへ**: 確認後に次のステップに進む

**禁止事項**:
- ❌ 一度に複数のボリュームを削除する
- ❌ 問題のないコンポーネントまで変更する
- ❌ 動作確認なしに次のステップに進む

### 4. ドキュメント参照の徹底

作業前に必ず以下を参照する：

- **`docs/INDEX.md`**: 関連ドキュメントの索引
- **`docs/knowledge-base/`**: 過去のトラブルシューティング記録（KB-xxx）
- **`docs/guides/`**: 運用ガイド、デプロイガイド
- **既存のコード**: 動いているコードは「動いている理由」を理解してから変更

**参照すべきドキュメント例**:
- Docker関連: `docs/knowledge-base/infrastructure.md`
- デプロイ関連: `docs/guides/deployment.md`、`docs/guides/deployment-troubleshooting.md`
- API関連: `docs/knowledge-base/api.md`
- Ansible関連: `docs/guides/ansible-best-practices.md`、`docs/guides/ansible-ssh-architecture.md`、`docs/knowledge-base/infrastructure.md`（KB-098など）

**最新のナレッジベース（2025-12-27時点）**:
- **KB-098**: `ansible_ssh_common_args`の`RequestTTY=force`によるansible pingタイムアウト（[KB-098](../docs/knowledge-base/infrastructure.md#kb-098-ansible_ssh_common_argsのrequestttyforceによるansible-pingタイムアウト)参照）
- **KB-097**: Pi3デプロイ時の`systemctl mask --runtime`の必要性（[KB-097](../docs/knowledge-base/infrastructure.md#kb-097-pi3デプロイ時のsignage-liteサービス自動再起動の完全防止systemctl-maskの必要性)参照）
- **KB-096**: Pi3デプロイ前の再起動の必要性（[KB-096](../docs/knowledge-base/infrastructure.md#kb-096-pi3デプロイに時間がかかる問題リポジトリの遅れメモリ制約)参照）

**詳細な手順**: ドキュメント参照と既存コード・設定の尊重の詳細な手順については、`.cursor/rules/documentation-first.mdc`を参照してください。

### 5. 既存コード・設定の尊重

- **動いているコードは変更しない**: 動いている理由を理解してから変更する
- **独自の新ロジックを追加する前に既存実装を確認**: 既存のパターンに従う
- **設定ファイルの変更は影響範囲を確認**: 他のコンポーネントへの影響を確認する

### 6. エラー発生時の対応

エラーが発生した場合：

1. **即座に作業を停止する**
2. **エラーログを確認する**: `docker logs <container-name>`
3. **影響範囲を確認する**: どのコンポーネントが影響を受けているか確認
4. **復旧手順を実行する**: バックアップから復旧、または段階的にロールバック
5. **ドキュメントに記録する**: 問題と解決策をナレッジベースに記録

## 具体例

### ❌ 悪い例（今回の失敗）

```bash
# 一度に全てのボリュームを削除（証明書も削除される）
docker volume rm docker_thumbnail-storage docker_pdf-storage ...
```

### ✅ 良い例

```bash
# 1. 影響範囲を確認
docker volume inspect docker_thumbnail-storage
docker compose config

# 2. バックアップを取る
cp -r /opt/RaspberryPiSystem_002/certs /opt/RaspberryPiSystem_002/certs.backup

# 3. 問題のあるボリュームのみを対象にする
# 4. 各ステップで動作確認
# 5. 問題が発生したら即座に停止して復旧
```

## チェックリスト

作業前に以下を確認：

- [ ] 影響範囲を確認したか？
- [ ] バックアップを取ったか？
- [ ] 関連ドキュメントを参照したか？
- [ ] 段階的に進める計画を立てたか？
- [ ] 既存の動作を維持できるか？

## 関連ドキュメント

- `docs/INDEX.md`: ドキュメント索引
- `docs/knowledge-base/infrastructure.md`: インフラ関連のナレッジベース
- `docs/guides/deployment.md`: デプロイガイド
- `.cursor/rules/documentation-first.mdc`: ドキュメント優先ルール（ドキュメント参照の詳細手順）
- `.cursor/rules/debug-mode.mdc`: デバッグモードと開発方針ルール（開発時のデバッグ手法）
