---
description: Cursorデバッグモードと開発環境でのデバッグ方針。詰まったときのモード切り替えを含む。
alwaysApply: false
---

# デバッグモードと開発方針ルール

## 基本原則

**デバッグモードを活用し、詰まったときは適切なモードに切り替えて対応する。物理デバイスが絡む場合は実行環境を考慮する。**

## Cursorデバッグモードの適用範囲

### 1. Mac上でのローカル開発環境でのデバッグ

**適用可能な範囲**:

#### ✅ UI部分（管理コンソール、キオスクUI）

**方法**:
- Mac上で`apps/web`の開発サーバーを起動
- Pi5のAPI（`http://<Pi5のIP>:8080/api`）に接続
- デバッグログをMac上で収集可能

**手順**:
```bash
# Mac上で開発サーバーを起動
cd apps/web
pnpm dev

# Pi5のAPIに接続するため、環境変数を設定
# VITE_API_BASE_URL=http://<Pi5のIP>:8080/api
```

**制限**:
- Pi5のAPIが起動している必要がある
- データベース接続が必要な機能はPi5のDBに依存

#### ✅ USBカメラ

**理由**:
- カメラはブラウザの`MediaDevices API`（`navigator.mediaDevices.getUserMedia`）を使用
- Mac上でもブラウザ経由でカメラにアクセス可能
- コードは`apps/web/src/utils/camera.ts`に集約

**デバッグモードで可能なこと**:
1. Mac上で開発サーバーを起動
2. Macのカメラで動作確認
3. デバッグログをMac上で収集
   - カメラストリーム取得の成功/失敗
   - 画像圧縮の処理状況
   - Base64エンコードの結果

**注意点**:
- MacとPi4でカメラの性能が異なる可能性
- Pi4の処理能力を考慮した制限（640x480、15fps）はMac上でも有効

### 2. 物理デバイスが絡む場合のデバッグ

#### ⚠️ NFCリーダー

**制限**: 自立的なデバッグは困難

**理由**:
- NFCリーダーはPi4上で動作する`nfc-agent`（Python）で管理
- 物理デバイス（RC-S300/S1）はPi4に接続されている
- Macから直接アクセス不可

**デバッグモードで可能なこと**:
1. **Pi4上で`nfc-agent`を実行し、ログを収集**
   - `nfc-agent`のログにデバッグログを追加
   - HTTPエンドポイントにログを送信して収集
   - ログパス: `/Users/tsudatakashi/RaspberryPiSystem_002/.cursor/debug.log`

2. **WebSocket経由のイベントをログ化**
   - `useNfcStream`フックにデバッグログを追加
   - イベントの受信・処理を追跡

3. **モックモードで動作確認**
   - `AGENT_MODE=mock`でNFCリーダーなしで動作確認可能

**できないこと**:
- Mac上でNFCリーダーを直接操作
- 物理デバイスの動作確認（Pi4上で実施が必要）

**推奨アプローチ**:
- Pi4上で`nfc-agent`を実行
- デバッグログをHTTPエンドポイントに送信
- Macからログを確認
- または、SSH経由でPi4のログファイルを確認

## 詰まったときのモード切り替え方針

### デバッグモードで解決できない場合

1. **デバッグモードの限界を認識**
   - 物理デバイスが絡む場合は実行環境を考慮
   - Mac上でのデバッグが不可能な場合は実機検証に切り替え

2. **実機検証への切り替え**
   - デバッグモードで収集したログを基に仮説を立てる
   - 実機環境で検証する
   - 必要に応じて追加のログを収集

3. **ログベースのデバッグから実機検証への移行**
   - デバッグモードで収集したログを分析
   - 仮説を立てて実機環境で検証
   - 検証結果をナレッジベースに記録

### モード切り替えの判断基準

| 状況 | デバッグモード | 実機検証 |
|------|--------------|---------|
| **UI部分（管理コンソール、キオスクUI）** | ✅ 推奨 | ⚠️ 必要に応じて |
| **USBカメラ** | ✅ 推奨（Mac上でも可能） | ⚠️ 最終確認時 |
| **NFCリーダー** | ⚠️ 部分的に可能（Pi4上で実行が必要） | ✅ 推奨（物理デバイスの動作確認） |
| **APIエンドポイント** | ✅ 推奨（Mac上でPi5のAPIに接続） | ⚠️ 必要に応じて |

## デバッグモードの使い方

### 1. ログの収集方法

**ログパス**: `/Users/tsudatakashi/RaspberryPiSystem_002/.cursor/debug.log`

**サーバーエンドポイント**: `http://127.0.0.1:7242/ingest/efef6d23-e2ed-411f-be56-ab093f2725f8`

**JavaScript/TypeScriptでのログ送信例**:
```typescript
fetch('http://127.0.0.1:7242/ingest/efef6d23-e2ed-411f-be56-ab093f2725f8', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    location: 'file.js:LINE',
    message: 'desc',
    data: { k: v },
    timestamp: Date.now(),
    sessionId: 'debug-session',
    hypothesisId: 'A'
  })
}).catch(() => {});
```

### 2. 仮説検証のアプローチ

1. **3-5個の仮説を生成**: なぜバグが発生するかの詳細な仮説
2. **コードにログを追加**: すべての仮説を並行してテストできるログ
3. **ユーザーに再現を依頼**: 再現手順を提供
4. **ログを分析**: 各仮説を評価（CONFIRMED/REJECTED/INCONCLUSIVE）
5. **100%の確信がある場合のみ修正**: ログの証拠に基づいて修正
6. **修正後の検証**: 修正前後のログを比較して確認

### 3. ログファイルの管理

- **実行前にログファイルをクリア**: `delete_file`ツールを使用
- **ログは検証完了まで保持**: 修正後もログを削除しない
- **検証成功後にログを削除**: ユーザーの明示的な確認後に削除

## チェックリスト

デバッグ開始前に以下を確認：

- [ ] デバッグモードが適用可能な範囲か？（UI部分、USBカメラ）
- [ ] 物理デバイスが絡む場合は実行環境を考慮したか？（NFCリーダーはPi4上で実行）
- [ ] ログの収集方法を理解したか？（ログパス、サーバーエンドポイント）
- [ ] 仮説を3-5個生成したか？
- [ ] ログファイルをクリアしたか？（実行前）
- [ ] 詰まった場合のモード切り替え方針を理解したか？

## 関連ドキュメント

- `docs/guides/development.md`: 開発ガイド（デバッグセクション）
- `docs/knowledge-base/frontend.md`: フロントエンド関連のナレッジベース
- `.cursor/rules/system-stability.mdc`: 既存システム保護ルール
- `.cursor/rules/documentation-first.mdc`: ドキュメント優先ルール
