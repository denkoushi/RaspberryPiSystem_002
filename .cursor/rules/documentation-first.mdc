---
description: 作業前に必ずドキュメントを参照し、既存のナレッジとパターンを尊重するルール
alwaysApply: true
---

# ドキュメント優先・既存コード尊重ルール

## 基本原則

**作業前に必ずドキュメントを参照し、既存のナレッジと実装パターンを尊重する。独自の新ロジックを追加する前に既存実装を確認する。**

**関連ルール**: `.cursor/rules/system-stability.mdc`（既存システム保護ルール）と連携して動作します。

## 必須手順

以下の手順は、基本原則を実現するための具体的なアクションです。すべての作業開始前に必ず実行してください。

### 1. ドキュメント参照の徹底

作業開始前に必ず以下を参照する：

#### 1.1 索引から開始

1. **`docs/INDEX.md` を最初に確認**: 関連ドキュメントの索引
2. **目的別インデックスを確認**: 「開発する」「デプロイ・運用する」「エラーを解決する」など
3. **関連ドキュメントを全て読み込む**: リンクされているドキュメントを漏れなく確認

#### 1.2 ナレッジベースの確認

過去のトラブルシューティング記録を必ず確認：

- **`docs/knowledge-base/index.md`**: 全ナレッジベースの索引
- **`docs/knowledge-base/infrastructure.md`**: インフラ関連（KB-014 〜 KB-098）
  - **最新の重要KB**: KB-098（ansible pingタイムアウト）、KB-097（Pi3 systemctl mask）、KB-096（Pi3再起動の必要性）
- **`docs/knowledge-base/api.md`**: API関連
- **`docs/knowledge-base/frontend.md`**: フロントエンド関連

**検索方法**:
- 類似の問題がないか `grep` で検索
- KB-xxx の番号で過去の対応を確認

#### 1.3 ガイドドキュメントの確認

- **`docs/guides/deployment.md`**: デプロイ手順（標準手順の唯一の入口）
- **`docs/guides/deployment-troubleshooting.md`**: デプロイトラブルシューティング（症状別の対処法）
- **`docs/guides/development.md`**: 開発環境・ワークフロー
- **`docs/guides/measuring-instruments-verification.md`**: 計測機器検証手順（該当機能の場合）
- **`docs/guides/ansible-best-practices.md`**: Ansibleベストプラクティス（inventory.yml設定など）
- **`docs/guides/ansible-ssh-architecture.md`**: Ansible SSH接続アーキテクチャ（KB-098参照）

### 2. 既存コード・設定の尊重

**関連**: `.cursor/rules/system-stability.mdc`の「5. 既存コード・設定の尊重」も参照してください。

#### 2.1 動いているコードは変更しない

- **動いている理由を理解してから変更**: なぜその実装になっているかを理解する
- **既存のパターンに従う**: 独自の新ロジックを追加する前に既存実装を確認
- **段階的な変更**: 小さな変更から開始し、各ステップで動作確認

#### 2.2 設定ファイルの変更

- **影響範囲を確認**: `docker-compose.server.yml` などの設定ファイル変更時は依存関係を確認
- **既存の設定を尊重**: 動いている設定を無闇に変更しない
- **変数化された設定を優先**: ハードコードではなく環境変数や設定ファイルを参照

#### 2.3 ブランチ・コミット履歴の確認

- **動いていた時期のブランチを確認**: `git log` で過去の動作していた状態を確認
- **変更履歴を追跡**: なぜその変更が行われたかを理解する

### 3. 質問と確認

不明点がある場合は：

1. **ドキュメントで確認**: まずドキュメントで答えを探す
2. **既存コードで確認**: 類似の実装がないか確認
3. **ユーザーに質問**: ドキュメントに記載がない場合は1件ずつ質問する

## 具体例

### ❌ 悪い例

```typescript
// 既存の認証ロジックを無視して新しい実装を追加
const allowView = async (request: FastifyRequest, reply: FastifyReply) => {
  // 既存の実装を確認せずに独自のロジックを追加
  if (request.headers.authorization) {
    await canView(request, reply);
    return; // フォールバックがない
  }
};
```

### ✅ 良い例

```typescript
// 1. 既存の実装を確認（他のルートファイルを参照）
// 2. ドキュメントを確認（KB-093など）
// 3. 既存のパターンに従う（try-catchでフォールバック）
const allowView = async (request: FastifyRequest, reply: FastifyReply) => {
  if (request.headers.authorization) {
    try {
      await canView(request, reply);
      return;
    } catch {
      // JWT認証失敗時はx-client-keyへフォールバック（既存パターンに従う）
    }
  }
  await allowClientKey(request);
};
```

## チェックリスト

作業前に以下を確認：

- [ ] `docs/INDEX.md` を確認したか？
- [ ] 関連するナレッジベース（KB-xxx）を確認したか？
- [ ] 既存の類似実装を確認したか？
- [ ] 動いていた時期のコードを確認したか？
- [ ] 既存のパターンに従っているか？

## 関連ドキュメント

- `docs/INDEX.md`: ドキュメント索引
- `docs/knowledge-base/index.md`: ナレッジベース索引
- `.agent/PLANS.md`: ExecPlanの説明
- `.cursor/rules/system-stability.mdc`: 既存システム保護ルール（システム保護の観点からドキュメント参照を強調）
- `.cursor/rules/debug-mode.mdc`: デバッグモードと開発方針ルール（開発時のデバッグ手法）
