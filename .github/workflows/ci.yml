name: CI

on:
  push:
    branches: [main, develop, 'feature/**', 'fix/**', 'refactor/**']
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Security scan (pnpm audit, high+)
        run: |
          pnpm audit --audit-level=high || {
            echo "Security scan failed!"
            exit 1
          }

      - name: Run lint
        run: |
          pnpm lint --max-warnings=0 || {
            echo "Lint failed!"
            exit 1
          }

      - name: Build shared-types
        run: |
          cd packages/shared-types
          pnpm build

      - name: Generate Prisma Client
        run: |
          cd apps/api
          echo "Generating Prisma Client..."
          pnpm prisma generate || {
            echo "Prisma generate failed!"
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return

      - name: Build API
        run: |
          cd apps/api
          echo "Building API..."
          pnpm build || {
            echo "Build failed!"
            exit 1
          }

      - name: Start PostgreSQL
        run: |
          docker run -d \
            --name postgres-test \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=borrow_return \
            -p 5432:5432 \
            --health-cmd="pg_isready -U postgres" \
            --health-interval=10s \
            --health-timeout=5s \
            --health-retries=5 \
            postgres:15-alpine

      - name: Wait for PostgreSQL
        run: |
          timeout=60
          elapsed=0
          until docker exec postgres-test pg_isready -U postgres 2>/dev/null; do
            if [ $elapsed -ge $timeout ]; then
              echo "PostgreSQL failed to start within $timeout seconds"
              docker logs postgres-test
              exit 1
            fi
            echo "Waiting for PostgreSQL... ($elapsed/$timeout seconds)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "PostgreSQL is ready!"
          # データベース接続の最終確認
          docker exec postgres-test psql -U postgres -d borrow_return -c "SELECT version();" || {
            echo "PostgreSQL connection test failed!"
            exit 1
          }

      - name: Run Prisma migrations
        run: |
          cd apps/api
          echo "Running Prisma migrations..."
          pnpm prisma migrate deploy || {
            echo "Migration failed, checking database connection..."
            docker exec postgres-test psql -U postgres -c "SELECT version();"
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return

      - name: Run API tests
        run: |
          cd apps/api
          echo "Running API tests..."
          echo "DATABASE_URL: $DATABASE_URL"
          echo "PostgreSQL connection test..."
          docker exec postgres-test psql -U postgres -d borrow_return -c "SELECT 1;" || {
            echo "PostgreSQL connection failed!"
            exit 1
          }
          # imports-scheduleは専用ステップで実行するため除外
          BACKUP_CONFIG_PATH=/tmp/test-backup.json PROJECT_ROOT=$(pwd) pnpm test -- --reporter=verbose --exclude "**/imports-schedule.integration.test.ts" || {
            echo "Tests failed, showing test output..."
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return
          JWT_ACCESS_SECRET: test-access-secret-1234567890
          JWT_REFRESH_SECRET: test-refresh-secret-1234567890
          CAMERA_TYPE: mock
          PHOTO_STORAGE_DIR: /tmp/test-photo-storage
          BACKUP_STORAGE_DIR: /tmp/test-backups
          NODE_ENV: test

      - name: Run backup service tests
        run: |
          cd apps/api
          echo "Running backup service tests..."
          pnpm test -- backup --reporter=verbose || {
            echo "Backup tests failed, showing test output..."
            exit 1
          }
        env:
          BACKUP_STORAGE_DIR: /tmp/test-backups
          NODE_ENV: test

      - name: Run imports-dropbox tests
        run: |
          cd apps/api
          echo "Running imports-dropbox tests..."
          pnpm test -- imports-dropbox --reporter=verbose || {
            echo "Imports-dropbox tests failed, showing test output..."
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return
          JWT_ACCESS_SECRET: test-access-secret-1234567890
          JWT_REFRESH_SECRET: test-refresh-secret-1234567890
          CAMERA_TYPE: mock
          PHOTO_STORAGE_DIR: /tmp/test-photo-storage
          BACKUP_STORAGE_DIR: /tmp/test-backups
          NODE_ENV: test

      - name: Run csv-import-scheduler tests
        run: |
          cd apps/api
          echo "Running csv-import-scheduler tests..."
          BACKUP_CONFIG_PATH=/tmp/test-backup.json PROJECT_ROOT=$(pwd) pnpm test -- csv-import-scheduler --reporter=verbose || {
            echo "Csv-import-scheduler tests failed, showing test output..."
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return
          JWT_ACCESS_SECRET: test-access-secret-1234567890
          JWT_REFRESH_SECRET: test-refresh-secret-1234567890
          CAMERA_TYPE: mock
          PHOTO_STORAGE_DIR: /tmp/test-photo-storage
          BACKUP_STORAGE_DIR: /tmp/test-backups
          NODE_ENV: test

      - name: Run imports-schedule integration tests
        run: |
          cd apps/api
          echo "Running imports-schedule integration tests..."
          BACKUP_CONFIG_PATH=/tmp/test-backup.json PROJECT_ROOT=$(pwd) pnpm test -- imports-schedule --reporter=verbose || {
            echo "Imports-schedule integration tests failed, showing test output..."
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return
          JWT_ACCESS_SECRET: test-access-secret-1234567890
          JWT_REFRESH_SECRET: test-refresh-secret-1234567890
          CAMERA_TYPE: mock
          PHOTO_STORAGE_DIR: /tmp/test-photo-storage
          BACKUP_STORAGE_DIR: /tmp/test-backups
          NODE_ENV: test

      - name: Run import-alert service tests
        run: |
          cd apps/api
          echo "Running import-alert service tests..."
          BACKUP_CONFIG_PATH=/tmp/test-backup.json PROJECT_ROOT=$(pwd) pnpm test -- import-alert --reporter=verbose || {
            echo "Import-alert service tests failed, showing test output..."
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return
          JWT_ACCESS_SECRET: test-access-secret-1234567890
          JWT_REFRESH_SECRET: test-refresh-secret-1234567890
          CAMERA_TYPE: mock
          PHOTO_STORAGE_DIR: /tmp/test-photo-storage
          BACKUP_STORAGE_DIR: /tmp/test-backups
          NODE_ENV: test

      - name: Start API server for monitoring tests
        run: |
          cd apps/api
          # バックグラウンドでAPIサーバーを起動
          # NODE_ENVをproductionに設定してAPIサーバーを起動（testだとmain.tsで起動しない）
          NODE_ENV=production pnpm start > /tmp/api-server.log 2>&1 &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          echo "API server started with PID: $API_PID"
          
          # 少し待ってからログを確認
          sleep 2
          echo "API server log (first 50 lines):"
          head -50 /tmp/api-server.log || echo "No log file yet"
          
          # APIサーバーが起動するまで待機
          timeout=30
          elapsed=0
          until curl -s http://localhost:8080/api/system/health > /dev/null 2>&1; do
            if [ $elapsed -ge $timeout ]; then
              echo "API server failed to start within $timeout seconds"
              echo "API server log (full):"
              cat /tmp/api-server.log || true
              echo "Checking if process is still running:"
              ps aux | grep -E "node|pnpm" | grep -v grep || true
              echo "Checking port 8080:"
              netstat -tuln | grep 8080 || ss -tuln | grep 8080 || true
              exit 1
            fi
            echo "Waiting for API server... ($elapsed/$timeout seconds)"
            sleep 1
            elapsed=$((elapsed + 1))
          done
          echo "API server is ready!"
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return
          JWT_ACCESS_SECRET: test-access-secret-1234567890
          JWT_REFRESH_SECRET: test-refresh-secret-1234567890
          PORT: 8080
          HOST: 0.0.0.0

      - name: Test backup/restore scripts
        run: |
          echo "Testing backup/restore scripts..."
          # CI環境ではpostgres-testコンテナを使用
          export COMPOSE_FILE="infrastructure/docker/docker-compose.server.yml"
          # postgres-testコンテナが起動していることを確認
          docker ps | grep postgres-test || {
            echo "PostgreSQL test container is not running"
            exit 1
          }
          # バックアップテストを実行（postgres-testコンテナを直接使用）
          bash scripts/test/backup-restore.test.sh || {
            echo "Backup/restore tests failed!"
            exit 1
          }

      - name: Install Ansible for template rendering
        run: |
          python3 -m pip install --user ansible-core || {
            echo "Warning: Failed to install ansible-core, tests will use sed fallback"
          }

      - name: Test monitoring scripts
        run: |
          echo "Testing monitoring scripts..."
          API_URL=http://localhost:8080/api pnpm test:monitor || {
            echo "Monitoring tests failed!"
            echo "API server log:"
            cat /tmp/api-server.log || true
            exit 1
          }

      - name: Security scan (Trivy fs)
        uses: aquasecurity/trivy-action@0.25.0
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          scanners: 'vuln'
          skip-dirs: |
            **/certs
            **/alerts

      - name: Build api image for Trivy image scan
        run: docker build -t raspisys-api:ci -f infrastructure/docker/Dockerfile.api .

      - name: Build web image for Trivy image scan
        run: docker build -t raspisys-web:ci -f infrastructure/docker/Dockerfile.web .

      - name: Security scan (Trivy image api)
        uses: aquasecurity/trivy-action@0.25.0
        with:
          scan-type: 'image'
          image-ref: 'raspisys-api:ci'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          scanners: 'vuln'

      - name: Security scan (Trivy image web)
        uses: aquasecurity/trivy-action@0.25.0
        with:
          scan-type: 'image'
          image-ref: 'raspisys-web:ci'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          scanners: 'vuln'
          trivyignores: '.trivyignore'

      - name: Stop API server
        if: always()
        run: |
          if [ -n "$API_PID" ]; then
            echo "Stopping API server (PID: $API_PID)"
            kill $API_PID || true
            sleep 2
            kill -9 $API_PID 2>/dev/null || true
          fi
          pkill -f "node dist/main.js" || true
          pkill -f "pnpm start" || true

      - name: Cleanup PostgreSQL
        if: always()
        run: docker stop postgres-test && docker rm postgres-test || true

      - name: Build Web
        run: |
          cd apps/web
          pnpm build || {
            echo "Build Web failed!"
            exit 1
          }

  e2e-smoke:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Start PostgreSQL (smoke)
        run: |
          docker run -d \
            --name postgres-e2e-smoke \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=borrow_return \
            -p 5432:5432 \
            --health-cmd="pg_isready -U postgres" \
            --health-interval=10s \
            --health-timeout=5s \
            --health-retries=5 \
            postgres:15-alpine

      - name: Wait for PostgreSQL (smoke)
        run: |
          timeout=60
          elapsed=0
          until docker exec postgres-e2e-smoke pg_isready -U postgres 2>/dev/null; do
            if [ $elapsed -ge $timeout ]; then
              echo "PostgreSQL failed to start within $timeout seconds"
              docker logs postgres-e2e-smoke
              exit 1
            fi
            echo "Waiting for PostgreSQL... ($elapsed/$timeout seconds)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "PostgreSQL is ready!"

      - name: Generate Prisma Client (smoke)
        run: |
          cd apps/api
          pnpm prisma generate || {
            echo "Prisma generate failed!"
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return

      - name: Run Prisma migrations (smoke)
        run: |
          cd apps/api
          pnpm prisma migrate deploy || {
            echo "Prisma migrate deploy failed!"
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return

      - name: Seed database (smoke)
        run: |
          cd apps/api
          pnpm prisma db seed || {
            echo "Database seed failed!"
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return

      - name: Run E2E smoke tests
        env:
          CI: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return
          VITE_KIOSK_DEFAULT_MODE: TAG
        run: |
          pnpm test:e2e:smoke || {
            echo "E2E smoke tests failed!"
            exit 1
          }

      - name: Cleanup PostgreSQL (smoke)
        if: always()
        run: docker stop postgres-e2e-smoke && docker rm postgres-e2e-smoke

  e2e-tests:
    runs-on: ubuntu-latest
    needs: e2e-smoke
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Build shared-types
        run: |
          cd packages/shared-types
          pnpm build || {
            echo "Build shared-types failed!"
            exit 1
          }

      - name: Generate Prisma Client
        run: |
          cd apps/api
          pnpm prisma generate || {
            echo "Prisma generate failed!"
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return

      - name: Build API
        run: |
          cd apps/api
          pnpm build || {
            echo "Build API failed!"
            exit 1
          }

      - name: Build Web
        run: |
          cd apps/web
          pnpm build || {
            echo "Build Web failed!"
            exit 1
          }

      - name: Start PostgreSQL
        run: |
          docker run -d \
            --name postgres-e2e \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=borrow_return \
            -p 5432:5432 \
            --health-cmd="pg_isready -U postgres" \
            --health-interval=10s \
            --health-timeout=5s \
            --health-retries=5 \
            postgres:15-alpine

      - name: Wait for PostgreSQL
        run: |
          timeout=60
          elapsed=0
          until docker exec postgres-e2e pg_isready -U postgres 2>/dev/null; do
            if [ $elapsed -ge $timeout ]; then
              echo "PostgreSQL failed to start within $timeout seconds"
              docker logs postgres-e2e
              exit 1
            fi
            echo "Waiting for PostgreSQL... ($elapsed/$timeout seconds)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "PostgreSQL is ready!"

      - name: Run Prisma migrations
        run: |
          cd apps/api
          pnpm prisma migrate deploy || {
            echo "Prisma migrate deploy failed!"
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return

      - name: Seed database
        run: |
          cd apps/api
          pnpm prisma db seed || {
            echo "Database seed failed!"
            exit 1
          }
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return

      - name: Run E2E tests
        run: |
          echo "Running E2E tests..."
          pnpm test:e2e || {
            echo "E2E tests failed!"
            exit 1
          }
        env:
          CI: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/borrow_return
          JWT_ACCESS_SECRET: test-access-secret-1234567890
          JWT_REFRESH_SECRET: test-refresh-secret-1234567890

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          docker stop postgres-e2e || true
          docker rm postgres-e2e || true

  docker-build:
    runs-on: ubuntu-latest
    needs: [lint-and-test, e2e-smoke]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infrastructure/docker/Dockerfile.api
          push: false
          tags: raspberry-pi-system-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Web Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./infrastructure/docker/Dockerfile.web
          push: false
          tags: raspberry-pi-system-web:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

