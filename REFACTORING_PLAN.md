# モジュール化リファクタリング計画

## 目的

現在ラズパイ上で正常稼働している状態を維持しつつ、モジュール化を進めて拡張性・保守性を向上させる。

## ブランチ戦略

- **ブランチ名**: `refactor/module-architecture`
- **ベースブランチ**: `main`（現在の安定状態）
- **方針**: 各ステップで動作確認を行い、問題があれば即座に修正

## 改善ステップ

### Phase 1: APIルートのモジュール化（最小限の変更）

**目標**: APIルートをモジュール単位に整理し、名前空間を明確化

**作業内容**:
1. `apps/api/src/routes/tools/` ディレクトリを作成
2. `employees.ts`, `items.ts`, `loans.ts`, `transactions.ts` を `tools/` に移動
3. `routes/index.ts` を更新して `/api/tools/*` パスで登録
4. 既存の `/api/employees` などのパスは後方互換性のため残す（リダイレクトまたはエイリアス）

**検証**:
- [ ] 既存のAPIエンドポイントが正常に動作する
- [ ] フロントエンドからのリクエストが正常に処理される
- [ ] ラズパイ上で動作確認

**リスク**: 低（パスの変更のみ、既存パスも維持）

---

### Phase 2: サービス層の導入（段階的）

**目標**: ビジネスロジックをルートハンドラーから分離

**作業内容**:
1. `apps/api/src/services/tools/` ディレクトリを作成
2. `employee.service.ts`, `item.service.ts`, `loan.service.ts` を作成
3. ルートハンドラーからPrismaクエリをサービス層に移動
4. ルートハンドラーはサービス層を呼び出すだけにする

**検証**:
- [ ] 既存のAPI動作が変わらないことを確認
- [ ] テストが正常に動作する
- [ ] ラズパイ上で動作確認

**リスク**: 中（ロジックの移動によりバグが発生する可能性）

---

### Phase 3: 共通パッケージの作成

**目標**: API/Web間で型定義を共有

**作業内容**:
1. `packages/shared-types/` を作成
2. API/Webで共通利用する型定義を移動
3. `apps/api` と `apps/web` から `@raspi-system/shared-types` を参照

**検証**:
- [ ] 型定義が正しく共有される
- [ ] ビルドが正常に完了する
- [ ] 型エラーが発生しない

**リスク**: 低（型定義の移動のみ）

---

### Phase 4: フロントエンドのモジュール化

**目標**: ページ構造をモジュール単位に整理

**作業内容**:
1. `apps/web/src/pages/tools/` ディレクトリを作成
2. `admin/employees`, `admin/items`, `admin/history` を `tools/` に移動
3. ルーティングを更新（`/admin/tools/employees` など）

**検証**:
- [ ] 既存のページが正常に表示される
- [ ] ルーティングが正常に動作する
- [ ] ラズパイ上で動作確認

**リスク**: 低（ページの移動のみ）

---

## ロールバック計画

各Phase完了後、問題が発生した場合：

1. **即座のロールバック**: `git checkout main` で元の状態に戻る
2. **部分的なロールバック**: 問題のあるPhaseのみを元に戻す
3. **修正**: ブランチ上で修正を続行

## 動作確認チェックリスト

各Phase完了後、以下を確認：

- [ ] APIサーバーが正常に起動する
- [ ] データベース接続が正常
- [ ] 認証・認可が正常に動作
- [ ] 主要なAPIエンドポイントが正常に応答
- [ ] Web UIが正常に表示される
- [ ] キオスク機能が正常に動作
- [ ] NFCエージェントとの連携が正常
- [ ] ラズパイ上での動作確認

## 注意事項

- **段階的な実施**: 一度に全てを変更せず、Phaseごとに実施
- **動作確認の徹底**: 各Phase完了後、必ずラズパイ上で動作確認
- **コミット頻度**: 各Phase完了後、動作確認が取れたらコミット
- **テスト**: 既存のテストが正常に動作することを確認

## 完了後のマージ

全てのPhaseが完了し、動作確認が取れたら：

1. `main` ブランチにマージ
2. ラズパイ上で最終動作確認
3. 問題がなければ `main` にマージ完了

---

**作成日**: 2025-01-XX  
**ブランチ**: `refactor/module-architecture`  
**ベース**: `main` (コミット: 0e26ee3)

